 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALIF | Advanced Medical Education</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/protect.js"></script>
    <style type="text/css">
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --primary: #3b82f6; 
            --primary-dark: #2563eb; 
            --primary-light: #dbeafe; 
            --secondary: #6b7280; 
            --success: #22c55e; 
            --error: #ef4444; 
            --warning: #eab308; 
            --info: #0ea5e9; 
            --background: #ffffff; 
            --surface: #f9fafb; 
            --text-primary: #111827; 
            --text-secondary: #4b5563; 
            --text-tertiary: #9ca3af; 
            --border: #e5e7eb; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.05);
            --radius: 8px; 
            --radius-lg: 12px;
            --radius-xl: 16px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
            --gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --glass: rgba(255, 255, 255, 0.85); 
            --glass-border: rgba(229, 231, 235, 0.3);
        }

        .dark-mode {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --primary-light: #93c5fd;
            --secondary: #94a3b8;
            --background: #000000; 
            --surface: #111827; 
            --text-primary: #f9fafb; 
            --text-secondary: #d1d5db; 
            --text-tertiary: #6b7280; 
            --border: #1f2937; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.6); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.6);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.6);
            --glass: rgba(17, 24, 39, 0.85); 
            --glass-border: rgba(31, 41, 55, 0.3);
            .mode-btn,
    .question-text,
    .option-text {
        color: var(--text-primary) !important;
    }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            transition: var(--transition);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* App Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow);
            transform: translateX(-100%);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 0 24px 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .logo i {
            font-size: 24px;
        }

        .sidebar-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            background: var(--glass);
            border-radius: var(--radius);
            margin: 0 16px 24px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: var(--shadow);
        }

        .user-info h3 {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .user-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--glass);
            border-left-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .nav-item.active .nav-icon {
            color: var(--primary);
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .categories-section {
            margin-top: 24px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .categories-grid {
            padding: 0 16px;
        }

        .category-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .category-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .category-card.active {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .category-card.active .category-icon {
            background: var(--primary);
        }

        .category-name {
            font-weight: 500;
            font-size: 14px;
        }

        .category-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-right: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .category-card.active .progress-text {
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content.sidebar-open {
            margin-left: 280px;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--primary-light);
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mode-selector {
            display: flex;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 4px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            padding: 24px 32px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Quiz Container */
        .quiz-container {
            padding: 0 32px 32px;
        }

        .question-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .question-card.fade-in {
            opacity: 1;
        }

        .question-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .question-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .question-number {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            background: var(--primary-light);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-category {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            background: var(--glass);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary-light);
        }

        .question-text {
            font-size: 18px;
            font-weight: 500;
            line-height: 1.6;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass);
            min-height: 60px;
        }

        .option:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .option.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            flex-shrink: 0;
            transition: var(--transition);
        }

        .option.selected .option-letter {
            background: var(--primary);
            color: white;
        }

        .option.correct .option-letter {
            background: var(--success);
            color: white;
        }

        .option.incorrect .option-letter {
            background: var(--error);
            color: white;
        }

        .option-text {
            flex: 1;
            font-size: 15px;
            font-weight: 400;
        }

        /* Explanation Section */
        .explanation-section {
            margin-top: 24px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 24px;
        }

        .explanation-section details {
            margin-bottom: 16px;
        }

        .explanation-section summary {
            padding: 12px 16px;
            background: var(--surface);
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .explanation-section summary:hover {
            background: var(--primary-light);
        }

        .explanation-section details[open] summary {
            background: var(--primary);
            color: white;
        }

        .explanation-content {
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .explanation-content strong {
            color: var(--text-primary);
        }

        .correct-answer, .why-not-section, .related-questions {
            margin-bottom: 16px;
            padding: 16px;
            border-radius: var(--radius);
        }

        .correct-answer {
            background: rgba(34, 197, 94, 0.05);
            border-left: 4px solid var(--success);
        }

        .why-not-section {
            background: rgba(239, 68, 68, 0.05);
            border-left: 4px solid var(--error);
        }

        .related-questions {
            background: rgba(59, 130, 246, 0.05);
            border-left: 4px solid var(--primary);
        }

        .related-questions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .related-question-tag {
            padding: 6px 12px;
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .related-question-tag:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        /* Quiz Controls */
        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .quiz-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .quiz-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .quiz-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .check-btn {
            background: var(--primary);
            color: white;
        }

        .check-btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .next-btn {
            background: var(--success);
            color: white;
        }

        .next-btn:hover:not(:disabled) {
            background: #16a34a;
        }

        .submit-btn {
            background: var(--gradient);
            color: white;
            padding: 12px 32px;
            font-size: 16px;
        }

        /* Results Screen */
        .results-screen {
            padding: 32px;
            max-width: 900px;
            margin: 0 auto;
        }

        .results-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 48px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .results-header {
            margin-bottom: 32px;
        }

        .results-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .score-display {
            font-size: 64px;
            font-weight: 700;
            margin: 32px 0;
            color: var(--text-primary);
        }

        .score-text {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .results-details {
            text-align: left;
            margin: 48px 0;
            background: var(--glass);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--glass-border);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-question {
            flex: 1;
            font-size: 14px;
        }

        .result-status {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .result-correct {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .result-incorrect {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .restart-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 16px 48px;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        /* Enhanced Features */
        .search-container {
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 12px 16px;
            max-width: 400px;
            margin: 0 auto;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-box i {
            color: var(--text-tertiary);
            margin-right: 8px;
        }


        .export-section {
            padding: 16px 32px;
            text-align: center;
        }

        .export-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Custom Quiz Modal */
/* Custom Quiz Modal Styles */
.custom-quiz-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.custom-quiz-modal.active {
    display: flex;
}

.custom-quiz-content {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 32px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--border);
}

.custom-quiz-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 24px;
    color: var(--text-primary);
}

.custom-quiz-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
}

.custom-quiz-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    background: var(--glass);
}

.custom-quiz-option:hover {
    border-color: var(--primary-light);
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

.custom-quiz-option.selected {
    border-color: var(--primary);
    background: var(--primary-light);
}

.custom-quiz-option .option-selector {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    flex-shrink: 0;
}

.custom-quiz-option.selected .option-selector {
    background: var(--primary);
    border-color: var(--primary);
}

.custom-quiz-option.selected .option-selector::after {
    content: 'âœ“';
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.custom-quiz-option label {
    cursor: pointer;
    font-weight: 500;
    color: var(--text-primary);
    flex: 1;
    margin: 0;
}

.quiz-options-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

.quiz-options-section label {
    display: block;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-weight: 600;
}

.custom-quiz-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
}

/* Modern Dropdown for Custom Quiz */
.custom-quiz-content .modern-dropdown {
    position: relative;
    margin-top: 8px;
}

.custom-quiz-content .modern-dropdown select {
    width: 100%;
    padding: 12px 48px 12px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    background-size: 18px;
}

.custom-quiz-content .modern-dropdown select:hover {
    border-color: var(--primary);
    background-color: var(--primary-light);
}

.custom-quiz-content .modern-dropdown select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Glass effect for modal */
.custom-quiz-content.glass-effect {
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.dark-mode .custom-quiz-content.glass-effect {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .sidebar {
                width: 66vw;
            }

            .main-content.sidebar-open {
                margin-left: 100vw;
            }

            .top-nav {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .nav-left {
                width: 100%;
                justify-content: space-between;
            }

            .nav-right {
                width: 100%;
                justify-content: space-between;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                padding: 16px;
            }

            .quiz-container {
                padding: 0 16px 16px;
            }

            .question-card {
                padding: 24px;
            }

            .question-text {
                font-size: 17px;
            }

            .option {
                padding: 12px;
                min-height: 70px;
            }

            .results-card {
                padding: 32px 24px;
            }

            .score-display {
                font-size: 48px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .search-container {
                padding: 12px 16px;
            }

            .analytics-section {
                margin: 16px;
                padding: 16px;
            }

            .quiz-btn {
                padding: 16px 20px;
                font-size: 16px;
            }
        }

        @media (min-width: 1200px) {
            .quiz-container {
                max-width: 1100px;
                margin: 0 auto;
                padding: 24px;
            }

            .question-card {
                max-width: 1000px;
                margin: 0 auto 24px;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        .hidden {
            display: none;
        }

        .glass {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .text-gradient {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .question-difficulty {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .question-dropdown {
            margin-top: 8px;
            display: block;
        }

        .question-dropdown select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .option.disabled {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .timer-warning {
            color: var(--warning);
        }

        .timer-error {
            color: var(--error);
        }

        .loading-spinner {
            display: none;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        .loading-spinner.active {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ultra Modern Styles */
        /* Glass Morphism Effects */
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark-mode .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Enhanced Hover Effects with Glow */
        .nav-item:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.15) 100%) !important;
            border-left-color: var(--primary) !important;
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25) !important;
            backdrop-filter: blur(10px);
        }

        .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(255, 255, 255, 0.95) 100%) !important;
            transform: translateY(-5px) scale(1.03) !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 30px rgba(59, 130, 246, 0.1) !important;
            border-color: var(--primary) !important;
            backdrop-filter: blur(10px);
        }

        .option:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.12) 100%) !important;
            transform: translateY(-3px) scale(1.03) !important;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.2) !important;
            border-color: var(--primary) !important;
        }

        .quiz-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.08) !important;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25) !important;
            filter: brightness(1.1);
        }

        .action-btn:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
            color: white !important;
            transform: scale(1.15) rotate(8deg) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5) !important;
        }

        /* Ultra Modern Dropdown */
        .modern-dropdown {
            position: relative;
            margin-top: 12px;
        }

        .modern-dropdown select {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 2px solid transparent;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--surface) 0%, var(--glass) 100%);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .modern-dropdown select:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.08) 100%);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .modern-dropdown select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 8px 25px rgba(59, 130, 246, 0.25);
            transform: translateY(-2px);
        }

        /* Enhanced Search with Blur Effect */
        .search-container {
            transition: all 0.4s ease;
        }

        .search-box {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .search-box:focus-within {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2);
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.15);
        }

        .search-blur-active .main-content > *:not(.search-container):not(.quiz-container) {
            filter: blur(8px);
            opacity: 0.7;
            pointer-events: none;
        }

        /* Beautiful Stats Cards */
        .stat-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.05) !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2) !important;
        }

        /* Modern Progress Bars */
        .progress-fill {
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark), #8b5cf6) !important;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.4);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Beautiful Notification */
        .notification {
            border-radius: 20px !important;
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15)) !important;
        }

        .dark-mode .notification {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2)) !important;
        }

        /* Enhanced Question Cards */
        .question-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .question-card:hover {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-3px);
            border-color: var(--primary-light);
        }

        /* Modern Settings Panel */
        .settings-panel {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
        }

        .dark-mode .settings-panel {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Question Creator */
        .custom-question-creator {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 32px;
        }

        .dark-mode .custom-question-creator {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.15) rotate(15deg);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.6);
        }

        /* Dark mode adjustments */
        .dark-mode .nav-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.1) 100%) !important;
        }

        .dark-mode .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(17, 24, 39, 0.95) 100%) !important;
        }

        .dark-mode .option:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.08) 100%) !important;
        }

        /* Search Results Highlight */
        .search-highlight {
            background: linear-gradient(120deg, var(--primary-light) 0%, transparent 50%);
            border-radius: 4px;
            padding: 2px 4px;
        }
        @media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 12px 16px;
    }

    .stat-card {
        padding: 16px 12px;
        min-height: 80px;
    }

    .stat-header {
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

    .stat-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }

    .stat-value {
        font-size: 20px;
        margin-bottom: 2px;
    }

    .stat-label {
        font-size: 11px;
        line-height: 1.3;
    }

    .stat-trend {
        font-size: 10px;
    }

    .stat-trend i {
        font-size: 10px;
    }
}

/* Extra small devices (phones under 400px) */
@media (max-width: 400px) {
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 10px 12px;
    }

    .stat-card {
        padding: 14px 10px;
        min-height: 70px;
    }

    .stat-value {
        font-size: 18px;
    }

    .stat-label {
        font-size: 10px;
    }
}
.analytics-grid {
    display: none;
}

/* OR hide individual cards */
.analytics-card {
    display: none;
}

/* If you want to keep the section structure but hide content */
.analytics-section {
    padding: 0;
    margin: 0;
    height: 0;
    overflow: hidden;
}
@media (max-width: 768px) {
    /* Your existing mobile styles... */
    
    .sidebar {
        width: 66vw;
    }

    .main-content.sidebar-open {
        margin-left: 100vw;
    }

    .top-nav {
        padding: 12px 16px;
        flex-wrap: wrap;
        gap: 12px;
    }

    /* Hide all custom question and export buttons on mobile */
    .fab {
        display: none !important;
    }
    
    #createCustomQuizBtn {
        display: none !important;
    }
    
    /* Hide both buttons in Settings section */
    .settings-panel .quiz-btn:has(i.fa-download),
    .settings-panel .quiz-btn:has(i.fa-plus) {
        display: none !important;
    }

    /* Your stats grid and other mobile styles... */
    .stats-grid {
        display: flex;
        overflow-x: auto;
        gap: 6px;
        padding: 6px 10px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        margin: 0 -4px;
    }
    /* ... rest of your mobile CSS */
}
@media (max-width: 768px) {
    .fab {
        display: none !important;
    }
    
    /* Hide entire export section from Dashboard */
    .export-section {
        display: none !important;
    }
    
    /* Hide both buttons in Settings section */
    .settings-panel .quiz-btn:has(i.fa-download),
    .settings-panel .quiz-btn:has(i.fa-plus) {
        display: none !important;
    }
}
@media (max-width: 768px) {
    /* Hide all stat cards except Correct Answers */
    .stat-card:not(:first-child) {
        display: none !important;
    }
    
    /* Optional: Make the Correct Answers card full width */
    .stat-card:first-child {
        width: 100% !important;
        flex: 1 !important;
    }

    /* Your existing mobile styles for stats grid */
    .stats-grid {
        display: flex;
        overflow-x: auto;
        gap: 6px;
        padding: 6px 10px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        margin: 0 -4px;
    }
}
.user-avatar img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}
/* Primary action button */
.action-btn.primary {
    background: var(--primary);
    color: white;
}

.action-btn.primary:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
}

    </style>
</head>
<body class="dark-mode">
    <div class="overlay" id="overlay"></div>
    
    <!-- Custom Quiz Modal -->
<div class="custom-quiz-modal" id="customQuizModal">
    <div class="custom-quiz-content glass-effect">
        <h3 class="custom-quiz-title"> </h3>
        <div class="custom-quiz-options">
            <div class="custom-quiz-option" data-category="all">
                <div class="option-selector"></div>
                <label>All Categories</label>
            </div>
            <div class="custom-quiz-option" data-category="easy">
                <div class="option-selector"></div>
                <label>Easy Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="medium">
                <div class="option-selector"></div>
                <label>Medium Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="hard">
                <div class="option-selector"></div>
                <label>Hard Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="bookmarked">
                <div class="option-selector"></div>
                <label>Bookmarked Questions Only</label>
            </div>
            <div class="quiz-options-section">
                <label>Number of Questions</label>
                <div class="modern-dropdown">
                    <select id="questionCount">
                        <option value="5">5 Questions</option>
                        <option value="10" selected>10 Questions</option>
                        <option value="15">15 Questions</option>
                        <option value="20">20 Questions</option>
                        <option value="0">All Questions</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="custom-quiz-actions">
            <button class="quiz-btn" id="cancelCustomQuiz">
                Cancel
            </button>
            <button class="quiz-btn check-btn" id="createCustomQuiz">
                Create Quiz
            </button>
        </div>
    </div>
</div>
    
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-stethoscope"></i>
                    <span>ALIF</span>
                </div>
                <div class="sidebar-subtitle">Advanced Medical Education Platform</div>
            </div>
            
            <div class="user-profile">
    <div class="user-avatar">
        <img src="logo.png" alt="User Avatar">
    </div>
    <div class="user-info">
        <h3>ALIFO</h3>
        <p>Medical Student</p>
    </div>
</div>

            
            <div class="nav-item active">
                <div class="nav-icon">
                    <i class="fas fa-home"></i>
                </div>
                <span>Dashboard</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span>My Courses</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span>Progress Analytics</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-bookmark"></i>
                </div>
                <span>Bookmarked Questions</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <span>Settings</span>
            </div>
            
            <div class="categories-section">
                <div class="section-title">
                    <span>Medical Categories</span>
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div class="categories-grid" id="categoriesGrid"></div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Top Navigation -->
            <div class="top-nav">
    <div class="nav-left">
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle Sidebar">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Add Back and Home buttons -->
        <a href="/" class="action-btn" id="backBtn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <a href="/" class="action-btn primary">
            <i class="fas fa-home"></i>
        </a>
        
        <h1 class="page-title" id="pageTitle">Dashboard</h1>
    </div>
    <div class="nav-right">
        <!-- Your existing mode selector and buttons -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="exam" aria-label="Exam Mode">
                <i class="fas fa-file-alt"></i>
                Exam
            </button>
            <button class="mode-btn" data-mode="quiz" aria-label="Quiz Mode">
                <i class="fas fa-tasks"></i>
                Quiz
            </button>
            <button class="mode-btn" data-mode="learn" aria-label="Learn Mode">
                <i class="fas fa-brain"></i>
                Learn
            </button>
        </div>
        <div class="action-btn" id="themeToggle" aria-label="Toggle Theme">
            <i class="fas fa-sun"></i>
        </div>
        <div class="action-btn" aria-label="Notifications">
            <i class="fas fa-bell"></i>
        </div>
    </div>
</div>
            
            <!-- Search Section -->
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search questions or categories...">
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+12%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="correctAnswers">0</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-down" style="color: var(--error);"></i>
                            <span style="color: var(--error); font-size: 13px;">-5%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="timeSpent">0h</div>
                    <div class="stat-label">Time Spent</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+8%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="masteryLevel">0%</div>
                    <div class="stat-label">Mastery Level</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--warning);"></i>
                            <span style="color: var(--warning); font-size: 13px;">+3</span>
                        </div>
                    </div>
                    <div class="stat-value" id="streakCount">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div class="analytics-section">
                <h3 class="analytics-title">Learning Analytics</h3>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-value" id="weakAreasCount">0</div>
                        <div class="analytics-label">Weak Areas Identified</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="avgTimePerQuestion">0s</div>
                        <div class="analytics-label">Avg Time Per Question</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="improvementRate">0%</div>
                        <div class="analytics-label">Weekly Improvement</div>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Container -->
            <div class="quiz-container" id="quizContainer"></div>
            
            <!-- Results Screen -->
            <div class="results-screen hidden" id="resultsScreen"></div>
            
            <!-- Export Section -->
            <div class="export-section">
                <button class="export-btn" id="exportProgress">
                    <i class="fas fa-download"></i>
                     
                </button>
                <button class="export-btn" id="createCustomQuizBtn" style="margin-left: 12px;">
                    <i class="fas fa-plus"></i>
                     
                </button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  // Check if running inside Telegram
  const tg = window.Telegram?.WebApp;

  // --- 1ï¸âƒ£ Handle Telegram Mini App Back Button ---
  if (tg) {
    tg.ready(); // Initialize Telegram SDK
    tg.BackButton.show();

    tg.BackButton.onClick(() => {
      console.log("Telegram back button pressed");
      handleBackAction();
    });
  }

  // --- 2ï¸âƒ£ Handle Browser/Phone Back Button ---
  window.addEventListener('popstate', () => {
    console.log("Browser back button pressed");
    handleBackAction();
  });

  // --- 3ï¸âƒ£ Function to handle back action globally ---
  function handleBackAction() {
    // Example actions (customize as you wish):
    // Go back if possible, otherwise go to home page
    if (document.referrer && window.history.length > 1) {
      window.history.back();
    } else {
      window.location.href = '/'; // or your home page route
    }
  }

  // --- 4ï¸âƒ£ Optional: Prevent unwanted exits ---
  // This ensures pressing back doesnâ€™t immediately close the app
  history.pushState(null, '', location.href);
</script>

     <script>
        // Anti-copy, anti-inspect measures
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
});
document.addEventListener('keydown', function(e) {
    if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.ctrlKey && e.shiftKey && e.keyCode === 74) || (e.ctrlKey && e.keyCode === 85)) {
        e.preventDefault();
    }
});

// Enhanced quiz data with more questions
const quizData = [
    {
        "id": 1,
        "question": "A 25-year-old man presents 1 week after discovering that his left testicle is twice the normal size. Physical examination reveals a nontender, testicular mass that cannot be transilluminated. Serum levels of alpha-fetoprotein and human chorionic gonadotropin are normal. A hemiorchiectomy is performed, and histologic examination of the surgical specimen shows embryonal carcinoma. Compared to normal adult somatic cells, this germ cell neoplasm would most likely show high levels of expression of which of the following proteins?",
        "options": [
            "(A) Desmin",
            "(B) Dystrophin",
            "(C) Cytochrome c",
            "(D) P selectin",
            "(E) Telomerase"
        ],
        "answer": 4,
        "correctAnswer": "Telomerase",
        "explanation": "Somatic cells do not normally express telomerase, which is an enzyme that adds repetitive sequences to maintain the length of the telomere. Thus, with each round of somatic cell replication, the telomere shortens. The length of telomeres may act as a â€œmolecular clockâ€ and govern the lifespan of replicating cells. Because cancer cells and embryonic cells express high levels of telomerase, the reactivation of this enzyme may be important for maintaining stem cell proliferation. Most human cancers show activation of the gene for the catalytic subunit of telomerase: human telomerase reverse transcriptase.",
        "whyNotOtherOptions": {
            "a": "Desmin is an intermediate filament protein found in cells of mesenchymal origin.",
            "b": "Dystrophin is a protein involved in muscular dystrophy, not cancer.",
            "c": "Cytochrome c is involved in apoptosis, not telomere maintenance.",
            "d": "P selectin is a cell adhesion molecule that mediates the margination of neutrophils during acute inflammation."
        },
        "relatedQuestions": ["4"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 2,
        "question": "A 25-year-old woman presents for a gynecologic examination. The cervical Pap smear shows â€œkoilocytic atypiaâ€ characterized by perinuclear halos and wrinkled nuclei (shown in the image). A cervical biopsy reveals invasive squamous cell carcinoma. Molecular tests for human papillomavirus (HPV) in the tumor cells are positive. Which of the following mechanisms of disease best explains the role of HPV in the pathogenesis of neoplasia in this patient?",
        "options": [
            "(A) Activation of cellular oncogenes",
            "(B) Enhanced transcription of telomerase gene",
            "(C) Episomal viral replication",
            "(D) Inactivation of tumor suppressor proteins",
            "(E) Insertional mutagenesis"
        ],
        "answer": 3,
        "correctAnswer": "Inactivation of tumor suppressor proteins",
        "explanation": "Unlike RNA tumor viruses, whose oncogenes have normal cellular counterparts, the transforming genes of DNA viruses are not homologous with any cellular genes. This conundrum was resolved with the discovery that the gene products of oncogenic DNA viruses inactivate tumor suppressor proteins. For example, proteins encoded by the E6 and E7 genes of HPV16 bind p53 and pRb.",
        "whyNotOtherOptions": {
            "a": "Activation of cellular oncogenes is seen in RNA viruses.",
            "b": "Enhanced transcription of telomerase is a feature of many cancers but not specific to HPV.",
            "c": "Episomal viral replication is not the transforming mechanism.",
            "e": "Insertional mutagenesis is typical of retroviruses."
        },
        "relatedQuestions": ["3", "13"],
        "category": "Neoplasia",
        "difficulty": "Hard"
    },
    {
        "id": 3,
        "question": "The patient described in Question 2 undergoes a hysterectomy. In addition to a focus of invasive carcinoma, the pathologist identifies dysplastic squamous cells occupying the entire thickness of the cervical epithelium, with no evidence of epithelial maturation. The basal membrane in these areas appears intact. Which of the following terms best describes this cervical lesion?",
        "options": [
            "(A) Atypical hyperplasia",
            "(B) Carcinoma in situ",
            "(C) Carcinomatosis",
            "(D) Complex hyperplasia",
            "(E) Koilocytic atypia"
        ],
        "answer": 1,
        "correctAnswer": "Carcinoma in situ",
        "explanation": "Most carcinomas begin as localized growths confined to the epithelium in which they arise. As long as these early cancers do not penetrate the basement membrane on which the epithelium rests, such tumors are labeled carcinoma in situ. When the in situ tumor acquires invasive potential and extends directly through the underlying basement membrane, it is in a position to compromise neighboring tissues and metastasize.",
        "whyNotOtherOptions": {
            "a": "Atypical hyperplasia refers to proliferative lesions of the glands within the uterine endometrium.",
            "c": "Carcinomatosis is a clinical term used to describe widespread dissemination of cancer.",
            "d": "Complex hyperplasia refers to proliferative lesions of the glands within the uterine endometrium.",
            "e": "Koilocytic atypia implies the presence of squamous cells with perinuclear halos and nuclear changes indicative of HPV infection."
        },
        "relatedQuestions": ["2", "40"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 4,
        "question": "A 62-year-old woman presents with a breast lump that she discovered 6 days ago. A breast biopsy shows lobular carcinoma in situ. Compared to normal epithelial cells of the breast lobule, these malignant cells would most likely show decreased expression of which of the following proteins?",
        "options": [
            "(A) Desmin",
            "(B) E-cadherin",
            "(C) Lysyl hydroxylase",
            "(D) P selectin",
            "(E) Telomerase"
        ],
        "answer": 1,
        "correctAnswer": "E-cadherin",
        "explanation": "Cadherins are Ca2+-dependent transmembrane glycoproteins that mediated cellâ€“cell adhesion. E-cadherin is expressed on the surface of all epithelia and mediates cell adhesion by â€œzipper-likeâ€ interactions. Overall, cadherins suppress invasion and metastasis. Thus, it is perhaps not surprising that the expression of E-cadherin is reduced in most carcinomas.",
        "whyNotOtherOptions": {
            "a": "Desmin is an intermediate filament protein found in cells of mesenchymal origin.",
            "c": "Lysyl hydroxylase is involved in the posttranslational modification of collagen.",
            "d": "P selectin is a cell adhesion molecule that mediates the margination of neutrophils during acute inflammation.",
            "e": "Telomerase is increased in certain malignancies."
        },
        "relatedQuestions": ["1", "12"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 5,
        "question": "An 80-year-old man complains of lower abdominal pain, increasing weakness, and fatigue. He has lost 16 lb (7.3 kg) in the past 6 months. The prostate-specific antigen test is elevated (8.5 ng/mL). Rectal examination reveals an enlarged and nodular prostate. A needle biopsy of the prostate discloses invasive prostatic adenocarcinoma. Histologic grading of this patientâ€™s carcinoma is based primarily on which of the following criteria?",
        "options": [
            "(A) Capsular involvement",
            "(B) Extent of regional lymph nodes involvement",
            "(C) Pulmonary metastases",
            "(D) Resemblance to normal tissue of origin",
            "(E) Volume of prostate involved by tumor"
        ],
        "answer": 3,
        "correctAnswer": "Resemblance to normal tissue of origin",
        "explanation": "To establish criteria for therapy, many cancers are classified according to histologic grading schemes or by staging protocols that describe the extent of spread. Cancer grading reflects cellular characteristics. Low-grade tumors are well differentiated, whereas high-grade tumors lack differentiated features (anaplasia). The general correlation between cytologic grade and the behavior of a neoplasm is not invariable.",
        "whyNotOtherOptions": {
            "a": "The other choices pertain to cancer staging.",
            "b": "The other choices pertain to cancer staging.",
            "c": "The other choices pertain to cancer staging.",
            "e": "The other choices pertain to cancer staging."
        },
        "relatedQuestions": ["14"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 6,
        "question": "A 50-year-old woman presents with a lump in her breast. A 4-cm firm and fixed mass is noted on breast examination. Excisional biopsy reveals malignant cells that form gland-like structures and solid nests, surrounded by a dense collagenous stroma. A connective tissue stain (trichrome) of the biopsy is shown in the image. Which of the following descriptive terms best describes the blue areas observed in this specimen?",
        "options": [
            "(A) Colloid carcinoma",
            "(B) Comedocarcinoma",
            "(C) Desmoplastic change",
            "(D) Medullary carcinoma",
            "(E) Papillomatosis"
        ],
        "answer": 2,
        "correctAnswer": "Desmoplastic change",
        "explanation": "Secondary descriptors are used to refer to a tumorâ€™s morphologic and functional characteristics. Scirrhous or desmoplastic implies dense fibrous stroma.",
        "whyNotOtherOptions": {
            "a": "Colloid carcinomas secrete abundant mucus.",
            "b": "Comedocarcinoma is an intraductal neoplasm in which necrotic material can be expressed from the ducts.",
            "d": "Medullary signifies a soft cellular tumor.",
            "e": "Papillomatosis describes frond-like structures."
        },
        "relatedQuestions": ["4"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 7,
        "question": "A 65-year-old man complains of muscle weakness and a dry cough for 4 months. He has smoked two packs of cigarettes daily for 45 years. A chest X-ray shows a 4-cm central, left lung mass. Laboratory studies reveal hyperglycemia and hypertension. A transbronchial biopsy is diagnosed as small cell carcinoma. Metastases to the liver are detected by CT scan. Which of the following might account for the development of hyperglycemia and hypertension in this patient?",
        "options": [
            "(A) Adrenal metastases",
            "(B) Paraneoplastic syndrome",
            "(C) Pituitary adenoma",
            "(D) Pituitary metastases",
            "(E) Thrombosis of the renal artery"
        ],
        "answer": 1,
        "correctAnswer": "Paraneoplastic syndrome",
        "explanation": "Cancers may produce remote effects, collectively termed paraneoplastic syndromes. For example, the secretion of corticotropin (ACTH) by a tumor leads to clinical features of Cushing syndrome, including hyperglycemia and hypertension. Corticotropin production is most commonly seen with cancers of the lung, particularly small cell carcinoma.",
        "whyNotOtherOptions": {
            "a": "Adrenal metastases would lead to loss of adrenal function (Addison disease).",
            "c": "Pituitary adenoma is a possible cause of Cushing syndrome, but unlikely in a patient with lung cancer.",
            "d": "Pituitary metastases would lead to loss of adrenal function (Addison disease).",
            "e": "Thrombosis of the renal artery is unrelated."
        },
        "relatedQuestions": ["19", "22"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 8,
        "question": "A 60-year-old man presents with a 4-month history of increasing weight loss, wheezing, and shortness of breath. He has smoked two packs of cigarettes a day for 40 years. His past medical history is significant for emphysema and chronic bronchitis. A chest X-ray shows a 10-cm mass in the left lung. Bronchoscopy discloses obstruction of the left main stem bronchus. A biopsy is obtained (shown in the image). Immunohistochemical studies of this biopsy specimen would most likely show strong expression of which of the following tumor markers?",
        "options": [
            "(A) Alpha-fetoprotein",
            "(B) Calretinin",
            "(C) Carcinoembryonic antigen",
            "(D) Cytokeratins",
            "(E) Synaptophysin"
        ],
        "answer": 3,
        "correctAnswer": "Cytokeratins",
        "explanation": "Tumor markers are products of malignant neoplasms that can be detected in cells or body fluids. Useful tumor markers include immunoglobulins, fetal proteins, enzymes, hormones, and cytoskeletal proteins. Carcinomas uniformly express cytokeratins, which are intermediate filaments.",
        "whyNotOtherOptions": {
            "a": "Alpha-fetoprotein is a marker for yolk sac carcinoma and hepatocellular carcinoma.",
            "b": "Calretinin provides a marker for mesothelioma.",
            "c": "Carcinoembryonic antigen is a marker for colon carcinoma and many other malignancies.",
            "e": "Synaptophysin is a marker for neuroendocrine tumors, including small cell carcinoma of the lung."
        },
        "relatedQuestions": ["24"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 9,
        "question": "Which of the following potent carcinogens was most likely involved in the pathogenesis of lung cancer in the patient described in Question 8?",
        "options": [
            "(A) Aflatoxin B1",
            "(B) Asbestos",
            "(C) Azo dyes",
            "(D) Polycyclic aromatic hydrocarbons",
            "(E) Vinyl chloride"
        ],
        "answer": 3,
        "correctAnswer": "Polycyclic aromatic hydrocarbons",
        "explanation": "Polycyclic aromatic hydrocarbons, originally derived from coal tar, are among the most extensively studied carcinogens. These compounds produce cancers at the site of application. Since polycyclic hydrocarbons have been identified in cigarette smoke, it has been suggested (but not proved) that they are involved in the pathogenesis of lung cancer.",
        "whyNotOtherOptions": {
            "a": "Aflatoxin B1 is among the most potent liver carcinogens.",
            "b": "Asbestos is associated with mesothelioma and adenocarcinoma of lung.",
            "c": "Azo dyes are associated with bladder cancer.",
            "e": "Industrial workers exposed to high levels of vinyl chloride developed angiosarcomas of the liver."
        },
        "relatedQuestions": ["11", "15"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 10,
        "question": "A 33-year-old woman discovers a lump in her left breast on self-examination. Her mother and sister both had breast cancer. A mammogram demonstrates an ill-defined density in the outer quadrant of the left breast, with microcalcifications. Needle aspiration reveals the presence of malignant, ductal epithelial cells. Genetic screening identifies a mutation in BRCA1. In addition to cell cycle control, BRCA1 protein promotes which of the following cellular functions?",
        "options": [
            "(A) Apoptosis",
            "(B) Cell adhesion",
            "(C) DNA repair",
            "(D) Gene transcription",
            "(E) Transmembrane signaling"
        ],
        "answer": 2,
        "correctAnswer": "DNA repair",
        "explanation": "Breast (BR) cancer (CA) susceptibility genes (BRCA1 and BRCA2) encode tumor suppressor proteins involved in checkpoint functions related to progression of the cell cycle into S phase. BRCA1 and BRCA2 proteins also promote DNA repair by binding to RAD51, a molecule that mediates DNA double-strand repair breaks.",
        "whyNotOtherOptions": {
            "a": "The other choices may be abnormal in neoplasia, but they are not primarily affected by BRCA1.",
            "b": "The other choices may be abnormal in neoplasia, but they are not primarily affected by BRCA1.",
            "d": "The other choices may be abnormal in neoplasia, but they are not primarily affected by BRCA1.",
            "e": "The other choices may be abnormal in neoplasia, but they are not primarily affected by BRCA1."
        },
        "relatedQuestions": ["4"],
        "category": "Neoplasia",
        "difficulty": "Hard"
    },
    {
        "id": 11,
        "question": "A 60-year-old man who worked for 30 years in a chemical factory complains of blood in his urine. Urine cytology discloses dysplastic cells. A bladder biopsy demonstrates transitional cell carcinoma. Which of the following carcinogens was most likely involved in the pathogenesis of bladder cancer in this patient?",
        "options": [
            "(A) Aniline dyes",
            "(B) Arsenic",
            "(C) Benzene",
            "(D) Cisplatinum",
            "(E) Vinyl chloride"
        ],
        "answer": 0,
        "correctAnswer": "Aniline dyes",
        "explanation": "Transitional cell carcinoma is the most common malignant tumor of the urinary bladder, and the incidence of bladder cancer is increased in aniline dye workers. These azo dyes are converted to water-soluble carcinogens in the liver. They are excreted in the urine, where they primarily affect the transitional epithelium of the bladder.",
        "whyNotOtherOptions": {
            "b": "Arsenic exposure is associated with skin and lung cancers.",
            "c": "Benzene exposure is associated with leukemia.",
            "d": "Cisplatinum is a chemotherapeutic agent, not a carcinogen in this context.",
            "e": "Vinyl chloride exposure has been associated with hepatic angiosarcomas."
        },
        "relatedQuestions": ["9", "15"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 12,
        "question": "A 60-year-old man presents with an ulcerated, encrusted, and infiltrating lesion on the sun-exposed dorsal aspect of a finger. A biopsy reveals squamous cell carcinoma. The metastatic potential of this neoplasm would be enhanced by upregulation of the gene for which of the following proteins?",
        "options": [
            "(A) Collagen type IV",
            "(B) Desmin",
            "(C) E-cadherin",
            "(D) Glutathione peroxidase",
            "(E) Plasminogen activator"
        ],
        "answer": 4,
        "correctAnswer": "Plasminogen activator",
        "explanation": "Malignant cells and stromal cells associated with cancers elaborate a variety of proteases that degrade basement membrane components. Such enzymes include the urokinase-type plasminogen activator (u-PA) and matrix metalloproteinases. u-PA converts serum plasminogen to plasmin, a serine protease that degrades laminin and activates type IV procollagenase.",
        "whyNotOtherOptions": {
            "a": "Metastatic cells would be expected to show reduced expression of collagens.",
            "b": "Desmin is found in cells of mesenchymal origin.",
            "c": "Metastatic cells would be expected to show reduced expression of cadherins.",
            "d": "Glutathione peroxidase is an antioxidant enzyme, not involved in enhancing metastasis."
        },
        "relatedQuestions": ["16", "17"],
        "category": "Neoplasia",
        "difficulty": "Hard"
    },
    {
        "id": 13,
        "question": "A 45-year-old man presents with a 9-month history of a reddish nodule on his foot. Biopsy of the nodule discloses a poorly demarcated lesion composed of fibroblasts and endothelial-like cells lining vascular spaces. Further work-up identifies similar lesions in the lymph nodes and liver. The tumor cells contain sequences of human herpesvirus-8 (HHV-8). This patient most likely has which of the following diseases?",
        "options": [
            "(A) Acquired immunodeficiency",
            "(B) Ataxia telangiectasia",
            "(C) Li-Fraumeni syndrome",
            "(D) Neurofibromatosis type I",
            "(E) Xeroderma pigmentosum"
        ],
        "answer": 0,
        "correctAnswer": "Acquired immunodeficiency",
        "explanation": "Kaposi sarcoma is the most common neoplasm associated with acquired immunodeficiency syndrome (AIDS). The neoplastic cells contain sequences of a novel virus, HHV-8, which is also known as Kaposi sarcomaâ€“associated herpesvirus. In addition to infecting the spindle cells of Kaposi sarcoma, HHV-8 is lymphotropic and has been implicated in two uncommon B-cell lymphoid malignancies.",
        "whyNotOtherOptions": {
            "b": "Ataxia telangiectasia features lymphoma/leukemia.",
            "c": "Li-Fraumeni syndrome refers to inherited predisposition due to p53 mutations.",
            "d": "Neurofibromatosis type I develops benign cutaneous neurofibromas.",
            "e": "Xeroderma pigmentosum has defects in DNA repair leading to skin cancers."
        },
        "relatedQuestions": ["2", "31"],
        "category": "Neoplasia",
        "difficulty": "Hard"
    },
    {
        "id": 14,
        "question": "During a routine checkup, a 50-year-old man is found to have blood in his urine. He is otherwise in excellent health. An abdominal CT scan reveals a 2-cm right renal mass. You inform the patient that staging of this tumor is key to selecting treatment and evaluating prognosis. Which of the following is the most important staging factor for this patient?",
        "options": [
            "(A) Histologic grade of the tumor",
            "(B) Metastases to regional lymph nodes",
            "(C) Proliferative capacity of the tumor cells",
            "(D) Somatic mutations in the p53 tumor suppressor gene",
            "(E) Tumor cell karyotype (aneuploidy)"
        ],
        "answer": 1,
        "correctAnswer": "Metastases to regional lymph nodes",
        "explanation": "The choice of surgical approach or treatment modalities is influenced more by the stage of a cancer than by its cytologic grade. Commonly used criteria include tumor size, extent of local growth, presence of lymph node metastases, and presence of distant metastases.",
        "whyNotOtherOptions": {
            "a": "Histologic grade reflects cellular characteristics, not staging.",
            "c": "Proliferative capacity reflects grade.",
            "d": "Somatic mutations reflect molecular changes, not staging.",
            "e": "Tumor cell karyotype reflects grade."
        },
        "relatedQuestions": ["5"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 15,
        "question": "A 68-year-old man who has worked in a shipyard and manufacturing plant all his adult life complains of a 4-month history of chest discomfort, malaise, fever, night sweats, and weight loss. A chest X-ray reveals a large pleural effusion. The patient dies 5 months later of cardiorespiratory failure. The lung at autopsy is shown in the image. This malignant neoplasm is associated with environmental exposure to which of the following carcinogens?",
        "options": [
            "(A) Aflatoxin B1",
            "(B) Asbestos",
            "(C) Beryllium",
            "(D) Ionizing radiation",
            "(E) Silica"
        ],
        "answer": 1,
        "correctAnswer": "Asbestos",
        "explanation": "The characteristic tumor associated with asbestos exposure is mesothelioma of the pleural and peritoneal cavities. This cancer has been reported to occur in 2% to 3% of heavily exposed workers. The pipe fitters in shipyards were the most exposed workers.",
        "whyNotOtherOptions": {
            "a": "Aflatoxin B1 can bind covalently to DNA and is among the most potent liver carcinogens.",
            "c": "Beryllium and silica cause lung disease but are not carcinogenic.",
            "d": "Ionizing radiation is associated with various cancers but not specifically mesothelioma.",
            "e": "Silica causes lung disease but not carcinogenic."
        },
        "relatedQuestions": ["9", "11"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 16,
        "question": "A 58-year-old woman with colon cancer presents with 3 months of increasing shortness of breath. A chest X-ray reveals numerous, bilateral, round masses in both lungs. Histologic examination of an open-lung biopsy discloses malignant gland-like structures, which are nearly identical to the colon primary. Which of the following changes in cell behavior was the first step in the process leading to tumor metastasis from the colon to the lung in this patient?",
        "options": [
            "(A) Arrest within the circulating blood or lymph",
            "(B) Exit from the circulation into a new tissue",
            "(C) Invasion of the underlying basement membrane",
            "(D) Penetration of vascular or lymphatic channels",
            "(E) Stimulation of angiogenesis within the pulmonary metastases"
        ],
        "answer": 2,
        "correctAnswer": "Invasion of the underlying basement membrane",
        "explanation": "The first event in tumor cell invasion is breach of the basement membrane that separates an epithelium from the underlying mesenchyme. After invading the interstitial tissue, malignant cells penetrate lymphatic or vascular channels.",
        "whyNotOtherOptions": {
            "a": "Arrest within circulation occurs later.",
            "b": "Exit from circulation occurs later.",
            "d": "Penetration of channels occurs after basement membrane invasion.",
            "e": "Angiogenesis occurs in the metastasis site."
        },
        "relatedQuestions": ["12", "17", "21"],
        "category": "Neoplasia",
        "difficulty": "Hard"
    },
    {
        "id": 17,
        "question": "A 68-year-old man complains of recent changes in bowel habits and blood-tinged stools. Colonoscopy reveals a 3-cm mass in the sigmoid colon. Biopsy of the mass shows infiltrating malignant glands. These neoplastic cells have most likely acquired a set of mutations that cause which of the following changes in cell behavior?",
        "options": [
            "(A) Decreased cellular motility",
            "(B) Enhanced stem cell differentiation",
            "(C) Increased cell-cell adhesion",
            "(D) Increased susceptibility to apoptosis",
            "(E) Loss of cell cycle restriction point control"
        ],
        "answer": 4,
        "correctAnswer": "Loss of cell cycle restriction point control",
        "explanation": "Cancer cells often display loss of cell cycle restriction point control through mechanisms such as overexpression of cyclin D1, loss of Cdk inhibitors, or inactivation of the pRb or p53 proteins. The p53 gene is deleted or mutated in 75% of cases of colorectal cancer.",
        "whyNotOtherOptions": {
            "a": "Malignant cells have increased cellular motility.",
            "b": "Malignant cells have reduced stem cell differentiation.",
            "c": "Malignant cells have decreased cell adhesion.",
            "d": "Malignant cells have decreased susceptibility to apoptosis."
        },
        "relatedQuestions": ["16", "20"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 18,
        "question": "A 35-year-old woman complains of nipple discharge and irregular menses of 5 months duration. Physical examination reveals a milky discharge from both nipples. MRI shows an enlargement of the anterior pituitary. Which of the following is the most likely histologic diagnosis of this patientâ€™s pituitary tumor?",
        "options": [
            "(A) Adenoma",
            "(B) Choristoma",
            "(C) Hamartoma",
            "(D) Papilloma",
            "(E) Teratoma"
        ],
        "answer": 0,
        "correctAnswer": "Adenoma",
        "explanation": "Benign tumors arising from a glandular epithelium are termed adenomas. Patients with a prolactin-secreting pituitary adenoma present with amenorrhea and galactorrhea.",
        "whyNotOtherOptions": {
            "b": "Ectopic islands of normal tissue are called choristomas.",
            "c": "Localized, disordered differentiation during development results in a hamartoma.",
            "d": "Papillomas do not occur in the pituitary.",
            "e": "Benign tumors that arise from germ cells and contain all three germ layers are termed teratomas."
        },
        "relatedQuestions": ["26", "37"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 19,
        "question": "A 52-year-old woman presents with a 1-year history of upper truncal obesity and moderate depression. Physical examination shows hirsutism and moon facies. A CT scan of the thorax displays a hilar mass. A transbronchial lung biopsy discloses small cell carcinoma. Electron microscopy of this patientâ€™s lung tumor will most likely reveal which of the following cytologic features?",
        "options": [
            "(A) Councilman bodies",
            "(B) Hyperplasia of endoplasmic reticulum",
            "(C) Mitochondrial calcification",
            "(D) Myelin figures in lysosomes",
            "(E) Neuroendocrine granules"
        ],
        "answer": 4,
        "correctAnswer": "Neuroendocrine granules",
        "explanation": "Neuroendocrine tumors may synthesize a number of hormones. The presence of small, membrane-bound granules with a dense core is a feature of these neoplasms. Dense granules are visible by electron microscopy.",
        "whyNotOtherOptions": {
            "a": "Councilman bodies are apoptotic hepatocytes.",
            "b": "Hyperplasia of endoplasmic reticulum is seen in protein-secreting cells.",
            "c": "Mitochondrial calcification is not typical.",
            "d": "Myelin figures are seen in inherited lysosomal storage disease."
        },
        "relatedQuestions": ["7", "32"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 20,
        "question": "Cytogenetic studies in a 40-year-old woman with follicular lymphoma demonstrate a t(14;18) chromosomal translocation involving the bcl-2 gene. Constitutive expression of the protein encoded by the bcl-2 gene inhibits which of the following processes in this patientâ€™s transformed lymphocytes?",
        "options": [
            "(A) Apoptosis",
            "(B) DNA excision repair",
            "(C) G1-to-S cell cycle progression",
            "(D) Oxidative phosphorylation",
            "(E) Protein (N-linked) glycosylation"
        ],
        "answer": 0,
        "correctAnswer": "Apoptosis",
        "explanation": "Many human cancers show abnormalities in the control of apoptosis. For example, follicular B-cell lymphomas display a characteristic chromosomal translocation in which the bcl-2 gene is brought under the transcriptional control of the immunoglobulin light-chain gene promoter, thereby causing overexpression of bcl-2.",
        "whyNotOtherOptions": {
            "b": "DNA excision repair is unrelated to bcl-2.",
            "c": "G1-to-S progression is regulated by cyclins and Rb.",
            "d": "Oxidative phosphorylation is mitochondrial.",
            "e": "Protein glycosylation is post-translational."
        },
        "relatedQuestions": ["17", "35"],
        "category": "Neoplasia",
        "difficulty": "Hard"
    },
    {
        "id": 21,
        "question": "A 60-year-old man presents with a 6-month history of increasing weight loss and fatigue. Physical examination reveals conspicuous hepatomegaly. An abdominal CT scan reveals multiple â€œcanon ballâ€ nodules in the liver. A CT-guided biopsy reveals a mucous-secreting adenocarcinoma. This patientâ€™s metastatic liver cancer most likely originated in which of the following anatomic locations?",
        "options": [
            "(A) Adrenal medulla",
            "(B) Bone marrow",
            "(C) Brain",
            "(D) Pancreas",
            "(E) Urinary bladder"
        ],
        "answer": 3,
        "correctAnswer": "Pancreas",
        "explanation": "Radiologic evidence of â€œcanon ballâ€ lesions in the liver or lung suggests metastatic cancer. The liver is involved in a third of all metastatic cancers, including half of those of the gastrointestinal tract, breast, and lung. Other tumors that characteristically metastasize to the liver are pancreatic carcinoma and malignant melanoma. Mucin-secreting glandular epithelium is expected in the pancreas.",
        "whyNotOtherOptions": {
            "a": "Adrenal medulla produces pheochromocytoma, not mucin-secreting.",
            "b": "Bone marrow cancers are hematologic.",
            "c": "Brain tumors rarely metastasize outside CNS.",
            "e": "Urinary bladder is transitional cell, not mucin-secreting adenocarcinoma."
        },
        "relatedQuestions": ["16", "23"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 22,
        "question": "A 59-year-old woman presents with increasing pigmentation of the skin. Physical examination shows hyperkeratosis and hyperpigmentation of the axilla, neck, flexures, and anogenital region. Endocrinologic studies reveal normal serum levels of adrenal corticosteroids and glucocorticoids. If this patientâ€™s skin pigmentation represents a paraneoplastic syndrome, the primary tumor would most likely be found in which of the following anatomic locations?",
        "options": [
            "(A) Bladder",
            "(B) Cervix",
            "(C) Esophagus",
            "(D) Pleura",
            "(E) Stomach"
        ],
        "answer": 4,
        "correctAnswer": "Stomach",
        "explanation": "Acanthosis nigricans is a cutaneous disorder marked by hyperkeratosis and pigmentation of the axilla, neck, flexures, and anogenital region. Over 90% of cases occur in association with gastrointestinal carcinomas (primarily stomach cancer).",
        "whyNotOtherOptions": {
            "a": "Bladder cancer is not typically associated.",
            "b": "Cervix is squamous.",
            "c": "Esophagus is uncommon.",
            "d": "Pleura is mesothelioma."
        },
        "relatedQuestions": ["7", "32"],
        "category": "Neoplasia",
        "difficulty": "Hard"
    },
    {
        "id": 23,
        "question": "A 65-year-old man dies after a protracted battle with metastatic colon carcinoma. At autopsy, the liver is filled with multiple nodules of cancer, many of which display central necrosis (umbilication). Which of the following best explains the pathogenesis of tumor umbilication in this patient?",
        "options": [
            "(A) Biphasic tumor",
            "(B) Chronic inflammation",
            "(C) Granulomatous inflammation",
            "(D) Ischemia and infarction",
            "(E) Stimulation of angiogenesis"
        ],
        "answer": 3,
        "correctAnswer": "Ischemia and infarction",
        "explanation": "Angiogenesis is a requirement for the continued growth of cancers. In the absence of new vessels, malignant tumors do not grow larger than 1 to 2 mm in diameter. Causes of tumor cell death in situ include inadequate blood supply, with consequent ischemia.",
        "whyNotOtherOptions": {
            "a": "Biphasic tumor refers to morphology like mesothelioma.",
            "b": "Chronic inflammation is not the cause of central necrosis.",
            "c": "Granulomatous inflammation is immune response.",
            "e": "Stimulation of angiogenesis prevents necrosis."
        },
        "relatedQuestions": ["21"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 24,
        "question": "A 59-year-old man complains of progressive weakness. He reports that his stools are very dark. Physical examination demonstrates fullness in the right lower quadrant. Laboratory studies show iron deficiency anemia, with a serum hemoglobin level of 7.4 g/dL. Stool specimens are positive for occult blood. Colonoscopy discloses an ulcerating lesion of the cecum. Which of the following serum tumor markers is most likely to be useful for following this patient after surgery?",
        "options": [
            "(A) Alpha-fetoprotein",
            "(B) Carcinoembryonic antigen",
            "(C) Chorionic gonadotropin",
            "(D) Chromogranin",
            "(E) Coagulation factor VIII"
        ],
        "answer": 1,
        "correctAnswer": "Carcinoembryonic antigen",
        "explanation": "Adenocarcinomas of the colon usually express CEA, a glycoprotein that is released into the circulation and serves as a serologic marker for these tumors. CEA is also found in association with malignant tumors of the pancreas, lung, and ovary.",
        "whyNotOtherOptions": {
            "a": "AFP is expressed by hepatocellular carcinoma and yolk sac tumors.",
            "c": "Chorionic gonadotropin is secreted by choriocarcinoma.",
            "d": "Chromogranin is expressed by neuroendocrine tumors.",
            "e": "Coagulation factor VIII is unrelated."
        },
        "relatedQuestions": ["8", "25"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 25,
        "question": "Laboratory studies of the surgical specimen obtained from the patient described in Question 24 demonstrate hypermethylation of the p53 gene. Which of the following best characterizes this biochemical change in the neoplastic cells?",
        "options": [
            "(A) Epigenetic modification",
            "(B) Gene amplification",
            "(C) Insertional mutagenesis",
            "(D) Nonreciprocal translocation",
            "(E) Protooncogene mutation"
        ],
        "answer": 0,
        "correctAnswer": "Epigenetic modification",
        "explanation": "Hypermethylation of many tumor suppressor and DNA repair genes has been demonstrated in human tumors. The pathways controlled by these genes are suppressed. Aberrant methylation of tumor suppressor genes may be an epigenetic mechanism for a â€œsecond hit,â€ leading to loss of heterozygosity.",
        "whyNotOtherOptions": {
            "b": "Gene amplification involves increased copies.",
            "c": "Insertional mutagenesis is viral.",
            "d": "Nonreciprocal translocation is chromosomal.",
            "e": "Protooncogene mutation activates oncogenes."
        },
        "relatedQuestions": ["24", "30"],
        "category": "Neoplasia",
        "difficulty": "Hard"
    },
    {
        "id": 26,
        "question": "A 20-year-old woman has an ovarian tumor removed. The surgical specimen is 10 cm in diameter and cystic. The cystic cavity is found to contain black hair and sebaceous material. Histologic examination of the cyst wall reveals a variety of benign differentiated tissues, including skin, cartilage, brain, and mucinous glandular epithelium. What is the diagnosis?",
        "options": [
            "(A) Adenoma",
            "(B) Chondroma",
            "(C) Hamartoma",
            "(D) Teratocarcinoma",
            "(E) Teratoma"
        ],
        "answer": 4,
        "correctAnswer": "Teratoma",
        "explanation": "Teratomas are benign tumors composed of tissues derived from all three primary germ layers: ectoderm, mesoderm, and endoderm. They are most common in the ovary but also occur in the testis and extragonadal sites.",
        "whyNotOtherOptions": {
            "a": "Adenoma is a benign tumor of epithelial origin.",
            "b": "Chondroma is a benign cartilaginous tumor.",
            "c": "Hamartoma is disorganized normal tissue.",
            "d": "Teratocarcinomas are malignant tumors that harbor embryonal carcinoma stem cells."
        },
        "relatedQuestions": ["1", "18"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 27,
        "question": "A 42-year-old man presents with upper gastrointestinal bleeding. Upper endoscopy and biopsy reveal gastric adenocarcinoma. Which country of the world has the highest incidence of this malignant neoplasm?",
        "options": [
            "(A) Argentina",
            "(B) Canada",
            "(C) Japan",
            "(D) Mexico",
            "(E) United States"
        ],
        "answer": 2,
        "correctAnswer": "Japan",
        "explanation": "The highest incidence of stomach cancer occurs in Japan, where the disease is almost ten times as frequent as it is among American whites. The highest incidence of colorectal cancer is found in the United States.",
        "whyNotOtherOptions": {
            "a": "Argentina has lower incidence.",
            "b": "Canada has lower incidence.",
            "d": "Mexico has lower incidence.",
            "e": "United States has high colorectal but low gastric."
        },
        "relatedQuestions": ["22"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 28,
        "question": "An 8-year-old girl with numerous hypopigmented, ulcerated, and crusted patches on her face and forearms develops an indurated, crater-like, skin nodule on the back of her left hand. Biopsy of this skin nodule discloses a squamous cell carcinoma. Molecular biology studies reveal that this patient has germline mutations in the gene encoding a nucleotide excision repair enzyme. What is the appropriate diagnosis?",
        "options": [
            "(A) Ataxia telangiectasia",
            "(B) Hereditary albinism",
            "(C) Li-Fraumeni syndrome",
            "(D) Neurofibromatosis, type I",
            "(E) Xeroderma pigmentosum"
        ],
        "answer": 4,
        "correctAnswer": "Xeroderma pigmentosum",
        "explanation": "Xeroderma pigmentosum is an autosomal recessive disease in which increased sensitivity to sunlight is accompanied by a high incidence of skin cancers, including basal cell carcinoma, squamous cell carcinoma, and malignant melanoma. Several xeroderma pigmentosum genes are involved in nucleotide excision of ultraviolet-damaged DNA.",
        "whyNotOtherOptions": {
            "a": "Ataxia telangiectasia features cerebellar degeneration and lymphoma.",
            "b": "Hereditary albinism lacks DNA repair defect.",
            "c": "Li-Fraumeni syndrome due to p53 mutations.",
            "d": "Neurofibromatosis develops neurofibromas."
        },
        "relatedQuestions": ["13", "43"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 29,
        "question": "A 59-year-old woman complains of â€œfeeling light-headedâ€ and losing 5 kg (11 lb) in the last month. A CBC reveals a normocytic, normochromic anemia. The patient subsequently dies of metastatic cancer. Based on current epidemiologic data for cancer-associated mortality in women, which of the following is the most likely primary site for this patientâ€™s malignant neoplasm?",
        "options": [
            "(A) Brain",
            "(B) Breast",
            "(C) Colon",
            "(D) Lung",
            "(E) Urinary bladder"
        ],
        "answer": 3,
        "correctAnswer": "Lung",
        "explanation": "Lung carcinoma is the cause of most cancer-related deaths in the United States and Western Europe in men and women. The second most common cause of death from cancer in women is breast cancer.",
        "whyNotOtherOptions": {
            "a": "Brain cancer is rare.",
            "b": "Breast is second.",
            "c": "Colon is common but not leading.",
            "e": "Urinary bladder is uncommon."
        },
        "relatedQuestions": ["8", "9"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 30,
        "question": "The parents of a 6-month-old girl palpate a mass on the left side of the childâ€™s abdomen. Urinalysis shows high levels of vanillylmandelic acid. A CT scan reveals an abdominal tumor and bony metastases. The primary tumor is surgically resected. Histologic examination of the surgical specimen discloses neuroblastoma. Evaluation of the N-myc protooncogene in this childâ€™s tumor will most likely demonstrate which of the following genetic changes?",
        "options": [
            "(A) Chromosomal translocation",
            "(B) Exon deletion",
            "(C) Expansion of a trinucleotide repeat",
            "(D) Frameshift mutation",
            "(E) Gene amplification"
        ],
        "answer": 4,
        "correctAnswer": "Gene amplification",
        "explanation": "Chromosomal alterations that result in an increased number of copies of a gene have been found primarily in solid tumors. In some cases, gene amplification has been shown to involve protooncogenes. For example, HSRs may be seen in neuroblastomas and are all derived from the N-myc protooncogene.",
        "whyNotOtherOptions": {
            "a": "Translocation is in lymphomas/leukemias.",
            "b": "Exon deletion not typical.",
            "c": "Trinucleotide repeat in neurodegenerative.",
            "d": "Frameshift in colon cancer."
        },
        "relatedQuestions": ["25", "35"],
        "category": "Neoplasia",
        "difficulty": "Hard"
    },
    {
        "id": 31,
        "question": "An 8-year-old African boy presents with swelling in his jaw and massive facial disfiguration. Biopsy reveals a tumor invading the bone marrow of the jaw. The pathogenesis of this malignant neoplasm is associated with a virus that exhibits a tropism for which of the following cells?",
        "options": [
            "(A) Chondrocytes",
            "(B) Fibroblasts",
            "(C) Lymphocytes",
            "(D) Macrophages",
            "(E) Osteocytes"
        ],
        "answer": 2,
        "correctAnswer": "Lymphocytes",
        "explanation": "Four DNA viruses are incriminated in human cancers. EBV was the first virus linked to a human tumor. African Burkitt lymphoma is a B-cell tumor, in which the neoplastic lymphocytes invariably contain EBV in their DNA.",
        "whyNotOtherOptions": {
            "a": "Chondrocytes not targeted.",
            "b": "Fibroblasts not.",
            "c": "Correct.",
            "d": "Macrophages not.",
            "e": "Osteocytes not."
        },
        "relatedQuestions": ["13", "20"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 32,
        "question": "A 58-year-old woman undergoes routine colonoscopy. A 2-cm submucosal nodule is identified in the appendix. Biopsy of the nodule shows nests of cells with round, uniform nuclei. Electron microscopy reveals numerous neuroendocrine granules in the cytoplasm. This patientâ€™s neoplastic disease is associated with which of the following clinical features?",
        "options": [
            "(A) Congestive heart failure",
            "(B) Flushing and wheezing",
            "(C) Muscular dystrophy",
            "(D) Progressive systemic sclerosis",
            "(E) Pulmonary embolism"
        ],
        "answer": 1,
        "correctAnswer": "Flushing and wheezing",
        "explanation": "Carcinoid syndrome is a systemic paraneoplastic disease caused by the release of hormones from carcinoid tumors into venous blood. Symptoms of flushing, bronchial wheezing, watery diarrhea, and abdominal colic are caused by the release of serotonin, bradykinin, and histamine.",
        "whyNotOtherOptions": {
            "a": "CHF not associated.",
            "c": "Muscular dystrophy unrelated.",
            "d": "Progressive systemic sclerosis unrelated.",
            "e": "Pulmonary embolism unrelated."
        },
        "relatedQuestions": ["7", "19"],
        "category": "Ne",
        "difficulty": "Medium"
    },
    {
        "id": 33,
        "question": "A 55-year-old woman presents with increasing weight loss and fatigue and subsequently dies of metastatic cancer. The vertebral column at autopsy is shown in the image. What is the diagnosis?",
        "options": [
            "(A) Chondrosarcoma",
            "(B) Melanoma",
            "(C) Multiple myeloma",
            "(D) Osteosarcoma",
            "(E) Rhabdomyosarcoma"
        ],
        "answer": 1,
        "correctAnswer": "Melanoma",
        "explanation": "The photograph shows pigmented cells in the vertebral bodies of a person who died of malignant melanoma. Tumor emboli in this case probably reached bone after surviving passage through the pulmonary microcirculation.",
        "whyNotOtherOptions": {
            "a": "Chondrosarcoma not pigmented.",
            "c": "Multiple myeloma lytic, not pigmented.",
            "d": "Osteosarcoma bone-forming.",
            "e": "Rhabdomyosarcoma muscle."
        },
        "relatedQuestions": ["21"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 34,
        "question": "A 45-year-old woman presents with abdominal pain and vaginal bleeding. A hysterectomy is performed and shows a benign tumor of the uterus derived from a smooth muscle cell. What is the appropriate diagnosis?",
        "options": [
            "(A) Angiomyolipoma",
            "(B) Leiomyoma",
            "(C) Leiomyosarcoma",
            "(D) Myxoma",
            "(E) Rhabdomyoma"
        ],
        "answer": 1,
        "correctAnswer": "Leiomyoma",
        "explanation": "Leiomyoma is the most common benign tumor of the uterus, usually arising in women of reproductive age. It originates from smooth muscle cells of the myometrium.",
        "whyNotOtherOptions": {
            "a": "Angiomyolipoma kidney.",
            "c": "Leiomyosarcoma malignant.",
            "d": "Myxoma heart.",
            "e": "Rhabdomyoma heart or skeletal."
        },
        "relatedQuestions": ["18"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 35,
        "question": "Cytogenetic studies in a 70-year-old woman with chronic myelogenous leukemia (CML) demonstrate a t(9;22) chromosomal translocation. Which of the following best explains the role of this translocation in the pathogenesis of leukemia in this patient?",
        "options": [
            "(A) Altered DNA methylation status",
            "(B) Enhanced expression of telomerase gene",
            "(C) Expansion of a trinucleotide repeat",
            "(D) Inactivation of tumor suppressor protein",
            "(E) Protooncogene activation"
        ],
        "answer": 4,
        "correctAnswer": "Protooncogene activation",
        "explanation": "The Philadelphia chromosome is found in 95% of patients with CML. The c-abl protooncogene on chromosome 9 is translocated to chromosome 22, placed in juxtaposition to the breakpoint cluster region (bcr). The hybrid oncogene codes for an aberrant protein with high tyrosine kinase activity.",
        "whyNotOtherOptions": {
            "a": "Methylation is epigenetic.",
            "b": "Telomerase for immortality.",
            "c": "Trinucleotide in other diseases.",
            "d": "Inactivation for suppressors."
        },
        "relatedQuestions": ["20", "30"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 36,
        "question": "A 33-year-old woman presents with a diffuse scaly skin rash of 4 weeks duration. Biopsy of lesional skin reveals a cutaneous T-cell lymphoma (mycosis fungoides). Which of the following immunohistochemical markers would be most useful for identifying malignant cells in the skin of this patient?",
        "options": [
            "(A) Calcitonin",
            "(B) CD4",
            "(C) Desmin",
            "(D) HMB-45",
            "(E) S-100"
        ],
        "answer": 1,
        "correctAnswer": "CD4",
        "explanation": "CD4 is a cluster-differentiation antigen of helper T lymphocytes.",
        "whyNotOtherOptions": {
            "a": "Calcitonin peptide hormone.",
            "c": "Desmin mesenchymal.",
            "d": "HMB-45 melanoma.",
            "e": "S-100 melanoma/neural."
        },
        "relatedQuestions": ["8"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 37,
        "question": "A 63-year-old woman with chronic bronchitis presents with shortness of breath. A chest X-ray reveals a 2-cm â€œcoin lesionâ€ in the upper lobe of the left lung. A CT-guided lung biopsy is obtained. Which of the following describes the histologic features of this lesion if the diagnosis is hamartoma?",
        "options": [
            "(A) Benign neoplasm of epithelial origin",
            "(B) Disorganized normal tissue",
            "(C) Ectopic islands of normal tissue",
            "(D) Granulation tissue",
            "(E) Granulomatous inflammation"
        ],
        "answer": 1,
        "correctAnswer": "Disorganized normal tissue",
        "explanation": "Localized, disordered differentiation during embryonic development results in a hamartoma, a disorganized caricature of normal tissue components. Such tumors contain varying combinations of cartilage, ducts or bronchi, connective tissue, blood vessels, and lymphoid tissue.",
        "whyNotOtherOptions": {
            "a": "Epithelial is adenoma.",
            "c": "Ectopic is choristoma.",
            "d": "Granulation healing.",
            "e": "Granulomatous immune."
        },
        "relatedQuestions": ["18", "26"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 38,
        "question": "A 67-year-old woman presents with a massively swollen abdomen. The patient was diagnosed with papillary, serous cystadenocarcinoma of the ovary 3 years ago. She dies in a hospice 1 month later. At autopsy, the peritoneum is studded with small tumors, and there are 4 L of ascites. Which of the following routes of tumor metastasis accounts for these autopsy findings?",
        "options": [
            "(A) Direct tumor extension",
            "(B) Hematogenous spread",
            "(C) Lymphatic spread",
            "(D) Seeding of body cavity",
            "(E) Venous spread"
        ],
        "answer": 3,
        "correctAnswer": "Seeding of body cavity",
        "explanation": "Malignant tumors that arise in organs adjacent to body cavities may shed malignant cells into these spaces. Such body cavities include principally the peritoneal and pleural cavities. Tumor cells in these sites grow in masses and often produce fluid (e.g., ascites or pleural fluid).",
        "whyNotOtherOptions": {
            "a": "Direct extension local.",
            "b": "Hematogenous to distant.",
            "c": "Lymphatic to nodes.",
            "e": "Venous to liver/lung."
        },
        "relatedQuestions": ["16", "21"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 39,
        "question": "A 2-year-old boy is found to have bilateral retinal tumors. Molecular studies demonstrate a germline mutation in one allele of the Rb gene. Which of the following genetic events best explains the mechanism of carcinogenesis in this patient?",
        "options": [
            "(A) Balanced translocation",
            "(B) Expansion of trinucleotide repeat",
            "(C) Gene amplification",
            "(D) Loss of heterozygosity",
            "(E) Maternal nondisjunction"
        ],
        "answer": 3,
        "correctAnswer": "Loss of heterozygosity",
        "explanation": "In cases of hereditary retinoblastoma, an affected child inherits one defective Rb allele. If the remaining normal Rb allele is inactivated by deletion or mutation, the loss of its suppressor function leads to the appearance of a neoplasm. This genetic process is referred to as loss of heterozygosity.",
        "whyNotOtherOptions": {
            "a": "Balanced translocation in lymphomas.",
            "b": "Trinucleotide in fragile X.",
            "c": "Amplification in neuroblastoma.",
            "e": "Nondisjunction aneuploidy."
        },
        "relatedQuestions": ["25", "30"],
        "category": "Neoplasia",
        "difficulty": "Hard"
    },
    {
        "id": 40,
        "question": "A 48-year-old nulliparous woman complains that her menstrual blood flow is more abundant than usual. An ultrasound examination reveals a polypoid mass in the uterine fundus. The patient subsequently undergoes a hysterectomy, which reveals a poorly differentiated endometrial adenocarcinoma. The development of this neoplasm was preceded by which of the following histopathologic changes in the glandular epithelium?",
        "options": [
            "(A) Atrophy",
            "(B) Hydropic swelling",
            "(C) Hyperplasia",
            "(D) Hypertrophy",
            "(E) Metaplasia"
        ],
        "answer": 2,
        "correctAnswer": "Hyperplasia",
        "explanation": "Endometrial hyperplasia refers to a spectrum that ranges from simple glandular crowding to conspicuous proliferation of atypical glands. The risk of developing endometrial cancer increases with higher degrees of endometrial hyperplasia. Estrogen exposure is thought to be a risk factor.",
        "whyNotOtherOptions": {
            "a": "Atrophy opposite.",
            "b": "Hydropic swelling injury.",
            "d": "Hypertrophy cell size.",
            "e": "Metaplasia change type, precedes some but not uterine."
        },
        "relatedQuestions": ["3", "40"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 41,
        "question": "A 53-year-old woman with a longstanding history of ulcerative colitis presents with increasing chest pain and shortness of breath of 2 months duration. She reports four recent episodes of hemoptysis. The patient subsequently develops overwhelming sepsis and expires. A section through the right lung is examined at autopsy. What is the appropriate diagnosis?",
        "options": [
            "(A) Carcinoid tumor of the lung",
            "(B) Primary adenocarcinoma of the lung",
            "(C) Metastatic carcinoma of the lung",
            "(D) Miliary tuberculosis",
            "(E) Sarcoidosis"
        ],
        "answer": 2,
        "correctAnswer": "Metastatic carcinoma of the lung",
        "explanation": "Pulmonary metastases are more common than primary lung tumors, and the histologic appearance of most metastases resembles that of the primary tumor. Persons with ulcerative colitis have a higher risk of colorectal cancer. The risk is related to the extent of colorectal involvement and the duration of the inflammatory disease.",
        "whyNotOtherOptions": {
            "a": "Carcinoid not multiple nodules.",
            "b": "Primary not multiple.",
            "d": "Miliary TB minute granulomas.",
            "e": "Sarcoidosis granulomas."
        },
        "relatedQuestions": ["16", "21"],
        "category": "Neoplasia",
        "difficulty": "Medium"
    },
    {
        "id": 42,
        "question": "A 50-year-old woman presents with a 2-year history of upper truncal obesity and depression. Serum levels of glucose and cortisol are elevated. A CT scan of the abdomen reveals a 2-cm suprarenal mass. The surgical specimen is shown in the image. If this neoplasm is benign, which of the following is the most appropriate diagnosis?",
        "options": [
            "(A) Adenoma",
            "(B) Chondroma",
            "(C) Lipoma",
            "(D) Papilloma",
            "(E) Teratoma"
        ],
        "answer": 0,
        "correctAnswer": "Adenoma",
        "explanation": "The patient shows signs and symptoms of Cushing syndrome. The surgical specimen reveals a circumscribed tumor of the adrenal cortex that produces cortisol. Histologic examination reveals nests of clear, lipid-laden epithelial cells.",
        "whyNotOtherOptions": {
            "b": "Chondroma cartilage.",
            "c": "Lipoma fat.",
            "d": "Papilloma surface.",
            "e": "Teratoma multiple layers."
        },
        "relatedQuestions": ["18", "26"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 43,
        "question": "A 65-year-old man presents with a pearly papule on his upper lip. A biopsy reveals buds of atypical, deeply basophilic keratinocytes extending from the overlying epidermis into the papillary dermis. Which of the following carcinogenic stimuli was the most important risk factor for development of this patientâ€™s skin cancer?",
        "options": [
            "(A) Aflatoxin B1",
            "(B) Divalent metal cations",
            "(C) Aromatic amines and azo dyes",
            "(D) Vinyl chloride",
            "(E) Sunlight"
        ],
        "answer": 4,
        "correctAnswer": "Sunlight",
        "explanation": "Basal cell carcinoma usually develops on the sun-damaged skin of people with fair skin and freckles. There is a direct correlation between total exposure to sunlight and the incidence of BCC, as well as squamous cell carcinoma and melanoma.",
        "whyNotOtherOptions": {
            "a": "Aflatoxin liver.",
            "b": "Metals occupational.",
            "c": "Amines bladder.",
            "d": "Vinyl liver."
        },
        "relatedQuestions": ["9", "28"],
        "category": "Neoplasia",
        "difficulty": "Easy"
    },
    {
        "id": 44,
        "question": "A 28-year-old man with a familial disease affecting the gastrointestinal tract undergoes a colectomy. The surgical specimen is shown in the image. Molecular studies demonstrate a germline mutation in the APC gene. The normal product of this gene (protooncogene) primarily regulates which of the following cell behaviors?",
        "options": [
            "(A) Apoptosis",
            "(B) Autophagy",
            "(C) Cell cycle",
            "(D) Differentiation",
            "(E) Motility"
        ],
        "answer": 2,
        "correctAnswer": "Cell cycle",
        "explanation": "Patients with adenomatous polyposis coli have mutations in the APC tumor suppressor gene. Without the APC protooncogene, cells are unable to downregulate signals from E-cadherin to b-catenin to nuclear transcription factors (myc and cyclin D) that regulate cell cycle progression.",
        "whyNotOtherOptions": {
            "a": "Apoptosis bcl-2.",
            "b": "Autophagy catabolic.",
            "d": "Differentiation other pathways.",
            "e": "Motility proteases."
        },
        "relatedQuestions": ["17", "24"],
        "category": "Neoplasia",
        "difficulty": "Hard"
    }
];

// Core application variables
const overlay = document.getElementById('overlay');
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const categoriesGrid = document.getElementById('categoriesGrid');
const themeToggle = document.getElementById('themeToggle');
const quizContainer = document.getElementById('quizContainer');
const resultsScreen = document.getElementById('resultsScreen');
const pageTitle = document.getElementById('pageTitle');
const modeButtons = document.querySelectorAll('.mode-btn');
const correctAnswersEl = document.getElementById('correctAnswers');
const timeSpentEl = document.getElementById('timeSpent');
const masteryLevelEl = document.getElementById('masteryLevel');
const streakCountEl = document.getElementById('streakCount');
const searchInput = document.getElementById('searchInput');
const exportProgressBtn = document.getElementById('exportProgress');
const createCustomQuizBtn = document.getElementById('createCustomQuizBtn');
const customQuizModal = document.getElementById('customQuizModal');
const cancelCustomQuizBtn = document.getElementById('cancelCustomQuiz');
const createCustomQuizBtnModal = document.getElementById('createCustomQuiz');
const weakAreasCountEl = document.getElementById('weakAreasCount');
const avgTimePerQuestionEl = document.getElementById('avgTimePerQuestion');
const improvementRateEl = document.getElementById('improvementRate');

// Navigation elements
const navItems = document.querySelectorAll('.nav-item');

// Application state
let currentMode = 'exam';
let selectedCategories = [];
let currentQuestionIndex = 0;
let score = 0;
let userAnswers = [];
let questions = [];
let incorrectQuestions = [];
let isAnswerChecked = false;
let bookmarkedQuestions = new Set();
let userProgress = {};
let userStats = {
    totalQuestions: 0,
    correctAnswers: 0,
    timeSpent: 0,
    masteryLevel: 0,
    streak: 0,
    lastActive: null,
    weeklyProgress: []
};
let timerInterval = null;
let startTime = null;
let remainingTime = 0;
let isCountdown = false;
let examCheckMode = 'immediate';
let examSubmitted = false;
let questionTimers = [];
let searchResults = [];
let isSearchActive = false;
let currentPage = 'Dashboard';
let customQuestions = [];

// Core application functions
function init() {
    initializeCategories();
    initializeEventListeners();
    initializeNavigation();
    loadUserData();
    updateDashboardStats();
    updateAnalytics();
    showDashboard();
    createFAB();
    updateCustomQuizModalHTML();
}

function createFAB() {
    const fab = document.createElement('button');
    fab.className = 'fab';
    fab.innerHTML = '<i class="fas fa-plus"></i>';
    fab.title = 'Create Custom Question';
    fab.addEventListener('click', showCustomQuestionCreator);
    document.body.appendChild(fab);
}

function initializeNavigation() {
    navItems.forEach((item, index) => {
        item.addEventListener('click', () => {
            navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
            
            switch(index) {
                case 0: // Dashboard
                    currentPage = 'Dashboard';
                    showDashboard();
                    break;
                case 1: // My Courses
                    currentPage = 'courses';
                    showCourses();
                    break;
                case 2: // Progress Analytics
                    currentPage = 'analytics';
                    showAnalytics();
                    break;
                case 3: // Bookmarked Questions
                    currentPage = 'bookmarks';
                    showBookmarks();
                    break;
                case 4: // Settings
                    currentPage = 'settings';
                    showSettings();
                    break;
            }
            
            closeSidebar();
        });
    });
}

function showDashboard() {
    console.log('showDashboard called'); // Debug
    
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.search-container').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    
    // Reset page title
    pageTitle.textContent = 'Dashboard';
    updateDashboardStats();
    
    // ALWAYS load questions and show quiz layout
    questions = [...quizData, ...customQuestions];
    selectedCategories = [...new Set(questions.map(q => q.category))];
    
    // Reset quiz state
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    examSubmitted = false;
    
    console.log('Questions loaded:', questions.length);
    console.log('Current mode:', currentMode);
    
    // Force show quiz container
    quizContainer.classList.remove('hidden');
    resultsScreen.classList.add('hidden');
    
    if (questions.length > 0) {
        console.log('Calling renderQuizLayout...');
        renderQuizLayout();
    } else {
        console.log('No questions, showing message');
        showNoQuestionsMessage();
    }
}

function showCourses() {
    hideAllSections();
    pageTitle.textContent = 'My Courses';
    
    quizContainer.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 80px; color: var(--primary); margin-bottom: 20px; opacity: 0.8;">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary); background: linear-gradient(135deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">Learning Pathways</h2>
            <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                Structured learning paths designed to build your medical knowledge systematically.
            </p>
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; margin-top: 40px;">
                    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Anatomy Mastery', 'fas fa-brain', '#6366f1', 75, 'Build foundational anatomy knowledge')}
                    </div>
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Physiology Deep Dive', 'fas fa-heartbeat', '#06b6d4', 45, 'Understand body systems and functions')}
                   </div>
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Clinical Pathology', 'fas fa-virus', '#10b981', 30, 'Study diseases and diagnostics')}
                    </div> 
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Pharmacology', 'fas fa-pills', '#f59e0b', 20, 'Master drug mechanisms and effects')}
                    </div>
    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Medical Imaging', 'fas fa-x-ray', '#8b5cf6', 15, 'Learn radiology and imaging techniques')}
                    </div>
    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Emergency Medicine', 'fas fa-ambulance', '#ef4444', 10, 'Critical care and emergency procedures')}
                    </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createCourseCard(title, icon, color, progress, description) {
    return `
        <div class="category-card" style="text-align: left; cursor: pointer; border-left: 4px solid ${color};" onclick="startCourse('${title.toLowerCase()}')">
            <div class="category-header">
                <div class="category-icon" style="background: ${color}20; color: ${color};">
                    <i class="${icon}"></i>
                </div>
                <div>
                    <div class="category-name" style="font-size: 16px; font-weight: 600;">${title}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${description}</div>
                </div>
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${color}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 12px;">
                <span style="font-size: 11px; color: var(--text-tertiary);">${Math.floor(progress/10)}/10 Modules</span>
                <span style="font-size: 11px; color: ${color}; font-weight: 600;">Continue â†’</span>
            </div>
        </div>
    `;
}

function showAnalytics() {
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    pageTitle.textContent = 'Progress Analytics';
    updateAnalytics();
    
    quizContainer.innerHTML = `
        <div style="padding: 24px;">
            <div class="analytics-section glass-effect" style="border-radius: 24px; padding: 32px;">
                <h3 class="analytics-title" style="font-size: 24px; margin-bottom: 8px;">Performance Insights</h3>
                <p style="color: var(--text-secondary); margin-bottom: 32px;">Detailed analytics to optimize your learning journey</p>
                <div class="analytics-grid">
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: var(--primary);">${weakAreasCountEl.textContent}</div>
                        <div class="analytics-label">Areas Needing Focus</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #06b6d4;">${avgTimePerQuestionEl.textContent}</div>
                        <div class="analytics-label">Average Response Time</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #10b981;">${improvementRateEl.textContent}</div>
                        <div class="analytics-label">Weekly Progress Rate</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">ðŸ“Š Learning Recommendations</h3>
                <div style="display: grid; gap: 16px;">
                    ${createRecommendation('Focus on Weak Areas', 'fas fa-bullseye', 'var(--primary)', 'Spend 60% of study time on topics below 70% mastery')}
                    ${createRecommendation('Consistent Practice', 'fas fa-chart-line', '#10b981', `Maintain your ${userStats.streak}-day streak for optimal retention`)}
                    ${createRecommendation('Active Recall', 'fas fa-brain', '#8b5cf6', 'Use spaced repetition for better long-term memory')}
                    ${createRecommendation('Mixed Practice', 'fas fa-random', '#f59e0b', 'Combine different topics in single study sessions')}
                </div>
            </div>

            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">ðŸŽ¯ Study Plan</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    ${createStudyPlanItem('Daily Goal', '50 questions', 'fas fa-calendar-day', '#6366f1')}
                    ${createStudyPlanItem('Weekly Target', '5 hours', 'fas fa-chart-bar', '#06b6d4')}
                    ${createStudyPlanItem('Mastery Goal', '85% overall', 'fas fa-trophy', '#f59e0b')}
                    ${createStudyPlanItem('Weak Topics', '2 sessions/week', 'fas fa-exclamation-triangle', '#ef4444')}
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createRecommendation(title, icon, color, description) {
    return `
        <div style="display: flex; align-items: center; gap: 16px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px; border-left: 4px solid ${color};">
            <i class="${icon}" style="color: ${color}; font-size: 24px;"></i>
            <div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${title}</div>
                <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.5;">${description}</div>
            </div>
        </div>
    `;
}

function createStudyPlanItem(title, value, icon, color) {
    return `
        <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px;">
            <i class="${icon}" style="color: ${color}; font-size: 32px; margin-bottom: 12px;"></i>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${title}</div>
            <div style="font-size: 18px; color: ${color}; font-weight: 700;">${value}</div>
        </div>
    `;
}

function showBookmarks() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    hideAllSections();
    pageTitle.textContent = 'Bookmarked Questions';
    
    if (bookmarkedQuestionsList.length === 0) {
        quizContainer.innerHTML = `
            <div style="text-align: center; padding: 80px 20px;">
                <div style="font-size: 96px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                    <i class="far fa-bookmark"></i>
                </div>
                <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary);">No Bookmarked Questions Yet</h2>
                <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 400px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                    Click the bookmark icon on any question to save it here for quick review. This is perfect for difficult concepts or important topics you want to revisit.
                </p>
                <button class="quiz-btn" onclick="showDashboard(); navItems[0].click()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 32px; border-radius: 16px;">
                    <i class="fas fa-arrow-left"></i>
                    Explore Questions
                </button>
            </div>
        `;
    } else {
        quizContainer.innerHTML = `
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                    <div>
                        <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
                            ${bookmarkedQuestionsList.length} Saved Question${bookmarkedQuestionsList.length !== 1 ? 's' : ''}
                        </h2>
                        <p style="color: var(--text-secondary);">Your personal collection of important questions</p>
                    </div>
                    <button class="quiz-btn" onclick="startBookmarksQuiz()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px;">
                        <i class="fas fa-play"></i>
                        Practice Bookmarks
                    </button>
                </div>
                <div style="display: grid; gap: 20px;">
                    ${bookmarkedQuestionsList.map(question => `
                        <div class="question-card glass-effect" style="cursor: pointer; border-radius: 20px; padding: 24px;" onclick="jumpToBookmarkQuestion(${question.id})">
                            <div class="question-header">
                                <div class="question-meta">
                                    <div class="question-number" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));">Q${question.id}</div>
                                    <div class="question-category glass-effect">${question.category}</div>
                                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                                        ${question.difficulty}
                                    </div>
                                    ${question.custom ? '<div class="question-category glass-effect" style="background: #10b98120; color: #10b981;">Custom</div>' : ''}
                                </div>
                                <div class="question-actions">
                                    <button class="action-btn bookmark-btn" onclick="event.stopPropagation(); toggleBookmark(${question.id}); showBookmarks();" aria-label="Remove Bookmark" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                                        <i class="fas fa-bookmark"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="question-text" style="font-size: 16px; line-height: 1.6;">${question.question}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    quizContainer.classList.remove('hidden');
}

// Add this function to handle clicking on individual bookmark questions
function jumpToBookmarkQuestion(questionId) {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    // Start a quiz with just this one question
    questions = [bookmarkedQuestionsList.find(q => q.id === questionId)];
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Question';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
}

function showSettings() {
    hideAllSections();
    pageTitle.textContent = 'Settings & Preferences';
    
    quizContainer.innerHTML = `
        <div style="padding: 24px; max-width: 800px; margin: 0 auto;">
            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">ðŸŽ¨ Appearance</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Customize the look and feel of your study environment</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Theme</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? '' : 'active'}" onclick="setTheme('light')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-sun"></i>
                                Light Mode
                            </button>
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? 'active' : ''}" onclick="setTheme('dark')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-moon"></i>
                                Dark Mode
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Animation</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn active" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-bolt"></i>
                                Smooth
                            </button>
                            <button class="mode-btn" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-minus"></i>
                                Minimal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">âš¡ Study Preferences</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Optimize your learning experience</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Default Mode</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${currentMode === 'quiz' ? 'active' : ''}" onclick="setDefaultMode('quiz')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-tasks"></i>
                                Quiz
                            </button>
                            <button class="mode-btn ${currentMode === 'exam' ? 'active' : ''}" onclick="setDefaultMode('exam')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-file-alt"></i>
                                Exam
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Questions Per Session</label>
                        <select class="modern-dropdown" style="width: 100%;" onchange="setQuestionsPerSession(this.value)">
                            <option value="10">10 Questions</option>
                            <option value="25" selected>25 Questions</option>
                            <option value="50">50 Questions</option>
                            <option value="100">100 Questions</option>
                            <option value="0">All Questions</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">ðŸ“Š Data & Progress</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Manage your learning data</p>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <button class="quiz-btn" onclick="exportProgress()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-download" style="margin-right: 12px;"></i>
                         
                    </button>
                    <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-plus" style="margin-right: 12px;"></i>
                        Create Custom Question
                    </button>
                    <button class="quiz-btn" onclick="resetProgress()" style="background: linear-gradient(135deg, var(--error), #dc2626); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-trash" style="margin-right: 12px;"></i>
                        Reset All Progress
                    </button>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">â„¹ï¸ About ALIF</h3>
                <div style="color: var(--text-secondary); line-height: 1.7;">
                    <p>ALIF is an advanced medical education platform designed to help medical students and professionals enhance their knowledge through interactive quizzes and detailed analytics.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
                        <div>
                            <strong style="color: var(--text-primary);">Version</strong>
                            <div>2.1.0</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Questions</strong>
                            <div>${quizData.length + customQuestions.length} total</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Last Updated</strong>
                            <div>${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function setTheme(theme) {
    if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-sun';
    } else {
        document.body.classList.remove('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-moon';
    }
    showNotification(`Theme set to ${theme} mode`, 'success');
}

function setDefaultMode(mode) {
    currentMode = mode;
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[mode === 'quiz' ? 1 : 0].classList.add('active');
    showNotification(`Default mode set to ${mode}`, 'success');
}

function setQuestionsPerSession(count) {
    showNotification(`Questions per session set to ${count === '0' ? 'all' : count}`, 'info');
}

function showCustomQuestionCreator() {
    const modal = document.createElement('div');
    modal.className = 'custom-quiz-modal active';
    modal.innerHTML = `
        <div class="custom-quiz-content glass-effect" style="max-width: 600px; border-radius: 24px;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">Create Custom Question</h3>
                <button class="action-btn" onclick="closeCustomQuestionModal()" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="custom-question-creator">
                <div style="display: grid; gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Question Text</label>
                        <textarea id="customQuestionText" placeholder="Enter your question here..." style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 80px;"></textarea>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Category</label>
                        <select id="customQuestionCategory" class="modern-dropdown" style="width: 100%;">
                            <option value="Custom Anatomy">Custom Anatomy</option>
                            <option value="Custom Physiology">Custom Physiology</option>
                            <option value="Custom Pathology">Custom Pathology</option>
                            <option value="Custom Pharmacology">Custom Pharmacology</option>
                            <option value="General Medicine">General Medicine</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Difficulty</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button type="button" class="mode-btn difficulty-btn active" data-difficulty="Easy" style="border-radius: 12px; padding: 12px 16px;">
                                Easy
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Medium" style="border-radius: 12px; padding: 12px 16px;">
                                Medium
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Hard" style="border-radius: 12px; padding: 12px 16px;">
                                Hard
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Options</label>
                        <div style="display: grid; gap: 12px;">
                            ${['A', 'B', 'C', 'D'].map(letter => `
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--surface); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--text-secondary); flex-shrink: 0;">${letter}</div>
                                    <input type="text" id="customOption${letter}" placeholder="Option ${letter}" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; background: var(--surface); color: var(--text-primary);">
                                    <input type="radio" name="correctAnswer" value="${letter}" id="correct${letter}" style="transform: scale(1.2);">
                                    <label for="correct${letter}" style="color: var(--text-secondary); font-weight: 600;">Correct</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Explanation</label>
                        <textarea id="customExplanation" placeholder="Explain why the correct answer is right..." style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 60px;"></textarea>
                    </div>
                </div>
                
                <div class="custom-quiz-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;">
                    <button class="quiz-btn" onclick="closeCustomQuestionModal()" style="background: var(--secondary); color: white; padding: 12px 24px; border-radius: 12px;">
                        Cancel
                    </button>
                    <button class="quiz-btn check-btn" onclick="saveCustomQuestion()" style="padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-save"></i>
                        Save Question
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add difficulty button handlers
    modal.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            modal.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

function closeCustomQuestionModal() {
    const modal = document.querySelector('.custom-quiz-modal');
    if (modal) {
        modal.remove();
    }
}

function saveCustomQuestion() {
    const questionText = document.getElementById('customQuestionText').value;
    const category = document.getElementById('customQuestionCategory').value;
    const difficulty = document.querySelector('.difficulty-btn.active').dataset.difficulty;
    const explanation = document.getElementById('customExplanation').value;
    
    // Get options
    const options = [];
    for (let letter of ['A', 'B', 'C', 'D']) {
        const optionText = document.getElementById(`customOption${letter}`).value;
        if (optionText.trim()) {
            options.push(optionText);
        }
    }
    
    // Get correct answer
    const correctAnswerRadio = document.querySelector('input[name="correctAnswer"]:checked');
    if (!correctAnswerRadio) {
        showNotification('Please select the correct answer', 'error');
        return;
    }
    
    const correctAnswerIndex = ['A', 'B', 'C', 'D'].indexOf(correctAnswerRadio.value);
    
    if (!questionText.trim() || options.length < 2) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    // Generate a unique ID for the custom question
    const maxId = Math.max(
        ...quizData.map(q => q.id),
        ...customQuestions.map(q => q.id),
        0
    );
    
    const newQuestion = {
        id: maxId + 1,
        question: questionText,
        options: options,
        answer: correctAnswerIndex,
        correctAnswer: options[correctAnswerIndex],
        explanation: explanation || 'No explanation provided.',
        whyNotOtherOptions: {},
        relatedQuestions: [],
        category: category,
        difficulty: difficulty,
        custom: true
    };
    
    customQuestions.push(newQuestion);
    saveUserData();
    
    closeCustomQuestionModal();
    showNotification('Custom question created successfully!', 'success');
    
    // Refresh the current view and categories
    initializeCategories();
    if (currentPage === 'Dashboard') {
        showDashboard();
    } else if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}

function hideAllSections() {
    quizContainer.classList.add('hidden');
    resultsScreen.classList.add('hidden');
    document.querySelector('.stats-grid').style.display = 'none';
    document.querySelector('.analytics-section').style.display = 'none';
    document.querySelector('.export-section').style.display = 'none';
    // Note: search-container is NOT hidden here - we want it always visible during search
}

function startCourse(courseName) {
    showNotification(`Starting ${courseName} course...`, 'info');
    // Filter questions by course/category and start quiz
    const courseQuestions = [...quizData, ...customQuestions].filter(q => 
        q.category.toLowerCase().includes(courseName.toLowerCase())
    );
    
    if (courseQuestions.length === 0) {
        showNotification('No questions available for this course yet', 'info');
        return;
    }
    
    questions = courseQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active');
    pageTitle.textContent = `Quiz Mode - ${courseName}`;
    
    hideAllSections();
    renderQuizLayout();
}

// FIXED BOOKMARK PRACTICE FUNCTION
function startBookmarksQuiz() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    if (bookmarkedQuestionsList.length === 0) {
        showNotification('No bookmarked questions to practice!', 'error');
        return;
    }
    
    questions = bookmarkedQuestionsList;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Questions';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
    
    showNotification(`Starting practice with ${questions.length} bookmarked questions`, 'success');
}

function resetProgress() {
    if (confirm('Are you sure you want to reset all your progress? This action cannot be undone.')) {
        userProgress = {};
        userStats = {
            totalQuestions: 0,
            correctAnswers: 0,
            timeSpent: 0,
            masteryLevel: 0,
            streak: 0,
            lastActive: new Date().toISOString(),
            weeklyProgress: []
        };
        bookmarkedQuestions = new Set();
        customQuestions = [];
        saveUserData();
        updateDashboardStats();
        updateAnalytics();
        showNotification('All progress has been reset', 'success');
        showDashboard();
    }
}

function initializeEventListeners() {
    menuToggle.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', closeSidebar);
    themeToggle.addEventListener('click', toggleTheme);
    
    modeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.mode;
            pageTitle.textContent = `${btn.dataset.mode.charAt(0).toUpperCase() + btn.dataset.mode.slice(1)} Mode`;
            startQuiz();
        });
    });
    
    initializeEnhancedFeatures();
    document.getElementById('backBtn').addEventListener('click', function(e) {
        e.preventDefault();
        // Use browser back navigation
        window.history.back();
    });
}
function updateBackButton() {
    const backBtn = document.getElementById('backBtn');
    // Show back button if there's history to go back to
    if (window.history.length > 1) {
        backBtn.style.display = 'flex';
    } else {
        backBtn.style.display = 'none';
    }
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
    mainContent.classList.toggle('sidebar-open');
    document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
    mainContent.classList.remove('sidebar-open');
    document.body.style.overflow = '';
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const icon = themeToggle.querySelector('i');
    if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun';
    } else {
        icon.className = 'fas fa-moon';
    }
}

function initializeEnhancedFeatures() {
    initializeSearch();
    initializeKeyboardNavigation();
    enhanceAccessibility();
    
    exportProgressBtn.addEventListener('click', exportProgress);
    createCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.add('active');
    });
    cancelCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.remove('active');
    });
    createCustomQuizBtnModal.addEventListener('click', () => {
        const selectedOptions = document.querySelectorAll('.custom-quiz-option.selected');
        const options = {
            categories: selectedCategories,
            difficulty: null,
            bookmarkedOnly: false
        };
        
        selectedOptions.forEach(option => {
            const category = option.dataset.category;
            if (category === 'easy' || category === 'medium' || category === 'hard') {
                options.difficulty = category;
            } else if (category === 'bookmarked') {
                options.bookmarkedOnly = true;
            }
        });
        
        createCustomQuiz(options);
    });
    
    // Add selection toggling for custom quiz options
    document.addEventListener('click', (e) => {
        if (e.target.closest('.custom-quiz-option')) {
            const option = e.target.closest('.custom-quiz-option');
            option.classList.toggle('selected');
        }
    });
    
    // Ensure search works when clicking Dashboard
    navItems[0].addEventListener('click', () => {
        if (searchInput.value.trim().length > 0) {
            // If there's a search query, maintain search state
            isSearchActive = true;
        }
    });
}

// FIXED SEARCH FUNCTIONALITY
function initializeSearch() {
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            
            // Clear previous search state when input is empty
            if (query.length === 0) {
                document.body.classList.remove('search-blur-active');
                isSearchActive = false;
                if (currentPage === 'Dashboard') {
                    showDashboard();
                }
                return;
            }
            
            // Add blur effect when searching
            document.body.classList.add('search-blur-active');
            
            if (query.length < 2) {
                isSearchActive = false;
                return;
            }
            
            isSearchActive = true;
            performSearch(query);
        });
        
        // Add clear search functionality
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                clearSearch();
            }
        });
    }
}

function performSearch(query) {
    const allQuestions = [...quizData, ...customQuestions];
    searchResults = allQuestions.filter(q => 
        q.question.toLowerCase().includes(query) ||
        q.category.toLowerCase().includes(query) ||
        (q.explanation && q.explanation.toLowerCase().includes(query)) ||
        q.options.some(opt => opt.toLowerCase().includes(query))
    );
    
    console.log('Search query:', query, 'Results:', searchResults.length); // Debug log
    
    if (searchResults.length > 0) {
        // Show search results in quiz layout
        questions = searchResults;
        currentQuestionIndex = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        
        hideAllSections();
        quizContainer.classList.remove('hidden');
        renderQuizLayout();
        
        // Update page title to show search context
        pageTitle.textContent = `Search: "${query}" (${searchResults.length} results)`;
        
        // Highlight search terms
        setTimeout(() => {
            highlightSearchTerms(query);
        }, 100);
    } else {
        // Show no results message
        showSearchNoResults(query);
    }
}

function showSearchNoResults(query) {
    hideAllSections();
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-search"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Results Found</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                No questions match your search for "<strong style="color: var(--primary);">${query}</strong>". Try different keywords or browse categories.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-times"></i>
                    Clear Search
                </button>
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Browse Categories
                </button>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
    pageTitle.textContent = `Search: "${query}" (0 results)`;
}

function clearSearch() {
    searchInput.value = '';
    document.body.classList.remove('search-blur-active');
    isSearchActive = false;
    showDashboard();
}

function highlightSearchTerms(query) {
    const questionTexts = document.querySelectorAll('.question-text');
    const optionTexts = document.querySelectorAll('.option-text');
    const categoryElements = document.querySelectorAll('.question-category');
    
    const highlightText = (element) => {
        const originalText = element.textContent;
        const regex = new RegExp(`(${query})`, 'gi');
        const highlighted = originalText.replace(regex, '<mark class="search-highlight">$1</mark>');
        element.innerHTML = highlighted;
    };
    
    questionTexts.forEach(highlightText);
    optionTexts.forEach(highlightText);
    categoryElements.forEach(highlightText);
}

function initializeKeyboardNavigation() {
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key) {
            case 'ArrowDown':
            case 'ArrowUp':
                e.preventDefault();
                navigateOptions(e.key === 'ArrowDown' ? 1 : -1);
                break;
            case ' ':
            case 'Enter':
                e.preventDefault();
                if (document.activeElement.classList.contains('option')) {
                    document.activeElement.click();
                }
                break;
            case '1':
            case '2':
            case '3':
            case '4':
            case '5':
                e.preventDefault();
                const index = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option:not(.disabled)');
                if (options[index]) {
                    options[index].click();
                }
                break;
            case 'Escape':
                if (document.querySelector('.custom-quiz-modal')) {
                    document.querySelector('.custom-quiz-modal').remove();
                }
                break;
        }
    });
}

function navigateOptions(direction) {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const currentIndex = Array.from(options).findIndex(opt => opt === document.activeElement);
    let nextIndex = currentIndex + direction;
    
    if (nextIndex < 0) nextIndex = options.length - 1;
    if (nextIndex >= options.length) nextIndex = 0;
    
    options[nextIndex].focus();
}

function enhanceAccessibility() {
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('option')) {
            const options = e.target.parentElement.querySelectorAll('.option');
            options.forEach((opt, index) => {
                opt.setAttribute('aria-checked', opt.classList.contains('selected') ? 'true' : 'false');
                opt.setAttribute('role', 'radio');
                opt.setAttribute('tabindex', '0');
            });
        }
    });
}

function loadUserData() {
    const savedProgress = localStorage.getItem('mediQuizProgress');
    const savedStats = localStorage.getItem('mediQuizStats');
    const savedBookmarks = localStorage.getItem('mediQuizBookmarks');
    const savedCustomQuestions = localStorage.getItem('mediQuizCustomQuestions');
    
    if (savedProgress) {
        userProgress = JSON.parse(savedProgress);
    }
    if (savedStats) {
        userStats = JSON.parse(savedStats);
        const today = new Date().toDateString();
        const lastActive = new Date(userStats.lastActive).toDateString();
        if (lastActive !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastActive === yesterday.toDateString()) {
                userStats.streak++;
            } else {
                userStats.streak = 1;
            }
        }
    }
    if (savedBookmarks) {
        bookmarkedQuestions = new Set(JSON.parse(savedBookmarks));
    }
    if (savedCustomQuestions) {
        customQuestions = JSON.parse(savedCustomQuestions);
    }
    
    userStats.lastActive = new Date().toISOString();
    saveUserData();
}

function saveUserData() {
    localStorage.setItem('mediQuizProgress', JSON.stringify(userProgress));
    localStorage.setItem('mediQuizStats', JSON.stringify(userStats));
    localStorage.setItem('mediQuizBookmarks', JSON.stringify(Array.from(bookmarkedQuestions)));
    localStorage.setItem('mediQuizCustomQuestions', JSON.stringify(customQuestions));
}

function updateDashboardStats() {
    correctAnswersEl.textContent = userStats.correctAnswers;
    timeSpentEl.textContent = `${Math.floor(userStats.timeSpent / 60)}h ${userStats.timeSpent % 60}m`;
    masteryLevelEl.textContent = `${userStats.masteryLevel}%`;
    streakCountEl.textContent = userStats.streak;
}

function updateAnalytics() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => allQuestions.find(q => q.id == id)?.category)
        .reduce((acc, category) => {
            acc[category] = (acc[category] || 0) + 1;
            return acc;
        }, {});
        
    weakAreasCountEl.textContent = Object.keys(weakAreas).length;
    
    const totalTime = userStats.timeSpent * 60;
    const avgTime = userStats.totalQuestions > 0 ? Math.round(totalTime / userStats.totalQuestions) : 0;
    avgTimePerQuestionEl.textContent = `${avgTime}s`;
    
    if (userStats.weeklyProgress.length > 1) {
        const latest = userStats.weeklyProgress[userStats.weeklyProgress.length - 1];
        const previous = userStats.weeklyProgress[userStats.weeklyProgress.length - 2];
        const improvement = ((latest - previous) / previous) * 100;
        improvementRateEl.textContent = `${Math.round(improvement)}%`;
    } else {
        improvementRateEl.textContent = "0%";
    }
}

function exportProgress() {
    const data = {
        progress: userProgress,
        stats: userStats,
        bookmarks: Array.from(bookmarkedQuestions),
        customQuestions: customQuestions,
        exportDate: new Date().toISOString(),
        analytics: generateStudyReport()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mediquiz-progress-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('Progress data exported successfully!', 'success');
}

function createCustomQuiz(options) {
    let filteredQuestions = [...quizData, ...customQuestions];
    
    if (options.categories && options.categories.length > 0) {
        filteredQuestions = filteredQuestions.filter(q => options.categories.includes(q.category));
    }
    
    if (options.difficulty) {
        filteredQuestions = filteredQuestions.filter(q => q.difficulty.toLowerCase() === options.difficulty);
    }
    
    if (options.bookmarkedOnly) {
        filteredQuestions = filteredQuestions.filter(q => bookmarkedQuestions.has(q.id));
    }
    
    if (options.count && options.count > 0) {
        filteredQuestions = shuffleArray(filteredQuestions).slice(0, options.count);
    }
    
    questions = filteredQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    examSubmitted = false;
    
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    hideAllSections();
    renderQuizLayout();
    customQuizModal.classList.remove('active');
    showNotification(`Custom quiz created with ${questions.length} questions`, 'success');
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function generateStudyReport() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    const strongAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) >= 0.8)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    return {
        weakAreas,
        strongAreas,
        totalMastered: Object.values(userProgress).filter(p => p.correct >= 3).length,
        totalQuestions: allQuestions.length,
        masteryPercentage: calculateMasteryLevel(),
        generatedAt: new Date().toISOString()
    };
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        padding: 20px 28px;
        background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--primary)'};
        color: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        font-weight: 600;
        max-width: 400px;
        line-height: 1.5;
    `;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}" style="font-size: 20px;"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 400);
    }, 4000);
}

function initializeCategories() {
    const allQuestions = [...quizData, ...customQuestions];
    const categories = [...new Set(allQuestions.map(q => q.category))];
    const categoryIcons = {
        "Anatomy Fundamentals": "fas fa-brain",
        "Neuroanatomy": "fas fa-brain",
        "Gastrointestinal System": "fas fa-stomach",
        "Cardiovascular System": "fas fa-heart",
        "Custom Anatomy": "fas fa-user-md",
        "Custom Physiology": "fas fa-heartbeat",
        "Custom Pathology": "fas fa-virus",
        "Custom Pharmacology": "fas fa-pills",
        "General Medicine": "fas fa-stethoscope"
    };
    
    const categoryColors = {
        "Anatomy Fundamentals": "#6366f1",
        "Neuroanatomy": "#06b6d4",
        "Gastrointestinal System": "#10b981",
        "Cardiovascular System": "#ef4444",
        "Custom Anatomy": "#8b5cf6",
        "Custom Physiology": "#f59e0b",
        "Custom Pathology": "#ec4899",
        "Custom Pharmacology": "#84cc16",
        "General Medicine": "#64748b"
    };

    categoriesGrid.innerHTML = '';
    categories.forEach(category => {
        const categoryQuestions = allQuestions.filter(q => q.category === category);
        const mastered = categoryQuestions.filter(q =>
            userProgress[q.id] && userProgress[q.id].correct >= 3
        ).length;
        const progress = categoryQuestions.length > 0 ?
            Math.round((mastered / categoryQuestions.length) * 100) : 0;
            
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card active glass-effect';
        categoryCard.dataset.category = category;
        categoryCard.style.borderLeft = `4px solid ${categoryColors[category] || '#6366f1'}`;
        categoryCard.innerHTML = `
            <div class="category-header">
                <div class="category-icon" style="background: ${categoryColors[category] || '#6366f1'}20; color: ${categoryColors[category] || '#6366f1'}">
                    <i class="${categoryIcons[category] || 'fas fa-question'}"></i>
                </div>
                <div class="category-name">${category}</div>
                ${category.includes('Custom') ? '<div style="font-size: 10px; color: var(--primary); background: var(--primary-light); padding: 2px 6px; border-radius: 8px;">Custom</div>' : ''}
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${categoryColors[category] || '#6366f1'}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                ${categoryQuestions.length} question${categoryQuestions.length !== 1 ? 's' : ''}
                ${categoryQuestions.filter(q => q.custom).length > 0 ? ` Â· ${categoryQuestions.filter(q => q.custom).length} custom` : ''}
            </div>
        `;
        
        if (categoryQuestions.length > 1) {
            const dropdown = document.createElement('div');
            dropdown.className = 'modern-dropdown';
            dropdown.innerHTML = `
                <select onchange="jumpToQuestion(this.value)">
                    <option value="">Jump to Question...</option>
                    ${categoryQuestions.sort((a, b) => a.id - b.id).map(q => 
                        `<option value="question-${q.id}">Q${q.id}: ${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}${q.custom ? ' â˜…' : ''}</option>`
                    ).join('')}
                </select>
            `;
            categoryCard.appendChild(dropdown);
        }
        
        categoryCard.addEventListener('click', (e) => {
            if (!e.target.closest('.modern-dropdown') && !e.target.closest('select')) {
                toggleCategory(categoryCard);
                const firstQ = categoryQuestions.sort((a, b) => a.id - b.id)[0];
                if (firstQ) {
                    jumpToQuestion(`question-${firstQ.id}`);
                }
            }
        });
        
        categoriesGrid.appendChild(categoryCard);
    });
    
    selectedCategories = [...categories];
}

function toggleCategory(categoryCard) {
    const category = categoryCard.dataset.category;
    if (categoryCard.classList.contains('active')) {
        categoryCard.classList.remove('active');
        selectedCategories = selectedCategories.filter(c => c !== category);
    } else {
        categoryCard.classList.add('active');
        selectedCategories.push(category);
    }
    startQuiz();
    closeSidebar();
}

function startQuiz() {
    if (currentPage !== 'Dashboard') return;
    
    quizContainer.style.opacity = '0';
    setTimeout(() => {
        const allQuestions = [...quizData, ...customQuestions];
        questions = selectedCategories.length > 0 ? 
            allQuestions.filter(q => selectedCategories.includes(q.category)) : 
            allQuestions;
            
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        if (currentMode === 'learn' && incorrectQuestions.length > 0) {
            questions = allQuestions.filter(q => incorrectQuestions.includes(q.id));
        }
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        questions.sort((a, b) => a.id - b.id);
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        examSubmitted = false;
        quizContainer.classList.remove('hidden');
        resultsScreen.classList.add('hidden');
        questionTimers = new Array(questions.length).fill(0);
        if (currentMode === 'exam') {
            isCountdown = true;
            remainingTime = 120 * questions.length;
        } else {
            isCountdown = false;
        }
        startTimer();
        renderQuizLayout();
        quizContainer.style.opacity = '1';
    }, 300);
}

function showNoQuestionsMessage() {
    let message = '';
    if (isSearchActive) {
        message = 'No questions match your search criteria. Try different keywords.';
    } else if (selectedCategories.length === 0) {
        message = 'No categories selected. Please select categories from the sidebar.';
    } else {
        message = 'No questions available for the selected categories.';
    }
    
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-inbox"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Questions Available</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                ${message}
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Select Categories
                </button>
                <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-plus"></i>
                    Create Question
                </button>
                ${isSearchActive ? `
                    <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-times"></i>
                        Clear Search
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    resultsScreen.classList.add('hidden');
    stopTimer();
    quizContainer.style.opacity = '1';
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    startTime = new Date();
    timerInterval = setInterval(() => {
        if (isCountdown) {
            remainingTime--;
            if (remainingTime <= 0) {
                remainingTime = 0;
                clearInterval(timerInterval);
                if (currentMode === 'exam' && !examSubmitted) {
                    showNotification('Time up! Submitting exam.', 'error');
                    submitExam();
                }
            }
            updateTimerDisplay(formatTime(remainingTime), 'timerDisplay', true);
        } else {
            questionTimers[currentQuestionIndex]++;
            updateTimerDisplay(formatTime(questionTimers[currentQuestionIndex]), 'timerDisplay', false);
        }
    }, 1000);
}

function formatTime(seconds) {
    const min = Math.floor(seconds / 60).toString().padStart(2, '0');
    const sec = (seconds % 60).toString().padStart(2, '0');
    return `${min}:${sec}`;
}

function updateTimerDisplay(time, id, isCountdown = false) {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = `Time: ${time}`;
        if (isCountdown) {
            el.classList.remove('timer-warning', 'timer-error');
            if (remainingTime <= 30) {
                el.classList.add('timer-error');
            } else if (remainingTime <= 60) {
                el.classList.add('timer-warning');
            }
        }
    }
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        if (startTime) {
            const endTime = new Date();
            const timeSpent = Math.floor((endTime - startTime) / 1000 / 60);
            userStats.timeSpent += timeSpent;
            userStats.lastActive = new Date().toISOString();
            saveUserData();
            updateDashboardStats();
        }
    }
}

function renderQuizLayout() {
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    if (currentMode === 'exam') {
        renderExamLayout();
    } else {
        renderSingleQuestionLayout();
    }
}

function renderExamLayout() {
    const isImmediateMode = examCheckMode === 'immediate';
    quizContainer.innerHTML = `
        <div class="exam-header" style="margin-bottom: 24px; padding: 20px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                <div>
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                        Exam Mode: ${questions.length} Questions
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        ${isImmediateMode ?
                          'Immediate Check - See explanations as you answer' :
                          'All-in-One Check - Check all answers at the end'}
                    </p>
                </div>
                <div class="exam-mode-toggle" style="display: flex; gap: 8px; background: var(--glass); padding: 4px; border-radius: var(--radius);">
                    <button class="mode-toggle-btn ${isImmediateMode ? 'active' : ''}" data-mode="immediate" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="Immediate Check Mode">
                        Immediate Check
                    </button>
                    <button class="mode-toggle-btn ${!isImmediateMode ? 'active' : ''}" data-mode="all-at-once" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${!isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${!isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="All-at-Once Check Mode">
                        Check All
                    </button>
                </div>
            </div>
            <div class="progress-info" style="display: flex; align-items: center; gap: 16px;">
                <span style="font-size: 14px; color: var(--text-secondary);" id="answeredCount">0/${questions.length} answered</span>
                <div class="progress-bar" style="flex: 1; height: 6px;">
                    <div class="progress-fill" id="examProgressFill" style="width: 0%"></div>
                </div>
                <span id="timerDisplay" style="font-size: 14px; color: var(--text-secondary);">Time: ${formatTime(remainingTime)}</span>
                ${examSubmitted ? `<span style="color: var(--success); font-weight: 600; font-size: 14px;">Submitted!</span>` : ''}
            </div>
        </div>
        <div class="exam-mode-layout">
            ${questions.map((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.answer;
                const showExplanationButton = examSubmitted || (isImmediateMode && userAnswer !== undefined);
                return `
                    <div class="question-card fade-in" data-question-index="${index}" id="question-${question.id}">
                        <div class="question-header">
                            <div class="question-meta">
                                <div class="question-number">Q${question.id}</div>
                                <div class="question-category">${question.category}</div>
                                <div class="question-difficulty" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${getDifficultyColor(question.difficulty)}; color: white;">
                                    ${question.difficulty}
                                </div>
                                ${userAnswer !== undefined ? `
                                    <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                                        ${isCorrect ? 'Correct' : 'Incorrect'}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="question-actions">
                                <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                                    <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                                </button>
                            </div>
                        </div>
                        <div class="question-text">${question.question}</div>
                        <div class="options-grid">
                            ${question.options.map((option, optIndex) => {
                                const isSelected = userAnswer === optIndex;
                                const isCorrectOption = optIndex === question.answer;
                                let optionClass = 'option';
                                if (userAnswer !== undefined) {
                                    if (isCorrectOption) {
                                        optionClass += ' correct';
                                    } else if (isSelected && !isCorrectOption) {
                                        optionClass += ' incorrect';
                                    }
                                    optionClass += ' disabled';
                                } else if (isSelected) {
                                    optionClass += ' selected';
                                }
                                return `
                                    <div class="${optionClass}" data-option-index="${optIndex}" role="button" aria-label="Option ${String.fromCharCode(65 + optIndex)}">
                                        <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                                        <div class="option-text">${option}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${showExplanationButton ? `
                            <div class="explanation-section">
                                <details open>
                                    <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                                    <div class="explanation-content correct-answer">
                                        <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                                    </div>
                                </details>
                                ${userAnswer !== undefined && userAnswer !== question.answer ? `
                                    <details>
                                        <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                                        <div class="explanation-content why-not-section">
                                            <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                            <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                                        </div>
                                    </details>
                                ` : ''}
                                <details>
                                    <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                                    <div class="explanation-content">${question.explanation}</div>
                                </details>
                                <details>
                                    <summary><i class="fas fa-link"></i> Related Questions</summary>
                                    <div class="explanation-content related-questions">
                                        <div class="related-questions-list">
                                            ${question.relatedQuestions.map(q => {
                                                const qId = q.match(/\d+/)[0];
                                                return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                </details>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('')}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    ${examCheckMode === 'all-at-once' && !examSubmitted ? `
                        <button class="quiz-btn check-btn" id="checkAllBtn" ${userAnswers.filter(a => a !== undefined).length === 0 ? 'disabled' : ''} aria-label="Check All Answers">
                            <i class="fas fa-check-double"></i>
                            Check All Answers
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn submit-btn" id="examSubmitBtn" ${examSubmitted ? 'disabled' : ''} aria-label="Submit Exam">
                    <i class="fas fa-paper-plane"></i>
                    ${examSubmitted ? 'Exam Submitted' : `Submit Exam (${questions.length} questions)`}
                </button>
            </div>
        </div>
    `;
    initializeExamModeEvents();
    updateExamSubmitButton();
}

function renderSingleQuestionLayout() {
    if (currentQuestionIndex >= questions.length) {
        showResults();
        return;
    }
    const question = questions[currentQuestionIndex];
    const userAnswer = userAnswers[currentQuestionIndex];
    const isCorrect = userAnswer === question.answer;
    quizContainer.innerHTML = `
        <div class="question-card fade-in" data-question-index="${currentQuestionIndex}">
            <div class="question-header">
                <div class="question-meta">
                    <div class="question-number">Q${question.id}</div>
                    <div class="question-category">${question.category}</div>
                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                        ${question.difficulty}
                    </div>
                    ${userAnswer !== undefined ? `
                        <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                            ${isCorrect ? 'Correct' : 'Incorrect'}
                        </div>
                    ` : ''}
                </div>
                <div class="question-actions">
                    <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                        <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                    </button>
                </div>
            </div>
            <div class="question-text">${question.question}</div>
            <div class="options-grid">
                ${question.options.map((option, index) => {
                    const isSelected = userAnswer === index;
                    const isCorrectOption = index === question.answer;
                    let optionClass = 'option';
                    if (isAnswerChecked) {
                        if (isCorrectOption) {
                            optionClass += ' correct';
                        } else if (isSelected && !isCorrectOption) {
                            optionClass += ' incorrect';
                        }
                        optionClass += ' disabled';
                    } else if (isSelected) {
                        optionClass += ' selected';
                    }
                    return `
                        <div class="${optionClass}" data-option-index="${index}" role="button" aria-label="Option ${String.fromCharCode(65 + index)}">
                            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                            <div class="option-text">${option}</div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${isAnswerChecked ? `
                <div class="explanation-section">
                    <details open>
                        <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                        <div class="explanation-content correct-answer">
                            <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                        </div>
                    </details>
                    ${userAnswer !== undefined && userAnswer !== question.answer ? `
                        <details>
                            <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                            <div class="explanation-content why-not-section">
                                <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                            </div>
                        </details>
                    ` : ''}
                    <details>
                        <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                        <div class="explanation-content">${question.explanation}</div>
                    </details>
                    <details>
                        <summary><i class="fas fa-link"></i> Related Questions</summary>
                        <div class="explanation-content related-questions">
                            <div class="related-questions-list">
                                ${question.relatedQuestions.map(q => {
                                    const qId = q.match(/\d+/)[0];
                                    return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    </details>
                </div>
            ` : ''}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    <button class="quiz-btn check-btn" id="checkAnswerBtn" ${userAnswer === undefined ? 'disabled' : ''} aria-label="Check Answer">
                        <i class="fas fa-check"></i>
                        Check Answer
                    </button>
                    ${currentMode === 'learn' && incorrectQuestions.length > 0 ? `
                        <button class="quiz-btn" id="incorrectOnlyBtn" aria-label="Show Incorrect Only">
                            <i class="fas fa-filter"></i>
                            Incorrect Only
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn next-btn" id="nextQuestionBtn" ${!isAnswerChecked ? 'disabled' : ''} aria-label="Next Question">
                    <i class="fas fa-arrow-right"></i>
                    ${currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish'}
                </button>
            </div>
        </div>
    `;
    initializeQuizEvents();
    updateTimerDisplay(formatTime(isCountdown ? remainingTime : questionTimers[currentQuestionIndex]), 'timerDisplay', isCountdown);
}

function initializeQuizEvents() {
    const checkAnswerBtn = document.getElementById('checkAnswerBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const incorrectOnlyBtn = document.getElementById('incorrectOnlyBtn');
    const bookmarkBtn = document.querySelector('.bookmark-btn');
    const options = document.querySelectorAll('.option:not(.disabled)');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            if (!isAnswerChecked) {
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                userAnswers[currentQuestionIndex] = parseInt(option.dataset.optionIndex);
                if (checkAnswerBtn) checkAnswerBtn.disabled = false;
                updateExamSubmitButton();
            }
        });
    });
    
    if (checkAnswerBtn) {
        checkAnswerBtn.addEventListener('click', () => {
            checkAnswer();
            renderQuizLayout();
        });
    }
    
    if (nextQuestionBtn) {
        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (incorrectOnlyBtn) {
        incorrectOnlyBtn.addEventListener('click', () => {
            questions = quizData.filter(q => incorrectQuestions.includes(q.id));
            currentQuestionIndex = 0;
            userAnswers = new Array(questions.length);
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', () => {
            const questionId = parseInt(bookmarkBtn.dataset.questionId);
            toggleBookmark(questionId);
            bookmarkBtn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    }
}

function initializeExamModeEvents() {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const checkAllBtn = document.getElementById('checkAllBtn');
    const submitBtn = document.getElementById('examSubmitBtn');
    const modeToggleButtons = document.querySelectorAll('.mode-toggle-btn');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            const questionIndex = parseInt(option.closest('.question-card').dataset.questionIndex);
            const prevSelected = option.closest('.options-grid').querySelector('.selected');
            if (prevSelected) prevSelected.classList.remove('selected');
            option.classList.add('selected');
            userAnswers[questionIndex] = parseInt(option.dataset.optionIndex);
            updateExamProgress();
            updateExamSubmitButton();
            if (examCheckMode === 'immediate') {
                checkAnswer(questionIndex);
                renderQuizLayout();
            }
        });
    });
    
    if (checkAllBtn) {
        checkAllBtn.addEventListener('click', () => {
            userAnswers.forEach((answer, index) => {
                if (answer !== undefined) {
                    checkAnswer(index);
                }
            });
            renderQuizLayout();
        });
    }
    
    if (submitBtn) {
        submitBtn.addEventListener('click', submitExam);
    }
    
    modeToggleButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeToggleButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            examCheckMode = btn.dataset.mode;
            renderQuizLayout();
        });
    });
    
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const questionId = parseInt(btn.dataset.questionId);
            toggleBookmark(questionId);
            btn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    });
}

function updateExamProgress() {
    const answered = userAnswers.filter(a => a !== undefined).length;
    const progressPercent = (answered / questions.length) * 100;
    const answeredCount = document.getElementById('answeredCount');
    const progressFill = document.getElementById('examProgressFill');
    if (answeredCount) {
        answeredCount.textContent = `${answered}/${questions.length} answered`;
    }
    if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
    }
}

function updateExamSubmitButton() {
    const submitBtn = document.getElementById('examSubmitBtn');
    if (submitBtn) {
        const allAnswered = userAnswers.every(a => a !== undefined);
        submitBtn.disabled = !allAnswered || examSubmitted;
        submitBtn.innerHTML = examSubmitted ?
            '<i class="fas fa-paper-plane"></i> Exam Submitted' :
            `<i class="fas fa-paper-plane"></i> Submit Exam (${questions.length} questions)`;
    }
}

function checkAnswer(questionIndex = currentQuestionIndex) {
    const question = questions[questionIndex];
    const userAnswer = userAnswers[questionIndex];
    isAnswerChecked = true;
    if (userAnswer === question.answer) {
        score++;
        userStats.correctAnswers++;
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].correct++;
        userProgress[question.id].attempts++;
        incorrectQuestions = incorrectQuestions.filter(id => id !== question.id);
    } else {
        if (!incorrectQuestions.includes(question.id)) {
            incorrectQuestions.push(question.id);
        }
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].attempts++;
    }
    userStats.totalQuestions++;
    userStats.masteryLevel = calculateMasteryLevel();
    saveUserData();
    updateDashboardStats();
}

function submitExam() {
    examSubmitted = true;
    if (examCheckMode === 'all-at-once') {
        userAnswers.forEach((answer, index) => {
            if (answer !== undefined) {
                checkAnswer(index);
            }
        });
    }
    stopTimer();
    showResults();
}

function calculateMasteryLevel() {
    const masteredQuestions = Object.values(userProgress).filter(p => p.correct >= 3).length;
    return quizData.length > 0 ? Math.round((masteredQuestions / quizData.length) * 100) : 0;
}

function showResults() {
    stopTimer();
    quizContainer.classList.add('hidden');
    resultsScreen.classList.remove('hidden');
    const percentage = questions.length > 0 ? Math.round((score / questions.length) * 100) : 0;
    
    let restartText = 'Restart Quiz';
    if (currentPage === 'bookmarks') {
        restartText = 'Practice Again';
    }
    
    resultsScreen.innerHTML = `
        <div class="results-card fade-in">
            <div class="results-header">
                <h2 class="results-title">${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)} Results</h2>
                <p class="score-text">You completed ${questions.length} question${questions.length !== 1 ? 's' : ''}</p>
            </div>
            <div class="score-display">${percentage}%</div>
            <div class="score-text">Score: ${score} out of ${questions.length} correct</div>
            <div class="results-details">
                ${questions.map((q, index) => {
                    const isCorrect = userAnswers[index] === q.answer;
                    return `
                        <div class="result-item">
                            <div class="result-question">Q${q.id}: ${q.question}</div>
                            <div class="result-status ${isCorrect ? 'result-correct' : 'result-incorrect'}">
                                ${isCorrect ? 'Correct' : 'Incorrect'}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="restart-btn" id="restartQuiz" aria-label="Restart Quiz" style="margin: 0;">
                    <i class="fas fa-redo"></i>
                    ${restartText}
                </button>
                ${currentPage === 'bookmarks' ? `
                    <button class="quiz-btn" onclick="showBookmarks()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 16px 24px; border-radius: var(--radius);">
                        <i class="fas fa-bookmark"></i>
                        Back to Bookmarks
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('restartQuiz').addEventListener('click', () => {
        if (currentPage === 'bookmarks') {
            startBookmarksQuiz();
        } else {
            startQuiz();
        }
    });
}

function toggleBookmark(questionId) {
    if (bookmarkedQuestions.has(questionId)) {
        bookmarkedQuestions.delete(questionId);
        showNotification('Question removed from bookmarks', 'info');
    } else {
        bookmarkedQuestions.add(questionId);
        showNotification('Question bookmarked', 'success');
    }
    saveUserData();
    
    // If we're on the bookmarks page, refresh it
    if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}


function getDifficultyColor(difficulty) {
    switch (difficulty.toLowerCase()) {
        case 'easy': return '#10b981';
        case 'medium': return '#f59e0b';
        case 'hard': return '#ef4444';
        default: return '#64748b';
    }
}

function jumpToQuestion(questionId) {
    const questionIndex = questions.findIndex(q => `question-${q.id}` === questionId);
    if (questionIndex !== -1) {
        if (currentMode === 'exam') {
            const element = document.getElementById(questionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        } else {
            currentQuestionIndex = questionIndex;
            isAnswerChecked = false;
            renderQuizLayout();
        }
    } else {
        // If question not in current quiz, start a new quiz with that question's category
        const question = quizData.find(q => `question-${q.id}` === questionId) || customQuestions.find(q => `question-${q.id}` === questionId);
        if (question) {
            selectedCategories = [question.category];
            startQuiz();
            setTimeout(() => {
                const element = document.getElementById(questionId);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
        }
    }
}

// Initialize the application
init();
    </script>
</body>

</html>
