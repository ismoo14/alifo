 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALIF | Advanced Medical Education</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/protect.js"></script>
    <style type="text/css">
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --primary: #3b82f6; 
            --primary-dark: #2563eb; 
            --primary-light: #dbeafe; 
            --secondary: #6b7280; 
            --success: #22c55e; 
            --error: #ef4444; 
            --warning: #eab308; 
            --info: #0ea5e9; 
            --background: #ffffff; 
            --surface: #f9fafb; 
            --text-primary: #111827; 
            --text-secondary: #4b5563; 
            --text-tertiary: #9ca3af; 
            --border: #e5e7eb; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.05);
            --radius: 8px; 
            --radius-lg: 12px;
            --radius-xl: 16px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
            --gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --glass: rgba(255, 255, 255, 0.85); 
            --glass-border: rgba(229, 231, 235, 0.3);
        }

        .dark-mode {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --primary-light: #93c5fd;
            --secondary: #94a3b8;
            --background: #000000; 
            --surface: #111827; 
            --text-primary: #f9fafb; 
            --text-secondary: #d1d5db; 
            --text-tertiary: #6b7280; 
            --border: #1f2937; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.6); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.6);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.6);
            --glass: rgba(17, 24, 39, 0.85); 
            --glass-border: rgba(31, 41, 55, 0.3);
            .mode-btn,
    .question-text,
    .option-text {
        color: var(--text-primary) !important;
    }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            transition: var(--transition);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* App Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow);
            transform: translateX(-100%);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 0 24px 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .logo i {
            font-size: 24px;
        }

        .sidebar-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            background: var(--glass);
            border-radius: var(--radius);
            margin: 0 16px 24px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: var(--shadow);
        }

        .user-info h3 {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .user-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--glass);
            border-left-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .nav-item.active .nav-icon {
            color: var(--primary);
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .categories-section {
            margin-top: 24px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .categories-grid {
            padding: 0 16px;
        }

        .category-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .category-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .category-card.active {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .category-card.active .category-icon {
            background: var(--primary);
        }

        .category-name {
            font-weight: 500;
            font-size: 14px;
        }

        .category-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-right: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .category-card.active .progress-text {
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content.sidebar-open {
            margin-left: 280px;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--primary-light);
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mode-selector {
            display: flex;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 4px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            padding: 24px 32px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Quiz Container */
        .quiz-container {
            padding: 0 32px 32px;
        }

        .question-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .question-card.fade-in {
            opacity: 1;
        }

        .question-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .question-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .question-number {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            background: var(--primary-light);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-category {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            background: var(--glass);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary-light);
        }

        .question-text {
            font-size: 18px;
            font-weight: 500;
            line-height: 1.6;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass);
            min-height: 60px;
        }

        .option:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .option.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            flex-shrink: 0;
            transition: var(--transition);
        }

        .option.selected .option-letter {
            background: var(--primary);
            color: white;
        }

        .option.correct .option-letter {
            background: var(--success);
            color: white;
        }

        .option.incorrect .option-letter {
            background: var(--error);
            color: white;
        }

        .option-text {
            flex: 1;
            font-size: 15px;
            font-weight: 400;
        }

        /* Explanation Section */
        .explanation-section {
            margin-top: 24px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 24px;
        }

        .explanation-section details {
            margin-bottom: 16px;
        }

        .explanation-section summary {
            padding: 12px 16px;
            background: var(--surface);
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .explanation-section summary:hover {
            background: var(--primary-light);
        }

        .explanation-section details[open] summary {
            background: var(--primary);
            color: white;
        }

        .explanation-content {
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .explanation-content strong {
            color: var(--text-primary);
        }

        .correct-answer, .why-not-section, .related-questions {
            margin-bottom: 16px;
            padding: 16px;
            border-radius: var(--radius);
        }

        .correct-answer {
            background: rgba(34, 197, 94, 0.05);
            border-left: 4px solid var(--success);
        }

        .why-not-section {
            background: rgba(239, 68, 68, 0.05);
            border-left: 4px solid var(--error);
        }

        .related-questions {
            background: rgba(59, 130, 246, 0.05);
            border-left: 4px solid var(--primary);
        }

        .related-questions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .related-question-tag {
            padding: 6px 12px;
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .related-question-tag:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        /* Quiz Controls */
        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .quiz-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .quiz-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .quiz-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .check-btn {
            background: var(--primary);
            color: white;
        }

        .check-btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .next-btn {
            background: var(--success);
            color: white;
        }

        .next-btn:hover:not(:disabled) {
            background: #16a34a;
        }

        .submit-btn {
            background: var(--gradient);
            color: white;
            padding: 12px 32px;
            font-size: 16px;
        }

        /* Results Screen */
        .results-screen {
            padding: 32px;
            max-width: 900px;
            margin: 0 auto;
        }

        .results-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 48px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .results-header {
            margin-bottom: 32px;
        }

        .results-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .score-display {
            font-size: 64px;
            font-weight: 700;
            margin: 32px 0;
            color: var(--text-primary);
        }

        .score-text {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .results-details {
            text-align: left;
            margin: 48px 0;
            background: var(--glass);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--glass-border);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-question {
            flex: 1;
            font-size: 14px;
        }

        .result-status {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .result-correct {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .result-incorrect {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .restart-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 16px 48px;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        /* Enhanced Features */
        .search-container {
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 12px 16px;
            max-width: 400px;
            margin: 0 auto;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-box i {
            color: var(--text-tertiary);
            margin-right: 8px;
        }


        .export-section {
            padding: 16px 32px;
            text-align: center;
        }

        .export-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Custom Quiz Modal */
/* Custom Quiz Modal Styles */
.custom-quiz-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.custom-quiz-modal.active {
    display: flex;
}

.custom-quiz-content {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 32px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--border);
}

.custom-quiz-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 24px;
    color: var(--text-primary);
}

.custom-quiz-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
}

.custom-quiz-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    background: var(--glass);
}

.custom-quiz-option:hover {
    border-color: var(--primary-light);
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

.custom-quiz-option.selected {
    border-color: var(--primary);
    background: var(--primary-light);
}

.custom-quiz-option .option-selector {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    flex-shrink: 0;
}

.custom-quiz-option.selected .option-selector {
    background: var(--primary);
    border-color: var(--primary);
}

.custom-quiz-option.selected .option-selector::after {
    content: '✓';
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.custom-quiz-option label {
    cursor: pointer;
    font-weight: 500;
    color: var(--text-primary);
    flex: 1;
    margin: 0;
}

.quiz-options-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

.quiz-options-section label {
    display: block;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-weight: 600;
}

.custom-quiz-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
}

/* Modern Dropdown for Custom Quiz */
.custom-quiz-content .modern-dropdown {
    position: relative;
    margin-top: 8px;
}

.custom-quiz-content .modern-dropdown select {
    width: 100%;
    padding: 12px 48px 12px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    background-size: 18px;
}

.custom-quiz-content .modern-dropdown select:hover {
    border-color: var(--primary);
    background-color: var(--primary-light);
}

.custom-quiz-content .modern-dropdown select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Glass effect for modal */
.custom-quiz-content.glass-effect {
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.dark-mode .custom-quiz-content.glass-effect {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .sidebar {
                width: 66vw;
            }

            .main-content.sidebar-open {
                margin-left: 100vw;
            }

            .top-nav {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .nav-left {
                width: 100%;
                justify-content: space-between;
            }

            .nav-right {
                width: 100%;
                justify-content: space-between;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                padding: 16px;
            }

            .quiz-container {
                padding: 0 16px 16px;
            }

            .question-card {
                padding: 24px;
            }

            .question-text {
                font-size: 17px;
            }

            .option {
                padding: 12px;
                min-height: 70px;
            }

            .results-card {
                padding: 32px 24px;
            }

            .score-display {
                font-size: 48px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .search-container {
                padding: 12px 16px;
            }

            .analytics-section {
                margin: 16px;
                padding: 16px;
            }

            .quiz-btn {
                padding: 16px 20px;
                font-size: 16px;
            }
        }

        @media (min-width: 1200px) {
            .quiz-container {
                max-width: 1100px;
                margin: 0 auto;
                padding: 24px;
            }

            .question-card {
                max-width: 1000px;
                margin: 0 auto 24px;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        .hidden {
            display: none;
        }

        .glass {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .text-gradient {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .question-difficulty {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .question-dropdown {
            margin-top: 8px;
            display: block;
        }

        .question-dropdown select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .option.disabled {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .timer-warning {
            color: var(--warning);
        }

        .timer-error {
            color: var(--error);
        }

        .loading-spinner {
            display: none;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        .loading-spinner.active {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ultra Modern Styles */
        /* Glass Morphism Effects */
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark-mode .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Enhanced Hover Effects with Glow */
        .nav-item:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.15) 100%) !important;
            border-left-color: var(--primary) !important;
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25) !important;
            backdrop-filter: blur(10px);
        }

        .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(255, 255, 255, 0.95) 100%) !important;
            transform: translateY(-5px) scale(1.03) !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 30px rgba(59, 130, 246, 0.1) !important;
            border-color: var(--primary) !important;
            backdrop-filter: blur(10px);
        }

        .option:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.12) 100%) !important;
            transform: translateY(-3px) scale(1.03) !important;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.2) !important;
            border-color: var(--primary) !important;
        }

        .quiz-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.08) !important;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25) !important;
            filter: brightness(1.1);
        }

        .action-btn:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
            color: white !important;
            transform: scale(1.15) rotate(8deg) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5) !important;
        }

        /* Ultra Modern Dropdown */
        .modern-dropdown {
            position: relative;
            margin-top: 12px;
        }

        .modern-dropdown select {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 2px solid transparent;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--surface) 0%, var(--glass) 100%);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .modern-dropdown select:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.08) 100%);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .modern-dropdown select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 8px 25px rgba(59, 130, 246, 0.25);
            transform: translateY(-2px);
        }

        /* Enhanced Search with Blur Effect */
        .search-container {
            transition: all 0.4s ease;
        }

        .search-box {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .search-box:focus-within {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2);
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.15);
        }

        .search-blur-active .main-content > *:not(.search-container):not(.quiz-container) {
            filter: blur(8px);
            opacity: 0.7;
            pointer-events: none;
        }

        /* Beautiful Stats Cards */
        .stat-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.05) !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2) !important;
        }

        /* Modern Progress Bars */
        .progress-fill {
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark), #8b5cf6) !important;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.4);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Beautiful Notification */
        .notification {
            border-radius: 20px !important;
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15)) !important;
        }

        .dark-mode .notification {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2)) !important;
        }

        /* Enhanced Question Cards */
        .question-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .question-card:hover {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-3px);
            border-color: var(--primary-light);
        }

        /* Modern Settings Panel */
        .settings-panel {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
        }

        .dark-mode .settings-panel {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Question Creator */
        .custom-question-creator {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 32px;
        }

        .dark-mode .custom-question-creator {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.15) rotate(15deg);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.6);
        }

        /* Dark mode adjustments */
        .dark-mode .nav-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.1) 100%) !important;
        }

        .dark-mode .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(17, 24, 39, 0.95) 100%) !important;
        }

        .dark-mode .option:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.08) 100%) !important;
        }

        /* Search Results Highlight */
        .search-highlight {
            background: linear-gradient(120deg, var(--primary-light) 0%, transparent 50%);
            border-radius: 4px;
            padding: 2px 4px;
        }
        @media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 12px 16px;
    }

    .stat-card {
        padding: 16px 12px;
        min-height: 80px;
    }

    .stat-header {
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

    .stat-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }

    .stat-value {
        font-size: 20px;
        margin-bottom: 2px;
    }

    .stat-label {
        font-size: 11px;
        line-height: 1.3;
    }

    .stat-trend {
        font-size: 10px;
    }

    .stat-trend i {
        font-size: 10px;
    }
}

/* Extra small devices (phones under 400px) */
@media (max-width: 400px) {
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 10px 12px;
    }

    .stat-card {
        padding: 14px 10px;
        min-height: 70px;
    }

    .stat-value {
        font-size: 18px;
    }

    .stat-label {
        font-size: 10px;
    }
}
.analytics-grid {
    display: none;
}

/* OR hide individual cards */
.analytics-card {
    display: none;
}

/* If you want to keep the section structure but hide content */
.analytics-section {
    padding: 0;
    margin: 0;
    height: 0;
    overflow: hidden;
}
@media (max-width: 768px) {
    /* Your existing mobile styles... */
    
    .sidebar {
        width: 66vw;
    }

    .main-content.sidebar-open {
        margin-left: 100vw;
    }

    .top-nav {
        padding: 12px 16px;
        flex-wrap: wrap;
        gap: 12px;
    }

    /* Hide all custom question and export buttons on mobile */
    .fab {
        display: none !important;
    }
    
    #createCustomQuizBtn {
        display: none !important;
    }
    
    /* Hide both buttons in Settings section */
    .settings-panel .quiz-btn:has(i.fa-download),
    .settings-panel .quiz-btn:has(i.fa-plus) {
        display: none !important;
    }

    /* Your stats grid and other mobile styles... */
    .stats-grid {
        display: flex;
        overflow-x: auto;
        gap: 6px;
        padding: 6px 10px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        margin: 0 -4px;
    }
    /* ... rest of your mobile CSS */
}
@media (max-width: 768px) {
    .fab {
        display: none !important;
    }
    
    /* Hide entire export section from Dashboard */
    .export-section {
        display: none !important;
    }
    
    /* Hide both buttons in Settings section */
    .settings-panel .quiz-btn:has(i.fa-download),
    .settings-panel .quiz-btn:has(i.fa-plus) {
        display: none !important;
    }
}
@media (max-width: 768px) {
    /* Hide all stat cards except Correct Answers */
    .stat-card:not(:first-child) {
        display: none !important;
    }
    
    /* Optional: Make the Correct Answers card full width */
    .stat-card:first-child {
        width: 100% !important;
        flex: 1 !important;
    }

    /* Your existing mobile styles for stats grid */
    .stats-grid {
        display: flex;
        overflow-x: auto;
        gap: 6px;
        padding: 6px 10px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        margin: 0 -4px;
    }
}
.user-avatar img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}
/* Primary action button */
.action-btn.primary {
    background: var(--primary);
    color: white;
}

.action-btn.primary:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
}

    </style>
</head>
<body class="dark-mode">
    <div class="overlay" id="overlay"></div>
    
    <!-- Custom Quiz Modal -->
<div class="custom-quiz-modal" id="customQuizModal">
    <div class="custom-quiz-content glass-effect">
        <h3 class="custom-quiz-title"> </h3>
        <div class="custom-quiz-options">
            <div class="custom-quiz-option" data-category="all">
                <div class="option-selector"></div>
                <label>All Categories</label>
            </div>
            <div class="custom-quiz-option" data-category="easy">
                <div class="option-selector"></div>
                <label>Easy Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="medium">
                <div class="option-selector"></div>
                <label>Medium Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="hard">
                <div class="option-selector"></div>
                <label>Hard Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="bookmarked">
                <div class="option-selector"></div>
                <label>Bookmarked Questions Only</label>
            </div>
            <div class="quiz-options-section">
                <label>Number of Questions</label>
                <div class="modern-dropdown">
                    <select id="questionCount">
                        <option value="5">5 Questions</option>
                        <option value="10" selected>10 Questions</option>
                        <option value="15">15 Questions</option>
                        <option value="20">20 Questions</option>
                        <option value="0">All Questions</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="custom-quiz-actions">
            <button class="quiz-btn" id="cancelCustomQuiz">
                Cancel
            </button>
            <button class="quiz-btn check-btn" id="createCustomQuiz">
                Create Quiz
            </button>
        </div>
    </div>
</div>
    
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-stethoscope"></i>
                    <span>ALIF</span>
                </div>
                <div class="sidebar-subtitle">Advanced Medical Education Platform</div>
            </div>
            
            <div class="user-profile">
    <div class="user-avatar">
        <img src="logo.png" alt="User Avatar">
    </div>
    <div class="user-info">
        <h3>ALIFO</h3>
        <p>Medical Student</p>
    </div>
</div>

            
            <div class="nav-item active">
                <div class="nav-icon">
                    <i class="fas fa-home"></i>
                </div>
                <span>Dashboard</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span>My Courses</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span>Progress Analytics</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-bookmark"></i>
                </div>
                <span>Bookmarked Questions</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <span>Settings</span>
            </div>
            
            <div class="categories-section">
                <div class="section-title">
                    <span>Medical Categories</span>
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div class="categories-grid" id="categoriesGrid"></div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Top Navigation -->
            <div class="top-nav">
    <div class="nav-left">
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle Sidebar">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Add Back and Home buttons -->
        <a href="/" class="action-btn" id="backBtn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <a href="/" class="action-btn primary">
            <i class="fas fa-home"></i>
        </a>
        
        <h1 class="page-title" id="pageTitle">Dashboard</h1>
    </div>
    <div class="nav-right">
        <!-- Your existing mode selector and buttons -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="exam" aria-label="Exam Mode">
                <i class="fas fa-file-alt"></i>
                Exam
            </button>
            <button class="mode-btn" data-mode="quiz" aria-label="Quiz Mode">
                <i class="fas fa-tasks"></i>
                Quiz
            </button>
            <button class="mode-btn" data-mode="learn" aria-label="Learn Mode">
                <i class="fas fa-brain"></i>
                Learn
            </button>
        </div>
        <div class="action-btn" id="themeToggle" aria-label="Toggle Theme">
            <i class="fas fa-sun"></i>
        </div>
        <div class="action-btn" aria-label="Notifications">
            <i class="fas fa-bell"></i>
        </div>
    </div>
</div>
            
            <!-- Search Section -->
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search questions or categories...">
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+12%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="correctAnswers">0</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-down" style="color: var(--error);"></i>
                            <span style="color: var(--error); font-size: 13px;">-5%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="timeSpent">0h</div>
                    <div class="stat-label">Time Spent</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+8%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="masteryLevel">0%</div>
                    <div class="stat-label">Mastery Level</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--warning);"></i>
                            <span style="color: var(--warning); font-size: 13px;">+3</span>
                        </div>
                    </div>
                    <div class="stat-value" id="streakCount">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div class="analytics-section">
                <h3 class="analytics-title">Learning Analytics</h3>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-value" id="weakAreasCount">0</div>
                        <div class="analytics-label">Weak Areas Identified</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="avgTimePerQuestion">0s</div>
                        <div class="analytics-label">Avg Time Per Question</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="improvementRate">0%</div>
                        <div class="analytics-label">Weekly Improvement</div>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Container -->
            <div class="quiz-container" id="quizContainer"></div>
            
            <!-- Results Screen -->
            <div class="results-screen hidden" id="resultsScreen"></div>
            
            <!-- Export Section -->
            <div class="export-section">
                <button class="export-btn" id="exportProgress">
                    <i class="fas fa-download"></i>
                     
                </button>
                <button class="export-btn" id="createCustomQuizBtn" style="margin-left: 12px;">
                    <i class="fas fa-plus"></i>
                     
                </button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  // Check if running inside Telegram
  const tg = window.Telegram?.WebApp;

  // --- 1️⃣ Handle Telegram Mini App Back Button ---
  if (tg) {
    tg.ready(); // Initialize Telegram SDK
    tg.BackButton.show();

    tg.BackButton.onClick(() => {
      console.log("Telegram back button pressed");
      handleBackAction();
    });
  }

  // --- 2️⃣ Handle Browser/Phone Back Button ---
  window.addEventListener('popstate', () => {
    console.log("Browser back button pressed");
    handleBackAction();
  });

  // --- 3️⃣ Function to handle back action globally ---
  function handleBackAction() {
    // Example actions (customize as you wish):
    // Go back if possible, otherwise go to home page
    if (document.referrer && window.history.length > 1) {
      window.history.back();
    } else {
      window.location.href = '/'; // or your home page route
    }
  }

  // --- 4️⃣ Optional: Prevent unwanted exits ---
  // This ensures pressing back doesn’t immediately close the app
  history.pushState(null, '', location.href);
</script>

     <script>
        // Anti-copy, anti-inspect measures
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
});
document.addEventListener('keydown', function(e) {
    if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.ctrlKey && e.shiftKey && e.keyCode === 74) || (e.ctrlKey && e.keyCode === 85)) {
        e.preventDefault();
    }
});

// Enhanced quiz data with more questions
const quizData = [
    {
        "id": 1,
        "question": "Bone marrow cells from an organ donor are cultured in vitro at 37°C in the presence of recombinant erythropoietin. A photomicrograph of a typical “burst-forming unit” is shown in the image. This colony, committed to the erythrocyte pathway of differentiation, represents an example of which of the following physiologic adaptations to transmembrane signaling?",
        "options": [
            "(A) Atrophy",
            "(B) Dysplasia",
            "(C) Hyperplasia",
            "(D) Hypertrophy",
            "(E) Metaplasia"
        ],
        "answer": 2,
        "correctAnswer": "Hyperplasia",
        "explanation": "Hyperplasia is defined as an increase in the number of cells in an organ or tissue. Like hypertrophy, it is often a response to trophic signals or increased functional demand and is commonly a normal process. Erythroid hyperplasia is typically seen in people living at high altitude. Low oxygen tension evokes the production of erythropoietin, which promotes the survival and proliferation of erythroid precursors in the bone marrow. The cellular and molecular mechanisms that are responsible for hyperplasia clearly relate to the control of cell proliferation (i.e., cell cycle).",
        "whyNotOtherOptions": {
            "a": "Atrophy refers to a decrease in cell size or number, often due to reduced demand or disuse.",
            "b": "Dysplasia involves abnormal cell maturation and organization, often preneoplastic.",
            "d": "Hypertrophy is an increase in cell size, not number.",
            "e": "Metaplasia is the replacement of one differentiated cell type with another."
        },
        "relatedQuestions": ["12", "41"],
        "category": "Cell Injury",
        "difficulty": "Easy"
    },
    {
        "id": 2,
        "question": "A 50-year-old chronic alcoholic presents to the emergency room with 12 hours of severe abdominal pain. The pain radiates to the back and is associated with an urge to vomit. Physical examination discloses exquisite abdominal tenderness. Laboratory studies show elevated serum amylase. Which of the following morphologic changes would be expected in the peripancreatic tissue of this patient?",
        "options": [
            "(A) Coagulative necrosis",
            "(B) Caseous necrosis",
            "(C) Fat necrosis",
            "(D) Fibrinoid necrosis",
            "(E) Liquefactive necrosis"
        ],
        "answer": 2,
        "correctAnswer": "Fat necrosis",
        "explanation": "Saponification of fat derived from peripancreatic fat cells exposed to pancreatic enzymes is a typical feature of fat necrosis. Lipase, released from pancreatic acinar cells during an attack of acute pancreatitis, hydrolyzes fat into fatty acids and glycerol. Free fatty acids bind with calcium to form soaps, which is a process known as saponification. Entry of calcium ions into the injured tissue reduces the level of calcium in blood. Hypocalcemia is, therefore, a typical finding in patients who had a recent bout of acute pancreatitis. Patients with acute pancreatitis experience sudden-onset abdominal pain, distention, and vomiting.",
        "whyNotOtherOptions": {
            "a": "Coagulative necrosis preserves cell outlines, seen in ischemic injury.",
            "b": "Caseous necrosis is cheese-like, typical of tuberculosis.",
            "d": "Fibrinoid necrosis occurs in vessel walls in vasculitis.",
            "e": "Liquefactive necrosis involves digestion, seen in brain or abscesses."
        },
        "relatedQuestions": ["13", "28"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 3,
        "question": "A 68-year-old man with a history of gastroesophageal reflux disease suffers a massive stroke and expires. The esophagus at autopsy is shown in the image. Histologic examination of the abnormal tissue shows intestine-like epithelium composed of goblet cells and surface cells similar to those of incompletely intestinalized gastric mucosa. There is no evidence of nuclear atypia. Which of the following terms best describes this morphologic response to persistent injury in the esophagus of this patient?",
        "options": [
            "(A) Atypical hyperplasia",
            "(B) Complex hyperplasia",
            "(C) Glandular metaplasia",
            "(D) Simple hyperplasia",
            "(E) Squamous metaplasia"
        ],
        "answer": 2,
        "correctAnswer": "Glandular metaplasia",
        "explanation": "The major adaptive responses of cells to sublethal injury are atrophy, hypertrophy, hyperplasia, metaplasia, dysplasia, and intracellular storage. Metaplasia is defined as the conversion of one differentiated cell pathway to another. In this case, the esophageal squamous epithelium is replaced by columnar epithelium as a result of chronic gastroesophageal reflux. The lesion is characterized histologically by intestine-like epithelium composed of goblet cells and cells similar to those of incompletely intestinalized gastric mucosa.",
        "whyNotOtherOptions": {
            "a": "Atypical hyperplasia involves abnormal cell growth, often in endometrium.",
            "b": "Complex hyperplasia is a preneoplastic change in endometrium.",
            "d": "Simple hyperplasia is increased cell number without atypia.",
            "e": "Squamous metaplasia occurs in bronchial epithelium of smokers."
        },
        "relatedQuestions": ["25", "39"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 4,
        "question": "A CT scan of a 43-year-old woman with a parathyroid adenoma and hyperparathyroidism reveals extensive calcium deposits in the lungs and kidney parenchyma. These radiologic findings are best explained by which of the following mechanisms of disease?",
        "options": [
            "(A) DNA",
            "(B) Glycogen",
            "(C) Lipid",
            "(D) mRNA",
            "(E) Water"
        ],
        "answer": 3,
        "correctAnswer": "Metastatic calcification",
        "explanation": "Metastatic calcification is associated with an increased serum calcium concentration (hypercalcemia). Almost any disorder that increases serum calcium levels can lead to calcification in the alveolar septa of the lung, renal tubules, and blood vessels. The patient in this case had a parathyroid adenoma that produced large quantities of parathyroid hormone. Other examples of metastatic calcification include multiple opacities in the cornea of a child given large amounts of vitamin D and partially calcified alveolar septa in the lungs of a patient with breast cancer metastatic to bone.",
        "whyNotOtherOptions": {
            "a": "DNA is not involved in calcification mechanisms.",
            "b": "Glycogen accumulation is seen in diabetes, not calcification.",
            "c": "Lipid relates to fat necrosis or atherosclerosis.",
            "d": "mRNA is involved in protein synthesis, like hypertrophy.",
            "e": "Water influx causes hydropic swelling."
        },
        "relatedQuestions": ["8", "32"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 5,
        "question": "A 75-year-old woman with Alzheimer disease dies of congestive heart failure. The brain at autopsy is shown in the image. This patient’s brain exemplifies which of the following responses to chronic injury?",
        "options": [
            "(A) Anaplasia",
            "(B) Atrophy",
            "(C) Dysplasia",
            "(D) Hyperplasia",
            "(E) Hypertrophy"
        ],
        "answer": 1,
        "correctAnswer": "Atrophy",
        "explanation": "Clinically, atrophy is recognized as diminution in the size or function of an organ. It is often seen in areas of vascular insufficiency or chronic inflammation and may result from disuse. Atrophy may be thought of as an adaptive response to stress, in which the cell shuts down its differentiated functions. Reduction in the size of an organ may reflect reversible cell atrophy or may be caused by irreversible loss of cells. For example, atrophy of the brain in this patient with Alzheimer disease is secondary to extensive cell death, and the size of the organ cannot be restored. This patient’s brain shows marked atrophy of the frontal lobe. The gyri are thinned, and sulci are widened.",
        "whyNotOtherOptions": {
            "a": "Anaplasia represents lack of differentiated features in a neoplasm.",
            "c": "Dysplasia is disordered maturation, preneoplastic.",
            "d": "Hyperplasia increases cell number.",
            "e": "Hypertrophy increases cell size."
        },
        "relatedQuestions": ["19", "31"],
        "category": "Cell Injury",
        "difficulty": "Easy"
    },
    {
        "id": 6,
        "question": "A 68-year-old woman with a history of heavy smoking and repeated bouts of pneumonia presents with a 2-week history of fever and productive cough. A chest X-ray reveals a right lower lobe infiltrate. A transbronchial biopsy confirms pneumonia and further demonstrates preneoplastic changes within the bronchial mucosa. Which of the following best characterizes the morphology of this bronchial mucosal lesion?",
        "options": [
            "(A) Abnormal pattern of cellular maturation",
            "(B) Increased numbers of otherwise normal cells",
            "(C) Invasiveness through the basement membrane",
            "(D) Transformation of one differentiated cell type to another",
            "(E) Ulceration and necrosis of epithelial cells"
        ],
        "answer": 0,
        "correctAnswer": "Abnormal pattern of cellular maturation",
        "explanation": "Cells that compose an epithelium exhibit uniformity of size and shape, and they undergo maturation in an orderly fashion (e.g., from plump basal cells to flat superficial cells in a squamous epithelium). When we speak of dysplasia, we mean that this regular appearance is disturbed by (1) variations in the size and shape of the cells; (2) enlargement, irregularity, and hyperchromatism of the nuclei; and (3) disorderly arrangement of the cells within the epithelium. Dysplasia of the bronchial epithelium is a reaction of respiratory epithelium to carcinogens in tobacco smoke. It is potentially reversible if the patient stops smoking but is considered preneoplastic and may progress to carcinoma.",
        "whyNotOtherOptions": {
            "b": "Increased numbers describe hyperplasia.",
            "c": "Invasiveness connotes malignancy.",
            "d": "Transformation to another cell type is metaplasia.",
            "e": "Ulceration and necrosis are seen in severe injury."
        },
        "relatedQuestions": ["40", "42"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 7,
        "question": "A 64-year-old man with long-standing angina pectoris and arterial hypertension dies of spontaneous intracerebral hemorrhage. At autopsy, the heart appears globoid. The left ventricle measures 2.8 cm on cross section (shown in the image). This adaptation to chronic injury was mediated primarily by changes in the intracellular concentration of which of the following components?",
        "options": [
            "(A) DNA",
            "(B) Glycogen",
            "(C) Lipid",
            "(D) mRNA",
            "(E) Water"
        ],
        "answer": 3,
        "correctAnswer": "mRNA",
        "explanation": "Hypertrophic cardiac myocytes have more cytoplasm and larger nuclei than normal cells. Although the elucidation of the cellular and molecular mechanisms underlying the hypertrophic response is still actively pursued, it is clear that the final steps include increases in mRNA, rRNA, and protein. Hypertrophy results from transcriptional regulation.",
        "whyNotOtherOptions": {
            "a": "Aneuploidy (DNA) is not a feature of myofiber hypertrophy.",
            "b": "Glycogen is stored in some conditions but not primary in hypertrophy.",
            "c": "Lipid accumulation is seen in fatty change.",
            "e": "Water influx is typical of hydropic swelling in acute injury."
        },
        "relatedQuestions": ["17"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 8,
        "question": "A 24-year-old woman contracts toxoplasmosis during her pregnancy and delivers a neonate at 37 weeks of gestation with a severe malformation of the central nervous system. MRI studies of the neonate reveal porencephaly and hydrocephalus. An X-ray film of the head shows irregular densities in the basal ganglia. These X-ray findings are best explained by which of the following mechanisms of disease?",
        "options": [
            "(A) Amniotic fluid embolism",
            "(B) Dystrophic calcification",
            "(C) Granulomatous inflammation",
            "(D) Metastatic calcification",
            "(E) Organ immaturity"
        ],
        "answer": 1,
        "correctAnswer": "Dystrophic calcification",
        "explanation": "Dystrophic calcification reflects underlying cell injury. Serum levels of calcium are normal, and the calcium deposits are located in previously damaged tissue. Intrauterine Toxoplasma infection affects approximately 0.1% of all pregnancies. Acute encephalitis in the fetus afflicted with TORCH syndrome may be associated with foci of necrosis that become calcified. Microcephaly, hydrocephalus, and microgyria are frequent complications of these intrauterine infections.",
        "whyNotOtherOptions": {
            "a": "Amniotic fluid embolism causes pulmonary issues in mother.",
            "c": "Granulomatous inflammation is seen in tuberculosis.",
            "d": "Metastatic calcification reflects hypercalcemia.",
            "e": "Organ immaturity does not cause calcification."
        },
        "relatedQuestions": ["4", "32"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 9,
        "question": "A 30-year-old man with AIDS-dementia complex develops acute pneumonia and dies of respiratory insufficiency. At autopsy, many central nervous system neurons display hydropic degeneration. This manifestation of sublethal neuronal injury was most likely mediated by impairment of which of the following cellular processes?",
        "options": [
            "(A) DNA synthesis",
            "(B) Lipid peroxidation",
            "(C) Mitotic spindle assembly",
            "(D) Plasma membrane sodium transport",
            "(E) Ribosome biosynthesis"
        ],
        "answer": 3,
        "correctAnswer": "Plasma membrane sodium transport",
        "explanation": "Hydropic swelling reflects acute, reversible (sublethal) cell injury. It results from impairment of cellular volume regulation, a process that controls ionic concentrations in the cytoplasm. This regulation, particularly for sodium, involves (1) the plasma membrane, (2) the plasma membrane sodium pump, and (3) the supply of ATP. Injurious agents may interfere with these membrane-regulated processes. Accumulation of sodium in the cell leads to an increase in water content to maintain isosmotic conditions, and the cell then swells.",
        "whyNotOtherOptions": {
            "a": "DNA synthesis impairment affects replication.",
            "b": "Lipid peroxidation is often a feature of irreversible injury.",
            "c": "Mitotic spindle relates to division.",
            "e": "Ribosome biosynthesis affects protein synthesis."
        },
        "relatedQuestions": ["34"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 10,
        "question": "A 62-year-old man is brought to the emergency room in a disoriented state. Physical examination reveals jaundice, splenomegaly, and ascites. Serum levels of ALT, AST, alkaline phosphatase, and bilirubin are all elevated. A liver biopsy demonstrates alcoholic hepatitis with Mallory bodies. These cytoplasmic structures are composed of interwoven bundles of which of the following proteins?",
        "options": [
            "(A) α1-Antitrypsin",
            "(B) β-Amyloid (Aβ)",
            "(C) Intermediate filaments",
            "(D) Prion protein (PrP)",
            "(E) α-Synuclein"
        ],
        "answer": 2,
        "correctAnswer": "Intermediate filaments",
        "explanation": "Hyaline is a term that refers to any material that exhibits a reddish, homogeneous appearance when stained with hematoxylin and eosin (H&E). Standard terminology includes hyaline arteriolosclerosis, alcoholic hyaline in the liver, hyaline membranes in the lung, and hyaline droplets in various cells. Alcoholic (Mallory) hyaline is composed of cytoskeletal intermediate filaments (cytokeratins), whereas pulmonary hyaline membranes consist of plasma proteins deposited in alveoli.",
        "whyNotOtherOptions": {
            "a": "Structurally abnormal α1-antitrypsin molecules accumulate in the liver of patients with α1-antitrypsin deficiency.",
            "b": "β-Amyloid accumulates in Alzheimer disease.",
            "d": "Prion protein in Creutzfeldt-Jakob disease.",
            "e": "α-Synuclein accumulates in neurons in Parkinson disease."
        },
        "relatedQuestions": ["47"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 11,
        "question": "A 65-year-old man suffers a heart attack and expires. Examination of the lungs at autopsy reveals numerous pigmented nodules scattered throughout the parenchyma (shown in the image). What is the appropriate diagnosis?",
        "options": [
            "(A) Anthracosis",
            "(B) Asbestosis",
            "(C) Hemosiderosis",
            "(D) Sarcoidosis",
            "(E) Silicosis"
        ],
        "answer": 0,
        "correctAnswer": "Anthracosis",
        "explanation": "Anthracosis refers to the storage of carbon particles in the lung and regional lymph nodes. These particles accumulate in alveolar macrophages and are also transported to hilar and mediastinal lymph nodes, where the indigestible material is stored indefinitely within tissue macrophages. Although the gross appearance of the lungs of persons with anthracosis may be alarming, the condition is innocuous. Workers who mine hard coal (anthracite) develop pulmonary fibrosis, owing to the presence of toxic/fibrogenic dusts such as silica.",
        "whyNotOtherOptions": {
            "b": "Asbestosis involves asbestos fibers and fibrosis.",
            "c": "Hemosiderosis represents intracellular storage of iron.",
            "d": "Sarcoidosis is granulomatous disease.",
            "e": "Silicosis from silica dust."
        },
        "relatedQuestions": ["22", "24"],
        "category": "Cell Injury",
        "difficulty": "Easy"
    },
    {
        "id": 12,
        "question": "A 32-year-old woman with poorly controlled diabetes mellitus delivers a healthy boy at 38 weeks of gestation. As a result of maternal hyperglycemia during pregnancy, pancreatic islets in the neonate would be expected to show which of the following morphologic responses to injury?",
        "options": [
            "(A) Atrophy",
            "(B) Dysplasia",
            "(C) Hyperplasia",
            "(D) Metaplasia",
            "(E) Necrosis"
        ],
        "answer": 2,
        "correctAnswer": "Hyperplasia",
        "explanation": "Infants of diabetic mothers show a 5% to 10% incidence of major developmental abnormalities, including anomalies of the heart and great vessels and neural tube defects. The frequency of these lesions relates to the control of maternal diabetes during early gestation. During fetal development, the islet cells of the pancreas have proliferative capacity and respond to increased demand for insulin by undergoing physiologic hyperplasia. Fetuses exposed to hyperglycemia in utero may develop hyperplasia of the pancreatic β cells, which may secrete insulin autonomously and cause hypoglycemia at birth.",
        "whyNotOtherOptions": {
            "a": "Atrophy is decrease in size.",
            "b": "Dysplasia is abnormal maturation.",
            "d": "Metaplasia is cell type change.",
            "e": "Necrosis is cell death."
        },
        "relatedQuestions": ["1", "41"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 13,
        "question": "A 59-year-old female alcoholic is brought to the emergency room with a fever (38.7°C/103°F) and foul-smelling breath. The patient subsequently develops acute bronchopneumonia and dies of respiratory insufficiency. A pulmonary abscess is identified at autopsy (shown in the image). Histologic examination of the wall of this lesion would most likely demonstrate which of the following pathologic changes?",
        "options": [
            "(A) Caseous necrosis",
            "(B) Coagulative necrosis",
            "(C) Fat necrosis",
            "(D) Fibrinoid necrosis",
            "(E) Liquefactive necrosis"
        ],
        "answer": 4,
        "correctAnswer": "Liquefactive necrosis",
        "explanation": "When the rate of dissolution of the necrotic cells is faster than the rate of repair, the resulting morphologic appearance is termed liquefactive necrosis. The polymorphonuclear leukocytes of the acute inflammatory reaction are endowed with potent hydrolases that are capable of digesting dead cells. A sharply localized collection of these acute inflammatory cells in response to a bacterial infection produces rapid death and dissolution of tissue. The result is often an abscess defined as a cavity formed by liquefactive necrosis in a solid tissue.",
        "whyNotOtherOptions": {
            "a": "Caseous necrosis is seen in necrotizing granulomas.",
            "b": "Coagulative necrosis retains cell outline.",
            "c": "Fat necrosis in pancreatitis.",
            "d": "Fibrinoid necrosis in vasculitis."
        },
        "relatedQuestions": ["2", "28"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 14,
        "question": "A 20-year-old man from China is evaluated for persistent cough, night sweats, low-grade fever, and general malaise. A chest X-ray reveals findings “consistent with a Ghon complex.” Sputum cultures grow acid-fast bacilli. Examination of hilar lymph nodes in this patient would most likely demonstrate which of the following pathologic changes?",
        "options": [
            "(A) Caseous necrosis",
            "(B) Coagulative necrosis",
            "(C) Fat necrosis",
            "(D) Fibrinoid necrosis",
            "(E) Liquefactive necrosis"
        ],
        "answer": 0,
        "correctAnswer": "Caseous necrosis",
        "explanation": "Caseous necrosis is a characteristic of primary tuberculosis, in which the necrotic cells fail to retain their cellular outlines. They do not disappear by lysis, as in liquefactive necrosis, but persist indefinitely as amorphous, coarsely granular, eosinophilic debris. Grossly, this debris resembles clumpy cheese, hence the name caseous necrosis. Primary tuberculosis is often asymptomatic or presents with nonspecific symptoms, such as low-grade fever, loss of appetite, and occasional spells of coughing. The Ghon complex includes parenchymal consolidation and ipsilateral enlargement of hilar lymph nodes and is often accompanied by a pleural effusion.",
        "whyNotOtherOptions": {
            "b": "Coagulative in ischemia.",
            "c": "Fat in pancreatitis.",
            "d": "Fibrinoid in vessels.",
            "e": "Liquefactive in abscesses."
        },
        "relatedQuestions": ["13", "28"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 15,
        "question": "A 31-year-old woman complains of increased vaginal discharge of 1-month duration. A cervical Pap smear is shown in the image. Superficial epithelial cells are identified with arrows. When compared to cells from the deeper intermediate layer (top), the nuclei of these superficial cells exhibit which of the following cytologic features?",
        "options": [
            "(A) Karyolysis",
            "(B) Karyorrhexis",
            "(C) Pyknosis",
            "(D) Segmentation",
            "(E) Viral inclusion bodies"
        ],
        "answer": 2,
        "correctAnswer": "Pyknosis",
        "explanation": "Coagulative necrosis refers to light microscopic alterations in dying cells. When stained with the usual combination of hematoxylin and eosin, the cytoplasm of a necrotic cell is eosinophilic. The nucleus displays an initial clumping of chromatin followed by its redistribution along the nuclear membrane. In pyknosis, the nucleus becomes smaller and stains deeply basophilic as chromatin clumping continues.",
        "whyNotOtherOptions": {
            "a": "Karyolysis is dissolution of nucleus.",
            "b": "Karyorrhexis is fragmentation.",
            "d": "Segmentation in neutrophils.",
            "e": "Viral inclusions in infections."
        },
        "relatedQuestions": ["21", "35"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 16,
        "question": "A 30-year-old woman suffers a tonic-clonic seizure and presents with delirium and hydrophobia. The patient states that she was bitten on the hand by a bat about 1 month ago. The patient subsequently dies of respiratory failure. Viral particles are found throughout the brainstem and cerebellum at autopsy. In addition to direct viral cytotoxicity, the necrosis of virally infected neurons in this patient was mediated primarily by which of the following mechanisms?",
        "options": [
            "(A) Histamine release from mast cells",
            "(B) Humoral and cellular immunity",
            "(C) Neutrophil-mediated phagocytosis",
            "(D) Release of oxygen radicals from macrophages",
            "(E) Vasoconstriction and ischemia"
        ],
        "answer": 1,
        "correctAnswer": "Humoral and cellular immunity",
        "explanation": "Both humoral and cellular arms of the immune system protect against the harmful effects of viral infections. Thus, the presentation of viral proteins to the immune system immunizes the body against the invader and elicits both killer cells and the production of antiviral antibodies. These arms of the immune system eliminate virus-infected cells by either inducing apoptosis or directing complement-mediated cytolysis. In this patient, the rabies virus entered a peripheral nerve and was transported by retrograde axoplasmic flow to the spinal cord and brain. The inflammation is centered in the brainstem and spills into the cerebellum and hypothalamus.",
        "whyNotOtherOptions": {
            "a": "Histamine in allergy.",
            "c": "Neutrophils in bacterial infections.",
            "d": "Oxygen radicals in reperfusion.",
            "e": "Vasoconstriction in ischemia."
        },
        "relatedQuestions": ["46"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 17,
        "question": "A 52-year-old woman loses her right kidney following an automobile accident. A CT scan of the abdomen 2 years later shows marked enlargement of the left kidney. The renal enlargement is an example of which of the following adaptations?",
        "options": [
            "(A) Atrophy",
            "(B) Dysplasia",
            "(C) Hyperplasia",
            "(D) Hypertrophy",
            "(E) Metaplasia"
        ],
        "answer": 3,
        "correctAnswer": "Hypertrophy",
        "explanation": "Hypertrophy is a response to trophic signals or increased functional demand and is commonly a normal process. For example, if one kidney is rendered inoperative because of vascular occlusion, the contralateral kidney hypertrophies to accommodate increased demand. The molecular basis of hypertrophy reflects increased expression of growth-promoting genes (protooncogenes) such as myc, fos, and ras.",
        "whyNotOtherOptions": {
            "a": "Atrophy is decrease.",
            "b": "Dysplasia abnormal maturation.",
            "c": "Hyperplasia may occur but enlargement is hypertrophy.",
            "e": "Metaplasia cell type change."
        },
        "relatedQuestions": ["7"],
        "category": "Cell Injury",
        "difficulty": "Easy"
    },
    {
        "id": 18,
        "question": "An 82-year-old man has profound bleeding from a peptic ulcer and dies of hypovolemic shock. The liver at autopsy displays centrilobular necrosis. Compared to viable hepatocytes, the necrotic cells contain higher intracellular concentrations of which of the following?",
        "options": [
            "(A) Calcium",
            "(B) Cobalt",
            "(C) Copper",
            "(D) Iron",
            "(E) Selenium"
        ],
        "answer": 0,
        "correctAnswer": "Calcium",
        "explanation": "Coagulative necrosis is characterized by a massive influx of calcium into the cell. Under normal circumstances, the plasma membrane maintains a steep gradient of calcium ions, whose concentration in interstitial fluids is 10,000 times higher than that inside the cell. Irreversible cell injury damages the plasma membrane, which then fails to maintain this gradient, allowing the influx of calcium into the cell.",
        "whyNotOtherOptions": {
            "b": "Cobalt not typically increased.",
            "c": "Copper in Wilson disease.",
            "d": "Iron in hemochromatosis.",
            "e": "Selenium antioxidant."
        },
        "relatedQuestions": ["20", "35"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 19,
        "question": "A 28-year-old woman is pinned by falling debris during a hurricane. An X-ray film of the leg reveals a compound fracture of the right tibia. The leg is immobilized in a cast for 6 weeks. When the cast is removed, the patient notices that her right leg is weak and visibly smaller in circumference than the left leg. Which of the following terms best describes this change in the patient’s leg muscle?",
        "options": [
            "(A) Atrophy",
            "(B) Hyperplasia",
            "(C) Metaplasia",
            "(D) Ischemic necrosis",
            "(E) Irreversible cell injury"
        ],
        "answer": 0,
        "correctAnswer": "Atrophy",
        "explanation": "The most common form of atrophy follows reduced functional demand. For example, after immobilization of a limb in a cast as treatment for a bone fracture, muscle cells atrophy, and muscular strength is reduced. The expression of differentiation genes is repressed. On restoration of normal conditions, atrophic cells are fully capable of resuming their differentiated functions; size increases to normal, and specialized functions, such as protein synthesis or contractile force, return to their original levels.",
        "whyNotOtherOptions": {
            "b": "Hyperplasia increase in number.",
            "c": "Metaplasia cell type change.",
            "d": "Ischemic necrosis from vascular issue.",
            "e": "Irreversible injury unlikely in cast."
        },
        "relatedQuestions": ["5", "31"],
        "category": "Cell Injury",
        "difficulty": "Easy"
    },
    {
        "id": 20,
        "question": "A 70-year-old man is hospitalized after suffering a mild stroke. While in the hospital, he suddenly develops crushing substernal chest pain. Analysis of serum proteins and ECG confirm a diagnosis of acute myocardial infarction. The patient subsequently develops an arrhythmia and expires. A cross section of the left ventricle at autopsy is shown in the image. Histologic examination of the affected heart muscle would demonstrate which of the following morphologic changes?",
        "options": [
            "(A) Caseous necrosis",
            "(B) Coagulative necrosis",
            "(C) Fat necrosis",
            "(D) Fibrinoid necrosis",
            "(E) Liquefactive necrosis"
        ],
        "answer": 1,
        "correctAnswer": "Coagulative necrosis",
        "explanation": "Ischemic necrosis of cardiac myocytes is the leading cause of death in the Western world. In brief, the interruption of blood supply to the heart decreases the delivery of O2 and glucose. Lack of O2 impairs mitochondrial electron transport, thereby decreasing ATP synthesis and facilitating the production of reactive oxygen species. Mitochondrial damage promotes the release of cytochrome c to the cytosol, and the cell dies. The morphologic appearance of the necrotic cell has traditionally been termed coagulative necrosis because of its similarity to the coagulation of proteins that occurs upon heating.",
        "whyNotOtherOptions": {
            "a": "Caseous in TB.",
            "c": "Fat in pancreatitis.",
            "d": "Fibrinoid in vessels.",
            "e": "Liquefactive in brain."
        },
        "relatedQuestions": ["13", "18"],
        "category": "Cell Injury",
        "difficulty": "Easy"
    },
    {
        "id": 21,
        "question": "Which of the following histologic features would provide definitive evidence of necrosis in the myocardium of the patient described in Question 20?",
        "options": [
            "(A) Disaggregation of polyribosomes",
            "(B) Increased intracellular volume",
            "(C) Influx of lymphocytes",
            "(D) Mitochondrial swelling and calcification",
            "(E) Nuclear fragmentation"
        ],
        "answer": 4,
        "correctAnswer": "Nuclear fragmentation",
        "explanation": "Nuclear fragmentation (karyorrhexis and karyolysis) is a hallmark of coagulative necrosis.",
        "whyNotOtherOptions": {
            "a": "Disaggregation in reversible injury.",
            "b": "Increased volume in swelling.",
            "c": "Lymphocytes in chronic inflammation.",
            "d": "Mitochondrial swelling in reversible."
        },
        "relatedQuestions": ["15", "35"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 22,
        "question": "A 90-year-old woman with mild diabetes and Alzheimer disease dies in her sleep. At autopsy, hepatocytes are noted to contain golden cytoplasmic granules that do not stain with Prussian blue. Which of the following best accounts for pigment accumulation in the liver of this patient?",
        "options": [
            "(A) Advanced age",
            "(B) Alzheimer disease",
            "(C) Congestive heart failure",
            "(D) Diabetic ketoacidosis",
            "(E) Hereditary hemochromatosis"
        ],
        "answer": 0,
        "correctAnswer": "Advanced age",
        "explanation": "Substances that cannot be metabolized accumulate in cells. Examples include (1) endogenous substrates that are not processed because a key enzyme is missing (lysosomal storage diseases), (2) insoluble endogenous pigments (lipofuscin and melanin), and (3) exogenous particulates (silica and carbon). Lipofuscin is a “wear and tear” pigment of aging that accumulates in organs such as the brain, heart, and liver.",
        "whyNotOtherOptions": {
            "b": "Alzheimer has neurofibrillary tangles.",
            "c": "Heart failure causes hemosiderin.",
            "d": "Ketoacidosis not pigment.",
            "e": "Hemochromatosis stains blue with Prussian."
        },
        "relatedQuestions": ["11", "23"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 23,
        "question": "Which of the following mechanisms of disease best describes the pathogenesis of pigment accumulation in hepatocytes in the patient described in Question 22?",
        "options": [
            "(A) Degradation of melanin pigments",
            "(B) Inhibition of glycogen biosynthesis",
            "(C) Malabsorption and enhanced deposition of iron",
            "(D) Peroxidation of membrane lipids",
            "(E) Progressive oxidation of bilirubin"
        ],
        "answer": 3,
        "correctAnswer": "Peroxidation of membrane lipids",
        "explanation": "Lipofuscin is found in lysosomes and contains peroxidation products of unsaturated fatty acids. The presence of this pigment is thought to reflect continuing lipid peroxidation of cellular membranes as a result of inadequate defenses against activated oxygen radicals.",
        "whyNotOtherOptions": {
            "a": "Melanin degradation not involved.",
            "b": "Glycogen in diabetes.",
            "c": "Iron in hemochromatosis.",
            "e": "Bilirubin in jaundice."
        },
        "relatedQuestions": ["22", "27"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 24,
        "question": "A 45-year-old man presents with increasing abdominal girth and yellow discoloration of his skin and sclera. Physical examination reveals hepatomegaly and jaundice. A Prussian blue stain of a liver biopsy is shown in the image. What is the major intracellular iron storage protein in this patient’s hepatocytes?",
        "options": [
            "(A) Bilirubin",
            "(B) Haptoglobin",
            "(C) Hemoglobin",
            "(D) Hemosiderin",
            "(E) Transferrin"
        ],
        "answer": 3,
        "correctAnswer": "Hemosiderin",
        "explanation": "Hemosiderin is a partially denatured form of ferritin that aggregates easily and is recognized microscopically as yellow-brown granules in the cytoplasm, which turn blue with the Prussian blue reaction. In hereditary hemochromatosis, a genetic abnormality of iron absorption in the small intestine, excess iron is stored mostly in the form of hemosiderin, primarily in the liver.",
        "whyNotOtherOptions": {
            "a": "Bilirubin product of heme.",
            "b": "Haptoglobin binds free Hb.",
            "c": "Hemoglobin is the iron-containing pigment of RBCs.",
            "e": "Transferrin binds serum iron."
        },
        "relatedQuestions": ["11", "22"],
        "category": "Cell Injury",
        "difficulty": "Easy"
    },
    {
        "id": 25,
        "question": "A 60-year-old man with chronic cystitis complains of urinary frequency and pelvic discomfort. Digital rectal examination is unremarkable. Biopsy of the bladder mucosa reveals foci of glandular epithelium and chronic inflammatory cells. No cytologic signs of atypia or malignancy are observed. Which of the following terms best describes the morphologic response to chronic injury in this patient?",
        "options": [
            "(A) Atrophy",
            "(B) Dysplasia",
            "(C) Hyperplasia",
            "(D) Hypertrophy",
            "(E) Metaplasia"
        ],
        "answer": 4,
        "correctAnswer": "Metaplasia",
        "explanation": "Metaplasia of transitional epithelium to glandular epithelium is seen in patients with chronic inflammation of the bladder (cystitis glandularis). Metaplasia is considered to be a protective mechanism, but it is not necessarily a harmless process. For example, squamous metaplasia in a bronchus may protect against injury produced by tobacco smoke, but it also impairs the production of mucus and ciliary clearance of debris. Furthermore, neoplastic transformation may occur in metaplastic epithelium.",
        "whyNotOtherOptions": {
            "a": "Atrophy decrease.",
            "b": "Dysplasia atypia present.",
            "c": "Hyperplasia increase number.",
            "d": "Hypertrophy increase size."
        },
        "relatedQuestions": ["3", "39"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 26,
        "question": " conc A 60-year-old man is rushed to the hospital with acute liver failure. He undergoes successful orthotopic liver transplantation; however, the transplanted liver does not produce much bile for the first 3 days. Poor graft function in this patient is thought to be the result of “reperfusion injury.” Which of the following substances was the most likely cause of reperfusion injury in this patient’s transplanted liver?",
        "options": [
            "(A) Cationic proteins",
            "(B) Free ferric iron",
            "(C) Hydrochlorous acid",
            "(D) Lysosomal acid hydrolases",
            "(E) Reactive oxygen species"
        ],
        "answer": 4,
        "correctAnswer": "Reactive oxygen species",
        "explanation": "Ischemia/reperfusion (I/R) injury is a common clinical problem that arises in the setting of occlusive cardiovascular disease, infection, transplantation, shock, and many other circumstances. The genesis of I/R injury relates to the interplay between transient ischemia and the re-establishment of blood flow (reperfusion). Initially, ischemia produces a type of cellular damage that leads to the generation of free radical species. Subsequently, reperfusion provides abundant molecular oxygen (O2) to combine with free radicals to form reactive oxygen species. Oxygen radicals are formed inside cells through the xanthine oxidase pathway and released from activated neutrophils.",
        "whyNotOtherOptions": {
            "a": "Cationic in neutrophils.",
            "b": "Free iron in Fenton reaction but secondary.",
            "c": "HOCl from neutrophils.",
            "d": "Hydrolases in autophagy."
        },
        "relatedQuestions": ["27"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 27,
        "question": "A 68-year-old woman with a history of hyperlipidemia dies of cardiac arrhythmia following a massive heart attack. Peroxidation of which of the following molecules was primarily responsible for causing the loss of membrane integrity in cardiac myocytes in this patient?",
        "options": [
            "(A) Cholesterol",
            "(B) Glucose transport proteins",
            "(C) Glycosphingolipids",
            "(D) Phospholipids",
            "(E) Sodium-potassium ATPase"
        ],
        "answer": 3,
        "correctAnswer": "Phospholipids",
        "explanation": "During lipid peroxidation, hydroxyl radicals remove a hydrogen atom from the unsaturated fatty acids of membrane phospholipids. The lipid radicals so formed react with molecular oxygen and form a lipid peroxide radical. A chain reaction is initiated. Lipid peroxides are unstable and break down into smaller molecules. The destruction of the unsaturated fatty acids of phospholipids results in a loss of membrane integrity.",
        "whyNotOtherOptions": {
            "a": "Cholesterol in plaques.",
            "b": "Glucose proteins in diabetes.",
            "c": "Glycosphingolipids in storage.",
            "e": "Na-K ATPase in swelling."
        },
        "relatedQuestions": ["23", "26"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 28,
        "question": "A 22-year-old construction worker sticks himself with a sharp, rusty nail. Within 24 hours, the wound has enlarged to become a 1-cm sore that drains thick, purulent material. This skin wound illustrates which of the following morphologic types of necrosis?",
        "options": [
            "(A) Caseous necrosis",
            "(B) Coagulative necrosis",
            "(C) Fat necrosis",
            "(D) Fibrinoid necrosis",
            "(E) Liquefactive necrosis"
        ],
        "answer": 4,
        "correctAnswer": "Liquefactive necrosis",
        "explanation": "Polymorphonuclear leukocytes (segmented neutrophils) rapidly accumulate at sites of injury. They are loaded with acid hydrolases and are capable of digesting dead cells. A localized collection of these inflammatory cells may create an abscess with central liquefaction (pus). Liquefactive necrosis is also commonly seen in the brain.",
        "whyNotOtherOptions": {
            "a": "Caseous in granulomas.",
            "b": "Coagulative in ischemia.",
            "c": "Fat in pancreatitis.",
            "d": "Fibrinoid in vessels."
        },
        "relatedQuestions": ["13", "2"],
        "category": "Cell Injury",
        "difficulty": "Easy"
    },
    {
        "id": 29,
        "question": "A 42-year-old man undergoes liver biopsy for evaluation of the grade and stage of his hepatitis C virus infection. The biopsy reveals swollen (ballooned) hepatocytes and moderate lobular inflammatory activity (shown in the image). The arrow identifies an acidophilic (Councilman) body. Which of the following cellular processes best accounts for the presence of scattered acidophilic bodies in this liver biopsy?",
        "options": [
            "(A) Aggregation of intermediate filament proteins",
            "(B) Apoptotic cell death",
            "(C) Coagulative necrosis",
            "(D) Collagen deposition",
            "(E) Intracellular viral inclusions"
        ],
        "answer": 1,
        "correctAnswer": "Apoptotic cell death",
        "explanation": "Apoptosis is a programmed pathway of cell death that is triggered by a variety of extracellular and intracellular signals. It is often a self-defense mechanism, destroying cells that have been infected with pathogens or those in which genomic alterations have occurred. After staining with hematoxylin and eosin, apoptotic cells are visible under the light microscope as acidophilic (Councilman) bodies. These deeply eosinophilic structures represent membrane-bound cellular remnants that are extruded into the hepatic sinusoids.",
        "whyNotOtherOptions": {
            "a": "Aggregation in Mallory bodies.",
            "c": "Coagulative not scattered.",
            "d": "Collagen in fibrosis.",
            "e": "Inclusions in viral."
        },
        "relatedQuestions": ["30", "33"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 30,
        "question": "Which of the following biochemical changes characterizes the formation of acidophilic bodies in the patient described in Question 29?",
        "options": [
            "(A) Fragmentation of DNA",
            "(B) Loss of tumor suppressor protein p53",
            "(C) Mitochondrial swelling",
            "(D) Synthesis of arachidonic acid",
            "(E) Triglyceride accumulation"
        ],
        "answer": 0,
        "correctAnswer": "Fragmentation of DNA",
        "explanation": "Fragmentation of DNA is a hallmark of cells undergoing both necrosis and apoptosis, but apoptotic cells can be detected by demonstrating nucleosomal “laddering.” This pattern of DNA degradation is characteristic of apoptotic cell death. It results from the cleavage of chromosomal DNA at nucleosomes by endonucleases. Since nucleosomes are regularly spaced along the genome, a pattern of regular bands can be seen when fragments of cellular DNA are separated by electrophoresis.",
        "whyNotOtherOptions": {
            "b": "p53 in apoptosis trigger.",
            "c": "Mitochondrial in injury.",
            "d": "Arachidonic in inflammation.",
            "e": "Triglyceride in steatosis."
        },
        "relatedQuestions": ["29", "49"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 31,
        "question": "A 56-year-old woman with a history of hyperlipidemia and hypertension develops progressive, right renal artery stenosis. Over time, this patient’s right kidney is likely to demonstrate which of the following morphologic adaptations to partial ischemia?",
        "options": [
            "(A) Atrophy",
            "(B) Dysplasia",
            "(C) Hyperplasia",
            "(D) Hypertrophy",
            "(E) Neoplasia"
        ],
        "answer": 0,
        "correctAnswer": "Atrophy",
        "explanation": "Interference with blood supply to tissues is known as ischemia. Total ischemia results in cell death. Partial ischemia occurs after incomplete occlusion of a blood vessel or in areas of inadequate collateral circulation. This results in a chronically reduced oxygen supply, a condition often compatible with continued cell viability. Under such circumstances, cell atrophy is common. For example, it is frequently seen around the inadequately perfused margins of infarcts in the heart, brain, and kidneys.",
        "whyNotOtherOptions": {
            "b": "Dysplasia abnormal.",
            "c": "Hyperplasia increase.",
            "d": "Hypertrophy in contralateral.",
            "e": "Neoplasia cancer."
        },
        "relatedQuestions": ["5", "19"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 32,
        "question": "A 5-year-old boy suffers blunt trauma to the leg in an automobile accident. Six months later, bone trabeculae have formed within the striated skeletal muscle at the site of tissue injury. This pathologic condition is an example of which of the following morphologic adaptations to injury?",
        "options": [
            "(A) Atrophy",
            "(B) Dysplasia",
            "(C) Metaplasia",
            "(D) Metastatic calcification",
            "(E) Dystrophic calcification"
        ],
        "answer": 2,
        "correctAnswer": "Metaplasia",
        "explanation": "Myositis ossificans is a disease characterized by formation of bony trabeculae within striated muscle. It represents a form of osseous metaplasia (i.e., replacement of one differentiated tissue with another type of normal differentiated tissue).",
        "whyNotOtherOptions": {
            "a": "Atrophy decrease.",
            "b": "Dysplasia abnormal.",
            "d": "Metastatic hypercalcemia.",
            "e": "Dystrophic in damaged tissue without bone."
        },
        "relatedQuestions": ["4", "8"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 33,
        "question": "A 43-year-old man presents with a scaly, erythematous lesion on the dorsal surface of his left hand. A skin biopsy reveals atypical keratinocytes filling the entire thickness of the epidermis (shown in the image). The arrows point to apoptotic bodies. Which of the following proteins plays the most important role in mediating programmed cell death in this patient’s skin cancer?",
        "options": [
            "(A) Catalase",
            "(B) Cytochrome c",
            "(C) Cytokeratins",
            "(D) Myeloperoxidase",
            "(E) Superoxide dismutase"
        ],
        "answer": 1,
        "correctAnswer": "Cytochrome c",
        "explanation": "The mitochondrial membrane is a key regulator of apoptosis. When mitochondrial pores open, cytochrome c leaks out and activates Apaf-1, which converts procaspase-9 to caspase-9, resulting in the activation of downstream caspases (cysteine proteases). These effector caspases cleave target proteins, including endonucleases nuclear proteins, and cytoskeletal proteins to mediate the varied morphological and biochemical changes that accompany apoptosis.",
        "whyNotOtherOptions": {
            "a": "Catalase antioxidant.",
            "c": "Cytokeratins intermediate filaments.",
            "d": "Myeloperoxidase in neutrophils.",
            "e": "Superoxide dismutase antioxidant."
        },
        "relatedQuestions": ["29", "49"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 34,
        "question": "A 16-year-old girl with a history of suicidal depression swallows a commercial solvent. A liver biopsy is performed to assess the degree of damage to the hepatic parenchyma. Histologic examination demonstrates severe swelling of the centrilobular hepatocytes (shown in the image). Which of the following mechanisms of disease best accounts for the reversible changes noted in this liver biopsy?",
        "options": [
            "(A) Decreased stores of intracellular ATP",
            "(B) Increased storage of triglycerides and free fatty acids",
            "(C) Intracytoplasmic rupture of lysosomes",
            "(D) Mitochondrial membrane permeability transition",
            "(E) Protein aggregation due to increased cytosolic pH"
        ],
        "answer": 0,
        "correctAnswer": "Decreased stores of intracellular ATP",
        "explanation": "Hydropic swelling may result from many causes, including chemical and biologic toxins, infections, and ischemia. Injurious agents cause hydropic swelling by (1) increasing the permeability of the plasma membrane to sodium; (2) damaging the membrane sodium-potassium ATPase (pump); or (3) interfering with the synthesis of ATP, thereby depriving the pump of its fuel.",
        "whyNotOtherOptions": {
            "b": "Triglycerides in steatosis.",
            "c": "Lysosome rupture irreversible.",
            "d": "Mitochondrial transition irreversible.",
            "e": "pH increase not typical."
        },
        "relatedQuestions": ["9"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 35,
        "question": "A 40-year-old man is pulled from the ocean after a boating accident and resuscitated. Six hours later, the patient develops acute renal failure. Kidney biopsy reveals evidence of karyorrhexis and karyolysis in renal tubular epithelial cells. Which of the following biochemical events preceded these pathologic changes?",
        "options": [
            "(A) Activation of Na+ /K+ ATPase",
            "(B) Decrease in intracellular calcium",
            "(C) Decrease in intracellular pH",
            "(D) Increase in ATP production",
            "(E) Increase in intracellular pH"
        ],
        "answer": 2,
        "correctAnswer": "Decrease in intracellular pH",
        "explanation": "During periods of ischemia, anaerobic glycolysis leads to the overproduction of lactate and a decrease in intracellular pH. Lack of O2 during myocardial ischemia blocks the production of ATP. Pyruvate is reduced to lactate in the cytosol and lowers intracellular pH. The acidification of the cytosol initiates a downward spiral of events that propels the cell toward necrosis.",
        "whyNotOtherOptions": {
            "a": "ATPase inhibited.",
            "b": "Calcium increases.",
            "d": "ATP decreases.",
            "e": "pH decreases."
        },
        "relatedQuestions": ["18", "21"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 36,
        "question": "A 58-year-old man presents with symptoms of acute renal failure. His blood pressure is 220/130 mm Hg (malignant hypertension). While in the emergency room, the patient suffers a stroke and expires. Microscopic examination of the kidney at autopsy is shown in the image. Which of the following morphologic changes accounts for the red material in the wall of the artery?",
        "options": [
            "(A) Apoptosis",
            "(B) Caseous necrosis",
            "(C) Fat necrosis",
            "(D) Fibrinoid necrosis",
            "(E) Liquefactive necrosis"
        ],
        "answer": 3,
        "correctAnswer": "Fibrinoid necrosis",
        "explanation": "Fibrinoid necrosis is an alteration of injured blood vessels, in which the insudation and accumulation of plasma proteins cause the wall to stain intensely with eosin.",
        "whyNotOtherOptions": {
            "a": "Apoptosis programmed.",
            "b": "Caseous in TB.",
            "c": "Fat in pancreas.",
            "e": "Liquefactive digestion."
        },
        "relatedQuestions": ["2", "13"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 37,
        "question": "A 10-year-old girl presents with advanced features of progeria (patient shown in the image). This child has inherited mutations in the gene that encodes which of the following types of intracellular proteins?",
        "options": [
            "(A) Helicase",
            "(B) Lamin",
            "(C) Oxidase",
            "(D) Polymerase",
            "(E) Topoisomerase"
        ],
        "answer": 1,
        "correctAnswer": "Lamin",
        "explanation": "Hutchinson-Gilford progeria is a rare genetic disease characterized by early cataracts, hair loss, atrophy of the skin, osteoporosis, and atherosclerosis. This phenotype gives the impression of premature aging in children. Progeria is one of many diseases caused by mutations in the human lamin A gene (LMNA). Lamins are intermediate filament proteins that form a fibrous meshwork beneath the nuclear envelope. Defective lamin A is thought to make the nucleus unstable, leading to cell injury and death.",
        "whyNotOtherOptions": {
            "a": "Helicase in Werner syndrome.",
            "c": "Oxidase not.",
            "d": "Polymerase in replication.",
            "e": "Topoisomerase in DNA."
        },
        "relatedQuestions": ["48"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 38,
        "question": "A 32-year-old woman develops an Addisonian crisis (acute adrenal insufficiency) 3 months after suffering massive hemorrhage during the delivery of her baby. A CT scan of the abdomen shows small adrenal glands. Which of the following mechanisms of disease best accounts for adrenal atrophy in this patient?",
        "options": [
            "(A) Chronic inflammation",
            "(B) Chronic ischemia",
            "(C) Hemorrhagic necrosis",
            "(D) Lack of trophic signals",
            "(E) Tuberculosis"
        ],
        "answer": 3,
        "correctAnswer": "Lack of trophic signals",
        "explanation": "Atrophy of an organ may be caused by interruption of key trophic signals. Postpartum infarction of the anterior pituitary in this patient resulted in decreased production of adrenocorticotropic hormone (ACTH, also termed corticotropin). Lack of corticotropin results in atrophy of the adrenal cortex, which leads to adrenal insufficiency. Symptoms of acute adrenal insufficiency (Addisonian crisis) include hypotension and shock, as well as weakness, vomiting, abdominal pain, and lethargy.",
        "whyNotOtherOptions": {
            "a": "Chronic inflammation not postpartum.",
            "b": "Ischemia not.",
            "c": "Hemorrhagic in pituitary but atrophy from lack ACTH.",
            "e": "TB chronic."
        },
        "relatedQuestions": ["5", "19"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 39,
        "question": "A 47-year-old man with a history of heavy smoking complains of chronic cough. A “coin lesion” is discovered in his right upper lobe on chest X-ray. Bronchoscopy and biopsy fail to identify a mass, but the bronchial mucosa displays squamous metaplasia. What is the most likely outcome of this morphologic adaptation if the patient stops smoking?",
        "options": [
            "(A) Atrophy",
            "(B) Malignant transformation",
            "(C) Necrosis and scarring",
            "(D) Persistence throughout life",
            "(E) Reversion to normal"
        ],
        "answer": 4,
        "correctAnswer": "Reversion to normal",
        "explanation": "Metaplasia is almost invariably a response to persistent injury and can be thought of as an adaptive mechanism. Prolonged exposure of the bronchi to tobacco smoke leads to squamous metaplasia of the bronchial epithelium. Unlike malignancy and necrosis with scarring, metaplasia is usually fully reversible. If the source of injury in this patient is removed (the patient stops smoking), then the metaplastic epithelium will eventually return to normal.",
        "whyNotOtherOptions": {
            "a": "Atrophy not.",
            "b": "Malignant if continues.",
            "c": "Scarring in advanced.",
            "d": "Persistence if smoking continues."
        },
        "relatedQuestions": ["3", "25"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 40,
        "question": "A 60-year-old farmer presents with multiple patches of discoloration on his face. Biopsy of lesional skin reveals actinic keratosis. Which of the following terms best describes this response of the skin to chronic sunlight exposure?",
        "options": [
            "(A) Atrophy",
            "(B) Dysplasia",
            "(C) Hyperplasia",
            "(D) Hypertrophy",
            "(E) Metaplasia"
        ],
        "answer": 1,
        "correctAnswer": "Dysplasia",
        "explanation": "Actinic keratosis is a form of dysplasia in sun-exposed skin. Histologically, such lesions are composed of atypical squamous cells, which vary in size and shape. They show no signs of regular maturation as the cells move from the basal layer of the epidermis to the surface. Dysplasia is a preneoplastic lesion, in the sense that it is a necessary stage in the multistep evolution to cancer. However, unlike cancer cells, dysplastic cells are not entirely autonomous, and the histologic appearance of the tissue may still revert to normal.",
        "whyNotOtherOptions": {
            "a": "Atrophy thin skin.",
            "c": "Hyperplasia increase.",
            "d": "Hypertrophy size.",
            "e": "Metaplasia type change."
        },
        "relatedQuestions": ["6", "42"],
        "category": "Cell Injury",
        "difficulty": "Easy"
    },
    {
        "id": 41,
        "question": "A 59-year-old woman smoker complains of intermittent blood in her urine. Urinalysis confirms 4+ hematuria. A CBC reveals increased red cell mass (hematocrit). A CT scan demonstrates a 3-cm renal mass, and a CT-guided biopsy displays renal cell carcinoma. Which of the following cellular adaptations in the bone marrow best explains the increased hematocrit in this patient?",
        "options": [
            "(A) Atrophy",
            "(B) Dysplasia",
            "(C) Hyperplasia",
            "(D) Hypertrophy",
            "(E) Metaplasia"
        ],
        "answer": 2,
        "correctAnswer": "Hyperplasia",
        "explanation": "Renal cell carcinomas often secrete erythropoietin. This hormone stimulates the growth of erythrocyte precursors in the bone marrow by inhibiting programmed cell death. Increased hematocrit in this patient is the result of bone marrow hyperplasia affecting the erythroid lineage.",
        "whyNotOtherOptions": {
            "a": "Atrophy decrease.",
            "b": "Dysplasia abnormal.",
            "d": "Hypertrophy size.",
            "e": "Metaplasia type."
        },
        "relatedQuestions": ["1", "12"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 42,
        "question": "A 33-year-old woman has an abnormal cervical Pap smear. A cervical biopsy reveals that the epithelium lacks normal polarity (shown in the image). Individual cells display hyperchromatic nuclei, a larger nucleus-to-cytoplasm ratio, and disorderly tissue arrangement. Which of the following adaptations to chronic injury best describes these changes in the patient’s cervical epithelium?",
        "options": [
            "(A) Atrophy",
            "(B) Dysplasia",
            "(C) Hyperplasia",
            "(D) Hypertrophy",
            "(E) Metaplasia"
        ],
        "answer": 1,
        "correctAnswer": "Dysplasia",
        "explanation": "The distinction between severe dysplasia and early cancer of the cervix is a common diagnostic problem for the pathologist. Both are associated with disordered growth and maturation of the tissue. Similar to the development of cancer, dysplasia is believed to result from mutations in a proliferating cell population. When a particular mutation confers a growth or survival advantage, the progeny of the affected cell will tend to predominate. In turn, their continued proliferation provides the opportunity for further mutations. The accumulation of such mutations progressively distances the cell from normal regulatory constraints and may lead to neoplasia.",
        "whyNotOtherOptions": {
            "a": "Atrophy thin.",
            "c": "Hyperplasia number.",
            "d": "Hypertrophy size.",
            "e": "Metaplasia type."
        },
        "relatedQuestions": ["6", "40"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 43,
        "question": "A 24-year-old woman accidentally ingests carbon tetrachloride (CCl4) in the laboratory and develops acute liver failure. Which of the following cellular proteins was directly involved in the development of hepatotoxicity in this patient?",
        "options": [
            "(A) Acetaldehyde dehydrogenase",
            "(B) Alcohol dehydrogenase",
            "(C) Glucose-6-phosphate dehydrogenase",
            "(D) Mixed function oxygenase",
            "(E) Superoxide dismutase"
        ],
        "answer": 3,
        "correctAnswer": "Mixed function oxygenase",
        "explanation": "The metabolism of CCl4 is a model system for toxicologic studies. CCl4 is first metabolized via the mixed function oxygenase system (P450) of the liver to a chloride ion and a highly reactive trichloromethyl free radical. Like the hydroxyl radical, this radical is a potent initiator of lipid peroxidation, which damages the plasma membrane and leads to cell death.",
        "whyNotOtherOptions": {
            "a": "Acetaldehyde in alcohol.",
            "b": "Alcohol dehydrogenase in ethanol.",
            "c": "G6PD in hemolysis.",
            "e": "SOD antioxidant."
        },
        "relatedQuestions": ["45"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 44,
        "question": "A 30-year-old woman presents with a 2-month history of fatigue, mild fever, and an erythematous scaling rash. She also notes joint pain and swelling, primarily involving the small bones of her fingers. Physical examination reveals erythematous plaques with adherent silvery scales that induce punctate bleeding points when removed. Biopsy of lesional skin reveals markedly increased thickness of the epidermis (shown in the image). Which of the following terms best describes this adaptation to chronic injury in this patient with psoriasis?",
        "options": [
            "(A) Atrophy",
            "(B) Dysplasia",
            "(C) Hyperplasia",
            "(D) Hypertrophy",
            "(E) Metaplasia"
        ],
        "answer": 2,
        "correctAnswer": "Hyperplasia",
        "explanation": "Psoriasis is a disease of the dermis and epidermis that is characterized by persistent epidermal hyperplasia. It is a chronic, frequently familial disorder that features large, erythematous, scaly plaques, commonly on the dorsal extensor cutaneous surfaces. There is evidence to suggest that deregulation of epidermal proliferation and an abnormality in the microcirculation of the dermis are responsible for the development of psoriatic lesions. Abnormal proliferation of keratinocytes is thought to be related to defective epidermal cell surface receptors and altered intracellular signaling.",
        "whyNotOtherOptions": {
            "a": "Atrophy thin.",
            "b": "Dysplasia atypia.",
            "d": "Hypertrophy size.",
            "e": "Metaplasia type."
        },
        "relatedQuestions": ["1", "12"],
        "category": "Cell Injury",
        "difficulty": "Easy"
    },
    {
        "id": 45,
        "question": "A 24-year-old woman with chronic depression ingests a bottle of acetaminophen tablets. Two days later, she is jaundiced (elevated serum bilirubin) and displays symptoms of encephalopathy, including impairment in spatial perception. In the liver, toxic metabolites of acetaminophen are generated by which of the following organelles?",
        "options": [
            "(A) Golgi apparatus",
            "(B) Mitochondria",
            "(C) Nucleus",
            "(D) Peroxisomes",
            "(E) Smooth endoplasmic reticulum"
        ],
        "answer": 4,
        "correctAnswer": "Smooth endoplasmic reticulum",
        "explanation": "Carbon tetrachloride and acetaminophen are well-studied hepatotoxins. Each is metabolized by cytochrome P450 of the mixed-function oxidase system, located in the smooth endoplasmic reticulum. These hepatotoxins are metabolized differently, and it is possible to relate the subsequent evolution of lethal cell injury to the specific features of this metabolism. Acetaminophen, an important constituent of many analgesics, is innocuous in recommended doses, but when consumed to excess it is highly toxic to the liver. The metabolism of acetaminophen to yield highly reactive quinones is accelerated by alcohol consumption, an effect mediated by an ethanol-induced increase in cytochrome P450.",
        "whyNotOtherOptions": {
            "a": "Golgi packaging.",
            "b": "Mitochondria energy.",
            "c": "Nucleus DNA.",
            "d": "Peroxisomes oxidation."
        },
        "relatedQuestions": ["43"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 46,
        "question": "A 45-year-old woman presents with a 2-month history of fatigue and recurrent fever. She also complains of tenderness below the right costal margin and dark urine. Physical examination reveals jaundice and mild hepatomegaly. The serum is positive for hepatitis B virus antigen. Which of the following best describes the mechanism of indirect virus-mediated hepatocyte cell death in this patient?",
        "options": [
            "(A) Accumulation of abnormal cytoplasmic proteins",
            "(B) Immune recognition of viral antigens on the cell surface",
            "(C) Generation of cytoplasmic free radicals",
            "(D) Impaired plasma membrane Na+ /K+ ATPase activity",
            "(E) Interference with cellular energy generation"
        ],
        "answer": 1,
        "correctAnswer": "Immune recognition of viral antigens on the cell surface",
        "explanation": "Viral cytotoxicity is either direct or indirect (immunologically mediated). Viruses may injure cells directly by subverting cellular enzymes and depleting the cell’s nutrients, thereby disrupting the normal homeostatic mechanisms. Some viruses also encode proteins that induce apoptosis once daughter virions are mature. Viruses may also injure cells indirectly through activation of the immune system. Both humoral and cellular arms of the immune system protect against the harmful effects of viral infections by eliminating infected cells. In brief, the presentation of viral proteins to the immune system in the context of a self major histocompatibility complex on the cell surface immunizes the body against the invader and elicits both killer cells and antiviral antibodies. These arms of the immune system eliminate virus-infected cells by inducing apoptosis or by lysing the virally infected target cell with complement.",
        "whyNotOtherOptions": {
            "a": "Abnormal proteins in storage.",
            "c": "Free radicals in reperfusion.",
            "d": "ATPase in swelling.",
            "e": "Energy in ischemia evolving."
        },
        "relatedQuestions": ["16"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 47,
        "question": "You are asked to present a grand rounds seminar on the role of abnormal proteins in disease. In this connection, intracellular accumulation of an abnormally folded protein plays a role in the pathogenesis of which of the following diseases?",
        "options": [
            "(A) AA amyloidosis",
            "(B) AL amyloidosis",
            "(C) α1-Antitrypsin deficiency",
            "(D) Gaucher disease",
            "(E) Tay-Sachs disease"
        ],
        "answer": 2,
        "correctAnswer": "α1-Antitrypsin deficiency",
        "explanation": "Several acquired and inherited diseases are characterized by intracellular accumulation of abnormal proteins. The deviant tertiary structure of the protein may result from an inherited mutation that alters the normal primary amino acid sequence, or may reflect an acquired defect in protein folding. α1-Antitrypsin deficiency is a heritable disorder in which mutations in the gene for α1-antitrypsin yield an insoluble protein. The mutant protein is not easily exported. It accumulates in liver cells, causing cell injury and cirrhosis. Pulmonary emphysema is another complication of α1-antitrypsin deficiency.",
        "whyNotOtherOptions": {
            "a": "AA amyloid extracellular.",
            "b": "AL amyloid extracellular.",
            "d": "Gaucher lysosomal storage.",
            "e": "Tay-Sachs lysosomal."
        },
        "relatedQuestions": ["10"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 48,
        "question": "A 38-year-old woman shows evidence of early cataracts, hair loss, atrophy of skin, osteoporosis, and accelerated atherosclerosis. This patient has most likely inherited mutations in both alleles of a gene that encodes which of the following types of intracellular proteins?",
        "options": [
            "(A) Deaminase",
            "(B) Helicase",
            "(C) Oxidase",
            "(D) Polymerase",
            "(E) Topoisomerase"
        ],
        "answer": 1,
        "correctAnswer": "Helicase",
        "explanation": "Werner syndrome is a rare autosomal recessive disease characterized by early cataracts, hair loss, atrophy of the skin, osteoporosis, and accelerated atherosclerosis. Affected persons are also at risk for development of a variety of cancers. Unlike Hutchinson-Gilford progeria, patients with Werner syndrome typically die in the fifth decade from either cancer or cardiovascular disease. Werner syndrome is caused by mutations in the WRN gene, which encodes a protein with multiple DNA-dependent enzymatic functions, including proteins with ATPase, helicase, and exonuclease activity.",
        "whyNotOtherOptions": {
            "a": "Deaminase not.",
            "c": "Oxidase not.",
            "d": "Polymerase replication.",
            "e": "Topoisomerase DNA."
        },
        "relatedQuestions": ["37"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    },
    {
        "id": 49,
        "question": "A 28-year-old man with a history of radiation/bone marrow transplantation for leukemia presents with severe diarrhea. He subsequently develops septic shock and expires. Microscopic examination of the colon epithelium at autopsy reveals numerous acidophilic bodies and small cells with pyknotic nuclei. Which of the following proteins most likely played a key role in triggering radiation-induced cell death in this patient’s colonic mucosa?",
        "options": [
            "(A) Cytochrome P450",
            "(B) β-Catenin",
            "(C) E-Cadherin",
            "(D) P-Selectin",
            "(E) p53"
        ],
        "answer": 4,
        "correctAnswer": "p53",
        "explanation": "Apoptosis detects and destroys cells that harbor dangerous mutations, thereby maintaining genetic consistency and preventing the development of cancer. There are several means, the most important of which is probably p53, by which the cell recognizes genomic abnormalities and “assesses” whether they can be repaired. If the damage to DNA is so severe that it cannot be repaired, the cascade of events leading to apoptosis is activated, and the cell dies. This process protects an organism from the consequences of a non-functional cell or one that cannot control its own proliferation (e.g., a cancer cell). After it binds to areas of DNA damage, p53 activates proteins that arrest the cell in G1 of the cell cycle, allowing time for DNA repair to proceed. It also directs DNA repair enzymes to the site of injury. If the DNA damage cannot be repaired, p53 activates mechanisms that terminate in apoptosis.",
        "whyNotOtherOptions": {
            "a": "P450 metabolism.",
            "b": "β-Catenin Wnt.",
            "c": "E-Cadherin adhesion.",
            "d": "P-Selectin inflammation."
        },
        "relatedQuestions": ["30", "33"],
        "category": "Cell Injury",
        "difficulty": "Hard"
    }
];

// Core application variables
const overlay = document.getElementById('overlay');
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const categoriesGrid = document.getElementById('categoriesGrid');
const themeToggle = document.getElementById('themeToggle');
const quizContainer = document.getElementById('quizContainer');
const resultsScreen = document.getElementById('resultsScreen');
const pageTitle = document.getElementById('pageTitle');
const modeButtons = document.querySelectorAll('.mode-btn');
const correctAnswersEl = document.getElementById('correctAnswers');
const timeSpentEl = document.getElementById('timeSpent');
const masteryLevelEl = document.getElementById('masteryLevel');
const streakCountEl = document.getElementById('streakCount');
const searchInput = document.getElementById('searchInput');
const exportProgressBtn = document.getElementById('exportProgress');
const createCustomQuizBtn = document.getElementById('createCustomQuizBtn');
const customQuizModal = document.getElementById('customQuizModal');
const cancelCustomQuizBtn = document.getElementById('cancelCustomQuiz');
const createCustomQuizBtnModal = document.getElementById('createCustomQuiz');
const weakAreasCountEl = document.getElementById('weakAreasCount');
const avgTimePerQuestionEl = document.getElementById('avgTimePerQuestion');
const improvementRateEl = document.getElementById('improvementRate');

// Navigation elements
const navItems = document.querySelectorAll('.nav-item');

// Application state
let currentMode = 'exam';
let selectedCategories = [];
let currentQuestionIndex = 0;
let score = 0;
let userAnswers = [];
let questions = [];
let incorrectQuestions = [];
let isAnswerChecked = false;
let bookmarkedQuestions = new Set();
let userProgress = {};
let userStats = {
    totalQuestions: 0,
    correctAnswers: 0,
    timeSpent: 0,
    masteryLevel: 0,
    streak: 0,
    lastActive: null,
    weeklyProgress: []
};
let timerInterval = null;
let startTime = null;
let remainingTime = 0;
let isCountdown = false;
let examCheckMode = 'immediate';
let examSubmitted = false;
let questionTimers = [];
let searchResults = [];
let isSearchActive = false;
let currentPage = 'Dashboard';
let customQuestions = [];

// Core application functions
function init() {
    initializeCategories();
    initializeEventListeners();
    initializeNavigation();
    loadUserData();
    updateDashboardStats();
    updateAnalytics();
    showDashboard();
    createFAB();
    updateCustomQuizModalHTML();
}

function createFAB() {
    const fab = document.createElement('button');
    fab.className = 'fab';
    fab.innerHTML = '<i class="fas fa-plus"></i>';
    fab.title = 'Create Custom Question';
    fab.addEventListener('click', showCustomQuestionCreator);
    document.body.appendChild(fab);
}

function initializeNavigation() {
    navItems.forEach((item, index) => {
        item.addEventListener('click', () => {
            navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
            
            switch(index) {
                case 0: // Dashboard
                    currentPage = 'Dashboard';
                    showDashboard();
                    break;
                case 1: // My Courses
                    currentPage = 'courses';
                    showCourses();
                    break;
                case 2: // Progress Analytics
                    currentPage = 'analytics';
                    showAnalytics();
                    break;
                case 3: // Bookmarked Questions
                    currentPage = 'bookmarks';
                    showBookmarks();
                    break;
                case 4: // Settings
                    currentPage = 'settings';
                    showSettings();
                    break;
            }
            
            closeSidebar();
        });
    });
}

function showDashboard() {
    console.log('showDashboard called'); // Debug
    
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.search-container').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    
    // Reset page title
    pageTitle.textContent = 'Dashboard';
    updateDashboardStats();
    
    // ALWAYS load questions and show quiz layout
    questions = [...quizData, ...customQuestions];
    selectedCategories = [...new Set(questions.map(q => q.category))];
    
    // Reset quiz state
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    examSubmitted = false;
    
    console.log('Questions loaded:', questions.length);
    console.log('Current mode:', currentMode);
    
    // Force show quiz container
    quizContainer.classList.remove('hidden');
    resultsScreen.classList.add('hidden');
    
    if (questions.length > 0) {
        console.log('Calling renderQuizLayout...');
        renderQuizLayout();
    } else {
        console.log('No questions, showing message');
        showNoQuestionsMessage();
    }
}

function showCourses() {
    hideAllSections();
    pageTitle.textContent = 'My Courses';
    
    quizContainer.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 80px; color: var(--primary); margin-bottom: 20px; opacity: 0.8;">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary); background: linear-gradient(135deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">Learning Pathways</h2>
            <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                Structured learning paths designed to build your medical knowledge systematically.
            </p>
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; margin-top: 40px;">
                    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Anatomy Mastery', 'fas fa-brain', '#6366f1', 75, 'Build foundational anatomy knowledge')}
                    </div>
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Physiology Deep Dive', 'fas fa-heartbeat', '#06b6d4', 45, 'Understand body systems and functions')}
                   </div>
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Clinical Pathology', 'fas fa-virus', '#10b981', 30, 'Study diseases and diagnostics')}
                    </div> 
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Pharmacology', 'fas fa-pills', '#f59e0b', 20, 'Master drug mechanisms and effects')}
                    </div>
    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Medical Imaging', 'fas fa-x-ray', '#8b5cf6', 15, 'Learn radiology and imaging techniques')}
                    </div>
    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Emergency Medicine', 'fas fa-ambulance', '#ef4444', 10, 'Critical care and emergency procedures')}
                    </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createCourseCard(title, icon, color, progress, description) {
    return `
        <div class="category-card" style="text-align: left; cursor: pointer; border-left: 4px solid ${color};" onclick="startCourse('${title.toLowerCase()}')">
            <div class="category-header">
                <div class="category-icon" style="background: ${color}20; color: ${color};">
                    <i class="${icon}"></i>
                </div>
                <div>
                    <div class="category-name" style="font-size: 16px; font-weight: 600;">${title}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${description}</div>
                </div>
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${color}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 12px;">
                <span style="font-size: 11px; color: var(--text-tertiary);">${Math.floor(progress/10)}/10 Modules</span>
                <span style="font-size: 11px; color: ${color}; font-weight: 600;">Continue →</span>
            </div>
        </div>
    `;
}

function showAnalytics() {
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    pageTitle.textContent = 'Progress Analytics';
    updateAnalytics();
    
    quizContainer.innerHTML = `
        <div style="padding: 24px;">
            <div class="analytics-section glass-effect" style="border-radius: 24px; padding: 32px;">
                <h3 class="analytics-title" style="font-size: 24px; margin-bottom: 8px;">Performance Insights</h3>
                <p style="color: var(--text-secondary); margin-bottom: 32px;">Detailed analytics to optimize your learning journey</p>
                <div class="analytics-grid">
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: var(--primary);">${weakAreasCountEl.textContent}</div>
                        <div class="analytics-label">Areas Needing Focus</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #06b6d4;">${avgTimePerQuestionEl.textContent}</div>
                        <div class="analytics-label">Average Response Time</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #10b981;">${improvementRateEl.textContent}</div>
                        <div class="analytics-label">Weekly Progress Rate</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">📊 Learning Recommendations</h3>
                <div style="display: grid; gap: 16px;">
                    ${createRecommendation('Focus on Weak Areas', 'fas fa-bullseye', 'var(--primary)', 'Spend 60% of study time on topics below 70% mastery')}
                    ${createRecommendation('Consistent Practice', 'fas fa-chart-line', '#10b981', `Maintain your ${userStats.streak}-day streak for optimal retention`)}
                    ${createRecommendation('Active Recall', 'fas fa-brain', '#8b5cf6', 'Use spaced repetition for better long-term memory')}
                    ${createRecommendation('Mixed Practice', 'fas fa-random', '#f59e0b', 'Combine different topics in single study sessions')}
                </div>
            </div>

            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">🎯 Study Plan</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    ${createStudyPlanItem('Daily Goal', '50 questions', 'fas fa-calendar-day', '#6366f1')}
                    ${createStudyPlanItem('Weekly Target', '5 hours', 'fas fa-chart-bar', '#06b6d4')}
                    ${createStudyPlanItem('Mastery Goal', '85% overall', 'fas fa-trophy', '#f59e0b')}
                    ${createStudyPlanItem('Weak Topics', '2 sessions/week', 'fas fa-exclamation-triangle', '#ef4444')}
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createRecommendation(title, icon, color, description) {
    return `
        <div style="display: flex; align-items: center; gap: 16px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px; border-left: 4px solid ${color};">
            <i class="${icon}" style="color: ${color}; font-size: 24px;"></i>
            <div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${title}</div>
                <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.5;">${description}</div>
            </div>
        </div>
    `;
}

function createStudyPlanItem(title, value, icon, color) {
    return `
        <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px;">
            <i class="${icon}" style="color: ${color}; font-size: 32px; margin-bottom: 12px;"></i>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${title}</div>
            <div style="font-size: 18px; color: ${color}; font-weight: 700;">${value}</div>
        </div>
    `;
}

function showBookmarks() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    hideAllSections();
    pageTitle.textContent = 'Bookmarked Questions';
    
    if (bookmarkedQuestionsList.length === 0) {
        quizContainer.innerHTML = `
            <div style="text-align: center; padding: 80px 20px;">
                <div style="font-size: 96px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                    <i class="far fa-bookmark"></i>
                </div>
                <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary);">No Bookmarked Questions Yet</h2>
                <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 400px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                    Click the bookmark icon on any question to save it here for quick review. This is perfect for difficult concepts or important topics you want to revisit.
                </p>
                <button class="quiz-btn" onclick="showDashboard(); navItems[0].click()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 32px; border-radius: 16px;">
                    <i class="fas fa-arrow-left"></i>
                    Explore Questions
                </button>
            </div>
        `;
    } else {
        quizContainer.innerHTML = `
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                    <div>
                        <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
                            ${bookmarkedQuestionsList.length} Saved Question${bookmarkedQuestionsList.length !== 1 ? 's' : ''}
                        </h2>
                        <p style="color: var(--text-secondary);">Your personal collection of important questions</p>
                    </div>
                    <button class="quiz-btn" onclick="startBookmarksQuiz()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px;">
                        <i class="fas fa-play"></i>
                        Practice Bookmarks
                    </button>
                </div>
                <div style="display: grid; gap: 20px;">
                    ${bookmarkedQuestionsList.map(question => `
                        <div class="question-card glass-effect" style="cursor: pointer; border-radius: 20px; padding: 24px;" onclick="jumpToBookmarkQuestion(${question.id})">
                            <div class="question-header">
                                <div class="question-meta">
                                    <div class="question-number" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));">Q${question.id}</div>
                                    <div class="question-category glass-effect">${question.category}</div>
                                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                                        ${question.difficulty}
                                    </div>
                                    ${question.custom ? '<div class="question-category glass-effect" style="background: #10b98120; color: #10b981;">Custom</div>' : ''}
                                </div>
                                <div class="question-actions">
                                    <button class="action-btn bookmark-btn" onclick="event.stopPropagation(); toggleBookmark(${question.id}); showBookmarks();" aria-label="Remove Bookmark" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                                        <i class="fas fa-bookmark"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="question-text" style="font-size: 16px; line-height: 1.6;">${question.question}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    quizContainer.classList.remove('hidden');
}

// Add this function to handle clicking on individual bookmark questions
function jumpToBookmarkQuestion(questionId) {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    // Start a quiz with just this one question
    questions = [bookmarkedQuestionsList.find(q => q.id === questionId)];
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Question';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
}

function showSettings() {
    hideAllSections();
    pageTitle.textContent = 'Settings & Preferences';
    
    quizContainer.innerHTML = `
        <div style="padding: 24px; max-width: 800px; margin: 0 auto;">
            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">🎨 Appearance</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Customize the look and feel of your study environment</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Theme</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? '' : 'active'}" onclick="setTheme('light')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-sun"></i>
                                Light Mode
                            </button>
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? 'active' : ''}" onclick="setTheme('dark')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-moon"></i>
                                Dark Mode
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Animation</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn active" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-bolt"></i>
                                Smooth
                            </button>
                            <button class="mode-btn" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-minus"></i>
                                Minimal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">⚡ Study Preferences</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Optimize your learning experience</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Default Mode</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${currentMode === 'quiz' ? 'active' : ''}" onclick="setDefaultMode('quiz')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-tasks"></i>
                                Quiz
                            </button>
                            <button class="mode-btn ${currentMode === 'exam' ? 'active' : ''}" onclick="setDefaultMode('exam')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-file-alt"></i>
                                Exam
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Questions Per Session</label>
                        <select class="modern-dropdown" style="width: 100%;" onchange="setQuestionsPerSession(this.value)">
                            <option value="10">10 Questions</option>
                            <option value="25" selected>25 Questions</option>
                            <option value="50">50 Questions</option>
                            <option value="100">100 Questions</option>
                            <option value="0">All Questions</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">📊 Data & Progress</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Manage your learning data</p>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <button class="quiz-btn" onclick="exportProgress()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-download" style="margin-right: 12px;"></i>
                         
                    </button>
                    <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-plus" style="margin-right: 12px;"></i>
                        Create Custom Question
                    </button>
                    <button class="quiz-btn" onclick="resetProgress()" style="background: linear-gradient(135deg, var(--error), #dc2626); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-trash" style="margin-right: 12px;"></i>
                        Reset All Progress
                    </button>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">ℹ️ About ALIF</h3>
                <div style="color: var(--text-secondary); line-height: 1.7;">
                    <p>ALIF is an advanced medical education platform designed to help medical students and professionals enhance their knowledge through interactive quizzes and detailed analytics.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
                        <div>
                            <strong style="color: var(--text-primary);">Version</strong>
                            <div>2.1.0</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Questions</strong>
                            <div>${quizData.length + customQuestions.length} total</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Last Updated</strong>
                            <div>${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function setTheme(theme) {
    if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-sun';
    } else {
        document.body.classList.remove('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-moon';
    }
    showNotification(`Theme set to ${theme} mode`, 'success');
}

function setDefaultMode(mode) {
    currentMode = mode;
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[mode === 'quiz' ? 1 : 0].classList.add('active');
    showNotification(`Default mode set to ${mode}`, 'success');
}

function setQuestionsPerSession(count) {
    showNotification(`Questions per session set to ${count === '0' ? 'all' : count}`, 'info');
}

function showCustomQuestionCreator() {
    const modal = document.createElement('div');
    modal.className = 'custom-quiz-modal active';
    modal.innerHTML = `
        <div class="custom-quiz-content glass-effect" style="max-width: 600px; border-radius: 24px;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">Create Custom Question</h3>
                <button class="action-btn" onclick="closeCustomQuestionModal()" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="custom-question-creator">
                <div style="display: grid; gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Question Text</label>
                        <textarea id="customQuestionText" placeholder="Enter your question here..." style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 80px;"></textarea>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Category</label>
                        <select id="customQuestionCategory" class="modern-dropdown" style="width: 100%;">
                            <option value="Custom Anatomy">Custom Anatomy</option>
                            <option value="Custom Physiology">Custom Physiology</option>
                            <option value="Custom Pathology">Custom Pathology</option>
                            <option value="Custom Pharmacology">Custom Pharmacology</option>
                            <option value="General Medicine">General Medicine</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Difficulty</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button type="button" class="mode-btn difficulty-btn active" data-difficulty="Easy" style="border-radius: 12px; padding: 12px 16px;">
                                Easy
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Medium" style="border-radius: 12px; padding: 12px 16px;">
                                Medium
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Hard" style="border-radius: 12px; padding: 12px 16px;">
                                Hard
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Options</label>
                        <div style="display: grid; gap: 12px;">
                            ${['A', 'B', 'C', 'D'].map(letter => `
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--surface); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--text-secondary); flex-shrink: 0;">${letter}</div>
                                    <input type="text" id="customOption${letter}" placeholder="Option ${letter}" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; background: var(--surface); color: var(--text-primary);">
                                    <input type="radio" name="correctAnswer" value="${letter}" id="correct${letter}" style="transform: scale(1.2);">
                                    <label for="correct${letter}" style="color: var(--text-secondary); font-weight: 600;">Correct</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Explanation</label>
                        <textarea id="customExplanation" placeholder="Explain why the correct answer is right..." style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 60px;"></textarea>
                    </div>
                </div>
                
                <div class="custom-quiz-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;">
                    <button class="quiz-btn" onclick="closeCustomQuestionModal()" style="background: var(--secondary); color: white; padding: 12px 24px; border-radius: 12px;">
                        Cancel
                    </button>
                    <button class="quiz-btn check-btn" onclick="saveCustomQuestion()" style="padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-save"></i>
                        Save Question
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add difficulty button handlers
    modal.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            modal.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

function closeCustomQuestionModal() {
    const modal = document.querySelector('.custom-quiz-modal');
    if (modal) {
        modal.remove();
    }
}

function saveCustomQuestion() {
    const questionText = document.getElementById('customQuestionText').value;
    const category = document.getElementById('customQuestionCategory').value;
    const difficulty = document.querySelector('.difficulty-btn.active').dataset.difficulty;
    const explanation = document.getElementById('customExplanation').value;
    
    // Get options
    const options = [];
    for (let letter of ['A', 'B', 'C', 'D']) {
        const optionText = document.getElementById(`customOption${letter}`).value;
        if (optionText.trim()) {
            options.push(optionText);
        }
    }
    
    // Get correct answer
    const correctAnswerRadio = document.querySelector('input[name="correctAnswer"]:checked');
    if (!correctAnswerRadio) {
        showNotification('Please select the correct answer', 'error');
        return;
    }
    
    const correctAnswerIndex = ['A', 'B', 'C', 'D'].indexOf(correctAnswerRadio.value);
    
    if (!questionText.trim() || options.length < 2) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    // Generate a unique ID for the custom question
    const maxId = Math.max(
        ...quizData.map(q => q.id),
        ...customQuestions.map(q => q.id),
        0
    );
    
    const newQuestion = {
        id: maxId + 1,
        question: questionText,
        options: options,
        answer: correctAnswerIndex,
        correctAnswer: options[correctAnswerIndex],
        explanation: explanation || 'No explanation provided.',
        whyNotOtherOptions: {},
        relatedQuestions: [],
        category: category,
        difficulty: difficulty,
        custom: true
    };
    
    customQuestions.push(newQuestion);
    saveUserData();
    
    closeCustomQuestionModal();
    showNotification('Custom question created successfully!', 'success');
    
    // Refresh the current view and categories
    initializeCategories();
    if (currentPage === 'Dashboard') {
        showDashboard();
    } else if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}

function hideAllSections() {
    quizContainer.classList.add('hidden');
    resultsScreen.classList.add('hidden');
    document.querySelector('.stats-grid').style.display = 'none';
    document.querySelector('.analytics-section').style.display = 'none';
    document.querySelector('.export-section').style.display = 'none';
    // Note: search-container is NOT hidden here - we want it always visible during search
}

function startCourse(courseName) {
    showNotification(`Starting ${courseName} course...`, 'info');
    // Filter questions by course/category and start quiz
    const courseQuestions = [...quizData, ...customQuestions].filter(q => 
        q.category.toLowerCase().includes(courseName.toLowerCase())
    );
    
    if (courseQuestions.length === 0) {
        showNotification('No questions available for this course yet', 'info');
        return;
    }
    
    questions = courseQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active');
    pageTitle.textContent = `Quiz Mode - ${courseName}`;
    
    hideAllSections();
    renderQuizLayout();
}

// FIXED BOOKMARK PRACTICE FUNCTION
function startBookmarksQuiz() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    if (bookmarkedQuestionsList.length === 0) {
        showNotification('No bookmarked questions to practice!', 'error');
        return;
    }
    
    questions = bookmarkedQuestionsList;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Questions';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
    
    showNotification(`Starting practice with ${questions.length} bookmarked questions`, 'success');
}

function resetProgress() {
    if (confirm('Are you sure you want to reset all your progress? This action cannot be undone.')) {
        userProgress = {};
        userStats = {
            totalQuestions: 0,
            correctAnswers: 0,
            timeSpent: 0,
            masteryLevel: 0,
            streak: 0,
            lastActive: new Date().toISOString(),
            weeklyProgress: []
        };
        bookmarkedQuestions = new Set();
        customQuestions = [];
        saveUserData();
        updateDashboardStats();
        updateAnalytics();
        showNotification('All progress has been reset', 'success');
        showDashboard();
    }
}

function initializeEventListeners() {
    menuToggle.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', closeSidebar);
    themeToggle.addEventListener('click', toggleTheme);
    
    modeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.mode;
            pageTitle.textContent = `${btn.dataset.mode.charAt(0).toUpperCase() + btn.dataset.mode.slice(1)} Mode`;
            startQuiz();
        });
    });
    
    initializeEnhancedFeatures();
    document.getElementById('backBtn').addEventListener('click', function(e) {
        e.preventDefault();
        // Use browser back navigation
        window.history.back();
    });
}
function updateBackButton() {
    const backBtn = document.getElementById('backBtn');
    // Show back button if there's history to go back to
    if (window.history.length > 1) {
        backBtn.style.display = 'flex';
    } else {
        backBtn.style.display = 'none';
    }
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
    mainContent.classList.toggle('sidebar-open');
    document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
    mainContent.classList.remove('sidebar-open');
    document.body.style.overflow = '';
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const icon = themeToggle.querySelector('i');
    if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun';
    } else {
        icon.className = 'fas fa-moon';
    }
}

function initializeEnhancedFeatures() {
    initializeSearch();
    initializeKeyboardNavigation();
    enhanceAccessibility();
    
    exportProgressBtn.addEventListener('click', exportProgress);
    createCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.add('active');
    });
    cancelCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.remove('active');
    });
    createCustomQuizBtnModal.addEventListener('click', () => {
        const selectedOptions = document.querySelectorAll('.custom-quiz-option.selected');
        const options = {
            categories: selectedCategories,
            difficulty: null,
            bookmarkedOnly: false
        };
        
        selectedOptions.forEach(option => {
            const category = option.dataset.category;
            if (category === 'easy' || category === 'medium' || category === 'hard') {
                options.difficulty = category;
            } else if (category === 'bookmarked') {
                options.bookmarkedOnly = true;
            }
        });
        
        createCustomQuiz(options);
    });
    
    // Add selection toggling for custom quiz options
    document.addEventListener('click', (e) => {
        if (e.target.closest('.custom-quiz-option')) {
            const option = e.target.closest('.custom-quiz-option');
            option.classList.toggle('selected');
        }
    });
    
    // Ensure search works when clicking Dashboard
    navItems[0].addEventListener('click', () => {
        if (searchInput.value.trim().length > 0) {
            // If there's a search query, maintain search state
            isSearchActive = true;
        }
    });
}

// FIXED SEARCH FUNCTIONALITY
function initializeSearch() {
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            
            // Clear previous search state when input is empty
            if (query.length === 0) {
                document.body.classList.remove('search-blur-active');
                isSearchActive = false;
                if (currentPage === 'Dashboard') {
                    showDashboard();
                }
                return;
            }
            
            // Add blur effect when searching
            document.body.classList.add('search-blur-active');
            
            if (query.length < 2) {
                isSearchActive = false;
                return;
            }
            
            isSearchActive = true;
            performSearch(query);
        });
        
        // Add clear search functionality
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                clearSearch();
            }
        });
    }
}

function performSearch(query) {
    const allQuestions = [...quizData, ...customQuestions];
    searchResults = allQuestions.filter(q => 
        q.question.toLowerCase().includes(query) ||
        q.category.toLowerCase().includes(query) ||
        (q.explanation && q.explanation.toLowerCase().includes(query)) ||
        q.options.some(opt => opt.toLowerCase().includes(query))
    );
    
    console.log('Search query:', query, 'Results:', searchResults.length); // Debug log
    
    if (searchResults.length > 0) {
        // Show search results in quiz layout
        questions = searchResults;
        currentQuestionIndex = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        
        hideAllSections();
        quizContainer.classList.remove('hidden');
        renderQuizLayout();
        
        // Update page title to show search context
        pageTitle.textContent = `Search: "${query}" (${searchResults.length} results)`;
        
        // Highlight search terms
        setTimeout(() => {
            highlightSearchTerms(query);
        }, 100);
    } else {
        // Show no results message
        showSearchNoResults(query);
    }
}

function showSearchNoResults(query) {
    hideAllSections();
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-search"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Results Found</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                No questions match your search for "<strong style="color: var(--primary);">${query}</strong>". Try different keywords or browse categories.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-times"></i>
                    Clear Search
                </button>
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Browse Categories
                </button>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
    pageTitle.textContent = `Search: "${query}" (0 results)`;
}

function clearSearch() {
    searchInput.value = '';
    document.body.classList.remove('search-blur-active');
    isSearchActive = false;
    showDashboard();
}

function highlightSearchTerms(query) {
    const questionTexts = document.querySelectorAll('.question-text');
    const optionTexts = document.querySelectorAll('.option-text');
    const categoryElements = document.querySelectorAll('.question-category');
    
    const highlightText = (element) => {
        const originalText = element.textContent;
        const regex = new RegExp(`(${query})`, 'gi');
        const highlighted = originalText.replace(regex, '<mark class="search-highlight">$1</mark>');
        element.innerHTML = highlighted;
    };
    
    questionTexts.forEach(highlightText);
    optionTexts.forEach(highlightText);
    categoryElements.forEach(highlightText);
}

function initializeKeyboardNavigation() {
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key) {
            case 'ArrowDown':
            case 'ArrowUp':
                e.preventDefault();
                navigateOptions(e.key === 'ArrowDown' ? 1 : -1);
                break;
            case ' ':
            case 'Enter':
                e.preventDefault();
                if (document.activeElement.classList.contains('option')) {
                    document.activeElement.click();
                }
                break;
            case '1':
            case '2':
            case '3':
            case '4':
            case '5':
                e.preventDefault();
                const index = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option:not(.disabled)');
                if (options[index]) {
                    options[index].click();
                }
                break;
            case 'Escape':
                if (document.querySelector('.custom-quiz-modal')) {
                    document.querySelector('.custom-quiz-modal').remove();
                }
                break;
        }
    });
}

function navigateOptions(direction) {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const currentIndex = Array.from(options).findIndex(opt => opt === document.activeElement);
    let nextIndex = currentIndex + direction;
    
    if (nextIndex < 0) nextIndex = options.length - 1;
    if (nextIndex >= options.length) nextIndex = 0;
    
    options[nextIndex].focus();
}

function enhanceAccessibility() {
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('option')) {
            const options = e.target.parentElement.querySelectorAll('.option');
            options.forEach((opt, index) => {
                opt.setAttribute('aria-checked', opt.classList.contains('selected') ? 'true' : 'false');
                opt.setAttribute('role', 'radio');
                opt.setAttribute('tabindex', '0');
            });
        }
    });
}

function loadUserData() {
    const savedProgress = localStorage.getItem('mediQuizProgress');
    const savedStats = localStorage.getItem('mediQuizStats');
    const savedBookmarks = localStorage.getItem('mediQuizBookmarks');
    const savedCustomQuestions = localStorage.getItem('mediQuizCustomQuestions');
    
    if (savedProgress) {
        userProgress = JSON.parse(savedProgress);
    }
    if (savedStats) {
        userStats = JSON.parse(savedStats);
        const today = new Date().toDateString();
        const lastActive = new Date(userStats.lastActive).toDateString();
        if (lastActive !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastActive === yesterday.toDateString()) {
                userStats.streak++;
            } else {
                userStats.streak = 1;
            }
        }
    }
    if (savedBookmarks) {
        bookmarkedQuestions = new Set(JSON.parse(savedBookmarks));
    }
    if (savedCustomQuestions) {
        customQuestions = JSON.parse(savedCustomQuestions);
    }
    
    userStats.lastActive = new Date().toISOString();
    saveUserData();
}

function saveUserData() {
    localStorage.setItem('mediQuizProgress', JSON.stringify(userProgress));
    localStorage.setItem('mediQuizStats', JSON.stringify(userStats));
    localStorage.setItem('mediQuizBookmarks', JSON.stringify(Array.from(bookmarkedQuestions)));
    localStorage.setItem('mediQuizCustomQuestions', JSON.stringify(customQuestions));
}

function updateDashboardStats() {
    correctAnswersEl.textContent = userStats.correctAnswers;
    timeSpentEl.textContent = `${Math.floor(userStats.timeSpent / 60)}h ${userStats.timeSpent % 60}m`;
    masteryLevelEl.textContent = `${userStats.masteryLevel}%`;
    streakCountEl.textContent = userStats.streak;
}

function updateAnalytics() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => allQuestions.find(q => q.id == id)?.category)
        .reduce((acc, category) => {
            acc[category] = (acc[category] || 0) + 1;
            return acc;
        }, {});
        
    weakAreasCountEl.textContent = Object.keys(weakAreas).length;
    
    const totalTime = userStats.timeSpent * 60;
    const avgTime = userStats.totalQuestions > 0 ? Math.round(totalTime / userStats.totalQuestions) : 0;
    avgTimePerQuestionEl.textContent = `${avgTime}s`;
    
    if (userStats.weeklyProgress.length > 1) {
        const latest = userStats.weeklyProgress[userStats.weeklyProgress.length - 1];
        const previous = userStats.weeklyProgress[userStats.weeklyProgress.length - 2];
        const improvement = ((latest - previous) / previous) * 100;
        improvementRateEl.textContent = `${Math.round(improvement)}%`;
    } else {
        improvementRateEl.textContent = "0%";
    }
}

function exportProgress() {
    const data = {
        progress: userProgress,
        stats: userStats,
        bookmarks: Array.from(bookmarkedQuestions),
        customQuestions: customQuestions,
        exportDate: new Date().toISOString(),
        analytics: generateStudyReport()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mediquiz-progress-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('Progress data exported successfully!', 'success');
}

function createCustomQuiz(options) {
    let filteredQuestions = [...quizData, ...customQuestions];
    
    if (options.categories && options.categories.length > 0) {
        filteredQuestions = filteredQuestions.filter(q => options.categories.includes(q.category));
    }
    
    if (options.difficulty) {
        filteredQuestions = filteredQuestions.filter(q => q.difficulty.toLowerCase() === options.difficulty);
    }
    
    if (options.bookmarkedOnly) {
        filteredQuestions = filteredQuestions.filter(q => bookmarkedQuestions.has(q.id));
    }
    
    if (options.count && options.count > 0) {
        filteredQuestions = shuffleArray(filteredQuestions).slice(0, options.count);
    }
    
    questions = filteredQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    examSubmitted = false;
    
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    hideAllSections();
    renderQuizLayout();
    customQuizModal.classList.remove('active');
    showNotification(`Custom quiz created with ${questions.length} questions`, 'success');
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function generateStudyReport() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    const strongAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) >= 0.8)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    return {
        weakAreas,
        strongAreas,
        totalMastered: Object.values(userProgress).filter(p => p.correct >= 3).length,
        totalQuestions: allQuestions.length,
        masteryPercentage: calculateMasteryLevel(),
        generatedAt: new Date().toISOString()
    };
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        padding: 20px 28px;
        background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--primary)'};
        color: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        font-weight: 600;
        max-width: 400px;
        line-height: 1.5;
    `;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}" style="font-size: 20px;"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 400);
    }, 4000);
}

function initializeCategories() {
    const allQuestions = [...quizData, ...customQuestions];
    const categories = [...new Set(allQuestions.map(q => q.category))];
    const categoryIcons = {
        "Anatomy Fundamentals": "fas fa-brain",
        "Neuroanatomy": "fas fa-brain",
        "Gastrointestinal System": "fas fa-stomach",
        "Cardiovascular System": "fas fa-heart",
        "Custom Anatomy": "fas fa-user-md",
        "Custom Physiology": "fas fa-heartbeat",
        "Custom Pathology": "fas fa-virus",
        "Custom Pharmacology": "fas fa-pills",
        "General Medicine": "fas fa-stethoscope"
    };
    
    const categoryColors = {
        "Anatomy Fundamentals": "#6366f1",
        "Neuroanatomy": "#06b6d4",
        "Gastrointestinal System": "#10b981",
        "Cardiovascular System": "#ef4444",
        "Custom Anatomy": "#8b5cf6",
        "Custom Physiology": "#f59e0b",
        "Custom Pathology": "#ec4899",
        "Custom Pharmacology": "#84cc16",
        "General Medicine": "#64748b"
    };

    categoriesGrid.innerHTML = '';
    categories.forEach(category => {
        const categoryQuestions = allQuestions.filter(q => q.category === category);
        const mastered = categoryQuestions.filter(q =>
            userProgress[q.id] && userProgress[q.id].correct >= 3
        ).length;
        const progress = categoryQuestions.length > 0 ?
            Math.round((mastered / categoryQuestions.length) * 100) : 0;
            
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card active glass-effect';
        categoryCard.dataset.category = category;
        categoryCard.style.borderLeft = `4px solid ${categoryColors[category] || '#6366f1'}`;
        categoryCard.innerHTML = `
            <div class="category-header">
                <div class="category-icon" style="background: ${categoryColors[category] || '#6366f1'}20; color: ${categoryColors[category] || '#6366f1'}">
                    <i class="${categoryIcons[category] || 'fas fa-question'}"></i>
                </div>
                <div class="category-name">${category}</div>
                ${category.includes('Custom') ? '<div style="font-size: 10px; color: var(--primary); background: var(--primary-light); padding: 2px 6px; border-radius: 8px;">Custom</div>' : ''}
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${categoryColors[category] || '#6366f1'}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                ${categoryQuestions.length} question${categoryQuestions.length !== 1 ? 's' : ''}
                ${categoryQuestions.filter(q => q.custom).length > 0 ? ` · ${categoryQuestions.filter(q => q.custom).length} custom` : ''}
            </div>
        `;
        
        if (categoryQuestions.length > 1) {
            const dropdown = document.createElement('div');
            dropdown.className = 'modern-dropdown';
            dropdown.innerHTML = `
                <select onchange="jumpToQuestion(this.value)">
                    <option value="">Jump to Question...</option>
                    ${categoryQuestions.sort((a, b) => a.id - b.id).map(q => 
                        `<option value="question-${q.id}">Q${q.id}: ${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}${q.custom ? ' ★' : ''}</option>`
                    ).join('')}
                </select>
            `;
            categoryCard.appendChild(dropdown);
        }
        
        categoryCard.addEventListener('click', (e) => {
            if (!e.target.closest('.modern-dropdown') && !e.target.closest('select')) {
                toggleCategory(categoryCard);
                const firstQ = categoryQuestions.sort((a, b) => a.id - b.id)[0];
                if (firstQ) {
                    jumpToQuestion(`question-${firstQ.id}`);
                }
            }
        });
        
        categoriesGrid.appendChild(categoryCard);
    });
    
    selectedCategories = [...categories];
}

function toggleCategory(categoryCard) {
    const category = categoryCard.dataset.category;
    if (categoryCard.classList.contains('active')) {
        categoryCard.classList.remove('active');
        selectedCategories = selectedCategories.filter(c => c !== category);
    } else {
        categoryCard.classList.add('active');
        selectedCategories.push(category);
    }
    startQuiz();
    closeSidebar();
}

function startQuiz() {
    if (currentPage !== 'Dashboard') return;
    
    quizContainer.style.opacity = '0';
    setTimeout(() => {
        const allQuestions = [...quizData, ...customQuestions];
        questions = selectedCategories.length > 0 ? 
            allQuestions.filter(q => selectedCategories.includes(q.category)) : 
            allQuestions;
            
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        if (currentMode === 'learn' && incorrectQuestions.length > 0) {
            questions = allQuestions.filter(q => incorrectQuestions.includes(q.id));
        }
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        questions.sort((a, b) => a.id - b.id);
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        examSubmitted = false;
        quizContainer.classList.remove('hidden');
        resultsScreen.classList.add('hidden');
        questionTimers = new Array(questions.length).fill(0);
        if (currentMode === 'exam') {
            isCountdown = true;
            remainingTime = 120 * questions.length;
        } else {
            isCountdown = false;
        }
        startTimer();
        renderQuizLayout();
        quizContainer.style.opacity = '1';
    }, 300);
}

function showNoQuestionsMessage() {
    let message = '';
    if (isSearchActive) {
        message = 'No questions match your search criteria. Try different keywords.';
    } else if (selectedCategories.length === 0) {
        message = 'No categories selected. Please select categories from the sidebar.';
    } else {
        message = 'No questions available for the selected categories.';
    }
    
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-inbox"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Questions Available</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                ${message}
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Select Categories
                </button>
                <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-plus"></i>
                    Create Question
                </button>
                ${isSearchActive ? `
                    <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-times"></i>
                        Clear Search
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    resultsScreen.classList.add('hidden');
    stopTimer();
    quizContainer.style.opacity = '1';
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    startTime = new Date();
    timerInterval = setInterval(() => {
        if (isCountdown) {
            remainingTime--;
            if (remainingTime <= 0) {
                remainingTime = 0;
                clearInterval(timerInterval);
                if (currentMode === 'exam' && !examSubmitted) {
                    showNotification('Time up! Submitting exam.', 'error');
                    submitExam();
                }
            }
            updateTimerDisplay(formatTime(remainingTime), 'timerDisplay', true);
        } else {
            questionTimers[currentQuestionIndex]++;
            updateTimerDisplay(formatTime(questionTimers[currentQuestionIndex]), 'timerDisplay', false);
        }
    }, 1000);
}

function formatTime(seconds) {
    const min = Math.floor(seconds / 60).toString().padStart(2, '0');
    const sec = (seconds % 60).toString().padStart(2, '0');
    return `${min}:${sec}`;
}

function updateTimerDisplay(time, id, isCountdown = false) {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = `Time: ${time}`;
        if (isCountdown) {
            el.classList.remove('timer-warning', 'timer-error');
            if (remainingTime <= 30) {
                el.classList.add('timer-error');
            } else if (remainingTime <= 60) {
                el.classList.add('timer-warning');
            }
        }
    }
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        if (startTime) {
            const endTime = new Date();
            const timeSpent = Math.floor((endTime - startTime) / 1000 / 60);
            userStats.timeSpent += timeSpent;
            userStats.lastActive = new Date().toISOString();
            saveUserData();
            updateDashboardStats();
        }
    }
}

function renderQuizLayout() {
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    if (currentMode === 'exam') {
        renderExamLayout();
    } else {
        renderSingleQuestionLayout();
    }
}

function renderExamLayout() {
    const isImmediateMode = examCheckMode === 'immediate';
    quizContainer.innerHTML = `
        <div class="exam-header" style="margin-bottom: 24px; padding: 20px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                <div>
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                        Exam Mode: ${questions.length} Questions
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        ${isImmediateMode ?
                          'Immediate Check - See explanations as you answer' :
                          'All-in-One Check - Check all answers at the end'}
                    </p>
                </div>
                <div class="exam-mode-toggle" style="display: flex; gap: 8px; background: var(--glass); padding: 4px; border-radius: var(--radius);">
                    <button class="mode-toggle-btn ${isImmediateMode ? 'active' : ''}" data-mode="immediate" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="Immediate Check Mode">
                        Immediate Check
                    </button>
                    <button class="mode-toggle-btn ${!isImmediateMode ? 'active' : ''}" data-mode="all-at-once" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${!isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${!isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="All-at-Once Check Mode">
                        Check All
                    </button>
                </div>
            </div>
            <div class="progress-info" style="display: flex; align-items: center; gap: 16px;">
                <span style="font-size: 14px; color: var(--text-secondary);" id="answeredCount">0/${questions.length} answered</span>
                <div class="progress-bar" style="flex: 1; height: 6px;">
                    <div class="progress-fill" id="examProgressFill" style="width: 0%"></div>
                </div>
                <span id="timerDisplay" style="font-size: 14px; color: var(--text-secondary);">Time: ${formatTime(remainingTime)}</span>
                ${examSubmitted ? `<span style="color: var(--success); font-weight: 600; font-size: 14px;">Submitted!</span>` : ''}
            </div>
        </div>
        <div class="exam-mode-layout">
            ${questions.map((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.answer;
                const showExplanationButton = examSubmitted || (isImmediateMode && userAnswer !== undefined);
                return `
                    <div class="question-card fade-in" data-question-index="${index}" id="question-${question.id}">
                        <div class="question-header">
                            <div class="question-meta">
                                <div class="question-number">Q${question.id}</div>
                                <div class="question-category">${question.category}</div>
                                <div class="question-difficulty" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${getDifficultyColor(question.difficulty)}; color: white;">
                                    ${question.difficulty}
                                </div>
                                ${userAnswer !== undefined ? `
                                    <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                                        ${isCorrect ? 'Correct' : 'Incorrect'}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="question-actions">
                                <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                                    <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                                </button>
                            </div>
                        </div>
                        <div class="question-text">${question.question}</div>
                        <div class="options-grid">
                            ${question.options.map((option, optIndex) => {
                                const isSelected = userAnswer === optIndex;
                                const isCorrectOption = optIndex === question.answer;
                                let optionClass = 'option';
                                if (userAnswer !== undefined) {
                                    if (isCorrectOption) {
                                        optionClass += ' correct';
                                    } else if (isSelected && !isCorrectOption) {
                                        optionClass += ' incorrect';
                                    }
                                    optionClass += ' disabled';
                                } else if (isSelected) {
                                    optionClass += ' selected';
                                }
                                return `
                                    <div class="${optionClass}" data-option-index="${optIndex}" role="button" aria-label="Option ${String.fromCharCode(65 + optIndex)}">
                                        <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                                        <div class="option-text">${option}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${showExplanationButton ? `
                            <div class="explanation-section">
                                <details open>
                                    <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                                    <div class="explanation-content correct-answer">
                                        <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                                    </div>
                                </details>
                                ${userAnswer !== undefined && userAnswer !== question.answer ? `
                                    <details>
                                        <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                                        <div class="explanation-content why-not-section">
                                            <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                            <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                                        </div>
                                    </details>
                                ` : ''}
                                <details>
                                    <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                                    <div class="explanation-content">${question.explanation}</div>
                                </details>
                                <details>
                                    <summary><i class="fas fa-link"></i> Related Questions</summary>
                                    <div class="explanation-content related-questions">
                                        <div class="related-questions-list">
                                            ${question.relatedQuestions.map(q => {
                                                const qId = q.match(/\d+/)[0];
                                                return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                </details>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('')}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    ${examCheckMode === 'all-at-once' && !examSubmitted ? `
                        <button class="quiz-btn check-btn" id="checkAllBtn" ${userAnswers.filter(a => a !== undefined).length === 0 ? 'disabled' : ''} aria-label="Check All Answers">
                            <i class="fas fa-check-double"></i>
                            Check All Answers
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn submit-btn" id="examSubmitBtn" ${examSubmitted ? 'disabled' : ''} aria-label="Submit Exam">
                    <i class="fas fa-paper-plane"></i>
                    ${examSubmitted ? 'Exam Submitted' : `Submit Exam (${questions.length} questions)`}
                </button>
            </div>
        </div>
    `;
    initializeExamModeEvents();
    updateExamSubmitButton();
}

function renderSingleQuestionLayout() {
    if (currentQuestionIndex >= questions.length) {
        showResults();
        return;
    }
    const question = questions[currentQuestionIndex];
    const userAnswer = userAnswers[currentQuestionIndex];
    const isCorrect = userAnswer === question.answer;
    quizContainer.innerHTML = `
        <div class="question-card fade-in" data-question-index="${currentQuestionIndex}">
            <div class="question-header">
                <div class="question-meta">
                    <div class="question-number">Q${question.id}</div>
                    <div class="question-category">${question.category}</div>
                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                        ${question.difficulty}
                    </div>
                    ${userAnswer !== undefined ? `
                        <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                            ${isCorrect ? 'Correct' : 'Incorrect'}
                        </div>
                    ` : ''}
                </div>
                <div class="question-actions">
                    <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                        <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                    </button>
                </div>
            </div>
            <div class="question-text">${question.question}</div>
            <div class="options-grid">
                ${question.options.map((option, index) => {
                    const isSelected = userAnswer === index;
                    const isCorrectOption = index === question.answer;
                    let optionClass = 'option';
                    if (isAnswerChecked) {
                        if (isCorrectOption) {
                            optionClass += ' correct';
                        } else if (isSelected && !isCorrectOption) {
                            optionClass += ' incorrect';
                        }
                        optionClass += ' disabled';
                    } else if (isSelected) {
                        optionClass += ' selected';
                    }
                    return `
                        <div class="${optionClass}" data-option-index="${index}" role="button" aria-label="Option ${String.fromCharCode(65 + index)}">
                            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                            <div class="option-text">${option}</div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${isAnswerChecked ? `
                <div class="explanation-section">
                    <details open>
                        <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                        <div class="explanation-content correct-answer">
                            <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                        </div>
                    </details>
                    ${userAnswer !== undefined && userAnswer !== question.answer ? `
                        <details>
                            <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                            <div class="explanation-content why-not-section">
                                <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                            </div>
                        </details>
                    ` : ''}
                    <details>
                        <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                        <div class="explanation-content">${question.explanation}</div>
                    </details>
                    <details>
                        <summary><i class="fas fa-link"></i> Related Questions</summary>
                        <div class="explanation-content related-questions">
                            <div class="related-questions-list">
                                ${question.relatedQuestions.map(q => {
                                    const qId = q.match(/\d+/)[0];
                                    return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    </details>
                </div>
            ` : ''}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    <button class="quiz-btn check-btn" id="checkAnswerBtn" ${userAnswer === undefined ? 'disabled' : ''} aria-label="Check Answer">
                        <i class="fas fa-check"></i>
                        Check Answer
                    </button>
                    ${currentMode === 'learn' && incorrectQuestions.length > 0 ? `
                        <button class="quiz-btn" id="incorrectOnlyBtn" aria-label="Show Incorrect Only">
                            <i class="fas fa-filter"></i>
                            Incorrect Only
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn next-btn" id="nextQuestionBtn" ${!isAnswerChecked ? 'disabled' : ''} aria-label="Next Question">
                    <i class="fas fa-arrow-right"></i>
                    ${currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish'}
                </button>
            </div>
        </div>
    `;
    initializeQuizEvents();
    updateTimerDisplay(formatTime(isCountdown ? remainingTime : questionTimers[currentQuestionIndex]), 'timerDisplay', isCountdown);
}

function initializeQuizEvents() {
    const checkAnswerBtn = document.getElementById('checkAnswerBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const incorrectOnlyBtn = document.getElementById('incorrectOnlyBtn');
    const bookmarkBtn = document.querySelector('.bookmark-btn');
    const options = document.querySelectorAll('.option:not(.disabled)');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            if (!isAnswerChecked) {
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                userAnswers[currentQuestionIndex] = parseInt(option.dataset.optionIndex);
                if (checkAnswerBtn) checkAnswerBtn.disabled = false;
                updateExamSubmitButton();
            }
        });
    });
    
    if (checkAnswerBtn) {
        checkAnswerBtn.addEventListener('click', () => {
            checkAnswer();
            renderQuizLayout();
        });
    }
    
    if (nextQuestionBtn) {
        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (incorrectOnlyBtn) {
        incorrectOnlyBtn.addEventListener('click', () => {
            questions = quizData.filter(q => incorrectQuestions.includes(q.id));
            currentQuestionIndex = 0;
            userAnswers = new Array(questions.length);
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', () => {
            const questionId = parseInt(bookmarkBtn.dataset.questionId);
            toggleBookmark(questionId);
            bookmarkBtn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    }
}

function initializeExamModeEvents() {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const checkAllBtn = document.getElementById('checkAllBtn');
    const submitBtn = document.getElementById('examSubmitBtn');
    const modeToggleButtons = document.querySelectorAll('.mode-toggle-btn');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            const questionIndex = parseInt(option.closest('.question-card').dataset.questionIndex);
            const prevSelected = option.closest('.options-grid').querySelector('.selected');
            if (prevSelected) prevSelected.classList.remove('selected');
            option.classList.add('selected');
            userAnswers[questionIndex] = parseInt(option.dataset.optionIndex);
            updateExamProgress();
            updateExamSubmitButton();
            if (examCheckMode === 'immediate') {
                checkAnswer(questionIndex);
                renderQuizLayout();
            }
        });
    });
    
    if (checkAllBtn) {
        checkAllBtn.addEventListener('click', () => {
            userAnswers.forEach((answer, index) => {
                if (answer !== undefined) {
                    checkAnswer(index);
                }
            });
            renderQuizLayout();
        });
    }
    
    if (submitBtn) {
        submitBtn.addEventListener('click', submitExam);
    }
    
    modeToggleButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeToggleButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            examCheckMode = btn.dataset.mode;
            renderQuizLayout();
        });
    });
    
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const questionId = parseInt(btn.dataset.questionId);
            toggleBookmark(questionId);
            btn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    });
}

function updateExamProgress() {
    const answered = userAnswers.filter(a => a !== undefined).length;
    const progressPercent = (answered / questions.length) * 100;
    const answeredCount = document.getElementById('answeredCount');
    const progressFill = document.getElementById('examProgressFill');
    if (answeredCount) {
        answeredCount.textContent = `${answered}/${questions.length} answered`;
    }
    if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
    }
}

function updateExamSubmitButton() {
    const submitBtn = document.getElementById('examSubmitBtn');
    if (submitBtn) {
        const allAnswered = userAnswers.every(a => a !== undefined);
        submitBtn.disabled = !allAnswered || examSubmitted;
        submitBtn.innerHTML = examSubmitted ?
            '<i class="fas fa-paper-plane"></i> Exam Submitted' :
            `<i class="fas fa-paper-plane"></i> Submit Exam (${questions.length} questions)`;
    }
}

function checkAnswer(questionIndex = currentQuestionIndex) {
    const question = questions[questionIndex];
    const userAnswer = userAnswers[questionIndex];
    isAnswerChecked = true;
    if (userAnswer === question.answer) {
        score++;
        userStats.correctAnswers++;
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].correct++;
        userProgress[question.id].attempts++;
        incorrectQuestions = incorrectQuestions.filter(id => id !== question.id);
    } else {
        if (!incorrectQuestions.includes(question.id)) {
            incorrectQuestions.push(question.id);
        }
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].attempts++;
    }
    userStats.totalQuestions++;
    userStats.masteryLevel = calculateMasteryLevel();
    saveUserData();
    updateDashboardStats();
}

function submitExam() {
    examSubmitted = true;
    if (examCheckMode === 'all-at-once') {
        userAnswers.forEach((answer, index) => {
            if (answer !== undefined) {
                checkAnswer(index);
            }
        });
    }
    stopTimer();
    showResults();
}

function calculateMasteryLevel() {
    const masteredQuestions = Object.values(userProgress).filter(p => p.correct >= 3).length;
    return quizData.length > 0 ? Math.round((masteredQuestions / quizData.length) * 100) : 0;
}

function showResults() {
    stopTimer();
    quizContainer.classList.add('hidden');
    resultsScreen.classList.remove('hidden');
    const percentage = questions.length > 0 ? Math.round((score / questions.length) * 100) : 0;
    
    let restartText = 'Restart Quiz';
    if (currentPage === 'bookmarks') {
        restartText = 'Practice Again';
    }
    
    resultsScreen.innerHTML = `
        <div class="results-card fade-in">
            <div class="results-header">
                <h2 class="results-title">${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)} Results</h2>
                <p class="score-text">You completed ${questions.length} question${questions.length !== 1 ? 's' : ''}</p>
            </div>
            <div class="score-display">${percentage}%</div>
            <div class="score-text">Score: ${score} out of ${questions.length} correct</div>
            <div class="results-details">
                ${questions.map((q, index) => {
                    const isCorrect = userAnswers[index] === q.answer;
                    return `
                        <div class="result-item">
                            <div class="result-question">Q${q.id}: ${q.question}</div>
                            <div class="result-status ${isCorrect ? 'result-correct' : 'result-incorrect'}">
                                ${isCorrect ? 'Correct' : 'Incorrect'}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="restart-btn" id="restartQuiz" aria-label="Restart Quiz" style="margin: 0;">
                    <i class="fas fa-redo"></i>
                    ${restartText}
                </button>
                ${currentPage === 'bookmarks' ? `
                    <button class="quiz-btn" onclick="showBookmarks()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 16px 24px; border-radius: var(--radius);">
                        <i class="fas fa-bookmark"></i>
                        Back to Bookmarks
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('restartQuiz').addEventListener('click', () => {
        if (currentPage === 'bookmarks') {
            startBookmarksQuiz();
        } else {
            startQuiz();
        }
    });
}

function toggleBookmark(questionId) {
    if (bookmarkedQuestions.has(questionId)) {
        bookmarkedQuestions.delete(questionId);
        showNotification('Question removed from bookmarks', 'info');
    } else {
        bookmarkedQuestions.add(questionId);
        showNotification('Question bookmarked', 'success');
    }
    saveUserData();
    
    // If we're on the bookmarks page, refresh it
    if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}


function getDifficultyColor(difficulty) {
    switch (difficulty.toLowerCase()) {
        case 'easy': return '#10b981';
        case 'medium': return '#f59e0b';
        case 'hard': return '#ef4444';
        default: return '#64748b';
    }
}

function jumpToQuestion(questionId) {
    const questionIndex = questions.findIndex(q => `question-${q.id}` === questionId);
    if (questionIndex !== -1) {
        if (currentMode === 'exam') {
            const element = document.getElementById(questionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        } else {
            currentQuestionIndex = questionIndex;
            isAnswerChecked = false;
            renderQuizLayout();
        }
    } else {
        // If question not in current quiz, start a new quiz with that question's category
        const question = quizData.find(q => `question-${q.id}` === questionId) || customQuestions.find(q => `question-${q.id}` === questionId);
        if (question) {
            selectedCategories = [question.category];
            startQuiz();
            setTimeout(() => {
                const element = document.getElementById(questionId);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
        }
    }
}

// Initialize the application
init();
    </script>
</body>

</html>
