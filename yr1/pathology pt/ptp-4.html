 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALIF | Advanced Medical Education</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/protect.js"></script>
    <style type="text/css">
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --primary: #3b82f6; 
            --primary-dark: #2563eb; 
            --primary-light: #dbeafe; 
            --secondary: #6b7280; 
            --success: #22c55e; 
            --error: #ef4444; 
            --warning: #eab308; 
            --info: #0ea5e9; 
            --background: #ffffff; 
            --surface: #f9fafb; 
            --text-primary: #111827; 
            --text-secondary: #4b5563; 
            --text-tertiary: #9ca3af; 
            --border: #e5e7eb; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.05);
            --radius: 8px; 
            --radius-lg: 12px;
            --radius-xl: 16px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
            --gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --glass: rgba(255, 255, 255, 0.85); 
            --glass-border: rgba(229, 231, 235, 0.3);
        }

        .dark-mode {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --primary-light: #93c5fd;
            --secondary: #94a3b8;
            --background: #000000; 
            --surface: #111827; 
            --text-primary: #f9fafb; 
            --text-secondary: #d1d5db; 
            --text-tertiary: #6b7280; 
            --border: #1f2937; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.6); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.6);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.6);
            --glass: rgba(17, 24, 39, 0.85); 
            --glass-border: rgba(31, 41, 55, 0.3);
            .mode-btn,
    .question-text,
    .option-text {
        color: var(--text-primary) !important;
    }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            transition: var(--transition);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* App Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow);
            transform: translateX(-100%);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 0 24px 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .logo i {
            font-size: 24px;
        }

        .sidebar-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            background: var(--glass);
            border-radius: var(--radius);
            margin: 0 16px 24px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: var(--shadow);
        }

        .user-info h3 {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .user-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--glass);
            border-left-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .nav-item.active .nav-icon {
            color: var(--primary);
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .categories-section {
            margin-top: 24px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .categories-grid {
            padding: 0 16px;
        }

        .category-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .category-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .category-card.active {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .category-card.active .category-icon {
            background: var(--primary);
        }

        .category-name {
            font-weight: 500;
            font-size: 14px;
        }

        .category-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-right: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .category-card.active .progress-text {
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content.sidebar-open {
            margin-left: 280px;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--primary-light);
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mode-selector {
            display: flex;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 4px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            padding: 24px 32px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Quiz Container */
        .quiz-container {
            padding: 0 32px 32px;
        }

        .question-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .question-card.fade-in {
            opacity: 1;
        }

        .question-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .question-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .question-number {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            background: var(--primary-light);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-category {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            background: var(--glass);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary-light);
        }

        .question-text {
            font-size: 18px;
            font-weight: 500;
            line-height: 1.6;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass);
            min-height: 60px;
        }

        .option:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .option.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            flex-shrink: 0;
            transition: var(--transition);
        }

        .option.selected .option-letter {
            background: var(--primary);
            color: white;
        }

        .option.correct .option-letter {
            background: var(--success);
            color: white;
        }

        .option.incorrect .option-letter {
            background: var(--error);
            color: white;
        }

        .option-text {
            flex: 1;
            font-size: 15px;
            font-weight: 400;
        }

        /* Explanation Section */
        .explanation-section {
            margin-top: 24px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 24px;
        }

        .explanation-section details {
            margin-bottom: 16px;
        }

        .explanation-section summary {
            padding: 12px 16px;
            background: var(--surface);
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .explanation-section summary:hover {
            background: var(--primary-light);
        }

        .explanation-section details[open] summary {
            background: var(--primary);
            color: white;
        }

        .explanation-content {
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .explanation-content strong {
            color: var(--text-primary);
        }

        .correct-answer, .why-not-section, .related-questions {
            margin-bottom: 16px;
            padding: 16px;
            border-radius: var(--radius);
        }

        .correct-answer {
            background: rgba(34, 197, 94, 0.05);
            border-left: 4px solid var(--success);
        }

        .why-not-section {
            background: rgba(239, 68, 68, 0.05);
            border-left: 4px solid var(--error);
        }

        .related-questions {
            background: rgba(59, 130, 246, 0.05);
            border-left: 4px solid var(--primary);
        }

        .related-questions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .related-question-tag {
            padding: 6px 12px;
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .related-question-tag:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        /* Quiz Controls */
        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .quiz-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .quiz-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .quiz-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .check-btn {
            background: var(--primary);
            color: white;
        }

        .check-btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .next-btn {
            background: var(--success);
            color: white;
        }

        .next-btn:hover:not(:disabled) {
            background: #16a34a;
        }

        .submit-btn {
            background: var(--gradient);
            color: white;
            padding: 12px 32px;
            font-size: 16px;
        }

        /* Results Screen */
        .results-screen {
            padding: 32px;
            max-width: 900px;
            margin: 0 auto;
        }

        .results-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 48px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .results-header {
            margin-bottom: 32px;
        }

        .results-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .score-display {
            font-size: 64px;
            font-weight: 700;
            margin: 32px 0;
            color: var(--text-primary);
        }

        .score-text {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .results-details {
            text-align: left;
            margin: 48px 0;
            background: var(--glass);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--glass-border);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-question {
            flex: 1;
            font-size: 14px;
        }

        .result-status {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .result-correct {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .result-incorrect {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .restart-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 16px 48px;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        /* Enhanced Features */
        .search-container {
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 12px 16px;
            max-width: 400px;
            margin: 0 auto;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-box i {
            color: var(--text-tertiary);
            margin-right: 8px;
        }


        .export-section {
            padding: 16px 32px;
            text-align: center;
        }

        .export-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Custom Quiz Modal */
/* Custom Quiz Modal Styles */
.custom-quiz-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.custom-quiz-modal.active {
    display: flex;
}

.custom-quiz-content {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 32px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--border);
}

.custom-quiz-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 24px;
    color: var(--text-primary);
}

.custom-quiz-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
}

.custom-quiz-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    background: var(--glass);
}

.custom-quiz-option:hover {
    border-color: var(--primary-light);
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

.custom-quiz-option.selected {
    border-color: var(--primary);
    background: var(--primary-light);
}

.custom-quiz-option .option-selector {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    flex-shrink: 0;
}

.custom-quiz-option.selected .option-selector {
    background: var(--primary);
    border-color: var(--primary);
}

.custom-quiz-option.selected .option-selector::after {
    content: '✓';
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.custom-quiz-option label {
    cursor: pointer;
    font-weight: 500;
    color: var(--text-primary);
    flex: 1;
    margin: 0;
}

.quiz-options-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

.quiz-options-section label {
    display: block;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-weight: 600;
}

.custom-quiz-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
}

/* Modern Dropdown for Custom Quiz */
.custom-quiz-content .modern-dropdown {
    position: relative;
    margin-top: 8px;
}

.custom-quiz-content .modern-dropdown select {
    width: 100%;
    padding: 12px 48px 12px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    background-size: 18px;
}

.custom-quiz-content .modern-dropdown select:hover {
    border-color: var(--primary);
    background-color: var(--primary-light);
}

.custom-quiz-content .modern-dropdown select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Glass effect for modal */
.custom-quiz-content.glass-effect {
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.dark-mode .custom-quiz-content.glass-effect {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .sidebar {
                width: 66vw;
            }

            .main-content.sidebar-open {
                margin-left: 100vw;
            }

            .top-nav {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .nav-left {
                width: 100%;
                justify-content: space-between;
            }

            .nav-right {
                width: 100%;
                justify-content: space-between;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                padding: 16px;
            }

            .quiz-container {
                padding: 0 16px 16px;
            }

            .question-card {
                padding: 24px;
            }

            .question-text {
                font-size: 17px;
            }

            .option {
                padding: 12px;
                min-height: 70px;
            }

            .results-card {
                padding: 32px 24px;
            }

            .score-display {
                font-size: 48px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .search-container {
                padding: 12px 16px;
            }

            .analytics-section {
                margin: 16px;
                padding: 16px;
            }

            .quiz-btn {
                padding: 16px 20px;
                font-size: 16px;
            }
        }

        @media (min-width: 1200px) {
            .quiz-container {
                max-width: 1100px;
                margin: 0 auto;
                padding: 24px;
            }

            .question-card {
                max-width: 1000px;
                margin: 0 auto 24px;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        .hidden {
            display: none;
        }

        .glass {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .text-gradient {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .question-difficulty {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .question-dropdown {
            margin-top: 8px;
            display: block;
        }

        .question-dropdown select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .option.disabled {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .timer-warning {
            color: var(--warning);
        }

        .timer-error {
            color: var(--error);
        }

        .loading-spinner {
            display: none;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        .loading-spinner.active {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ultra Modern Styles */
        /* Glass Morphism Effects */
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark-mode .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Enhanced Hover Effects with Glow */
        .nav-item:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.15) 100%) !important;
            border-left-color: var(--primary) !important;
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25) !important;
            backdrop-filter: blur(10px);
        }

        .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(255, 255, 255, 0.95) 100%) !important;
            transform: translateY(-5px) scale(1.03) !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 30px rgba(59, 130, 246, 0.1) !important;
            border-color: var(--primary) !important;
            backdrop-filter: blur(10px);
        }

        .option:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.12) 100%) !important;
            transform: translateY(-3px) scale(1.03) !important;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.2) !important;
            border-color: var(--primary) !important;
        }

        .quiz-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.08) !important;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25) !important;
            filter: brightness(1.1);
        }

        .action-btn:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
            color: white !important;
            transform: scale(1.15) rotate(8deg) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5) !important;
        }

        /* Ultra Modern Dropdown */
        .modern-dropdown {
            position: relative;
            margin-top: 12px;
        }

        .modern-dropdown select {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 2px solid transparent;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--surface) 0%, var(--glass) 100%);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .modern-dropdown select:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.08) 100%);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .modern-dropdown select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 8px 25px rgba(59, 130, 246, 0.25);
            transform: translateY(-2px);
        }

        /* Enhanced Search with Blur Effect */
        .search-container {
            transition: all 0.4s ease;
        }

        .search-box {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .search-box:focus-within {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2);
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.15);
        }

        .search-blur-active .main-content > *:not(.search-container):not(.quiz-container) {
            filter: blur(8px);
            opacity: 0.7;
            pointer-events: none;
        }

        /* Beautiful Stats Cards */
        .stat-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.05) !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2) !important;
        }

        /* Modern Progress Bars */
        .progress-fill {
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark), #8b5cf6) !important;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.4);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Beautiful Notification */
        .notification {
            border-radius: 20px !important;
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15)) !important;
        }

        .dark-mode .notification {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2)) !important;
        }

        /* Enhanced Question Cards */
        .question-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .question-card:hover {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-3px);
            border-color: var(--primary-light);
        }

        /* Modern Settings Panel */
        .settings-panel {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
        }

        .dark-mode .settings-panel {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Question Creator */
        .custom-question-creator {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 32px;
        }

        .dark-mode .custom-question-creator {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.15) rotate(15deg);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.6);
        }

        /* Dark mode adjustments */
        .dark-mode .nav-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.1) 100%) !important;
        }

        .dark-mode .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(17, 24, 39, 0.95) 100%) !important;
        }

        .dark-mode .option:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.08) 100%) !important;
        }

        /* Search Results Highlight */
        .search-highlight {
            background: linear-gradient(120deg, var(--primary-light) 0%, transparent 50%);
            border-radius: 4px;
            padding: 2px 4px;
        }
        @media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 12px 16px;
    }

    .stat-card {
        padding: 16px 12px;
        min-height: 80px;
    }

    .stat-header {
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

    .stat-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }

    .stat-value {
        font-size: 20px;
        margin-bottom: 2px;
    }

    .stat-label {
        font-size: 11px;
        line-height: 1.3;
    }

    .stat-trend {
        font-size: 10px;
    }

    .stat-trend i {
        font-size: 10px;
    }
}

/* Extra small devices (phones under 400px) */
@media (max-width: 400px) {
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 10px 12px;
    }

    .stat-card {
        padding: 14px 10px;
        min-height: 70px;
    }

    .stat-value {
        font-size: 18px;
    }

    .stat-label {
        font-size: 10px;
    }
}
.analytics-grid {
    display: none;
}

/* OR hide individual cards */
.analytics-card {
    display: none;
}

/* If you want to keep the section structure but hide content */
.analytics-section {
    padding: 0;
    margin: 0;
    height: 0;
    overflow: hidden;
}
@media (max-width: 768px) {
    /* Your existing mobile styles... */
    
    .sidebar {
        width: 66vw;
    }

    .main-content.sidebar-open {
        margin-left: 100vw;
    }

    .top-nav {
        padding: 12px 16px;
        flex-wrap: wrap;
        gap: 12px;
    }

    /* Hide all custom question and export buttons on mobile */
    .fab {
        display: none !important;
    }
    
    #createCustomQuizBtn {
        display: none !important;
    }
    
    /* Hide both buttons in Settings section */
    .settings-panel .quiz-btn:has(i.fa-download),
    .settings-panel .quiz-btn:has(i.fa-plus) {
        display: none !important;
    }

    /* Your stats grid and other mobile styles... */
    .stats-grid {
        display: flex;
        overflow-x: auto;
        gap: 6px;
        padding: 6px 10px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        margin: 0 -4px;
    }
    /* ... rest of your mobile CSS */
}
@media (max-width: 768px) {
    .fab {
        display: none !important;
    }
    
    /* Hide entire export section from Dashboard */
    .export-section {
        display: none !important;
    }
    
    /* Hide both buttons in Settings section */
    .settings-panel .quiz-btn:has(i.fa-download),
    .settings-panel .quiz-btn:has(i.fa-plus) {
        display: none !important;
    }
}
@media (max-width: 768px) {
    /* Hide all stat cards except Correct Answers */
    .stat-card:not(:first-child) {
        display: none !important;
    }
    
    /* Optional: Make the Correct Answers card full width */
    .stat-card:first-child {
        width: 100% !important;
        flex: 1 !important;
    }

    /* Your existing mobile styles for stats grid */
    .stats-grid {
        display: flex;
        overflow-x: auto;
        gap: 6px;
        padding: 6px 10px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        margin: 0 -4px;
    }
}
.user-avatar img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}
/* Primary action button */
.action-btn.primary {
    background: var(--primary);
    color: white;
}

.action-btn.primary:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
}

    </style>
</head>
<body class="dark-mode">
    <div class="overlay" id="overlay"></div>
    
    <!-- Custom Quiz Modal -->
<div class="custom-quiz-modal" id="customQuizModal">
    <div class="custom-quiz-content glass-effect">
        <h3 class="custom-quiz-title"> </h3>
        <div class="custom-quiz-options">
            <div class="custom-quiz-option" data-category="all">
                <div class="option-selector"></div>
                <label>All Categories</label>
            </div>
            <div class="custom-quiz-option" data-category="easy">
                <div class="option-selector"></div>
                <label>Easy Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="medium">
                <div class="option-selector"></div>
                <label>Medium Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="hard">
                <div class="option-selector"></div>
                <label>Hard Questions Only</label>
            </div>
            <div class="custom-quiz-option" data-category="bookmarked">
                <div class="option-selector"></div>
                <label>Bookmarked Questions Only</label>
            </div>
            <div class="quiz-options-section">
                <label>Number of Questions</label>
                <div class="modern-dropdown">
                    <select id="questionCount">
                        <option value="5">5 Questions</option>
                        <option value="10" selected>10 Questions</option>
                        <option value="15">15 Questions</option>
                        <option value="20">20 Questions</option>
                        <option value="0">All Questions</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="custom-quiz-actions">
            <button class="quiz-btn" id="cancelCustomQuiz">
                Cancel
            </button>
            <button class="quiz-btn check-btn" id="createCustomQuiz">
                Create Quiz
            </button>
        </div>
    </div>
</div>
    
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-stethoscope"></i>
                    <span>ALIF</span>
                </div>
                <div class="sidebar-subtitle">Advanced Medical Education Platform</div>
            </div>
            
            <div class="user-profile">
    <div class="user-avatar">
        <img src="logo.png" alt="User Avatar">
    </div>
    <div class="user-info">
        <h3>ALIFO</h3>
        <p>Medical Student</p>
    </div>
</div>

            
            <div class="nav-item active">
                <div class="nav-icon">
                    <i class="fas fa-home"></i>
                </div>
                <span>Dashboard</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span>My Courses</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span>Progress Analytics</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-bookmark"></i>
                </div>
                <span>Bookmarked Questions</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <span>Settings</span>
            </div>
            
            <div class="categories-section">
                <div class="section-title">
                    <span>Medical Categories</span>
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div class="categories-grid" id="categoriesGrid"></div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Top Navigation -->
            <div class="top-nav">
    <div class="nav-left">
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle Sidebar">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Add Back and Home buttons -->
        <a href="/" class="action-btn" id="backBtn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <a href="/" class="action-btn primary">
            <i class="fas fa-home"></i>
        </a>
        
        <h1 class="page-title" id="pageTitle">Dashboard</h1>
    </div>
    <div class="nav-right">
        <!-- Your existing mode selector and buttons -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="exam" aria-label="Exam Mode">
                <i class="fas fa-file-alt"></i>
                Exam
            </button>
            <button class="mode-btn" data-mode="quiz" aria-label="Quiz Mode">
                <i class="fas fa-tasks"></i>
                Quiz
            </button>
            <button class="mode-btn" data-mode="learn" aria-label="Learn Mode">
                <i class="fas fa-brain"></i>
                Learn
            </button>
        </div>
        <div class="action-btn" id="themeToggle" aria-label="Toggle Theme">
            <i class="fas fa-sun"></i>
        </div>
        <div class="action-btn" aria-label="Notifications">
            <i class="fas fa-bell"></i>
        </div>
    </div>
</div>
            
            <!-- Search Section -->
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search questions or categories...">
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+12%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="correctAnswers">0</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-down" style="color: var(--error);"></i>
                            <span style="color: var(--error); font-size: 13px;">-5%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="timeSpent">0h</div>
                    <div class="stat-label">Time Spent</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+8%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="masteryLevel">0%</div>
                    <div class="stat-label">Mastery Level</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--warning);"></i>
                            <span style="color: var(--warning); font-size: 13px;">+3</span>
                        </div>
                    </div>
                    <div class="stat-value" id="streakCount">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div class="analytics-section">
                <h3 class="analytics-title">Learning Analytics</h3>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-value" id="weakAreasCount">0</div>
                        <div class="analytics-label">Weak Areas Identified</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="avgTimePerQuestion">0s</div>
                        <div class="analytics-label">Avg Time Per Question</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="improvementRate">0%</div>
                        <div class="analytics-label">Weekly Improvement</div>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Container -->
            <div class="quiz-container" id="quizContainer"></div>
            
            <!-- Results Screen -->
            <div class="results-screen hidden" id="resultsScreen"></div>
            
            <!-- Export Section -->
            <div class="export-section">
                <button class="export-btn" id="exportProgress">
                    <i class="fas fa-download"></i>
                     
                </button>
                <button class="export-btn" id="createCustomQuizBtn" style="margin-left: 12px;">
                    <i class="fas fa-plus"></i>
                     
                </button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  // Check if running inside Telegram
  const tg = window.Telegram?.WebApp;

  // --- 1️⃣ Handle Telegram Mini App Back Button ---
  if (tg) {
    tg.ready(); // Initialize Telegram SDK
    tg.BackButton.show();

    tg.BackButton.onClick(() => {
      console.log("Telegram back button pressed");
      handleBackAction();
    });
  }

  // --- 2️⃣ Handle Browser/Phone Back Button ---
  window.addEventListener('popstate', () => {
    console.log("Browser back button pressed");
    handleBackAction();
  });

  // --- 3️⃣ Function to handle back action globally ---
  function handleBackAction() {
    // Example actions (customize as you wish):
    // Go back if possible, otherwise go to home page
    if (document.referrer && window.history.length > 1) {
      window.history.back();
    } else {
      window.location.href = '/'; // or your home page route
    }
  }

  // --- 4️⃣ Optional: Prevent unwanted exits ---
  // This ensures pressing back doesn’t immediately close the app
  history.pushState(null, '', location.href);
</script>

     <script>
        // Anti-copy, anti-inspect measures
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
});
document.addEventListener('keydown', function(e) {
    if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73) || (e.ctrlKey && e.shiftKey && e.keyCode === 74) || (e.ctrlKey && e.keyCode === 85)) {
        e.preventDefault();
    }
});

// Enhanced quiz data with more questions
const quizData = [
    {
        "id": 1,
        "question": "A 22-year-old woman nursing her newborn develops a tender erythematous area around the nipple of her left breast. A thick, yellow fluid is observed to drain from an open fissure. Examination of this breast fluid under the light microscope will most likely reveal an abundance of which of the following inflammatory cells?",
        "options": [
            "(A) B lymphocytes",
            "(B) Eosinophils",
            "(C) Mast cells",
            "(D) Neutrophils",
            "(E) Plasma cells"
        ],
        "answer": 3,
        "correctAnswer": "Neutrophils",
        "explanation": "The thick, yellow fluid draining from the breast fissure in this patient represents a purulent exudate. Purulent exudates and effusions are associated with pathologic conditions such as pyogenic bacterial infections, in which the predominant cell type is the segmented neutrophil (polymorphonuclear leukocyte).",
        "whyNotOtherOptions": {
            "a": "B lymphocytes are mediators of chronic inflammation and provide antigen-specific immunity to infectious diseases.",
            "b": "Eosinophils are particularly evident during allergic-type reactions and parasitic infestations.",
            "c": "Mast cells are granulated cells that contain receptors for IgE on their cell surface. They are additional cellular sources of vasoactive mediators, particularly in response to allergens.",
            "e": "Plasma cells are mediators of chronic inflammation and provide antigen-specific immunity to infectious diseases."
        },
        "relatedQuestions": ["9", "19"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 2,
        "question": "Which of the following mediators of inflammation facilitates chemotaxis, cytolysis, and opsonization at the site of inflammation in the patient described in Question 1?",
        "options": [
            "(A) Complement proteins",
            "(B) Defensins",
            "(C) Kallikrein",
            "(D) Kinins",
            "(E) Prostaglandins"
        ],
        "answer": 0,
        "correctAnswer": "Complement proteins",
        "explanation": "Complement proteins act upon one another in a cascade, generating biologically active fragments (e.g., C5a, C3b) or complexes (e.g., C567). These products of complement activation cause local edema by increasing the permeability of blood vessels. They also promote chemotaxis of leukocytes and lyse cells (membrane attack complex) and act as opsonins by coating bacteria.",
        "whyNotOtherOptions": {
            "b": "Defensins are antimicrobial peptides but do not mediate chemotaxis, cytolysis, or opsonization.",
            "c": "Kallikrein generates vasoactive kinins but is not involved in opsonization or cytolysis.",
            "d": "Kinins are formed following tissue trauma and mediate pain transmission.",
            "e": "Prostaglandins are involved in vasodilation and pain but not directly in chemotaxis, cytolysis, or opsonization."
        },
        "relatedQuestions": ["1", "18"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 3,
        "question": "A 63-year-old man becomes febrile and begins expectorating large amounts of mucopurulent sputum. Sputum cultures are positive for Gram-positive diplococci. Which of the following mediators of inflammation provides potent chemotactic factors for the directed migration of inflammatory cells into the alveolar air spaces of this patient?",
        "options": [
            "(A) Bradykinin",
            "(B) Histamine",
            "(C) Myeloperoxidase",
            "(D) N-formylated peptides",
            "(E) Plasmin"
        ],
        "answer": 3,
        "correctAnswer": "N-formylated peptides",
        "explanation": "The most potent chemotactic factors for leukocytes at the site of injury are (1) complement proteins (e.g., C5a); (2) bacterial and mitochondrial products, particularly low molecular weight N-formylated peptides; (3) products of arachidonic acid metabolism (especially LTB4); and (4) chemokines (e.g., interleukin-1 and interferon-γ).",
        "whyNotOtherOptions": {
            "a": "Bradykinin is a vasoactive mediator causing pain and increased permeability.",
            "b": "Histamine is one of the primary mediators of increased vascular permeability.",
            "c": "Myeloperoxidase is involved in generating hypochlorous acid for bactericidal activity.",
            "e": "Plasmin is a fibrinolytic enzyme generated by activated Hageman factor (clotting factor XII)."
        },
        "relatedQuestions": ["17", "18"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 4,
        "question": "A 59-year-old man suffers a massive heart attack and expires 24 hours later due to ventricular arrhythmia. Histologic examination of the affected heart muscle at autopsy would show an abundance of which of the following inflammatory cells?",
        "options": [
            "(A) Fibroblasts",
            "(B) Lymphocytes",
            "(C) Macrophages",
            "(D) Neutrophils",
            "(E) Plasma cells"
        ],
        "answer": 3,
        "correctAnswer": "Neutrophils",
        "explanation": "During acute inflammation, neutrophils (PMNs) adhere to the vascular endothelium. They flatten and migrate from the vasculature, through the endothelial cell layer, and into the surrounding tissue. About 24 hours after the onset of infarction, PMNs are observed to infiltrate necrotic tissue at the periphery of the infarct. Their function is to clear debris and begin the process of wound healing.",
        "whyNotOtherOptions": {
            "a": "Fibroblasts regulate scar tissue formation at the site of infarction.",
            "b": "Lymphocytes are mediators of chronic inflammation and provide antigen-specific immunity to infectious diseases.",
            "c": "Macrophages regulate scar tissue formation at the site of infarction.",
            "e": "Plasma cells are mediators of chronic inflammation and provide antigen-specific immunity to infectious diseases."
        },
        "relatedQuestions": ["39", "40"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 5,
        "question": "A 5-year-old boy punctures his thumb with a rusty nail. Four hours later, the thumb appears red and swollen. Initial swelling of the boy’s thumb is primarily due to which of the following mechanisms?",
        "options": [
            "(A) Decreased intravascular hydrostatic pressure",
            "(B) Decreased intravascular oncotic pressure",
            "(C) Increased capillary permeability",
            "(D) Increased intravascular oncotic pressure",
            "(E) Vasoconstriction of arterioles"
        ],
        "answer": 2,
        "correctAnswer": "Increased capillary permeability",
        "explanation": "Forces that regulate the balance of vascular and tissue fluids include (1) hydrostatic pressure, (2) oncotic pressure, (3) osmotic pressure, and (4) lymph flow. During inflammation, an increase in the permeability of the endothelial cell barrier results in local edema. Vasodilation of arterioles exacerbates fluid leakage, and vasoconstriction of postcapillary venules increases the hydrostatic pressure in the capillary bed, potentiating the formation of edema.",
        "whyNotOtherOptions": {
            "a": "Decreased intravascular hydrostatic pressure would reduce edema formation.",
            "b": "Decreased intravascular oncotic pressure is seen in conditions like nephrotic syndrome, not acute injury.",
            "d": "Increased intravascular oncotic pressure would draw fluid into vessels.",
            "e": "Vasoconstriction of arterioles is transient and initial; swelling is due to permeability."
        },
        "relatedQuestions": ["28", "34"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 6,
        "question": "Which of the following serum proteins activates the complement, coagulation, and fibrinolytic systems at the site of injury in the patient described in Question 5?",
        "options": [
            "(A) Bradykinin",
            "(B) Hageman factor",
            "(C) Kallikrein",
            "(D) Plasmin",
            "(E) Thrombin"
        ],
        "answer": 1,
        "correctAnswer": "Hageman factor",
        "explanation": "Hageman factor (clotting factor XII) provides a key source of vasoactive mediators. Activation of this plasma protein at the site of tissue injury stimulates (1) conversion of plasminogen to plasmin, which induces fibrinolysis; (2) conversion of prekallikrein to kallikrein, which generates vasoactive peptides of low molecular weight referred to as kinins; (3) activation of the alternative complement pathway; and (4) activation of the coagulation system.",
        "whyNotOtherOptions": {
            "a": "Bradykinin is a product of the kinin system, not the activator.",
            "c": "Kallikrein is activated by Hageman factor.",
            "d": "Plasmin is activated downstream in fibrinolysis.",
            "e": "Thrombin is part of coagulation but not the initial activator of all systems."
        },
        "relatedQuestions": ["5", "29"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 7,
        "question": "An 80-year-old woman presents with a 4-hour history of fever, shaking chills, and disorientation. Her blood pressure is 80/40 mm Hg. Physical examination shows diffuse purpura on her upper arms and chest. Blood cultures are positive for Gram-negative organisms. Which of the following cytokines is primarily involved in the pathogenesis of direct vascular injury in this patient with septic shock?",
        "options": [
            "(A) Interferon-γ",
            "(B) Interleukin-1",
            "(C) Platelet-derived growth factor",
            "(D) Transforming growth factor-β",
            "(E) Tumor necrosis factor-α"
        ],
        "answer": 4,
        "correctAnswer": "Tumor necrosis factor-α",
        "explanation": "In patients with endotoxic shock, lipopolysaccharide released from Gram-negative bacteria stimulates monocytes/macrophages to secrete large quantities of TNF-α. This glycoprotein causes direct cytotoxic damage to capillary endothelial cells.",
        "whyNotOtherOptions": {
            "a": "Interferon-γ activates macrophages but does not cause direct vascular injury.",
            "b": "Interleukin-1 induces fever and acute phase response but secondary to TNF.",
            "c": "Platelet-derived growth factor promotes fibrosis, not acute vascular injury.",
            "d": "Transforming growth factor-β is involved in fibrosis and repair."
        },
        "relatedQuestions": ["17", "45"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 8,
        "question": "A 24-year-old intravenous drug abuser develops a 2-day history of severe headache and fever. His temperature is 38.7°C (103°F). Blood cultures are positive for Gram-positive cocci. The patient is given intravenous antibiotics, but he deteriorates rapidly and dies. A cross section of the brain at autopsy reveals two encapsulated cavities. Which of the following terms best characterizes this pathologic finding?",
        "options": [
            "(A) Chronic inflammation",
            "(B) Fibrinoid necrosis",
            "(C) Granulomatous inflammation",
            "(D) Reactive gliosis",
            "(E) Suppurative inflammation"
        ],
        "answer": 4,
        "correctAnswer": "Suppurative inflammation",
        "explanation": "Suppurative inflammation describes a condition in which a purulent exudate is accompanied by significant liquefactive necrosis. It is the equivalent of pus. The abscesses are composed of a central cavity filled with pus, surrounded by a layer of granulation tissue.",
        "whyNotOtherOptions": {
            "a": "Chronic inflammation is nonsuppurative.",
            "b": "Fibrinoid necrosis is observed in areas of necrotizing vasculitis.",
            "c": "Granulomatous inflammation is seen in patients with tuberculosis.",
            "d": "Reactive gliosis is a normal response of the brain to injury and infection but is not visible on the cut surface of the brain at autopsy."
        },
        "relatedQuestions": ["9", "33"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 9,
        "question": "A 36-year-old woman with pneumococcal pneumonia develops a right pleural effusion. The pleural fluid displays a high specific gravity and contains large numbers of polymorphonuclear (PMN) leukocytes. Which of the following best characterizes this pleural effusion?",
        "options": [
            "(A) Fibrinous exudate",
            "(B) Lymphedema",
            "(C) Purulent exudate",
            "(D) Serosanguineous exudate",
            "(E) Transudate"
        ],
        "answer": 2,
        "correctAnswer": "Purulent exudate",
        "explanation": "A transudate denotes edema fluid with low protein content, whereas an exudate denotes edema fluid with high protein content. A purulent exudate or effusion contains a prominent cellular component (PMNs).",
        "whyNotOtherOptions": {
            "a": "Fibrinous exudate does not contain leukocytes.",
            "b": "Lymphedema is due to lymphatic obstruction.",
            "d": "Serosanguineous exudate contains RBCs and has a red tinge.",
            "e": "Transudate has low protein and no prominent cellular response."
        },
        "relatedQuestions": ["1", "16"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 10,
        "question": "A 33-year-old man presents with a 5-week history of calf pain and swelling and low-grade fever. Serum levels of creatine kinase are elevated. A muscle biopsy reveals numerous eosinophils. What is the most likely etiology of this patient’s myalgia?",
        "options": [
            "(A) Autoimmune disease",
            "(B) Bacterial infection",
            "(C) Muscular dystrophy",
            "(D) Parasitic infection",
            "(E) Viral infection"
        ],
        "answer": 3,
        "correctAnswer": "Parasitic infection",
        "explanation": "Eosinophils are particularly evident during allergic-type reactions and parasitic infestations. Infections with Trichinella are accompanied by eosinophilia, and skeletal muscle is typically infiltrated by eosinophils.",
        "whyNotOtherOptions": {
            "a": "Autoimmune disease like polymyositis does not feature eosinophils.",
            "b": "Bacterial infections are associated with neutrophilia, and affected tissues are infiltrated with PMNs.",
            "c": "Patients with muscular dystrophy show elevated serum levels of creatine kinase, but eosinophils are not seen on muscle biopsy.",
            "e": "Viral infections are associated with lymphocytosis, and affected tissues are infiltrated with B and T lymphocytes."
        },
        "relatedQuestions": ["13", "43"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 11,
        "question": "A 10-year-old boy with a history of recurrent bacterial infections presents with fever and a productive cough. Biochemical analysis of his neutrophils demonstrates that he has an impaired ability to generate reactive oxygen species. This patient most likely has inherited mutations in the gene that encodes which of the following proteins?",
        "options": [
            "(A) Catalase",
            "(B) Cytochrome P450",
            "(C) Myeloperoxidase",
            "(D) NADPH oxidase",
            "(E) Superoxide dismutase"
        ],
        "answer": 3,
        "correctAnswer": "NADPH oxidase",
        "explanation": "Children with chronic granulomatous disease suffer from a hereditary deficiency of NADPH oxidase, resulting in a failure to produce superoxide anion and hydrogen peroxide during phagocytosis. Persons with this disorder are susceptible to recurrent bacterial infections.",
        "whyNotOtherOptions": {
            "a": "Catalase converts hydrogen peroxide to water and molecular oxygen.",
            "b": "Cytochrome P450 is involved in drug metabolism, not ROS generation.",
            "c": "Patients deficient in myeloperoxidase cannot produce hypochlorous acid (HOCl) and experience an increased susceptibility to infections with the fungal pathogen Candida.",
            "e": "Superoxide dismutase converts superoxide to hydrogen peroxide."
        },
        "relatedQuestions": ["12", "25"],
        "category": "Inflammation",
        "difficulty": "Hard"
    },
    {
        "id": 12,
        "question": "A 25-year-old woman presents with a history of recurrent shortness of breath and severe wheezing. Laboratory studies demonstrate that she has a deficiency of C1 inhibitor, an esterase inhibitor that regulates the activation of the classical complement pathway. What is the diagnosis?",
        "options": [
            "(A) Chronic granulomatous disease",
            "(B) Hereditary angioedema",
            "(C) Myeloperoxidase deficiency",
            "(D) Selective IgA deficiency",
            "(E) Wiskott-Aldrich syndrome"
        ],
        "answer": 1,
        "correctAnswer": "Hereditary angioedema",
        "explanation": "Deficiency of C1 inhibitor, with excessive cleavage of C4 and C2 by C1s, is associated with the syndrome of hereditary angioedema. This disease is characterized by episodic, painless, nonpitting edema of soft tissues.",
        "whyNotOtherOptions": {
            "a": "Chronic granulomatous disease is due to a hereditary deficiency of NADPH oxidase.",
            "c": "Myeloperoxidase deficiency increases susceptibility to infections with Candida.",
            "d": "Selective IgA deficiency and Wiskott-Aldrich syndrome are congenital immunodeficiency disorders associated with defects in lymphocyte function."
        },
        "relatedQuestions": ["11", "32"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 13,
        "question": "A 40-year-old man complains of a 2-week history of increasing abdominal pain and yellow discoloration of his sclera. Physical examination reveals right upper quadrant pain. Laboratory studies show elevated serum levels of alkaline phosphatase (520 U/dL) and bilirubin (3.0 mg/dL). A liver biopsy shows portal fibrosis, with scattered foreign bodies consistent with schistosome eggs. Which of the following inflammatory cells is most likely to predominate in the portal tracts in the liver of this patient?",
        "options": [
            "(A) Basophils",
            "(B) Eosinophils",
            "(C) Macrophages",
            "(D) Monocytes",
            "(E) Plasma cells"
        ],
        "answer": 1,
        "correctAnswer": "Eosinophils",
        "explanation": "Eosinophils are recruited in parasitic infestations and would be expected to predominate in the portal tracts of the liver in patients with schistosomiasis. Eosinophils contain leukotrienes and platelet-activating factor, as well as acid phosphatase and eosinophil major basic protein.",
        "whyNotOtherOptions": {
            "a": "Basophils are involved in immediate hypersensitivity.",
            "c": "Macrophages are seen in granulomatous inflammation.",
            "d": "Monocytes are precursors to macrophages.",
            "e": "Plasma cells are differentiated B lymphocytes that secrete large amounts of monospecific immunoglobulin."
        },
        "relatedQuestions": ["10", "38"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 14,
        "question": "A 41-year-old woman complains of excessive menstrual bleeding and pelvic pain of 4 months. She uses an intrauterine device for contraception. Endometrial biopsy reveals an excess of plasma cells and macrophages within the stroma. The presence of these cells and scattered lymphoid follicles within the endometrial stroma is evidence of which of the following conditions?",
        "options": [
            "(A) Acute inflammation",
            "(B) Chronic inflammation",
            "(C) Granulation tissue",
            "(D) Granulomatous inflammation",
            "(E) Menstruation"
        ],
        "answer": 1,
        "correctAnswer": "Chronic inflammation",
        "explanation": "The cellular components of chronic inflammation are lymphocytes, antibody-producing plasma cells, and macrophages. The chronic inflammatory response is often prolonged and may be associated with aberrant repair (i.e., fibrosis).",
        "whyNotOtherOptions": {
            "a": "Neutrophils are featured in acute inflammation.",
            "c": "Granulation tissue is part of repair with fibroblasts and new vessels.",
            "d": "Granulomatous inflammation features epithelioid macrophages and giant cells.",
            "e": "Menstruation features neutrophils."
        },
        "relatedQuestions": ["26", "31"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 15,
        "question": "A 62-year-old woman undergoing chemotherapy for breast cancer presents with a 3-day history of fever and chest pain. Cardiac catheterization reveals a markedly reduced ejection fraction with normal coronary blood flow. A myocardial biopsy is obtained, and a PCR test for coxsackievirus is positive. Histologic examination of this patient’s myocardium will most likely reveal an abundance of which of the following inflammatory cells?",
        "options": [
            "(A) Eosinophils",
            "(B) Lymphocytes",
            "(C) Macrophages",
            "(D) Mast cells",
            "(E) Neutrophils"
        ],
        "answer": 1,
        "correctAnswer": "Lymphocytes",
        "explanation": "This patient with viral myocarditis will show an accumulation of lymphocytes in the affected heart muscle. Naïve lymphocytes encounter antigen-presenting cells (macrophages and dendritic cells) in the secondary lymphoid organs. In response to this cell-cell interaction, they become activated, circulate in the vascular system, and are recruited to peripheral tissues (e.g., heart).",
        "whyNotOtherOptions": {
            "a": "Eosinophils are seen in parasitic or allergic conditions.",
            "c": "Macrophages are in chronic or granulomatous inflammation.",
            "d": "Mast cells are in hypersensitivity.",
            "e": "Neutrophils are in acute bacterial infections, although acute inflammation may be observed in lytic infections."
        },
        "relatedQuestions": ["43", "44"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 16,
        "question": "A 58-year-old woman with long-standing diabetes and hypertension develops end-stage renal disease and dies in uremia. A shaggy fibrin-rich exudate is noted on the visceral pericardium at autopsy. Which of the following best explains the pathogenesis of this fibrinous exudate?",
        "options": [
            "(A) Antibody binding and complement activation",
            "(B) Chronic passive congestion",
            "(C) Injury and increased vascular permeability",
            "(D) Margination of segmented neutrophils",
            "(E) Thrombosis of penetrating coronary arteries"
        ],
        "answer": 2,
        "correctAnswer": "Injury and increased vascular permeability",
        "explanation": "Binding of vasoactive mediators to specific receptors on endothelial cells results in contraction and gap formation. This break in the endothelial barrier leads to the leakage of intravascular fluid into the extravascular space. Direct injury to endothelial cells also leads to leakage of intravascular fluid. A fibrinous exudate contains large amounts of fibrin as a result of activation of the coagulation system.",
        "whyNotOtherOptions": {
            "a": "Antibody binding and complement are in immune-mediated injury.",
            "b": "Chronic passive congestion leads to transudate.",
            "d": "Margination is part of leukocyte recruitment.",
            "e": "Thrombosis is vascular occlusion."
        },
        "relatedQuestions": ["9", "28"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 17,
        "question": "A 68-year-old man presents with fever, shaking chills, and shortness of breath. Physical examination shows rales and decreased breath sounds over both lung fields. The patient exhibits grunting respirations, 30 to 35 breaths per minute, with flaring of the nares. The sputum is rusty yellow and displays numerous polymorphonuclear leukocytes. Which of the following mediators of inflammation is chiefly responsible for the development of fever in this patient?",
        "options": [
            "(A) Arachidonic acid",
            "(B) Interleukin-1",
            "(C) Leukotriene B4",
            "(D) Prostacyclin (PGI2 )",
            "(E) Thromboxane A2"
        ],
        "answer": 1,
        "correctAnswer": "Interleukin-1",
        "explanation": "Release of exogenous pyrogens by bacteria, viruses, or injured cells stimulates the production of endogenous pyrogens such as IL-1α, IL-1β, and TNF-α. IL-1 is a 15-kDa protein that stimulates prostaglandin synthesis in the hypothalamic thermoregulatory centers, thereby altering the “thermostat” that controls body temperature.",
        "whyNotOtherOptions": {
            "a": "Arachidonic acid is precursor to eicosanoids.",
            "c": "Leukotriene B4 is chemotactic.",
            "d": "Prostacyclin inhibits platelet aggregation.",
            "e": "Thromboxane A2 promotes platelet aggregation."
        },
        "relatedQuestions": ["3", "7"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 18,
        "question": "Sputum cultures obtained from the patient described in Question 17 are positive for Streptococcus pneumoniae. Removal of bacteria from the alveolar air spaces in this patient involves opsonization by complement, an important step in mediating which of the following leukocyte functions?",
        "options": [
            "(A) Chemotaxis",
            "(B) Diapedesis",
            "(C) Haptotaxis",
            "(D) Margination",
            "(E) Phagocytosis"
        ],
        "answer": 4,
        "correctAnswer": "Phagocytosis",
        "explanation": "Phagocytosis of most biologic agents is enhanced by their coating with specific plasma components (opsonins), particularly immunoglobulins or the C3b fragment of complement.",
        "whyNotOtherOptions": {
            "a": "Chemotaxis is directed migration.",
            "b": "Diapedesis is transendothelial migration.",
            "c": "Haptotaxis is migration along substrate.",
            "d": "Margination is adhesion to endothelium."
        },
        "relatedQuestions": ["2", "19"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 19,
        "question": "Which of the following mediators of inflammation is primarily responsible for secondary injury to alveolar basement membranes and lung parenchyma in the patient described in Questions 17 and 18?",
        "options": [
            "(A) Complement proteins",
            "(B) Fibrin split products",
            "(C) Immunoglobulins",
            "(D) Interleukin-1",
            "(E) Lysosomal enzymes"
        ],
        "answer": 4,
        "correctAnswer": "Lysosomal enzymes",
        "explanation": "The primary role of neutrophils in inflammation is host defense and débridement of damaged tissue. However, when the response is extensive or unregulated, the chemical mediators of inflammation may prolong tissue damage. Thus, the same neutrophil-derived lysosomal enzymes that are beneficial when active intracellularly can be harmful when released to the extracellular environment.",
        "whyNotOtherOptions": {
            "a": "Complement proteins aid in opsonization and chemotaxis.",
            "b": "Fibrin split products are from coagulation.",
            "c": "Immunoglobulins are for opsonization.",
            "d": "Interleukin-1 induces fever and acute phase."
        },
        "relatedQuestions": ["1", "20"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 20,
        "question": "Which of the following proteins inhibits fibrinolysis, activation of the complement system, and protease-mediated damage in the lungs of the patient described in the previous questions?",
        "options": [
            "(A) Acid phosphatase",
            "(B) Lactoferrin",
            "(C) Lysozyme",
            "(D) α2 -Macroglobulin",
            "(E) Myeloperoxidase"
        ],
        "answer": 3,
        "correctAnswer": "α2 -Macroglobulin",
        "explanation": "Proteolytic enzymes that are released by phagocytic cells during inflammation are regulated by a family of protease inhibitors, including α1 -antitrypsin and α2 -macroglobulin. These plasma-derived proteins inhibit plasmin-activated fibrinolysis and activation of the complement system and help protect against nonspecific tissue injury during acute inflammation.",
        "whyNotOtherOptions": {
            "a": "Acid phosphatase is a lysosomal enzyme.",
            "b": "Lactoferrin binds iron.",
            "c": "Lysozyme is a glycosidase that degrades the peptidoglycans of Gram-positive bacterial cell walls.",
            "e": "Myeloperoxidase is contained within neutrophil granules."
        },
        "relatedQuestions": ["19", "46"],
        "category": "Inflammation",
        "difficulty": "Hard"
    },
    {
        "id": 21,
        "question": "A 35-year-old woman presents with a 5-day history of a painful sore on her back. Physical examination reveals a 1-cm abscess over her left shoulder. Biopsy of the lesion shows vasodilation and leukocyte margination. What glycoprotein mediates initial tethering of segmented neutrophils to endothelial cells in this skin lesion?",
        "options": [
            "(A) Cadherin",
            "(B) Entactin",
            "(C) Integrin",
            "(D) Laminin",
            "(E) Selectin"
        ],
        "answer": 4,
        "correctAnswer": "Selectin",
        "explanation": "Selectins are sugar-binding glycoproteins that mediate the initial adhesion of leukocytes to endothelial cells at sites of inflammation. E-selectins are found on endothelial cells, P-selectins are found on platelets, and L-selectins are found on leukocytes. E-selectins are stored in Weibel-Palade bodies of resting endothelial cells. Upon activation, E-selectins are redistributed along the luminal surface of the endothelial cells, where they mediate the initial adhesion (tethering) and rolling of leukocytes.",
        "whyNotOtherOptions": {
            "a": "Cadherins mediate cell-cell adhesion, but they are not involved in neutrophil adhesion to vascular endothelium.",
            "b": "Entactin and laminin are original basement membrane proteins.",
            "c": "After leukocytes have come to a rest, integrins mediate transendothelial cell migration and chemotaxis.",
            "d": "Laminin is a basement membrane protein."
        },
        "relatedQuestions": ["35", "28"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 22,
        "question": "A 14-year-old boy receives a laceration on his forehead during an ice hockey game. When he is first attended to by the medic, there is blanching of the skin around the wound. Which of the following mechanisms accounts for this transient reaction to neurogenic and chemical stimuli at the site of injury?",
        "options": [
            "(A) Constriction of postcapillary venules",
            "(B) Constriction of precapillary arterioles",
            "(C) Dilation of postcapillary venules",
            "(D) Dilation of precapillary arterioles",
            "(E) Ischemic necrosis"
        ],
        "answer": 1,
        "correctAnswer": "Constriction of precapillary arterioles",
        "explanation": "The initial response of arterioles to neurogenic and chemical stimuli is transient vasoconstriction. However, shortly thereafter, vasodilation occurs, with an increase in blood flow to the inflamed area. This process is referred to as active hyperemia.",
        "whyNotOtherOptions": {
            "a": "Constriction of postcapillary venules increases hydrostatic pressure.",
            "c": "Dilation of postcapillary venules decreases hydrostatic pressure.",
            "d": "Dilation of precapillary arterioles causes hyperemia and redness.",
            "e": "Ischemic necrosis is later event."
        },
        "relatedQuestions": ["5", "28"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 23,
        "question": "An 8-year-old girl with asthma presents with respiratory distress. She has a history of allergies and upper respiratory tract infections. She also has history of wheezes associated with exercise. Which of the following mediators of inflammation is the most powerful stimulator of bronchoconstriction and vasoconstriction in this patient?",
        "options": [
            "(A) Bradykinin",
            "(B) Complement proteins",
            "(C) Interleukin-1",
            "(D) Leukotrienes",
            "(E) Tumor necrosis factor-α"
        ],
        "answer": 3,
        "correctAnswer": "Leukotrienes",
        "explanation": "Chemical mediators released by chronic inflammatory cells in the lungs of these patients stimulate bronchial mucus production and bronchoconstriction. Among these mediators are leukotrienes, also known as slow-reacting substances of anaphylaxis. They are derived from arachidonic acid through the lipoxygenase pathway. Leukotrienes stimulate contraction of smooth muscle and enhance vascular permeability.",
        "whyNotOtherOptions": {
            "a": "Bradykinin causes vasodilation and pain.",
            "b": "Complement proteins are in innate immunity.",
            "c": "Interleukin-1 is pyrogenic.",
            "e": "Tumor necrosis factor-α causes cachexia and shock."
        },
        "relatedQuestions": ["24", "36"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 24,
        "question": "Which of the following preformed substances is released from mast cells and platelets, resulting in increased vascular permeability in the lungs of the patient described in Question 23?",
        "options": [
            "(A) Bradykinin",
            "(B) Hageman factor",
            "(C) Histamine",
            "(D) Leukotrienes (SRS-A)",
            "(E) Thromboxane A2"
        ],
        "answer": 2,
        "correctAnswer": "Histamine",
        "explanation": "When IgE-sensitized mast cells are stimulated by antigen, preformed mediators of inflammation are secreted into the extracellular tissues. Histamine binds to specific H1 receptors in the vascular wall, inducing endothelial cell contraction, gap formation, and edema.",
        "whyNotOtherOptions": {
            "a": "Bradykinin and Hageman factor are plasma-derived mediators.",
            "d": "Leukotrienes are not preformed but are synthesized de novo following cell activation.",
            "e": "Thromboxane A2 is synthesized de novo."
        },
        "relatedQuestions": ["23", "29"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 25,
        "question": "A 75-year-old woman complains of recent onset of chest pain, fever, and productive cough with rust-colored sputum. A chest X-ray reveals an infiltrate in the right middle lobe. Sputum cultures are positive for Streptococcus pneumoniae. Phagocytic cells in this patient’s affected lung tissue generate bacteriocidal hypochlorous acid using which of the following enzymes?",
        "options": [
            "(A) Catalase",
            "(B) Cyclooxygenase",
            "(C) Myeloperoxidase",
            "(D) NADPH oxidase",
            "(E) Superoxide dismutase"
        ],
        "answer": 2,
        "correctAnswer": "Myeloperoxidase",
        "explanation": "Myeloperoxidase catalyzes the conversion of H2 O2 , in the presence of a halide (e.g., chloride ion), to form hypochlorous acid. This powerful oxidant is a major bactericidal agent produced by phagocytic cells.",
        "whyNotOtherOptions": {
            "a": "Catalase catabolizes H2 O2 .",
            "b": "Cyclooxygenase mediates the conversion of arachidonic acid to prostaglandins.",
            "d": "NADPH oxidase is involved in oxygen-free radical formation during the neutrophil respiratory burst.",
            "e": "Superoxide dismutase reduces the superoxide radical to H2 O2 ."
        },
        "relatedQuestions": ["11", "19"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 26,
        "question": "A 28-year-old woman cuts her hand while dicing vegetables in the kitchen. The wound is cleaned and sutured. Five days later, the site of injury contains an abundance of chronic inflammatory cells that actively secrete interleukin-1, tumor necrosis factor-α, interferon-α, numerous arachidonic acid derivatives, and various enzymes. Name these cells.",
        "options": [
            "(A) B lymphocytes",
            "(B) Macrophages",
            "(C) Plasma cells",
            "(D) Smooth muscle cells",
            "(E) T lymphocytes"
        ],
        "answer": 1,
        "correctAnswer": "Macrophages",
        "explanation": "The macrophage is the pivotal cell in regulating chronic inflammation. Macrophages, which are derived from circulating monocytes, regulate lymphocyte responses to antigens and secrete a variety of mediators that modulate the proliferation and function of fibroblasts and endothelial cells.",
        "whyNotOtherOptions": {
            "a": "B lymphocytes produce antibodies.",
            "c": "Plasma cells secrete antibodies.",
            "d": "Smooth muscle cells are structural.",
            "e": "T lymphocytes secrete some cytokines but not the wide spectrum."
        },
        "relatedQuestions": ["14", "31"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 27,
        "question": "A 68-year-old man with prostate cancer and bone metastases presents with shaking chills and fever. The peripheral WBC count is 1,000/μL (normal = 4,000 to 11,000/μL). Which of the following terms best describes this hematologic finding?",
        "options": [
            "(A) Leukocytosis",
            "(B) Leukopenia",
            "(C) Neutrophilia",
            "(D) Pancytopenia",
            "(E) Leukemoid reaction"
        ],
        "answer": 1,
        "correctAnswer": "Leukopenia",
        "explanation": "Leukopenia is defined as an absolute decrease in the circulating WBC count. It is occasionally encountered under conditions of chronic inflammation, especially in patients who are malnourished or who suffer from a chronic debilitating disease.",
        "whyNotOtherOptions": {
            "a": "Leukocytosis is an absolute increase in the circulating WBC count.",
            "c": "Neutrophilia is defined as an absolute increase in the circulating neutrophil count.",
            "d": "Pancytopenia refers to decreased circulating levels of all formed elements in the blood.",
            "e": "Leukemoid reaction features very high WBC with immature forms."
        },
        "relatedQuestions": ["37", "42"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 28,
        "question": "A 25-year-old machinist is injured by a metal sliver in his left hand. Over the next few days, the wounded area becomes reddened, tender, swollen, and feels warm to the touch. Redness at the site of injury in this patient is caused primarily by which of the following mechanisms?",
        "options": [
            "(A) Hemorrhage",
            "(B) Hemostasis",
            "(C) Neutrophil margination",
            "(D) Vasoconstriction",
            "(E) Vasodilation"
        ],
        "answer": 4,
        "correctAnswer": "Vasodilation",
        "explanation": "Vasodilation of precapillary arterioles increases blood flow at the site of tissue injury. This condition (active hyperemia) is caused by the release of specific mediators. Vasodilation and hyperemia are primarily responsible for the redness and warmth (rubor and calor) at sites of injury.",
        "whyNotOtherOptions": {
            "a": "Hemorrhage would cause bruising.",
            "b": "Hemostasis is clotting.",
            "c": "Neutrophil margination is part of recruitment.",
            "d": "Vasoconstriction is initial transient."
        },
        "relatedQuestions": ["5", "22"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 29,
        "question": "The patient described in Question 28 goes to the emergency room to have the sliver removed. Which of the following mediators of inflammation plays the most important role in stimulating platelet aggregation at the site of injury following this minor surgical procedure?",
        "options": [
            "(A) Leukotriene C4",
            "(B) Leukotriene D4",
            "(C) Prostaglandin E2",
            "(D) Prostaglandin I2",
            "(E) Thromboxane A2"
        ],
        "answer": 4,
        "correctAnswer": "Thromboxane A2",
        "explanation": "Platelet adherence, aggregation, and degranulation occur when platelets come in contact with fibrillar collagen or thrombin (after activation of the coagulation system). In addition, the arachidonic acid metabolite thromboxane A2 plays a key role in the second wave of platelet aggregation and mediates smooth muscle constriction.",
        "whyNotOtherOptions": {
            "a": "Leukotrienes C4 and D4 induce smooth muscle contraction.",
            "c": "Prostaglandin E2 inhibits inflammatory cell functions.",
            "d": "Prostaglandin I2 inhibits platelet aggregation."
        },
        "relatedQuestions": ["24", "30"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 30,
        "question": "Twenty-four hours later, endothelial cells at the site of injury in the patient described in Questions 28 and 29 release a chemical mediator that inhibits further platelet aggregation. Name this mediator of inflammation.",
        "options": [
            "(A) Plasmin",
            "(B) Prostaglandin (PGI2 )",
            "(C) Serotonin",
            "(D) Thrombin",
            "(E) Thromboxane A2"
        ],
        "answer": 1,
        "correctAnswer": "Prostaglandin (PGI2 )",
        "explanation": "PGI2 is a derivative of arachidonic acid that is formed in the cyclooxygenase enzyme pathway. It promotes vasodilation and bronchodilation and also inhibits platelet aggregation. It activates adenylyl cyclase and increases intracellular levels of cAMP.",
        "whyNotOtherOptions": {
            "a": "Plasmin degrades fibrin.",
            "c": "Serotonin is a vasoactive amine.",
            "d": "Thrombin is a protease that mediates the conversion of fibrinogen to fibrin.",
            "e": "Thromboxane A2 activates guanylyl cyclase and increases intracellular levels of cGMP."
        },
        "relatedQuestions": ["29", "40"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 31,
        "question": "A 37-year-old man with AIDS is admitted to the hospital with a 3-week history of chest pain and shortness of breath. An X-ray film of the chest shows bilateral nodularities of the lungs. A CT-guided lung biopsy is shown. The multinucleated cell in the center of this field is most likely derived from which of the following inflammatory cells?",
        "options": [
            "(A) Entactins",
            "(B) Fibrillins",
            "(C) Fibronectins",
            "(D) Integrins",
            "(E) Macrophages"
        ],
        "answer": 4,
        "correctAnswer": "Macrophages",
        "explanation": "Granulomas are collections of epithelioid cells and multinucleated giant cells that are formed by cytoplasmic fusion of macrophages. When the nuclei are arranged around the periphery of the cell in a horseshoe pattern, the cell is termed a Langhans giant cell.",
        "whyNotOtherOptions": {
            "a": "Entactins are extracellular matrix.",
            "b": "Fibrillins are in elastic fibers.",
            "c": "Fibronectins are adhesion molecules.",
            "d": "Integrins are cell adhesion receptors."
        },
        "relatedQuestions": ["26", "38"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 32,
        "question": "A 45-year-old woman with autoimmune hemolytic anemia presents with increasing fatigue. Which of the following mediators of inflammation is primarily responsible for antibody-mediated hemolysis in this patient?",
        "options": [
            "(A) Arachidonic acid metabolites",
            "(B) Coagulation proteins",
            "(C) Complement proteins",
            "(D) Kallikrein and kinins",
            "(E) Lysophospholipids"
        ],
        "answer": 2,
        "correctAnswer": "Complement proteins",
        "explanation": "Activation of the complement cascade by the classical or alternative pathway leads to the cleavage of complement fragments and the formation of biologically active complexes. The C5b fragment aggregates with complement proteins C6, C7, C8, and C9, resulting in the polymerization of the membrane attack complex (MAC). MAC lyses cells by inserting into the lipid bilayer, forming a pore, and destroying the permeability barrier of the plasma membrane.",
        "whyNotOtherOptions": {
            "a": "Arachidonic acid metabolites are eicosanoids.",
            "b": "Coagulation proteins are for clotting.",
            "d": "Kallikrein and kinins are formed following tissue trauma and mediate pain transmission.",
            "e": "Lysophospholipids are from phospholipase activity."
        },
        "relatedQuestions": ["12", "2"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 33,
        "question": "A 59-year-old alcoholic man is brought to the emergency room with a fever (38.7°C/103°F) and foul-smelling breath. A chest X-ray reveals a pulmonary abscess in the right lower lobe. The patient subsequently develops acute bronchopneumonia and dies. Microscopic examination of the lungs at autopsy is shown. Activation of phospholipase A2 in these intra-alveolar cells resulted in the formation of which of the following mediators of inflammation?",
        "options": [
            "(A) Arachidonic acid",
            "(B) cAMP",
            "(C) cGMP",
            "(D) Diacylglycerol",
            "(E) Inositol trisphosphate"
        ],
        "answer": 0,
        "correctAnswer": "Arachidonic acid",
        "explanation": "Cellular sources of vasoactive mediators are (1) derived from the metabolism of arachidonic acid (prostaglandins, thromboxanes, leukotrienes, and platelet-activating factor). Free arachidonic acid in these acute inflammatory cells is derived from membrane phospholipids (primarily phosphatidylcholine) by stimulus-induced activation of phospholipase A2 .",
        "whyNotOtherOptions": {
            "b": "cAMP is second messenger.",
            "c": "cGMP is second messenger.",
            "d": "Diacylglycerol is from PIP2 hydrolysis.",
            "e": "Inositol trisphosphate is from PIP2 hydrolysis."
        },
        "relatedQuestions": ["8", "36"],
        "category": "Inflammation",
        "difficulty": "Hard"
    },
    {
        "id": 34,
        "question": "A 10-year-old girl presents with a 2-week history of puffiness around her eyes and swelling of the legs and ankles. Laboratory studies show hypoalbuminemia and proteinuria. The urinary sediment contains no inflammatory cells or red blood cells. Which of the following terms describes this patient’s peripheral edema?",
        "options": [
            "(A) Effusion",
            "(B) Exudate",
            "(C) Hydropic change",
            "(D) Lymphedema",
            "(E) Transudate"
        ],
        "answer": 4,
        "correctAnswer": "Transudate",
        "explanation": "Loss of albumin (kidney disorders, this case) or decreased synthesis of plasma proteins (liver disease, malnutrition) reduces plasma oncotic pressure. Noninflammatory edema is referred to as a transudate. A transudate is edema fluid with a low protein content.",
        "whyNotOtherOptions": {
            "a": "An effusion represents excess fluid in a body cavity.",
            "b": "An exudate is edema fluid with a high protein and lipid concentration that frequently contains inflammatory cells.",
            "c": "Hydropic change is cellular swelling.",
            "d": "Lymphedema is usually associated with obstruction of lymphatic flow."
        },
        "relatedQuestions": ["5", "9"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 35,
        "question": "A 25-year-old woman develops a sore, red, hot, swollen left knee. She has no history of trauma and no familial history of joint disease. Fluid aspirated from the joint space shows an abundance of segmented neutrophils. Transendothelial migration of acute inflammatory cells into this patient’s joint space was mediated primarily by which of the following families of proteins?",
        "options": [
            "(A) Eosinophils",
            "(B) B lymphocytes",
            "(C) T lymphocytes",
            "(D) Mast cells",
            "(E) Integrins"
        ],
        "answer": 4,
        "correctAnswer": "Integrins",
        "explanation": "Chemokines and other proinflammatory molecules activate a family of cell adhesion molecules, namely the integrins. Molecules in this family participate in cell-cell and cell-substrate adhesions and cell signaling. Integrins are involved in leukocyte recruitment to sites of injury in acute inflammation.",
        "whyNotOtherOptions": {
            "a": "Eosinophils are cells, not proteins for migration.",
            "b": "B lymphocytes are for antibody production.",
            "c": "T lymphocytes are for cell-mediated immunity.",
            "d": "Mast cells release mediators."
        },
        "relatedQuestions": ["21", "36"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 36,
        "question": "Aspirin is effective in relieving symptoms of acute inflammation in the patient described in Question 35 because it inhibits which of the following enzymes?",
        "options": [
            "(A) Cyclooxygenase",
            "(B) Myeloperoxidase",
            "(C) Phospholipase A2",
            "(D) Protein kinase C",
            "(E) Superoxide dismutase"
        ],
        "answer": 0,
        "correctAnswer": "Cyclooxygenase",
        "explanation": "Arachidonic acid is metabolized by cyclooxygenases (COX-1, COX-2) and lipoxygenases (5-LOX) to generate prostanoids and leukotrienes, respectively. Inhibition of COX is one mechanism by which nonsteroidal anti-inflammatory drugs (NSAIDs), including aspirin, indomethacin, and ibuprofen, exert their potent analgesic and anti-inflammatory effects.",
        "whyNotOtherOptions": {
            "b": "Myeloperoxidase catalyzes the conversion of H2 O2 , in the presence of a halide (e.g., chloride ion) to form hypochlorous acid.",
            "c": "Phospholipase A2 is inhibited by corticosteroids.",
            "d": "Protein kinase C is signaling.",
            "e": "Superoxide dismutase reduces the superoxide radical to H2 O2 ."
        },
        "relatedQuestions": ["23", "45"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 37,
        "question": "A 50-year-old woman is discovered to have metastatic breast cancer. One week after receiving her first dose of chemotherapy, she develops bacterial pneumonia. Which of the following best explains this patient’s susceptibility to bacterial infection?",
        "options": [
            "(A) Depletion of serum complement",
            "(B) Impaired neutrophil respiratory burst",
            "(C) Inhibition of clotting factor activation",
            "(D) Lymphocytosis",
            "(E) Neutropenia"
        ],
        "answer": 4,
        "correctAnswer": "Neutropenia",
        "explanation": "The most common defect is iatrogenic neutropenia secondary to cancer chemotherapy. The importance of protection afforded by acute inflammatory cells is emphasized by the frequency and severity of infections in persons with defective phagocytic cells.",
        "whyNotOtherOptions": {
            "a": "Chemotherapy would not be expected to deplete serum levels of complement.",
            "b": "Impaired neutrophil respiratory burst is in CGD.",
            "c": "Inhibition of clotting is not typical.",
            "d": "Lymphocytosis is increase in lymphocytes."
        },
        "relatedQuestions": ["11", "27"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 38,
        "question": "A 53-year-old man develops weakness, malaise, cough with bloody sputum, and night sweats. A chest X-ray reveals numerous apical densities bilaterally. Exposure to Mycobacterium tuberculosis was documented 20 years ago, and M. tuberculosis is identified in the sputum. The patient subsequently dies of respiratory insufficiency. The lungs are examined at autopsy. Which of the following best characterizes the histopathologic features of this pulmonary lesion?",
        "options": [
            "(A) Acute suppurative inflammation",
            "(B) Chronic inflammation",
            "(C) Fat necrosis",
            "(D) Fibrinoid necrosis",
            "(E) Granulomatous inflammation"
        ],
        "answer": 4,
        "correctAnswer": "Granulomatous inflammation",
        "explanation": "The photograph shows a necrotizing granuloma due to M. tuberculosis. The necrotic center is surrounded by histiocytes, giant cells, and fibrous tissue. Granulomatous inflammation is elicited by fungal infections, tuberculosis, leprosy, schistosomiasis, and the presence of foreign material.",
        "whyNotOtherOptions": {
            "a": "Acute suppurative is pus with neutrophils.",
            "b": "Chronic inflammation is lymphocytes and macrophages without granulomas.",
            "c": "Fat necrosis is in pancreatitis.",
            "d": "Fibrinoid necrosis is in vasculitis."
        },
        "relatedQuestions": ["13", "31"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 39,
        "question": "A 59-year-old man experiences acute chest pain and is rushed to the emergency room. Laboratory studies and ECG demonstrate an acute myocardial infarction; however, coronary artery angiography performed 2 hours later does not show evidence of thrombosis. Intravascular thrombolysis that occurred in this patient was mediated by plasminogen activators that were released by which of the following cells?",
        "options": [
            "(A) Basophils",
            "(B) Capillary endothelial cells",
            "(C) Macrophages",
            "(D) Myofibroblasts",
            "(E) Smooth muscle cells"
        ],
        "answer": 1,
        "correctAnswer": "Capillary endothelial cells",
        "explanation": "Endothelial cells in the vicinity of the thrombus produce tissue-type plasminogen activators, which activate plasmin and initiate thrombolysis (fibrinolysis).",
        "whyNotOtherOptions": {
            "a": "Basophils release histamine.",
            "c": "Macrophages phagocytose.",
            "d": "Myofibroblasts are in repair.",
            "e": "Smooth muscle cells are structural."
        },
        "relatedQuestions": ["4", "40"],
        "category": "Inflammation",
        "difficulty": "Hard"
    },
    {
        "id": 40,
        "question": "Which of the following mediators of inflammation causes relaxation of vascular smooth muscle cells and vasodilation of arterioles at the site of myocardial infarction in the patient described in Question 39?",
        "options": [
            "(A) Bradykinin",
            "(B) Histamine",
            "(C) Leukotrienes",
            "(D) Nitric oxide",
            "(E) Thromboxane A2"
        ],
        "answer": 3,
        "correctAnswer": "Nitric oxide",
        "explanation": "Nitric oxide (NO), which was previously known as endothelium-derived relaxing factor, leads to relaxation of vascular smooth muscle cells and vasodilation of arterioles. NO also inhibits platelet aggregation and mediates the killing of bacteria and tumor cells by macrophages.",
        "whyNotOtherOptions": {
            "a": "Bradykinin causes vasodilation but via different mechanism.",
            "b": "Histamine stimulates the contraction of smooth muscle cells.",
            "c": "Leukotrienes stimulate the contraction of smooth muscle cells.",
            "e": "Thromboxane A2 stimulates the contraction of smooth muscle cells."
        },
        "relatedQuestions": ["30", "28"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 41,
        "question": "A 68-year-old coal miner with a history of smoking and emphysema develops severe air-flow obstruction and expires. Autopsy reveals a “black lung,” with coal-dust nodules scattered throughout the parenchyma and a central area of dense fibrosis. The coal dust entrapped within this miner’s lung was sequestered primarily by which of the following cells?",
        "options": [
            "(A) Endothelial cells",
            "(B) Fibroblasts",
            "(C) Lymphocytes",
            "(D) Macrophages",
            "(E) Plasma cells"
        ],
        "answer": 3,
        "correctAnswer": "Macrophages",
        "explanation": "Nodules consist of dust-laden macrophages associated with a fibrotic stroma. Nodules occur when coal is admixed with fibrogenic dusts such as silica and are more properly classified as anthracosilicosis.",
        "whyNotOtherOptions": {
            "a": "Endothelial cells line vessels.",
            "b": "Fibroblasts produce collagen.",
            "c": "Lymphocytes are in adaptive immunity.",
            "e": "Plasma cells produce antibodies."
        },
        "relatedQuestions": ["26", "31"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 42,
        "question": "A 40-year-old man presents with 5 days of productive cough and fever. Pseudomonas aeruginosa is isolated from a pulmonary abscess. The CBC shows an acute effect characterized by marked leukocytosis (50,000 WBC/μL), and the differential count reveals numerous immature cells (band forms). Which of the following terms best describes these hematologic findings?",
        "options": [
            "(A) Leukemoid reaction",
            "(B) Leukopenia",
            "(C) Myeloid metaplasia",
            "(D) Myeloproliferative disease",
            "(E) Neutrophilia"
        ],
        "answer": 0,
        "correctAnswer": "Leukemoid reaction",
        "explanation": "Circulating levels of leukocytes and their precursors may occasionally reach very high levels (>50,000 WBC/μL). Such a situation, referred to as a leukemoid reaction, is sometimes difficult to differentiate from leukemia.",
        "whyNotOtherOptions": {
            "b": "Leukopenia is defined as an absolute decrease in the circulating WBC count.",
            "c": "Myeloid metaplasia and myeloproliferative disease are chronic disorders of the hematopoietic system.",
            "e": "Neutrophilia by itself does not demonstrate immature cells (band forms) and usually refers to lower levels of increased neutrophils."
        },
        "relatedQuestions": ["27", "43"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 43,
        "question": "A 19-year-old woman presents with 5 days of fever (38°C/101°F) and sore throat. She reports that she has felt fatigued for the past week and has difficulty swallowing. A physical examination reveals generalized lymphadenopathy. If this patient has a viral infection, a CBC will most likely show which of the following hematologic findings?",
        "options": [
            "(A) Eosinophilia",
            "(B) Leukopenia",
            "(C) Lymphocytosis",
            "(D) Neutrophilia",
            "(E) Thrombocythemia"
        ],
        "answer": 2,
        "correctAnswer": "Lymphocytosis",
        "explanation": "The principal causes of absolute peripheral blood lymphocytosis are (1) acute viral infections (infectious mononucleosis, whooping cough, and acute infection lymphocytosis), (2) chronic bacterial infections (tuberculosis, brucellosis), and (3) lymphoproliferative diseases.",
        "whyNotOtherOptions": {
            "a": "Eosinophilia is in parasitic or allergic.",
            "b": "Leukopenia is decrease.",
            "d": "Neutrophilia is in bacterial.",
            "e": "Thrombocythemia is platelet increase."
        },
        "relatedQuestions": ["15", "42"],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 44,
        "question": "A 40-year-old woman presents with an 8-month history of progressive generalized itching, weight loss, fatigue, and yellow sclerae. Physical examination reveals mild jaundice. The antimitochondrial antibody test is positive. A liver biopsy discloses periductal inflammation and bile duct injury. Which of the following inflammatory cells is the principal mediator of destructive cholangitis in this patient?",
        "options": [
            "(A) Eosinophils",
            "(B) B lymphocytes",
            "(C) T lymphocytes",
            "(D) Mast cells",
            "(E) Neutrophils"
        ],
        "answer": 2,
        "correctAnswer": "T lymphocytes",
        "explanation": "The cells surrounding and infiltrating the sites of bile duct damage are predominantly suppressor/cytotoxic (CD8+ ) T lymphocytes, suggesting that they mediate the destruction of the ductal epithelium.",
        "whyNotOtherOptions": {
            "a": "Eosinophils have no role in primary immune-related mechanisms.",
            "b": "Macrophages and B lymphocytes are associated with periductal inflammation but do not mediate epithelial cytotoxicity.",
            "d": "Mast cells are in hypersensitivity.",
            "e": "Neutrophils are in acute."
        },
        "relatedQuestions": ["15", "26"],
        "category": "Inflammation",
        "difficulty": "Hard"
    },
    {
        "id": 45,
        "question": "A 25-year-old woman presents with a 2-week history of febrile illness and chest pain. She has an erythematous, macular facial rash and tender joints, particularly in her left wrist and elbow. A CBC shows mild anemia and thrombocytopenia. Corticosteroids are prescribed for the patient. This medication induces the synthesis of an inhibitor of which of the following enzymes in inflammatory cells?",
        "options": [
            "(A) Lipoxygenase",
            "(B) Myeloperoxidase",
            "(C) Phospholipase A2",
            "(D) Phospholipase C",
            "(E) Superoxide dismutase"
        ],
        "answer": 2,
        "correctAnswer": "Phospholipase A2",
        "explanation": "Corticosteroids induce the synthesis of an inhibitor of phospholipase A2 and block the release of arachidonic acid from the plasma membranes of inflammatory cells.",
        "whyNotOtherOptions": {
            "a": "Lipoxygenase is for leukotrienes.",
            "b": "Myeloperoxidase is for hypochlorite.",
            "d": "Phospholipase C is signaling.",
            "e": "Superoxide dismutase is antioxidant."
        },
        "relatedQuestions": ["36", "46"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 46,
        "question": "The patient described in Question 45 is noted to have increased serum levels of ceruloplasmin, fibrinogen, α2 -macroglobulin, serum amyloid A protein, and C-reactive protein. Together, these markers belong to which of the following families of proteins?",
        "options": [
            "(A) Acute phase proteins",
            "(B) Anaphylatoxins",
            "(C) Inhibitors of platelet activation",
            "(D) Protease inhibitors",
            "(E) Regulators of coagulation"
        ],
        "answer": 0,
        "correctAnswer": "Acute phase proteins",
        "explanation": "These proteins are synthesized primarily by the liver and are released into the circulation in response to an acute inflammatory challenge. Changes in the plasma levels of acute phase proteins are mediated primarily by cytokines (IL-1, IL-6, and TNF-α).",
        "whyNotOtherOptions": {
            "b": "Anaphylatoxins are C3a, C5a.",
            "c": "Inhibitors of platelet activation like PGI2.",
            "d": "Protease inhibitors are specific subset.",
            "e": "Regulators of coagulation are clotting factors."
        },
        "relatedQuestions": ["20", "17"],
        "category": "Inflammation",
        "difficulty": "Easy"
    }
];

// Core application variables
const overlay = document.getElementById('overlay');
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const categoriesGrid = document.getElementById('categoriesGrid');
const themeToggle = document.getElementById('themeToggle');
const quizContainer = document.getElementById('quizContainer');
const resultsScreen = document.getElementById('resultsScreen');
const pageTitle = document.getElementById('pageTitle');
const modeButtons = document.querySelectorAll('.mode-btn');
const correctAnswersEl = document.getElementById('correctAnswers');
const timeSpentEl = document.getElementById('timeSpent');
const masteryLevelEl = document.getElementById('masteryLevel');
const streakCountEl = document.getElementById('streakCount');
const searchInput = document.getElementById('searchInput');
const exportProgressBtn = document.getElementById('exportProgress');
const createCustomQuizBtn = document.getElementById('createCustomQuizBtn');
const customQuizModal = document.getElementById('customQuizModal');
const cancelCustomQuizBtn = document.getElementById('cancelCustomQuiz');
const createCustomQuizBtnModal = document.getElementById('createCustomQuiz');
const weakAreasCountEl = document.getElementById('weakAreasCount');
const avgTimePerQuestionEl = document.getElementById('avgTimePerQuestion');
const improvementRateEl = document.getElementById('improvementRate');

// Navigation elements
const navItems = document.querySelectorAll('.nav-item');

// Application state
let currentMode = 'exam';
let selectedCategories = [];
let currentQuestionIndex = 0;
let score = 0;
let userAnswers = [];
let questions = [];
let incorrectQuestions = [];
let isAnswerChecked = false;
let bookmarkedQuestions = new Set();
let userProgress = {};
let userStats = {
    totalQuestions: 0,
    correctAnswers: 0,
    timeSpent: 0,
    masteryLevel: 0,
    streak: 0,
    lastActive: null,
    weeklyProgress: []
};
let timerInterval = null;
let startTime = null;
let remainingTime = 0;
let isCountdown = false;
let examCheckMode = 'immediate';
let examSubmitted = false;
let questionTimers = [];
let searchResults = [];
let isSearchActive = false;
let currentPage = 'Dashboard';
let customQuestions = [];

// Core application functions
function init() {
    initializeCategories();
    initializeEventListeners();
    initializeNavigation();
    loadUserData();
    updateDashboardStats();
    updateAnalytics();
    showDashboard();
    createFAB();
    updateCustomQuizModalHTML();
}

function createFAB() {
    const fab = document.createElement('button');
    fab.className = 'fab';
    fab.innerHTML = '<i class="fas fa-plus"></i>';
    fab.title = 'Create Custom Question';
    fab.addEventListener('click', showCustomQuestionCreator);
    document.body.appendChild(fab);
}

function initializeNavigation() {
    navItems.forEach((item, index) => {
        item.addEventListener('click', () => {
            navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
            
            switch(index) {
                case 0: // Dashboard
                    currentPage = 'Dashboard';
                    showDashboard();
                    break;
                case 1: // My Courses
                    currentPage = 'courses';
                    showCourses();
                    break;
                case 2: // Progress Analytics
                    currentPage = 'analytics';
                    showAnalytics();
                    break;
                case 3: // Bookmarked Questions
                    currentPage = 'bookmarks';
                    showBookmarks();
                    break;
                case 4: // Settings
                    currentPage = 'settings';
                    showSettings();
                    break;
            }
            
            closeSidebar();
        });
    });
}

function showDashboard() {
    console.log('showDashboard called'); // Debug
    
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.search-container').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    
    // Reset page title
    pageTitle.textContent = 'Dashboard';
    updateDashboardStats();
    
    // ALWAYS load questions and show quiz layout
    questions = [...quizData, ...customQuestions];
    selectedCategories = [...new Set(questions.map(q => q.category))];
    
    // Reset quiz state
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    examSubmitted = false;
    
    console.log('Questions loaded:', questions.length);
    console.log('Current mode:', currentMode);
    
    // Force show quiz container
    quizContainer.classList.remove('hidden');
    resultsScreen.classList.add('hidden');
    
    if (questions.length > 0) {
        console.log('Calling renderQuizLayout...');
        renderQuizLayout();
    } else {
        console.log('No questions, showing message');
        showNoQuestionsMessage();
    }
}

function showCourses() {
    hideAllSections();
    pageTitle.textContent = 'My Courses';
    
    quizContainer.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 80px; color: var(--primary); margin-bottom: 20px; opacity: 0.8;">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary); background: linear-gradient(135deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">Learning Pathways</h2>
            <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                Structured learning paths designed to build your medical knowledge systematically.
            </p>
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; margin-top: 40px;">
                    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Anatomy Mastery', 'fas fa-brain', '#6366f1', 75, 'Build foundational anatomy knowledge')}
                    </div>
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Physiology Deep Dive', 'fas fa-heartbeat', '#06b6d4', 45, 'Understand body systems and functions')}
                   </div>
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Clinical Pathology', 'fas fa-virus', '#10b981', 30, 'Study diseases and diagnostics')}
                    </div> 
  <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Pharmacology', 'fas fa-pills', '#f59e0b', 20, 'Master drug mechanisms and effects')}
                    </div>
    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Medical Imaging', 'fas fa-x-ray', '#8b5cf6', 15, 'Learn radiology and imaging techniques')}
                    </div>
    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Emergency Medicine', 'fas fa-ambulance', '#ef4444', 10, 'Critical care and emergency procedures')}
                    </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createCourseCard(title, icon, color, progress, description) {
    return `
        <div class="category-card" style="text-align: left; cursor: pointer; border-left: 4px solid ${color};" onclick="startCourse('${title.toLowerCase()}')">
            <div class="category-header">
                <div class="category-icon" style="background: ${color}20; color: ${color};">
                    <i class="${icon}"></i>
                </div>
                <div>
                    <div class="category-name" style="font-size: 16px; font-weight: 600;">${title}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${description}</div>
                </div>
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${color}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 12px;">
                <span style="font-size: 11px; color: var(--text-tertiary);">${Math.floor(progress/10)}/10 Modules</span>
                <span style="font-size: 11px; color: ${color}; font-weight: 600;">Continue →</span>
            </div>
        </div>
    `;
}

function showAnalytics() {
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    pageTitle.textContent = 'Progress Analytics';
    updateAnalytics();
    
    quizContainer.innerHTML = `
        <div style="padding: 24px;">
            <div class="analytics-section glass-effect" style="border-radius: 24px; padding: 32px;">
                <h3 class="analytics-title" style="font-size: 24px; margin-bottom: 8px;">Performance Insights</h3>
                <p style="color: var(--text-secondary); margin-bottom: 32px;">Detailed analytics to optimize your learning journey</p>
                <div class="analytics-grid">
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: var(--primary);">${weakAreasCountEl.textContent}</div>
                        <div class="analytics-label">Areas Needing Focus</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #06b6d4;">${avgTimePerQuestionEl.textContent}</div>
                        <div class="analytics-label">Average Response Time</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #10b981;">${improvementRateEl.textContent}</div>
                        <div class="analytics-label">Weekly Progress Rate</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">📊 Learning Recommendations</h3>
                <div style="display: grid; gap: 16px;">
                    ${createRecommendation('Focus on Weak Areas', 'fas fa-bullseye', 'var(--primary)', 'Spend 60% of study time on topics below 70% mastery')}
                    ${createRecommendation('Consistent Practice', 'fas fa-chart-line', '#10b981', `Maintain your ${userStats.streak}-day streak for optimal retention`)}
                    ${createRecommendation('Active Recall', 'fas fa-brain', '#8b5cf6', 'Use spaced repetition for better long-term memory')}
                    ${createRecommendation('Mixed Practice', 'fas fa-random', '#f59e0b', 'Combine different topics in single study sessions')}
                </div>
            </div>

            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">🎯 Study Plan</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    ${createStudyPlanItem('Daily Goal', '50 questions', 'fas fa-calendar-day', '#6366f1')}
                    ${createStudyPlanItem('Weekly Target', '5 hours', 'fas fa-chart-bar', '#06b6d4')}
                    ${createStudyPlanItem('Mastery Goal', '85% overall', 'fas fa-trophy', '#f59e0b')}
                    ${createStudyPlanItem('Weak Topics', '2 sessions/week', 'fas fa-exclamation-triangle', '#ef4444')}
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createRecommendation(title, icon, color, description) {
    return `
        <div style="display: flex; align-items: center; gap: 16px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px; border-left: 4px solid ${color};">
            <i class="${icon}" style="color: ${color}; font-size: 24px;"></i>
            <div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${title}</div>
                <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.5;">${description}</div>
            </div>
        </div>
    `;
}

function createStudyPlanItem(title, value, icon, color) {
    return `
        <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px;">
            <i class="${icon}" style="color: ${color}; font-size: 32px; margin-bottom: 12px;"></i>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${title}</div>
            <div style="font-size: 18px; color: ${color}; font-weight: 700;">${value}</div>
        </div>
    `;
}

function showBookmarks() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    hideAllSections();
    pageTitle.textContent = 'Bookmarked Questions';
    
    if (bookmarkedQuestionsList.length === 0) {
        quizContainer.innerHTML = `
            <div style="text-align: center; padding: 80px 20px;">
                <div style="font-size: 96px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                    <i class="far fa-bookmark"></i>
                </div>
                <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary);">No Bookmarked Questions Yet</h2>
                <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 400px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                    Click the bookmark icon on any question to save it here for quick review. This is perfect for difficult concepts or important topics you want to revisit.
                </p>
                <button class="quiz-btn" onclick="showDashboard(); navItems[0].click()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 32px; border-radius: 16px;">
                    <i class="fas fa-arrow-left"></i>
                    Explore Questions
                </button>
            </div>
        `;
    } else {
        quizContainer.innerHTML = `
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                    <div>
                        <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
                            ${bookmarkedQuestionsList.length} Saved Question${bookmarkedQuestionsList.length !== 1 ? 's' : ''}
                        </h2>
                        <p style="color: var(--text-secondary);">Your personal collection of important questions</p>
                    </div>
                    <button class="quiz-btn" onclick="startBookmarksQuiz()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px;">
                        <i class="fas fa-play"></i>
                        Practice Bookmarks
                    </button>
                </div>
                <div style="display: grid; gap: 20px;">
                    ${bookmarkedQuestionsList.map(question => `
                        <div class="question-card glass-effect" style="cursor: pointer; border-radius: 20px; padding: 24px;" onclick="jumpToBookmarkQuestion(${question.id})">
                            <div class="question-header">
                                <div class="question-meta">
                                    <div class="question-number" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));">Q${question.id}</div>
                                    <div class="question-category glass-effect">${question.category}</div>
                                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                                        ${question.difficulty}
                                    </div>
                                    ${question.custom ? '<div class="question-category glass-effect" style="background: #10b98120; color: #10b981;">Custom</div>' : ''}
                                </div>
                                <div class="question-actions">
                                    <button class="action-btn bookmark-btn" onclick="event.stopPropagation(); toggleBookmark(${question.id}); showBookmarks();" aria-label="Remove Bookmark" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                                        <i class="fas fa-bookmark"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="question-text" style="font-size: 16px; line-height: 1.6;">${question.question}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    quizContainer.classList.remove('hidden');
}

// Add this function to handle clicking on individual bookmark questions
function jumpToBookmarkQuestion(questionId) {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    // Start a quiz with just this one question
    questions = [bookmarkedQuestionsList.find(q => q.id === questionId)];
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Question';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
}

function showSettings() {
    hideAllSections();
    pageTitle.textContent = 'Settings & Preferences';
    
    quizContainer.innerHTML = `
        <div style="padding: 24px; max-width: 800px; margin: 0 auto;">
            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">🎨 Appearance</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Customize the look and feel of your study environment</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Theme</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? '' : 'active'}" onclick="setTheme('light')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-sun"></i>
                                Light Mode
                            </button>
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? 'active' : ''}" onclick="setTheme('dark')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-moon"></i>
                                Dark Mode
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Animation</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn active" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-bolt"></i>
                                Smooth
                            </button>
                            <button class="mode-btn" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-minus"></i>
                                Minimal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">⚡ Study Preferences</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Optimize your learning experience</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Default Mode</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${currentMode === 'quiz' ? 'active' : ''}" onclick="setDefaultMode('quiz')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-tasks"></i>
                                Quiz
                            </button>
                            <button class="mode-btn ${currentMode === 'exam' ? 'active' : ''}" onclick="setDefaultMode('exam')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-file-alt"></i>
                                Exam
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Questions Per Session</label>
                        <select class="modern-dropdown" style="width: 100%;" onchange="setQuestionsPerSession(this.value)">
                            <option value="10">10 Questions</option>
                            <option value="25" selected>25 Questions</option>
                            <option value="50">50 Questions</option>
                            <option value="100">100 Questions</option>
                            <option value="0">All Questions</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">📊 Data & Progress</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Manage your learning data</p>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <button class="quiz-btn" onclick="exportProgress()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-download" style="margin-right: 12px;"></i>
                         
                    </button>
                    <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-plus" style="margin-right: 12px;"></i>
                        Create Custom Question
                    </button>
                    <button class="quiz-btn" onclick="resetProgress()" style="background: linear-gradient(135deg, var(--error), #dc2626); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-trash" style="margin-right: 12px;"></i>
                        Reset All Progress
                    </button>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">ℹ️ About ALIF</h3>
                <div style="color: var(--text-secondary); line-height: 1.7;">
                    <p>ALIF is an advanced medical education platform designed to help medical students and professionals enhance their knowledge through interactive quizzes and detailed analytics.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
                        <div>
                            <strong style="color: var(--text-primary);">Version</strong>
                            <div>2.1.0</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Questions</strong>
                            <div>${quizData.length + customQuestions.length} total</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Last Updated</strong>
                            <div>${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function setTheme(theme) {
    if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-sun';
    } else {
        document.body.classList.remove('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-moon';
    }
    showNotification(`Theme set to ${theme} mode`, 'success');
}

function setDefaultMode(mode) {
    currentMode = mode;
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[mode === 'quiz' ? 1 : 0].classList.add('active');
    showNotification(`Default mode set to ${mode}`, 'success');
}

function setQuestionsPerSession(count) {
    showNotification(`Questions per session set to ${count === '0' ? 'all' : count}`, 'info');
}

function showCustomQuestionCreator() {
    const modal = document.createElement('div');
    modal.className = 'custom-quiz-modal active';
    modal.innerHTML = `
        <div class="custom-quiz-content glass-effect" style="max-width: 600px; border-radius: 24px;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">Create Custom Question</h3>
                <button class="action-btn" onclick="closeCustomQuestionModal()" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="custom-question-creator">
                <div style="display: grid; gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Question Text</label>
                        <textarea id="customQuestionText" placeholder="Enter your question here..." style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 80px;"></textarea>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Category</label>
                        <select id="customQuestionCategory" class="modern-dropdown" style="width: 100%;">
                            <option value="Custom Anatomy">Custom Anatomy</option>
                            <option value="Custom Physiology">Custom Physiology</option>
                            <option value="Custom Pathology">Custom Pathology</option>
                            <option value="Custom Pharmacology">Custom Pharmacology</option>
                            <option value="General Medicine">General Medicine</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Difficulty</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button type="button" class="mode-btn difficulty-btn active" data-difficulty="Easy" style="border-radius: 12px; padding: 12px 16px;">
                                Easy
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Medium" style="border-radius: 12px; padding: 12px 16px;">
                                Medium
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Hard" style="border-radius: 12px; padding: 12px 16px;">
                                Hard
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Options</label>
                        <div style="display: grid; gap: 12px;">
                            ${['A', 'B', 'C', 'D'].map(letter => `
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--surface); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--text-secondary); flex-shrink: 0;">${letter}</div>
                                    <input type="text" id="customOption${letter}" placeholder="Option ${letter}" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; background: var(--surface); color: var(--text-primary);">
                                    <input type="radio" name="correctAnswer" value="${letter}" id="correct${letter}" style="transform: scale(1.2);">
                                    <label for="correct${letter}" style="color: var(--text-secondary); font-weight: 600;">Correct</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Explanation</label>
                        <textarea id="customExplanation" placeholder="Explain why the correct answer is right..." style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 60px;"></textarea>
                    </div>
                </div>
                
                <div class="custom-quiz-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;">
                    <button class="quiz-btn" onclick="closeCustomQuestionModal()" style="background: var(--secondary); color: white; padding: 12px 24px; border-radius: 12px;">
                        Cancel
                    </button>
                    <button class="quiz-btn check-btn" onclick="saveCustomQuestion()" style="padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-save"></i>
                        Save Question
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add difficulty button handlers
    modal.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            modal.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

function closeCustomQuestionModal() {
    const modal = document.querySelector('.custom-quiz-modal');
    if (modal) {
        modal.remove();
    }
}

function saveCustomQuestion() {
    const questionText = document.getElementById('customQuestionText').value;
    const category = document.getElementById('customQuestionCategory').value;
    const difficulty = document.querySelector('.difficulty-btn.active').dataset.difficulty;
    const explanation = document.getElementById('customExplanation').value;
    
    // Get options
    const options = [];
    for (let letter of ['A', 'B', 'C', 'D']) {
        const optionText = document.getElementById(`customOption${letter}`).value;
        if (optionText.trim()) {
            options.push(optionText);
        }
    }
    
    // Get correct answer
    const correctAnswerRadio = document.querySelector('input[name="correctAnswer"]:checked');
    if (!correctAnswerRadio) {
        showNotification('Please select the correct answer', 'error');
        return;
    }
    
    const correctAnswerIndex = ['A', 'B', 'C', 'D'].indexOf(correctAnswerRadio.value);
    
    if (!questionText.trim() || options.length < 2) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    // Generate a unique ID for the custom question
    const maxId = Math.max(
        ...quizData.map(q => q.id),
        ...customQuestions.map(q => q.id),
        0
    );
    
    const newQuestion = {
        id: maxId + 1,
        question: questionText,
        options: options,
        answer: correctAnswerIndex,
        correctAnswer: options[correctAnswerIndex],
        explanation: explanation || 'No explanation provided.',
        whyNotOtherOptions: {},
        relatedQuestions: [],
        category: category,
        difficulty: difficulty,
        custom: true
    };
    
    customQuestions.push(newQuestion);
    saveUserData();
    
    closeCustomQuestionModal();
    showNotification('Custom question created successfully!', 'success');
    
    // Refresh the current view and categories
    initializeCategories();
    if (currentPage === 'Dashboard') {
        showDashboard();
    } else if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}

function hideAllSections() {
    quizContainer.classList.add('hidden');
    resultsScreen.classList.add('hidden');
    document.querySelector('.stats-grid').style.display = 'none';
    document.querySelector('.analytics-section').style.display = 'none';
    document.querySelector('.export-section').style.display = 'none';
    // Note: search-container is NOT hidden here - we want it always visible during search
}

function startCourse(courseName) {
    showNotification(`Starting ${courseName} course...`, 'info');
    // Filter questions by course/category and start quiz
    const courseQuestions = [...quizData, ...customQuestions].filter(q => 
        q.category.toLowerCase().includes(courseName.toLowerCase())
    );
    
    if (courseQuestions.length === 0) {
        showNotification('No questions available for this course yet', 'info');
        return;
    }
    
    questions = courseQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active');
    pageTitle.textContent = `Quiz Mode - ${courseName}`;
    
    hideAllSections();
    renderQuizLayout();
}

// FIXED BOOKMARK PRACTICE FUNCTION
function startBookmarksQuiz() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    if (bookmarkedQuestionsList.length === 0) {
        showNotification('No bookmarked questions to practice!', 'error');
        return;
    }
    
    questions = bookmarkedQuestionsList;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Questions';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
    
    showNotification(`Starting practice with ${questions.length} bookmarked questions`, 'success');
}

function resetProgress() {
    if (confirm('Are you sure you want to reset all your progress? This action cannot be undone.')) {
        userProgress = {};
        userStats = {
            totalQuestions: 0,
            correctAnswers: 0,
            timeSpent: 0,
            masteryLevel: 0,
            streak: 0,
            lastActive: new Date().toISOString(),
            weeklyProgress: []
        };
        bookmarkedQuestions = new Set();
        customQuestions = [];
        saveUserData();
        updateDashboardStats();
        updateAnalytics();
        showNotification('All progress has been reset', 'success');
        showDashboard();
    }
}

function initializeEventListeners() {
    menuToggle.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', closeSidebar);
    themeToggle.addEventListener('click', toggleTheme);
    
    modeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.mode;
            pageTitle.textContent = `${btn.dataset.mode.charAt(0).toUpperCase() + btn.dataset.mode.slice(1)} Mode`;
            startQuiz();
        });
    });
    
    initializeEnhancedFeatures();
    document.getElementById('backBtn').addEventListener('click', function(e) {
        e.preventDefault();
        // Use browser back navigation
        window.history.back();
    });
}
function updateBackButton() {
    const backBtn = document.getElementById('backBtn');
    // Show back button if there's history to go back to
    if (window.history.length > 1) {
        backBtn.style.display = 'flex';
    } else {
        backBtn.style.display = 'none';
    }
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
    mainContent.classList.toggle('sidebar-open');
    document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
    mainContent.classList.remove('sidebar-open');
    document.body.style.overflow = '';
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const icon = themeToggle.querySelector('i');
    if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun';
    } else {
        icon.className = 'fas fa-moon';
    }
}

function initializeEnhancedFeatures() {
    initializeSearch();
    initializeKeyboardNavigation();
    enhanceAccessibility();
    
    exportProgressBtn.addEventListener('click', exportProgress);
    createCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.add('active');
    });
    cancelCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.remove('active');
    });
    createCustomQuizBtnModal.addEventListener('click', () => {
        const selectedOptions = document.querySelectorAll('.custom-quiz-option.selected');
        const options = {
            categories: selectedCategories,
            difficulty: null,
            bookmarkedOnly: false
        };
        
        selectedOptions.forEach(option => {
            const category = option.dataset.category;
            if (category === 'easy' || category === 'medium' || category === 'hard') {
                options.difficulty = category;
            } else if (category === 'bookmarked') {
                options.bookmarkedOnly = true;
            }
        });
        
        createCustomQuiz(options);
    });
    
    // Add selection toggling for custom quiz options
    document.addEventListener('click', (e) => {
        if (e.target.closest('.custom-quiz-option')) {
            const option = e.target.closest('.custom-quiz-option');
            option.classList.toggle('selected');
        }
    });
    
    // Ensure search works when clicking Dashboard
    navItems[0].addEventListener('click', () => {
        if (searchInput.value.trim().length > 0) {
            // If there's a search query, maintain search state
            isSearchActive = true;
        }
    });
}

// FIXED SEARCH FUNCTIONALITY
function initializeSearch() {
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            
            // Clear previous search state when input is empty
            if (query.length === 0) {
                document.body.classList.remove('search-blur-active');
                isSearchActive = false;
                if (currentPage === 'Dashboard') {
                    showDashboard();
                }
                return;
            }
            
            // Add blur effect when searching
            document.body.classList.add('search-blur-active');
            
            if (query.length < 2) {
                isSearchActive = false;
                return;
            }
            
            isSearchActive = true;
            performSearch(query);
        });
        
        // Add clear search functionality
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                clearSearch();
            }
        });
    }
}

function performSearch(query) {
    const allQuestions = [...quizData, ...customQuestions];
    searchResults = allQuestions.filter(q => 
        q.question.toLowerCase().includes(query) ||
        q.category.toLowerCase().includes(query) ||
        (q.explanation && q.explanation.toLowerCase().includes(query)) ||
        q.options.some(opt => opt.toLowerCase().includes(query))
    );
    
    console.log('Search query:', query, 'Results:', searchResults.length); // Debug log
    
    if (searchResults.length > 0) {
        // Show search results in quiz layout
        questions = searchResults;
        currentQuestionIndex = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        
        hideAllSections();
        quizContainer.classList.remove('hidden');
        renderQuizLayout();
        
        // Update page title to show search context
        pageTitle.textContent = `Search: "${query}" (${searchResults.length} results)`;
        
        // Highlight search terms
        setTimeout(() => {
            highlightSearchTerms(query);
        }, 100);
    } else {
        // Show no results message
        showSearchNoResults(query);
    }
}

function showSearchNoResults(query) {
    hideAllSections();
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-search"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Results Found</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                No questions match your search for "<strong style="color: var(--primary);">${query}</strong>". Try different keywords or browse categories.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-times"></i>
                    Clear Search
                </button>
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Browse Categories
                </button>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
    pageTitle.textContent = `Search: "${query}" (0 results)`;
}

function clearSearch() {
    searchInput.value = '';
    document.body.classList.remove('search-blur-active');
    isSearchActive = false;
    showDashboard();
}

function highlightSearchTerms(query) {
    const questionTexts = document.querySelectorAll('.question-text');
    const optionTexts = document.querySelectorAll('.option-text');
    const categoryElements = document.querySelectorAll('.question-category');
    
    const highlightText = (element) => {
        const originalText = element.textContent;
        const regex = new RegExp(`(${query})`, 'gi');
        const highlighted = originalText.replace(regex, '<mark class="search-highlight">$1</mark>');
        element.innerHTML = highlighted;
    };
    
    questionTexts.forEach(highlightText);
    optionTexts.forEach(highlightText);
    categoryElements.forEach(highlightText);
}

function initializeKeyboardNavigation() {
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key) {
            case 'ArrowDown':
            case 'ArrowUp':
                e.preventDefault();
                navigateOptions(e.key === 'ArrowDown' ? 1 : -1);
                break;
            case ' ':
            case 'Enter':
                e.preventDefault();
                if (document.activeElement.classList.contains('option')) {
                    document.activeElement.click();
                }
                break;
            case '1':
            case '2':
            case '3':
            case '4':
            case '5':
                e.preventDefault();
                const index = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option:not(.disabled)');
                if (options[index]) {
                    options[index].click();
                }
                break;
            case 'Escape':
                if (document.querySelector('.custom-quiz-modal')) {
                    document.querySelector('.custom-quiz-modal').remove();
                }
                break;
        }
    });
}

function navigateOptions(direction) {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const currentIndex = Array.from(options).findIndex(opt => opt === document.activeElement);
    let nextIndex = currentIndex + direction;
    
    if (nextIndex < 0) nextIndex = options.length - 1;
    if (nextIndex >= options.length) nextIndex = 0;
    
    options[nextIndex].focus();
}

function enhanceAccessibility() {
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('option')) {
            const options = e.target.parentElement.querySelectorAll('.option');
            options.forEach((opt, index) => {
                opt.setAttribute('aria-checked', opt.classList.contains('selected') ? 'true' : 'false');
                opt.setAttribute('role', 'radio');
                opt.setAttribute('tabindex', '0');
            });
        }
    });
}

function loadUserData() {
    const savedProgress = localStorage.getItem('mediQuizProgress');
    const savedStats = localStorage.getItem('mediQuizStats');
    const savedBookmarks = localStorage.getItem('mediQuizBookmarks');
    const savedCustomQuestions = localStorage.getItem('mediQuizCustomQuestions');
    
    if (savedProgress) {
        userProgress = JSON.parse(savedProgress);
    }
    if (savedStats) {
        userStats = JSON.parse(savedStats);
        const today = new Date().toDateString();
        const lastActive = new Date(userStats.lastActive).toDateString();
        if (lastActive !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastActive === yesterday.toDateString()) {
                userStats.streak++;
            } else {
                userStats.streak = 1;
            }
        }
    }
    if (savedBookmarks) {
        bookmarkedQuestions = new Set(JSON.parse(savedBookmarks));
    }
    if (savedCustomQuestions) {
        customQuestions = JSON.parse(savedCustomQuestions);
    }
    
    userStats.lastActive = new Date().toISOString();
    saveUserData();
}

function saveUserData() {
    localStorage.setItem('mediQuizProgress', JSON.stringify(userProgress));
    localStorage.setItem('mediQuizStats', JSON.stringify(userStats));
    localStorage.setItem('mediQuizBookmarks', JSON.stringify(Array.from(bookmarkedQuestions)));
    localStorage.setItem('mediQuizCustomQuestions', JSON.stringify(customQuestions));
}

function updateDashboardStats() {
    correctAnswersEl.textContent = userStats.correctAnswers;
    timeSpentEl.textContent = `${Math.floor(userStats.timeSpent / 60)}h ${userStats.timeSpent % 60}m`;
    masteryLevelEl.textContent = `${userStats.masteryLevel}%`;
    streakCountEl.textContent = userStats.streak;
}

function updateAnalytics() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => allQuestions.find(q => q.id == id)?.category)
        .reduce((acc, category) => {
            acc[category] = (acc[category] || 0) + 1;
            return acc;
        }, {});
        
    weakAreasCountEl.textContent = Object.keys(weakAreas).length;
    
    const totalTime = userStats.timeSpent * 60;
    const avgTime = userStats.totalQuestions > 0 ? Math.round(totalTime / userStats.totalQuestions) : 0;
    avgTimePerQuestionEl.textContent = `${avgTime}s`;
    
    if (userStats.weeklyProgress.length > 1) {
        const latest = userStats.weeklyProgress[userStats.weeklyProgress.length - 1];
        const previous = userStats.weeklyProgress[userStats.weeklyProgress.length - 2];
        const improvement = ((latest - previous) / previous) * 100;
        improvementRateEl.textContent = `${Math.round(improvement)}%`;
    } else {
        improvementRateEl.textContent = "0%";
    }
}

function exportProgress() {
    const data = {
        progress: userProgress,
        stats: userStats,
        bookmarks: Array.from(bookmarkedQuestions),
        customQuestions: customQuestions,
        exportDate: new Date().toISOString(),
        analytics: generateStudyReport()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mediquiz-progress-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('Progress data exported successfully!', 'success');
}

function createCustomQuiz(options) {
    let filteredQuestions = [...quizData, ...customQuestions];
    
    if (options.categories && options.categories.length > 0) {
        filteredQuestions = filteredQuestions.filter(q => options.categories.includes(q.category));
    }
    
    if (options.difficulty) {
        filteredQuestions = filteredQuestions.filter(q => q.difficulty.toLowerCase() === options.difficulty);
    }
    
    if (options.bookmarkedOnly) {
        filteredQuestions = filteredQuestions.filter(q => bookmarkedQuestions.has(q.id));
    }
    
    if (options.count && options.count > 0) {
        filteredQuestions = shuffleArray(filteredQuestions).slice(0, options.count);
    }
    
    questions = filteredQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    examSubmitted = false;
    
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    hideAllSections();
    renderQuizLayout();
    customQuizModal.classList.remove('active');
    showNotification(`Custom quiz created with ${questions.length} questions`, 'success');
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function generateStudyReport() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    const strongAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) >= 0.8)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    return {
        weakAreas,
        strongAreas,
        totalMastered: Object.values(userProgress).filter(p => p.correct >= 3).length,
        totalQuestions: allQuestions.length,
        masteryPercentage: calculateMasteryLevel(),
        generatedAt: new Date().toISOString()
    };
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        padding: 20px 28px;
        background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--primary)'};
        color: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        font-weight: 600;
        max-width: 400px;
        line-height: 1.5;
    `;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}" style="font-size: 20px;"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 400);
    }, 4000);
}

function initializeCategories() {
    const allQuestions = [...quizData, ...customQuestions];
    const categories = [...new Set(allQuestions.map(q => q.category))];
    const categoryIcons = {
        "Anatomy Fundamentals": "fas fa-brain",
        "Neuroanatomy": "fas fa-brain",
        "Gastrointestinal System": "fas fa-stomach",
        "Cardiovascular System": "fas fa-heart",
        "Custom Anatomy": "fas fa-user-md",
        "Custom Physiology": "fas fa-heartbeat",
        "Custom Pathology": "fas fa-virus",
        "Custom Pharmacology": "fas fa-pills",
        "General Medicine": "fas fa-stethoscope"
    };
    
    const categoryColors = {
        "Anatomy Fundamentals": "#6366f1",
        "Neuroanatomy": "#06b6d4",
        "Gastrointestinal System": "#10b981",
        "Cardiovascular System": "#ef4444",
        "Custom Anatomy": "#8b5cf6",
        "Custom Physiology": "#f59e0b",
        "Custom Pathology": "#ec4899",
        "Custom Pharmacology": "#84cc16",
        "General Medicine": "#64748b"
    };

    categoriesGrid.innerHTML = '';
    categories.forEach(category => {
        const categoryQuestions = allQuestions.filter(q => q.category === category);
        const mastered = categoryQuestions.filter(q =>
            userProgress[q.id] && userProgress[q.id].correct >= 3
        ).length;
        const progress = categoryQuestions.length > 0 ?
            Math.round((mastered / categoryQuestions.length) * 100) : 0;
            
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card active glass-effect';
        categoryCard.dataset.category = category;
        categoryCard.style.borderLeft = `4px solid ${categoryColors[category] || '#6366f1'}`;
        categoryCard.innerHTML = `
            <div class="category-header">
                <div class="category-icon" style="background: ${categoryColors[category] || '#6366f1'}20; color: ${categoryColors[category] || '#6366f1'}">
                    <i class="${categoryIcons[category] || 'fas fa-question'}"></i>
                </div>
                <div class="category-name">${category}</div>
                ${category.includes('Custom') ? '<div style="font-size: 10px; color: var(--primary); background: var(--primary-light); padding: 2px 6px; border-radius: 8px;">Custom</div>' : ''}
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${categoryColors[category] || '#6366f1'}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                ${categoryQuestions.length} question${categoryQuestions.length !== 1 ? 's' : ''}
                ${categoryQuestions.filter(q => q.custom).length > 0 ? ` · ${categoryQuestions.filter(q => q.custom).length} custom` : ''}
            </div>
        `;
        
        if (categoryQuestions.length > 1) {
            const dropdown = document.createElement('div');
            dropdown.className = 'modern-dropdown';
            dropdown.innerHTML = `
                <select onchange="jumpToQuestion(this.value)">
                    <option value="">Jump to Question...</option>
                    ${categoryQuestions.sort((a, b) => a.id - b.id).map(q => 
                        `<option value="question-${q.id}">Q${q.id}: ${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}${q.custom ? ' ★' : ''}</option>`
                    ).join('')}
                </select>
            `;
            categoryCard.appendChild(dropdown);
        }
        
        categoryCard.addEventListener('click', (e) => {
            if (!e.target.closest('.modern-dropdown') && !e.target.closest('select')) {
                toggleCategory(categoryCard);
                const firstQ = categoryQuestions.sort((a, b) => a.id - b.id)[0];
                if (firstQ) {
                    jumpToQuestion(`question-${firstQ.id}`);
                }
            }
        });
        
        categoriesGrid.appendChild(categoryCard);
    });
    
    selectedCategories = [...categories];
}

function toggleCategory(categoryCard) {
    const category = categoryCard.dataset.category;
    if (categoryCard.classList.contains('active')) {
        categoryCard.classList.remove('active');
        selectedCategories = selectedCategories.filter(c => c !== category);
    } else {
        categoryCard.classList.add('active');
        selectedCategories.push(category);
    }
    startQuiz();
    closeSidebar();
}

function startQuiz() {
    if (currentPage !== 'Dashboard') return;
    
    quizContainer.style.opacity = '0';
    setTimeout(() => {
        const allQuestions = [...quizData, ...customQuestions];
        questions = selectedCategories.length > 0 ? 
            allQuestions.filter(q => selectedCategories.includes(q.category)) : 
            allQuestions;
            
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        if (currentMode === 'learn' && incorrectQuestions.length > 0) {
            questions = allQuestions.filter(q => incorrectQuestions.includes(q.id));
        }
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        questions.sort((a, b) => a.id - b.id);
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        examSubmitted = false;
        quizContainer.classList.remove('hidden');
        resultsScreen.classList.add('hidden');
        questionTimers = new Array(questions.length).fill(0);
        if (currentMode === 'exam') {
            isCountdown = true;
            remainingTime = 120 * questions.length;
        } else {
            isCountdown = false;
        }
        startTimer();
        renderQuizLayout();
        quizContainer.style.opacity = '1';
    }, 300);
}

function showNoQuestionsMessage() {
    let message = '';
    if (isSearchActive) {
        message = 'No questions match your search criteria. Try different keywords.';
    } else if (selectedCategories.length === 0) {
        message = 'No categories selected. Please select categories from the sidebar.';
    } else {
        message = 'No questions available for the selected categories.';
    }
    
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-inbox"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Questions Available</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                ${message}
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Select Categories
                </button>
                <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-plus"></i>
                    Create Question
                </button>
                ${isSearchActive ? `
                    <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-times"></i>
                        Clear Search
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    resultsScreen.classList.add('hidden');
    stopTimer();
    quizContainer.style.opacity = '1';
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    startTime = new Date();
    timerInterval = setInterval(() => {
        if (isCountdown) {
            remainingTime--;
            if (remainingTime <= 0) {
                remainingTime = 0;
                clearInterval(timerInterval);
                if (currentMode === 'exam' && !examSubmitted) {
                    showNotification('Time up! Submitting exam.', 'error');
                    submitExam();
                }
            }
            updateTimerDisplay(formatTime(remainingTime), 'timerDisplay', true);
        } else {
            questionTimers[currentQuestionIndex]++;
            updateTimerDisplay(formatTime(questionTimers[currentQuestionIndex]), 'timerDisplay', false);
        }
    }, 1000);
}

function formatTime(seconds) {
    const min = Math.floor(seconds / 60).toString().padStart(2, '0');
    const sec = (seconds % 60).toString().padStart(2, '0');
    return `${min}:${sec}`;
}

function updateTimerDisplay(time, id, isCountdown = false) {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = `Time: ${time}`;
        if (isCountdown) {
            el.classList.remove('timer-warning', 'timer-error');
            if (remainingTime <= 30) {
                el.classList.add('timer-error');
            } else if (remainingTime <= 60) {
                el.classList.add('timer-warning');
            }
        }
    }
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        if (startTime) {
            const endTime = new Date();
            const timeSpent = Math.floor((endTime - startTime) / 1000 / 60);
            userStats.timeSpent += timeSpent;
            userStats.lastActive = new Date().toISOString();
            saveUserData();
            updateDashboardStats();
        }
    }
}

function renderQuizLayout() {
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    if (currentMode === 'exam') {
        renderExamLayout();
    } else {
        renderSingleQuestionLayout();
    }
}

function renderExamLayout() {
    const isImmediateMode = examCheckMode === 'immediate';
    quizContainer.innerHTML = `
        <div class="exam-header" style="margin-bottom: 24px; padding: 20px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                <div>
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                        Exam Mode: ${questions.length} Questions
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        ${isImmediateMode ?
                          'Immediate Check - See explanations as you answer' :
                          'All-in-One Check - Check all answers at the end'}
                    </p>
                </div>
                <div class="exam-mode-toggle" style="display: flex; gap: 8px; background: var(--glass); padding: 4px; border-radius: var(--radius);">
                    <button class="mode-toggle-btn ${isImmediateMode ? 'active' : ''}" data-mode="immediate" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="Immediate Check Mode">
                        Immediate Check
                    </button>
                    <button class="mode-toggle-btn ${!isImmediateMode ? 'active' : ''}" data-mode="all-at-once" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${!isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${!isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="All-at-Once Check Mode">
                        Check All
                    </button>
                </div>
            </div>
            <div class="progress-info" style="display: flex; align-items: center; gap: 16px;">
                <span style="font-size: 14px; color: var(--text-secondary);" id="answeredCount">0/${questions.length} answered</span>
                <div class="progress-bar" style="flex: 1; height: 6px;">
                    <div class="progress-fill" id="examProgressFill" style="width: 0%"></div>
                </div>
                <span id="timerDisplay" style="font-size: 14px; color: var(--text-secondary);">Time: ${formatTime(remainingTime)}</span>
                ${examSubmitted ? `<span style="color: var(--success); font-weight: 600; font-size: 14px;">Submitted!</span>` : ''}
            </div>
        </div>
        <div class="exam-mode-layout">
            ${questions.map((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.answer;
                const showExplanationButton = examSubmitted || (isImmediateMode && userAnswer !== undefined);
                return `
                    <div class="question-card fade-in" data-question-index="${index}" id="question-${question.id}">
                        <div class="question-header">
                            <div class="question-meta">
                                <div class="question-number">Q${question.id}</div>
                                <div class="question-category">${question.category}</div>
                                <div class="question-difficulty" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${getDifficultyColor(question.difficulty)}; color: white;">
                                    ${question.difficulty}
                                </div>
                                ${userAnswer !== undefined ? `
                                    <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                                        ${isCorrect ? 'Correct' : 'Incorrect'}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="question-actions">
                                <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                                    <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                                </button>
                            </div>
                        </div>
                        <div class="question-text">${question.question}</div>
                        <div class="options-grid">
                            ${question.options.map((option, optIndex) => {
                                const isSelected = userAnswer === optIndex;
                                const isCorrectOption = optIndex === question.answer;
                                let optionClass = 'option';
                                if (userAnswer !== undefined) {
                                    if (isCorrectOption) {
                                        optionClass += ' correct';
                                    } else if (isSelected && !isCorrectOption) {
                                        optionClass += ' incorrect';
                                    }
                                    optionClass += ' disabled';
                                } else if (isSelected) {
                                    optionClass += ' selected';
                                }
                                return `
                                    <div class="${optionClass}" data-option-index="${optIndex}" role="button" aria-label="Option ${String.fromCharCode(65 + optIndex)}">
                                        <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                                        <div class="option-text">${option}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${showExplanationButton ? `
                            <div class="explanation-section">
                                <details open>
                                    <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                                    <div class="explanation-content correct-answer">
                                        <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                                    </div>
                                </details>
                                ${userAnswer !== undefined && userAnswer !== question.answer ? `
                                    <details>
                                        <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                                        <div class="explanation-content why-not-section">
                                            <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                            <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                                        </div>
                                    </details>
                                ` : ''}
                                <details>
                                    <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                                    <div class="explanation-content">${question.explanation}</div>
                                </details>
                                <details>
                                    <summary><i class="fas fa-link"></i> Related Questions</summary>
                                    <div class="explanation-content related-questions">
                                        <div class="related-questions-list">
                                            ${question.relatedQuestions.map(q => {
                                                const qId = q.match(/\d+/)[0];
                                                return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                </details>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('')}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    ${examCheckMode === 'all-at-once' && !examSubmitted ? `
                        <button class="quiz-btn check-btn" id="checkAllBtn" ${userAnswers.filter(a => a !== undefined).length === 0 ? 'disabled' : ''} aria-label="Check All Answers">
                            <i class="fas fa-check-double"></i>
                            Check All Answers
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn submit-btn" id="examSubmitBtn" ${examSubmitted ? 'disabled' : ''} aria-label="Submit Exam">
                    <i class="fas fa-paper-plane"></i>
                    ${examSubmitted ? 'Exam Submitted' : `Submit Exam (${questions.length} questions)`}
                </button>
            </div>
        </div>
    `;
    initializeExamModeEvents();
    updateExamSubmitButton();
}

function renderSingleQuestionLayout() {
    if (currentQuestionIndex >= questions.length) {
        showResults();
        return;
    }
    const question = questions[currentQuestionIndex];
    const userAnswer = userAnswers[currentQuestionIndex];
    const isCorrect = userAnswer === question.answer;
    quizContainer.innerHTML = `
        <div class="question-card fade-in" data-question-index="${currentQuestionIndex}">
            <div class="question-header">
                <div class="question-meta">
                    <div class="question-number">Q${question.id}</div>
                    <div class="question-category">${question.category}</div>
                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                        ${question.difficulty}
                    </div>
                    ${userAnswer !== undefined ? `
                        <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                            ${isCorrect ? 'Correct' : 'Incorrect'}
                        </div>
                    ` : ''}
                </div>
                <div class="question-actions">
                    <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                        <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                    </button>
                </div>
            </div>
            <div class="question-text">${question.question}</div>
            <div class="options-grid">
                ${question.options.map((option, index) => {
                    const isSelected = userAnswer === index;
                    const isCorrectOption = index === question.answer;
                    let optionClass = 'option';
                    if (isAnswerChecked) {
                        if (isCorrectOption) {
                            optionClass += ' correct';
                        } else if (isSelected && !isCorrectOption) {
                            optionClass += ' incorrect';
                        }
                        optionClass += ' disabled';
                    } else if (isSelected) {
                        optionClass += ' selected';
                    }
                    return `
                        <div class="${optionClass}" data-option-index="${index}" role="button" aria-label="Option ${String.fromCharCode(65 + index)}">
                            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                            <div class="option-text">${option}</div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${isAnswerChecked ? `
                <div class="explanation-section">
                    <details open>
                        <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                        <div class="explanation-content correct-answer">
                            <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                        </div>
                    </details>
                    ${userAnswer !== undefined && userAnswer !== question.answer ? `
                        <details>
                            <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                            <div class="explanation-content why-not-section">
                                <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                            </div>
                        </details>
                    ` : ''}
                    <details>
                        <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                        <div class="explanation-content">${question.explanation}</div>
                    </details>
                    <details>
                        <summary><i class="fas fa-link"></i> Related Questions</summary>
                        <div class="explanation-content related-questions">
                            <div class="related-questions-list">
                                ${question.relatedQuestions.map(q => {
                                    const qId = q.match(/\d+/)[0];
                                    return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    </details>
                </div>
            ` : ''}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    <button class="quiz-btn check-btn" id="checkAnswerBtn" ${userAnswer === undefined ? 'disabled' : ''} aria-label="Check Answer">
                        <i class="fas fa-check"></i>
                        Check Answer
                    </button>
                    ${currentMode === 'learn' && incorrectQuestions.length > 0 ? `
                        <button class="quiz-btn" id="incorrectOnlyBtn" aria-label="Show Incorrect Only">
                            <i class="fas fa-filter"></i>
                            Incorrect Only
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn next-btn" id="nextQuestionBtn" ${!isAnswerChecked ? 'disabled' : ''} aria-label="Next Question">
                    <i class="fas fa-arrow-right"></i>
                    ${currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish'}
                </button>
            </div>
        </div>
    `;
    initializeQuizEvents();
    updateTimerDisplay(formatTime(isCountdown ? remainingTime : questionTimers[currentQuestionIndex]), 'timerDisplay', isCountdown);
}

function initializeQuizEvents() {
    const checkAnswerBtn = document.getElementById('checkAnswerBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const incorrectOnlyBtn = document.getElementById('incorrectOnlyBtn');
    const bookmarkBtn = document.querySelector('.bookmark-btn');
    const options = document.querySelectorAll('.option:not(.disabled)');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            if (!isAnswerChecked) {
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                userAnswers[currentQuestionIndex] = parseInt(option.dataset.optionIndex);
                if (checkAnswerBtn) checkAnswerBtn.disabled = false;
                updateExamSubmitButton();
            }
        });
    });
    
    if (checkAnswerBtn) {
        checkAnswerBtn.addEventListener('click', () => {
            checkAnswer();
            renderQuizLayout();
        });
    }
    
    if (nextQuestionBtn) {
        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (incorrectOnlyBtn) {
        incorrectOnlyBtn.addEventListener('click', () => {
            questions = quizData.filter(q => incorrectQuestions.includes(q.id));
            currentQuestionIndex = 0;
            userAnswers = new Array(questions.length);
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', () => {
            const questionId = parseInt(bookmarkBtn.dataset.questionId);
            toggleBookmark(questionId);
            bookmarkBtn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    }
}

function initializeExamModeEvents() {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const checkAllBtn = document.getElementById('checkAllBtn');
    const submitBtn = document.getElementById('examSubmitBtn');
    const modeToggleButtons = document.querySelectorAll('.mode-toggle-btn');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            const questionIndex = parseInt(option.closest('.question-card').dataset.questionIndex);
            const prevSelected = option.closest('.options-grid').querySelector('.selected');
            if (prevSelected) prevSelected.classList.remove('selected');
            option.classList.add('selected');
            userAnswers[questionIndex] = parseInt(option.dataset.optionIndex);
            updateExamProgress();
            updateExamSubmitButton();
            if (examCheckMode === 'immediate') {
                checkAnswer(questionIndex);
                renderQuizLayout();
            }
        });
    });
    
    if (checkAllBtn) {
        checkAllBtn.addEventListener('click', () => {
            userAnswers.forEach((answer, index) => {
                if (answer !== undefined) {
                    checkAnswer(index);
                }
            });
            renderQuizLayout();
        });
    }
    
    if (submitBtn) {
        submitBtn.addEventListener('click', submitExam);
    }
    
    modeToggleButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeToggleButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            examCheckMode = btn.dataset.mode;
            renderQuizLayout();
        });
    });
    
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const questionId = parseInt(btn.dataset.questionId);
            toggleBookmark(questionId);
            btn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    });
}

function updateExamProgress() {
    const answered = userAnswers.filter(a => a !== undefined).length;
    const progressPercent = (answered / questions.length) * 100;
    const answeredCount = document.getElementById('answeredCount');
    const progressFill = document.getElementById('examProgressFill');
    if (answeredCount) {
        answeredCount.textContent = `${answered}/${questions.length} answered`;
    }
    if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
    }
}

function updateExamSubmitButton() {
    const submitBtn = document.getElementById('examSubmitBtn');
    if (submitBtn) {
        const allAnswered = userAnswers.every(a => a !== undefined);
        submitBtn.disabled = !allAnswered || examSubmitted;
        submitBtn.innerHTML = examSubmitted ?
            '<i class="fas fa-paper-plane"></i> Exam Submitted' :
            `<i class="fas fa-paper-plane"></i> Submit Exam (${questions.length} questions)`;
    }
}

function checkAnswer(questionIndex = currentQuestionIndex) {
    const question = questions[questionIndex];
    const userAnswer = userAnswers[questionIndex];
    isAnswerChecked = true;
    if (userAnswer === question.answer) {
        score++;
        userStats.correctAnswers++;
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].correct++;
        userProgress[question.id].attempts++;
        incorrectQuestions = incorrectQuestions.filter(id => id !== question.id);
    } else {
        if (!incorrectQuestions.includes(question.id)) {
            incorrectQuestions.push(question.id);
        }
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].attempts++;
    }
    userStats.totalQuestions++;
    userStats.masteryLevel = calculateMasteryLevel();
    saveUserData();
    updateDashboardStats();
}

function submitExam() {
    examSubmitted = true;
    if (examCheckMode === 'all-at-once') {
        userAnswers.forEach((answer, index) => {
            if (answer !== undefined) {
                checkAnswer(index);
            }
        });
    }
    stopTimer();
    showResults();
}

function calculateMasteryLevel() {
    const masteredQuestions = Object.values(userProgress).filter(p => p.correct >= 3).length;
    return quizData.length > 0 ? Math.round((masteredQuestions / quizData.length) * 100) : 0;
}

function showResults() {
    stopTimer();
    quizContainer.classList.add('hidden');
    resultsScreen.classList.remove('hidden');
    const percentage = questions.length > 0 ? Math.round((score / questions.length) * 100) : 0;
    
    let restartText = 'Restart Quiz';
    if (currentPage === 'bookmarks') {
        restartText = 'Practice Again';
    }
    
    resultsScreen.innerHTML = `
        <div class="results-card fade-in">
            <div class="results-header">
                <h2 class="results-title">${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)} Results</h2>
                <p class="score-text">You completed ${questions.length} question${questions.length !== 1 ? 's' : ''}</p>
            </div>
            <div class="score-display">${percentage}%</div>
            <div class="score-text">Score: ${score} out of ${questions.length} correct</div>
            <div class="results-details">
                ${questions.map((q, index) => {
                    const isCorrect = userAnswers[index] === q.answer;
                    return `
                        <div class="result-item">
                            <div class="result-question">Q${q.id}: ${q.question}</div>
                            <div class="result-status ${isCorrect ? 'result-correct' : 'result-incorrect'}">
                                ${isCorrect ? 'Correct' : 'Incorrect'}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="restart-btn" id="restartQuiz" aria-label="Restart Quiz" style="margin: 0;">
                    <i class="fas fa-redo"></i>
                    ${restartText}
                </button>
                ${currentPage === 'bookmarks' ? `
                    <button class="quiz-btn" onclick="showBookmarks()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 16px 24px; border-radius: var(--radius);">
                        <i class="fas fa-bookmark"></i>
                        Back to Bookmarks
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('restartQuiz').addEventListener('click', () => {
        if (currentPage === 'bookmarks') {
            startBookmarksQuiz();
        } else {
            startQuiz();
        }
    });
}

function toggleBookmark(questionId) {
    if (bookmarkedQuestions.has(questionId)) {
        bookmarkedQuestions.delete(questionId);
        showNotification('Question removed from bookmarks', 'info');
    } else {
        bookmarkedQuestions.add(questionId);
        showNotification('Question bookmarked', 'success');
    }
    saveUserData();
    
    // If we're on the bookmarks page, refresh it
    if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}


function getDifficultyColor(difficulty) {
    switch (difficulty.toLowerCase()) {
        case 'easy': return '#10b981';
        case 'medium': return '#f59e0b';
        case 'hard': return '#ef4444';
        default: return '#64748b';
    }
}

function jumpToQuestion(questionId) {
    const questionIndex = questions.findIndex(q => `question-${q.id}` === questionId);
    if (questionIndex !== -1) {
        if (currentMode === 'exam') {
            const element = document.getElementById(questionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        } else {
            currentQuestionIndex = questionIndex;
            isAnswerChecked = false;
            renderQuizLayout();
        }
    } else {
        // If question not in current quiz, start a new quiz with that question's category
        const question = quizData.find(q => `question-${q.id}` === questionId) || customQuestions.find(q => `question-${q.id}` === questionId);
        if (question) {
            selectedCategories = [question.category];
            startQuiz();
            setTimeout(() => {
                const element = document.getElementById(questionId);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
        }
    }
}

// Initialize the application
init();
    </script>
</body>

</html>
