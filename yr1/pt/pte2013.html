<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MediQuiz Pro | Advanced Medical Education</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/protect.js"></script>
    <style type="text/css">
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --primary: #3b82f6; 
            --primary-dark: #2563eb; 
            --primary-light: #dbeafe; 
            --secondary: #6b7280; 
            --success: #22c55e; 
            --error: #ef4444; 
            --warning: #eab308; 
            --info: #0ea5e9; 
            --background: #ffffff; 
            --surface: #f9fafb; 
            --text-primary: #111827; 
            --text-secondary: #4b5563; 
            --text-tertiary: #9ca3af; 
            --border: #e5e7eb; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.05);
            --radius: 8px; 
            --radius-lg: 12px;
            --radius-xl: 16px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
            --gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --glass: rgba(255, 255, 255, 0.85); 
            --glass-border: rgba(229, 231, 235, 0.3);
        }

        .dark-mode {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --primary-light: #93c5fd;
            --secondary: #94a3b8;
            --background: #000000; 
            --surface: #111827; 
            --text-primary: #f9fafb; 
            --text-secondary: #d1d5db; 
            --text-tertiary: #6b7280; 
            --border: #1f2937; 
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.6); 
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.6);
            --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.6);
            --glass: rgba(17, 24, 39, 0.85); 
            --glass-border: rgba(31, 41, 55, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            transition: var(--transition);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* App Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow);
            transform: translateX(-100%);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 0 24px 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .logo i {
            font-size: 24px;
        }

        .sidebar-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            background: var(--glass);
            border-radius: var(--radius);
            margin: 0 16px 24px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: var(--shadow);
        }

        .user-info h3 {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .user-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--glass);
            border-left-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .nav-item.active .nav-icon {
            color: var(--primary);
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .categories-section {
            margin-top: 24px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .categories-grid {
            padding: 0 16px;
        }

        .category-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .category-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .category-card.active {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .category-card.active .category-icon {
            background: var(--primary);
        }

        .category-name {
            font-weight: 500;
            font-size: 14px;
        }

        .category-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-right: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .category-card.active .progress-text {
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content.sidebar-open {
            margin-left: 280px;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--primary-light);
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mode-selector {
            display: flex;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 4px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            padding: 24px 32px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Quiz Container */
        .quiz-container {
            padding: 0 32px 32px;
        }

        .question-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .question-card.fade-in {
            opacity: 1;
        }

        .question-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .question-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .question-number {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            background: var(--primary-light);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-category {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            background: var(--glass);
            padding: 6px 12px;
            border-radius: 16px;
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary-light);
        }

        .question-text {
            font-size: 18px;
            font-weight: 500;
            line-height: 1.6;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass);
            min-height: 60px;
        }

        .option:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .option.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            flex-shrink: 0;
            transition: var(--transition);
        }

        .option.selected .option-letter {
            background: var(--primary);
            color: white;
        }

        .option.correct .option-letter {
            background: var(--success);
            color: white;
        }

        .option.incorrect .option-letter {
            background: var(--error);
            color: white;
        }

        .option-text {
            flex: 1;
            font-size: 15px;
            font-weight: 400;
        }

        /* Explanation Section */
        .explanation-section {
            margin-top: 24px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 24px;
        }

        .explanation-section details {
            margin-bottom: 16px;
        }

        .explanation-section summary {
            padding: 12px 16px;
            background: var(--surface);
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .explanation-section summary:hover {
            background: var(--primary-light);
        }

        .explanation-section details[open] summary {
            background: var(--primary);
            color: white;
        }

        .explanation-content {
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .explanation-content strong {
            color: var(--text-primary);
        }

        .correct-answer, .why-not-section, .related-questions {
            margin-bottom: 16px;
            padding: 16px;
            border-radius: var(--radius);
        }

        .correct-answer {
            background: rgba(34, 197, 94, 0.05);
            border-left: 4px solid var(--success);
        }

        .why-not-section {
            background: rgba(239, 68, 68, 0.05);
            border-left: 4px solid var(--error);
        }

        .related-questions {
            background: rgba(59, 130, 246, 0.05);
            border-left: 4px solid var(--primary);
        }

        .related-questions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .related-question-tag {
            padding: 6px 12px;
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .related-question-tag:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        /* Quiz Controls */
        .quiz-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .quiz-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .quiz-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .quiz-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .check-btn {
            background: var(--primary);
            color: white;
        }

        .check-btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .next-btn {
            background: var(--success);
            color: white;
        }

        .next-btn:hover:not(:disabled) {
            background: #16a34a;
        }

        .submit-btn {
            background: var(--gradient);
            color: white;
            padding: 12px 32px;
            font-size: 16px;
        }

        /* Results Screen */
        .results-screen {
            padding: 32px;
            max-width: 900px;
            margin: 0 auto;
        }

        .results-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 48px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .results-header {
            margin-bottom: 32px;
        }

        .results-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .score-display {
            font-size: 64px;
            font-weight: 700;
            margin: 32px 0;
            color: var(--text-primary);
        }

        .score-text {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .results-details {
            text-align: left;
            margin: 48px 0;
            background: var(--glass);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--glass-border);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-question {
            flex: 1;
            font-size: 14px;
        }

        .result-status {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .result-correct {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .result-incorrect {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .restart-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 16px 48px;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        /* Enhanced Features */
        .search-container {
            padding: 16px 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 12px 16px;
            max-width: 400px;
            margin: 0 auto;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-box i {
            color: var(--text-tertiary);
            margin-right: 8px;
        }

        .analytics-section {
            padding: 24px 32px;
            background: var(--surface);
            margin: 16px 32px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .analytics-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .analytics-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
        }

        .analytics-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .analytics-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .export-section {
            padding: 16px 32px;
            text-align: center;
        }

        .export-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Custom Quiz Modal */
        .custom-quiz-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .custom-quiz-modal.active {
            display: flex;
        }

        .custom-quiz-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border);
        }

        .custom-quiz-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .custom-quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .custom-quiz-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass);
        }

        .custom-quiz-option:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .custom-quiz-option.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .custom-quiz-option .option-selector {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .custom-quiz-option.selected .option-selector {
            background: var(--primary);
            border-color: var(--primary);
        }

        .custom-quiz-option.selected .option-selector::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .custom-quiz-option label {
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
            margin: 0;
        }

        .quiz-options-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .quiz-options-section label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .custom-quiz-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Registration System Styles */
        .price-info {
            color: var(--warning);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .input-group {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .input-group i {
            position: absolute;
            left: 1rem;
            color: var(--text-secondary);
            font-size: 1.1rem;
            z-index: 2;
        }

        .input-group select, .input-group input {
            width: 100%;
            padding: 12px 16px 12px 48px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition);
        }

        .input-group select:focus, .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .file-upload {
            position: relative;
            padding: 20px;
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 16px;
        }

        .file-upload:hover {
            border-color: var(--primary-light);
            background: rgba(59, 130, 246, 0.05);
        }

        .file-upload i {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 8px;
            position: static;
        }

        .file-upload span {
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: block;
        }

        .file-upload input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .receipt-preview {
            margin-top: 12px;
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            display: none;
        }

        .error {
            color: var(--error);
            font-size: 0.85rem;
            margin-top: 8px;
            text-align: center;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .sidebar {
                width: 50vw;
            }

            .main-content.sidebar-open {
                margin-left: 100vw;
            }

            .top-nav {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .nav-left {
                width: 100%;
                justify-content: space-between;
            }

            .nav-right {
                width: 100%;
                justify-content: space-between;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                padding: 16px;
            }

            .quiz-container {
                padding: 0 16px 16px;
            }

            .question-card {
                padding: 24px;
            }

            .question-text {
                font-size: 17px;
            }

            .option {
                padding: 12px;
                min-height: 70px;
            }

            .results-card {
                padding: 32px 24px;
            }

            .score-display {
                font-size: 48px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .search-container {
                padding: 12px 16px;
            }

            .analytics-section {
                margin: 16px;
                padding: 16px;
            }

            .quiz-btn {
                padding: 16px 20px;
                font-size: 16px;
            }
        }

        @media (min-width: 1200px) {
            .quiz-container {
                max-width: 1100px;
                margin: 0 auto;
                padding: 24px;
            }

            .question-card {
                max-width: 1000px;
                margin: 0 auto 24px;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        .hidden {
            display: none;
        }

        .glass {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .text-gradient {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .question-difficulty {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .question-dropdown {
            margin-top: 8px;
            display: block;
        }

        .question-dropdown select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .option.disabled {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .timer-warning {
            color: var(--warning);
        }

        .timer-error {
            color: var(--error);
        }

        .loading-spinner {
            display: none;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        .loading-spinner.active {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ultra Modern Styles */
        /* Glass Morphism Effects */
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark-mode .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Enhanced Hover Effects with Glow */
        .nav-item:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.15) 100%) !important;
            border-left-color: var(--primary) !important;
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25) !important;
            backdrop-filter: blur(10px);
        }

        .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(255, 255, 255, 0.95) 100%) !important;
            transform: translateY(-5px) scale(1.03) !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 30px rgba(59, 130, 246, 0.1) !important;
            border-color: var(--primary) !important;
            backdrop-filter: blur(10px);
        }

        .option:hover {
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.12) 100%) !important;
            transform: translateY(-3px) scale(1.03) !important;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.2) !important;
            border-color: var(--primary) !important;
        }

        .quiz-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.08) !important;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25) !important;
            filter: brightness(1.1);
        }

        .action-btn:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
            color: white !important;
            transform: scale(1.15) rotate(8deg) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5) !important;
        }

        /* Modern Dropdown */
        .modern-dropdown {
            position: relative;
            margin-top: 12px;
        }

        .modern-dropdown select {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 2px solid transparent;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--surface) 0%, var(--glass) 100%);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .modern-dropdown select:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(59, 130, 246, 0.08) 100%);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .modern-dropdown select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 8px 25px rgba(59, 130, 246, 0.25);
            transform: translateY(-2px);
        }

        /* Enhanced Search with Blur Effect */
        .search-container {
            transition: all 0.4s ease;
        }

        .search-box {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .search-box:focus-within {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2);
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.15);
        }

        .search-blur-active .main-content > *:not(.search-container):not(.quiz-container) {
            filter: blur(8px);
            opacity: 0.7;
            pointer-events: none;
        }

        /* Beautiful Stats Cards */
        .stat-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.05) !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2) !important;
        }

        /* Modern Progress Bars */
        .progress-fill {
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark), #8b5cf6) !important;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.4);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Beautiful Notification */
        .notification {
            border-radius: 20px !important;
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15)) !important;
        }

        .dark-mode .notification {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2)) !important;
        }

        /* Enhanced Question Cards */
        .question-card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .question-card:hover {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-3px);
            border-color: var(--primary-light);
        }

        /* Modern Settings Panel */
        .settings-panel {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
        }

        .dark-mode .settings-panel {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Question Creator */
        .custom-question-creator {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 32px;
        }

        .dark-mode .custom-question-creator {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.15) rotate(15deg);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.6);
        }

        /* Dark mode adjustments */
        .dark-mode .nav-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.1) 100%) !important;
        }

        .dark-mode .category-card:hover {
            background: linear-gradient(135deg, var(--glass) 0%, rgba(17, 24, 39, 0.95) 100%) !important;
        }

        .dark-mode .option:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.08) 100%) !important;
        }

        /* Search Results Highlight */
        .search-highlight {
            background: linear-gradient(120deg, var(--primary-light) 0%, transparent 50%);
            border-radius: 4px;
            padding: 2px 4px;
        }
    </style>
</head>
<body class="dark-mode">
    <div class="overlay" id="overlay"></div>
    
    <!-- Registration Modal -->
    <div class="custom-quiz-modal" id="registrationModal">
        <div class="custom-quiz-content glass-effect" style="max-width: 450px;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 24px;">
                <h3 class="custom-quiz-title"><i class="fas fa-user-plus"></i> Register</h3>
                <button class="action-btn" onclick="closeRegistrationModal()" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="priceInfo" class="price-info">Select Year to View Price</div>
            
            <form id="regForm">
                <div class="input-group">
                    <i class="fas fa-graduation-cap"></i>
                    <select id="year" required>
                        <option value="" disabled selected>Select Year of Study</option>
                        <option value="1">1st Year - 100 ETB</option>
                        <option value="2">2nd Year - 120 ETB</option>
                        <option value="3">3rd Year - 140 ETB</option>
                        <option value="4">4th Year - 160 ETB</option>
                        <option value="5">5th Year - 180 ETB</option>
                        <option value="6">6th Year - 200 ETB</option>
                        <option value="7">7th Year - 220 ETB</option>
                    </select>
                </div>
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input id="name" placeholder="Full Name" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-phone"></i>
                    <input id="phone" type="tel" placeholder="Phone Number" required>
                </div>
                <div class="input-group">
                    <i class="fab fa-telegram-plane"></i>
                    <input id="telegram" placeholder="Telegram Username (optional)">
                </div>
                <div class="file-upload">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span id="uploadText">Upload Payment Receipt</span>
                    <input id="receipt" type="file" accept="image/*" required>
                </div>
                <img id="receiptPreview" class="receipt-preview" alt="Receipt Preview">
                <button type="submit" id="submitBtn"><i class="fas fa-paper-plane"></i> Submit Registration</button>
                <div id="regError" class="error"></div>
            </form>
            
            <div id="verifyForm" style="display:none">
                <h3 class="custom-quiz-title"><i class="fas fa-lock"></i> Enter Verification Code</h3>
                <div class="input-group">
                    <i class="fas fa-key"></i>
                    <input id="verifyCode" placeholder="6-digit code" maxlength="6" required>
                </div>
                <div class="custom-quiz-actions" style="display: flex; gap: 12px; justify-content: space-between; margin-top: 24px;">
                    <button class="quiz-btn" id="backBtn" style="background: var(--secondary); color: white; padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-arrow-left"></i>
                        Back to Registration
                    </button>
                    <button class="quiz-btn check-btn" id="verifyBtn" style="padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-check-circle"></i>
                        Verify
                    </button>
                </div>
                <div id="verifyError" class="error"></div>
            </div>
        </div>
    </div>

    <!-- Add Year Modal -->
    <div class="custom-quiz-modal" id="addModal">
        <div class="custom-quiz-content glass-effect" style="max-width: 450px;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 24px;">
                <h3 class="custom-quiz-title"><i class="fas fa-plus"></i> Add Year</h3>
                <button class="action-btn" onclick="closeAddModal()" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="price-info">Additional Charge: 50 ETB</div>
            
            <form id="addForm">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input id="addName" placeholder="Full Name (for verification)" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-graduation-cap"></i>
                    <select id="newYear" required>
                        <option value="" disabled selected>Select New Year</option>
                        <option value="1">1st Year</option>
                        <option value="2">2nd Year</option>
                        <option value="3">3rd Year</option>
                        <option value="4">4th Year</option>
                        <option value="5">5th Year</option>
                        <option value="6">6th Year</option>
                        <option value="7">7th Year</option>
                    </select>
                </div>
                <div class="file-upload">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span id="addUploadText">Upload Payment Receipt (50 ETB)</span>
                    <input id="addReceipt" type="file" accept="image/*" required>
                </div>
                <img id="addReceiptPreview" class="receipt-preview" alt="Receipt Preview">
                <button type="submit" id="addSubmitBtn"><i class="fas fa-paper-plane"></i> Submit Addition</button>
                <div id="addError" class="error"></div>
            </form>
            
            <div id="addVerifyForm" style="display:none">
                <h3 class="custom-quiz-title"><i class="fas fa-lock"></i> Enter Verification Code</h3>
                <div class="input-group">
                    <i class="fas fa-key"></i>
                    <input id="addVerifyCode" placeholder="6-digit code" maxlength="6" required>
                </div>
                <div class="custom-quiz-actions" style="display: flex; gap: 12px; justify-content: space-between; margin-top: 24px;">
                    <button class="quiz-btn" id="addBackBtn" style="background: var(--secondary); color: white; padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-arrow-left"></i>
                        Back to Addition
                    </button>
                    <button class="quiz-btn check-btn" id="addVerifyBtn" style="padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-check-circle"></i>
                        Verify
                    </button>
                </div>
                <div id="addVerifyError" class="error"></div>
            </div>
        </div>
    </div>

    <!-- Confirm Add Modal -->
    <div class="custom-quiz-modal" id="confirmAddModal">
        <div class="custom-quiz-content glass-effect" style="max-width: 400px;">
            <h3 class="custom-quiz-title"><i class="fas fa-exclamation-circle"></i> Confirm Addition</h3>
            <p style="color: var(--text-secondary); margin-bottom: 24px; text-align: center;">Adding a new year costs 50 ETB. Proceed to add a new year?</p>
            <div class="custom-quiz-actions" style="display: flex; gap: 12px; justify-content: center;">
                <button class="quiz-btn" id="cancelAddBtn" style="background: var(--secondary); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="quiz-btn check-btn" id="okAddBtn" style="padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-check"></i>
                    Proceed
                </button>
            </div>
        </div>
    </div>

    <!-- Access Denied Modal -->
    <div class="custom-quiz-modal" id="accessDeniedModal">
        <div class="custom-quiz-content glass-effect" style="max-width: 400px;">
            <h3 class="custom-quiz-title"><i class="fas fa-ban"></i> Access Denied</h3>
            <p id="deniedMessage" style="color: var(--text-secondary); margin-bottom: 24px; text-align: center;"></p>
            <button class="quiz-btn check-btn" id="closeDeniedBtn" style="padding: 12px 24px; border-radius: 12px; margin: 0 auto;">
                <i class="fas fa-times"></i>
                Close
            </button>
        </div>
    </div>

    <!-- Logout Modal -->
    <div class="custom-quiz-modal" id="logoutModal">
        <div class="custom-quiz-content glass-effect" style="max-width: 400px;">
            <h3 class="custom-quiz-title"><i class="fas fa-sign-out-alt"></i> Confirm Logout</h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px; text-align: center;">Enter the 6-digit code sent to the admin to confirm logout.</p>
            <div class="input-group">
                <i class="fas fa-key"></i>
                <input id="logoutCode" placeholder="6-digit code" maxlength="6" required>
            </div>
            <button class="quiz-btn check-btn" id="confirmLogoutBtn" style="padding: 12px 24px; border-radius: 12px; margin-top: 16px; width: 100%;">
                <i class="fas fa-check-circle"></i>
                Confirm Logout
            </button>
            <div id="logoutError" class="error"></div>
        </div>
    </div>
    
    <!-- Custom Quiz Modal -->
    <div class="custom-quiz-modal" id="customQuizModal">
        <div class="custom-quiz-content glass-effect">
            <h3 class="custom-quiz-title">Create Custom Quiz</h3>
            <div class="custom-quiz-options">
                <div class="custom-quiz-option" data-category="all">
                    <div class="option-selector"></div>
                    <label>All Categories</label>
                </div>
                <div class="custom-quiz-option" data-category="easy">
                    <div class="option-selector"></div>
                    <label>Easy Questions Only</label>
                </div>
                <div class="custom-quiz-option" data-category="medium">
                    <div class="option-selector"></div>
                    <label>Medium Questions Only</label>
                </div>
                <div class="custom-quiz-option" data-category="hard">
                    <div class="option-selector"></div>
                    <label>Hard Questions Only</label>
                </div>
                <div class="custom-quiz-option" data-category="bookmarked">
                    <div class="option-selector"></div>
                    <label>Bookmarked Questions Only</label>
                </div>
                <div class="quiz-options-section">
                    <label>Number of Questions</label>
                    <div class="modern-dropdown">
                        <select id="questionCount">
                            <option value="5">5 Questions</option>
                            <option value="10" selected>10 Questions</option>
                            <option value="15">15 Questions</option>
                            <option value="20">20 Questions</option>
                            <option value="0">All Questions</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="custom-quiz-actions">
                <button class="quiz-btn" id="cancelCustomQuiz">
                    Cancel
                </button>
                <button class="quiz-btn check-btn" id="createCustomQuiz">
                    Create Quiz
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-stethoscope"></i>
                    <span>MediQuiz Pro</span>
                </div>
                <div class="sidebar-subtitle">Advanced Medical Education Platform</div>
            </div>
            
            <div class="user-profile" id="userProfileSection">
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <h3 id="userName">Guest User</h3>
                    <p id="userRole">Not registered</p>
                </div>
                <div class="user-actions" style="margin-left: auto;">
                    <button class="action-btn" onclick="showRegistrationModal()" aria-label="Register" style="background: rgba(59, 130, 246, 0.1); color: var(--primary);">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="nav-item active">
                <div class="nav-icon">
                    <i class="fas fa-home"></i>
                </div>
                <span>Dashboard</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span>My Courses</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span>Progress Analytics</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-bookmark"></i>
                </div>
                <span>Bookmarked Questions</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <span>Settings</span>
            </div>
            
            <div class="categories-section">
                <div class="section-title">
                    <span>Medical Categories</span>
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div class="categories-grid" id="categoriesGrid"></div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Top Navigation -->
            <div class="top-nav">
                <div class="nav-left">
                    <button class="menu-toggle" id="menuToggle" aria-label="Toggle Sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Medical Quiz Dashboard</h1>
                </div>
                <div class="nav-right">
                    <div class="mode-selector">
                        <button class="mode-btn active" data-mode="exam" aria-label="Exam Mode">
                            <i class="fas fa-file-alt"></i>
                            Exam
                        </button>
                        <button class="mode-btn" data-mode="quiz" aria-label="Quiz Mode">
                            <i class="fas fa-tasks"></i>
                            Quiz
                        </button>
                        <button class="mode-btn" data-mode="learn" aria-label="Learn Mode">
                            <i class="fas fa-brain"></i>
                            Learn
                        </button>
                    </div>
                    <div class="action-btn" id="themeToggle" aria-label="Toggle Theme">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div class="action-btn" aria-label="Notifications">
                        <i class="fas fa-bell"></i>
                    </div>
                    <button class="action-btn" id="logoutBtn" aria-label="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- Search Section -->
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search questions or categories...">
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+12%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="correctAnswers">0</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-down" style="color: var(--error);"></i>
                            <span style="color: var(--error); font-size: 13px;">-5%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="timeSpent">0h</div>
                    <div class="stat-label">Time Spent</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            <span style="color: var(--success); font-size: 13px;">+8%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="masteryLevel">0%</div>
                    <div class="stat-label">Mastery Level</div>
                </div>
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up" style="color: var(--warning);"></i>
                            <span style="color: var(--warning); font-size: 13px;">+3</span>
                        </div>
                    </div>
                    <div class="stat-value" id="streakCount">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div class="analytics-section">
                <h3 class="analytics-title">Learning Analytics</h3>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-value" id="weakAreasCount">0</div>
                        <div class="analytics-label">Weak Areas Identified</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="avgTimePerQuestion">0s</div>
                        <div class="analytics-label">Avg Time Per Question</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="improvementRate">0%</div>
                        <div class="analytics-label">Weekly Improvement</div>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Container -->
            <div class="quiz-container" id="quizContainer"></div>
            
            <!-- Results Screen -->
            <div class="results-screen hidden" id="resultsScreen"></div>
            
            <!-- Export Section -->
            <div class="export-section">
                <button class="export-btn" id="exportProgress">
                    <i class="fas fa-download"></i>
                    Export Progress Data
                </button>
                <button class="export-btn" id="createCustomQuizBtn" style="margin-left: 12px;">
                    <i class="fas fa-plus"></i>
                    Create Custom Quiz
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="custom-quiz-modal" id="profileModal">
        <div class="custom-quiz-content glass-effect" style="max-width: 500px;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 24px;">
                <h3 class="custom-quiz-title">My Profile</h3>
                <button class="action-btn" onclick="closeProfileModal()" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="profileContent">
                <!-- Profile content will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  const tg = window.Telegram.WebApp;

  // Show Telegram's native back button
  tg.BackButton.show();

  // Handle Telegram back button press
  tg.BackButton.onClick(() => {
    // Example: navigate back
    window.history.back();
  });
</script>

    <script>
        // ==================== SECURITY SYSTEM ====================
        // Anti-copy, anti-inspect, and protection measures
        (function() {
            'use strict';
            
            // Prevent right-click context menu
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Prevent keyboard shortcuts for DevTools
            document.addEventListener('keydown', function(e) {
                // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
                if (e.keyCode === 123 || 
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) || 
                    (e.ctrlKey && e.shiftKey && e.keyCode === 74) || 
                    (e.ctrlKey && e.keyCode === 85)) {
                    e.preventDefault();
                    showSecurityAlert('Developer tools are disabled for security reasons.');
                    return false;
                }
                
                // Ctrl+S (Save Page)
                if (e.ctrlKey && e.keyCode === 83) {
                    e.preventDefault();
                    showSecurityAlert('Page saving is disabled.');
                    return false;
                }
                
                // Ctrl+C (Copy) - Allow but log
                if (e.ctrlKey && e.keyCode === 67) {
                    logSecurityEvent('copy_attempt');
                }
            });
            
            // Prevent text selection and copy
            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Prevent drag and drop
            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
                return false;
            });
            
            document.addEventListener('drop', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Detect DevTools opening
            let devToolsOpen = false;
            const element = new Image();
            Object.defineProperty(element, 'id', {
                get: function() {
                    devToolsOpen = true;
                    showSecurityAlert('Developer tools detection triggered.');
                }
            });
            
            console.log('%c', element);
            
            // Periodic DevTools check
            setInterval(function() {
                if (devToolsOpen) {
                    document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #000; color: #fff; font-family: Arial, sans-serif;"><h1>Security Violation Detected</h1></div>';
                    throw new Error('Security violation');
                }
            }, 1000);
            
            // Detect iframe embedding (prevent clickjacking)
            if (window.location !== window.parent.location) {
                document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #000; color: #fff; font-family: Arial, sans-serif;"><h1>Framing not allowed for security reasons</h1></div>';
            }
            
            // Disable console functions
            console.log = function() {};
            console.warn = function() {};
            console.error = function() {};
            console.info = function() {};
            
            // Override alert to prevent external calls
            window.alert = function(message) {
                showSecurityAlert(message);
            };
            
            // Utility functions
            function showSecurityAlert(message) {
                // Create security notification
                const alert = document.createElement('div');
                alert.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #dc2626;
                    color: white;
                    padding: 16px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                    font-weight: bold;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    border-left: 4px solid #fee2e2;
                `;
                alert.innerHTML = `🚫 ${message}`;
                document.body.appendChild(alert);
                
                setTimeout(() => {
                    if (document.body.contains(alert)) {
                        document.body.removeChild(alert);
                    }
                }, 5000);
            }
            
            function logSecurityEvent(eventType) {
                const timestamp = new Date().toISOString();
                const logEntry = {
                    event: eventType,
                    timestamp: timestamp,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                // Store in memory (could be sent to server in production)
                if (!window.securityLogs) {
                    window.securityLogs = [];
                }
                window.securityLogs.push(logEntry);
            }
            
            // Initialize security logging
            logSecurityEvent('page_loaded');
        })();
        // ==================== END SECURITY SYSTEM ====================

        // Registration System Variables
        const prices = {
            1: 100,
            2: 120,
            3: 140,
            4: 160,
            5: 180,
            6: 200,
            7: 220
        };

        // Core application variables
        const overlay = document.getElementById('overlay');
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const categoriesGrid = document.getElementById('categoriesGrid');
        const themeToggle = document.getElementById('themeToggle');
        const quizContainer = document.getElementById('quizContainer');
        const resultsScreen = document.getElementById('resultsScreen');
        const pageTitle = document.getElementById('pageTitle');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const correctAnswersEl = document.getElementById('correctAnswers');
        const timeSpentEl = document.getElementById('timeSpent');
        const masteryLevelEl = document.getElementById('masteryLevel');
        const streakCountEl = document.getElementById('streakCount');
        const searchInput = document.getElementById('searchInput');
        const exportProgressBtn = document.getElementById('exportProgress');
        const createCustomQuizBtn = document.getElementById('createCustomQuizBtn');
        const customQuizModal = document.getElementById('customQuizModal');
        const cancelCustomQuizBtn = document.getElementById('cancelCustomQuiz');
        const createCustomQuizBtnModal = document.getElementById('createCustomQuiz');
        const weakAreasCountEl = document.getElementById('weakAreasCount');
        const avgTimePerQuestionEl = document.getElementById('avgTimePerQuestion');
        const improvementRateEl = document.getElementById('improvementRate');

        // Registration System DOM Elements
        const registrationModal = document.getElementById('registrationModal');
        const regForm = document.getElementById('regForm');
        const verifyForm = document.getElementById('verifyForm');
        const addModal = document.getElementById('addModal');
        const confirmAddModal = document.getElementById('confirmAddModal');
        const addForm = document.getElementById('addForm');
        const addVerifyForm = document.getElementById('addVerifyForm');
        const accessDeniedModal = document.getElementById('accessDeniedModal');
        const logoutModal = document.getElementById('logoutModal');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileModal = document.getElementById('profileModal');

        // Navigation elements
        const navItems = document.querySelectorAll('.nav-item');

        // Application state
        let currentMode = 'exam';
        let selectedCategories = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = [];
        let questions = [];
        let incorrectQuestions = [];
        let isAnswerChecked = false;
        let bookmarkedQuestions = new Set();
        let userProgress = {};
        let userStats = {
            totalQuestions: 0,
            correctAnswers: 0,
            timeSpent: 0,
            masteryLevel: 0,
            streak: 0,
            lastActive: null,
            weeklyProgress: []
        };
        let timerInterval = null;
        let startTime = null;
        let remainingTime = 0;
        let isCountdown = false;
        let examCheckMode = 'immediate';
        let examSubmitted = false;
        let questionTimers = [];
        let searchResults = [];
        let isSearchActive = false;
        let currentPage = 'dashboard';
        let customQuestions = [];

        // Enhanced quiz data with more questions
        const quizData = [
    {
        "id": 1,
        "question": "Which of the following is not pathologic hyperplasia?",
        "options": [
            "Compensatory hyperplasia in liver",
            "Endometrial hyperplasia",
            "Benign prostatic hyperplasia",
            "None"
        ],
        "answer": 0,
        "correctAnswer": "Compensatory hyperplasia in liver",
        "explanation": "Hyperplasia can be physiologic or pathologic. Physiologic hyperplasia includes compensatory hyperplasia, such as liver regeneration after partial hepatectomy, which is an adaptive, controlled response. Endometrial hyperplasia and benign prostatic hyperplasia are pathologic, driven by abnormal hormonal or growth factor stimulation, potentially predisposing to cancer. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 34.",
        "whyNotOtherOptions": {
            "b": "Endometrial hyperplasia is pathologic, often due to excess estrogen.",
            "c": "Benign prostatic hyperplasia is pathologic, linked to hormonal imbalances.",
            "d": "Incorrect, as compensatory hyperplasia is physiologic."
        },
        "relatedQuestions": [],
        "category": "Cellular Adaptations",
        "difficulty": "Medium"
    },
    {
        "id": 2,
        "question": "Which of the following is false about atrophy?",
        "options": [
            "Ubiquitin-proteasome pathway activation",
            "Increased autophagy",
            "Reprogramming of stem cells",
            "None"
        ],
        "answer": 2,
        "correctAnswer": "Reprogramming of stem cells",
        "explanation": "Atrophy involves reduced cell and organ size via protein degradation through the ubiquitin-proteasome pathway and increased autophagy, where cellular components are digested in lysosomes. Reprogramming of stem cells is not a standard mechanism of atrophy. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 36.",
        "whyNotOtherOptions": {
            "a": "Ubiquitin-proteasome pathway is a key mechanism in atrophy.",
            "b": "Increased autophagy is a hallmark of atrophy.",
            "d": "Incorrect, as reprogramming of stem cells is not a primary mechanism."
        },
        "relatedQuestions": [],
        "category": "Cellular Adaptations",
        "difficulty": "Medium"
    },
    {
        "id": 3,
        "question": "Which of the following features of reversible cell injury can be recognized under the light microscope?",
        "options": [
            "Dilation of the ER, with detachment of polysomes",
            "Mitochondrial changes, including swelling and the appearance of small amorphous density",
            "Plasma membrane alterations, such as blebbing",
            "Fatty change",
            "None"
        ],
        "answer": 3,
        "correctAnswer": "Fatty change",
        "explanation": "Fatty change, the accumulation of lipid vacuoles in the cytoplasm, is visible under a light microscope, especially in organs like the liver. Other options (ER dilation, mitochondrial swelling, membrane blebbing) are ultrastructural changes seen only with electron microscopy. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 40.",
        "whyNotOtherOptions": {
            "a": "ER dilation is visible only by electron microscopy.",
            "b": "Mitochondrial changes require electron microscopy.",
            "c": "Membrane blebbing is an ultrastructural feature.",
            "e": "Incorrect, as fatty change is visible under light microscopy."
        },
        "relatedQuestions": [],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 4,
        "question": "The enzymes that digest the necrotic cell are derived from?",
        "options": [
            "Lysosomes of the dying cells",
            "Lysosomes of leukocytes",
            "Mitochondria",
            "A and B",
            "All of the above"
        ],
        "answer": 3,
        "correctAnswer": "A and B",
        "explanation": "Necrotic cell digestion occurs via enzymes from lysosomes of the dead cells (autolysis) and leukocytes (heterolysis) recruited to the site. Mitochondria do not contribute digestive enzymes. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 43.",
        "whyNotOtherOptions": {
            "c": "Mitochondria are involved in energy production, not digestion.",
            "e": "Incorrect, as mitochondria are not involved."
        },
        "relatedQuestions": [],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 5,
        "question": "Which of the following is a special form of necrosis seen in immune reactions involving blood vessels?",
        "options": [
            "Fibrinoid necrosis",
            "Coagulative necrosis",
            "Fat necrosis",
            "Caseous necrosis"
        ],
        "answer": 0,
        "correctAnswer": "Fibrinoid necrosis",
        "explanation": "Fibrinoid necrosis involves fibrin-like material deposition in blood vessel walls, common in immune-mediated conditions like vasculitides and malignant hypertension. It consists of fibrin and immune complexes. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 45.",
        "whyNotOtherOptions": {
            "b": "Coagulative necrosis is typical in ischemic injury, e.g., myocardial infarction.",
            "c": "Fat necrosis occurs in adipose tissue, e.g., pancreatitis.",
            "d": "Caseous necrosis is associated with tuberculosis."
        },
        "relatedQuestions": [],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 6,
        "question": "Which of the following is involved in free radical removal?",
        "options": [
            "Nitric oxide (NO)",
            "Catalase",
            "Superoxide dismutase",
            "Glutathione peroxidase",
            "All except A"
        ],
        "answer": 4,
        "correctAnswer": "All except A",
        "explanation": "Catalase, superoxide dismutase (SOD), and glutathione peroxidase neutralize free radicals by degrading H₂O₂ and superoxide. Nitric oxide (NO) is a free radical and contributes to oxidative stress. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 38.",
        "whyNotOtherOptions": {
            "a": "Nitric oxide is a free radical, not an antioxidant.",
            "b": "Catalase degrades H₂O₂.",
            "c": "SOD converts superoxide to H₂O₂.",
            "d": "Glutathione peroxidase reduces H₂O₂."
        },
        "relatedQuestions": ["12 (lipofuscin)"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 7,
        "question": "Which of the following is a pathologic effect of free radicals?",
        "options": [
            "Lipid peroxidation in membranes",
            "Misfolded proteins formation",
            "Double-strand breaks in DNA",
            "Cross-linking of DNA strands",
            "All of the above",
            "None"
        ],
        "answer": 4,
        "correctAnswer": "All of the above",
        "explanation": "Free radicals cause lipid peroxidation, protein misfolding, and DNA damage (strand breaks and cross-links), leading to cell injury. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 38.",
        "whyNotOtherOptions": {
            "f": "Incorrect, as all listed effects are caused by free radicals."
        },
        "relatedQuestions": ["6 (free radical removal)"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 8,
        "question": "Which of the following consistently characterizes irreversible cell injury?",
        "options": [
            "Profound disturbances in membrane function",
            "Mitochondrial changes, including swelling and the appearance of small amorphous density",
            "Dilation of the ER, with detachment of polysomes",
            "All of the above"
        ],
        "answer": 0,
        "correctAnswer": "Profound disturbances in membrane function",
        "explanation": "Irreversible cell injury is marked by severe mitochondrial dysfunction and extensive plasma membrane damage. Small amorphous densities and ER dilation are features of reversible injury. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 40.",
        "whyNotOtherOptions": {
            "b": "Small amorphous densities is seen in reversible injury.",
            "c": "ER dilation is a reversible injury feature.",
            "d": "Incorrect, as only profound membrane dysfunction is consistently irreversible."
        },
        "relatedQuestions": ["3 (reversible injury)"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 9,
        "question": "Which type of necrosis, on microscopic examination, appears as a structureless collection of fragmented cells and amorphous granular debris?",
        "options": [
            "Coagulative necrosis",
            "Liquefaction necrosis",
            "Caseous necrosis"
        ],
        "answer": 1,
        "correctAnswer": "Liquefaction necrosis",
        "explanation": "Liquefaction necrosis results in a liquid viscous mass, appearing microscopically as fragmented cells and amorphous debris, typical in bacterial abscesses. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 44.",
        "whyNotOtherOptions": {
            "a": "Coagulative necrosis preserves cell outlines.",
            "c": "Caseous necrosis has a cheese-like granular appearance."
        },
        "relatedQuestions": ["5 (fibrinoid necrosis)"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 10,
        "question": "Which of the following is FALSE about apoptosis?",
        "options": [
            "Elimination of potentially harmful self-reactive lymphocytes",
            "Occurs in cell death in certain infections, particularly viral infections",
            "It is always physiologic",
            "It induces inflammation",
            "C and D",
            "A and B"
        ],
        "answer": 4,
        "correctAnswer": "C and D",
        "explanation": "Apoptosis can be physiologic or pathologic (e.g., in viral infections) and does not induce inflammation, as apoptotic bodies are phagocytosed without releasing cellular contents. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 47.",
        "whyNotOtherOptions": {
            "a": "Apoptosis eliminates self-reactive lymphocytes.",
            "b": "Apoptosis occurs in viral infections, e.g., hepatitis.",
            "f": "Incorrect, as A and B are true."
        },
        "relatedQuestions": ["14 (apoptosis features)"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 11,
        "question": "Which of the following techniques is used in pathology?",
        "options": [
            "Immunohistochemistry",
            "FNAC",
            "FISH (fluorescent in situ hybridization)",
            "PCR",
            "All of the above",
            "Except D"
        ],
        "answer": 4,
        "correctAnswer": "All of the above",
        "explanation": "All are standard pathology techniques: immunohistochemistry detects antigens, FNAC is a diagnostic procedure, FISH identifies DNA sequences, and PCR amplifies DNA/RNA. Reference: Robbins, Basic Pathology, 10th ed., Chapter 1, p. 20.",
        "whyNotOtherOptions": {
            "f": "Incorrect, as PCR is a widely used pathology technique."
        },
        "relatedQuestions": [],
        "category": "Pathology Techniques",
        "difficulty": "Easy"
    },
    {
        "id": 12,
        "question": "Which pigment is a telltale sign of free radical injury and lipid peroxidation?",
        "options": [
            "Hemosiderin",
            "Lipofuscin",
            "Melanin",
            "None"
        ],
        "answer": 1,
        "correctAnswer": "Lipofuscin",
        "explanation": "Lipofuscin, a brownish-yellow pigment, accumulates in cells due to lipid peroxidation from free radical injury, seen in aging or atrophy. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 39.",
        "whyNotOtherOptions": {
            "a": "Hemosiderin is an iron storage pigment.",
            "c": "Melanin is a skin pigment, not related to free radicals.",
            "d": "Incorrect, as lipofuscin is the correct pigment."
        },
        "relatedQuestions": ["6 (free radical removal)"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 13,
        "question": "Which of the following conditions is not associated with metastatic calcification?",
        "options": [
            "Multiple myeloma",
            "Paget disease",
            "Sarcoidosis",
            "Hyperparathyroidism"
        ],
        "answer": 1,
        "correctAnswer": "Paget disease",
        "explanation": "Metastatic calcification occurs in normal tissues due to hypercalcemia, caused by conditions like multiple myeloma, sarcoidosis, and hyperparathyroidism. Paget disease involves bone remodeling but rarely causes significant hypercalcemia. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 50.",
        "whyNotOtherOptions": {
            "a": "Multiple myeloma causes hypercalcemia via bone destruction.",
            "c": "Sarcoidosis increases vitamin D, causing hypercalcemia.",
            "d": "Hyperparathyroidism directly causes hypercalcemia."
        },
        "relatedQuestions": [],
        "category": "Pathologic Calcification",
        "difficulty": "Medium"
    },
    {
        "id": 14,
        "question": "The most characteristic feature of apoptosis is?",
        "options": [
            "Chromatin condensation",
            "Induction of inflammation",
            "Formation of cytoplasmic blebs",
            "Apoptotic bodies"
        ],
        "answer": 0,
        "correctAnswer": "Chromatin condensation",
        "explanation": "Chromatin condensation, with margination against the nuclear envelope, is the hallmark of apoptosis, distinguishing it from necrosis. Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 47.",
        "whyNotOtherOptions": {
            "b": "Apoptosis does not induce inflammation.",
            "c": "Cytoplasmic blebs are a feature but less specific.",
            "d": "Apoptotic bodies occur later in the process."
        },
        "relatedQuestions": ["10 (apoptosis)"],
        "category": "Cell Injury",
        "difficulty": "Medium"
    },
    {
        "id": 15,
        "question": "Which adaptive process is a characteristic response to certain viral infections, such as papillomaviruses, which cause skin warts and mucosal lesions?",
        "options": [
            "Atrophy",
            "Hyperplasia",
            "Hypertrophy",
            "Metaplasia"
        ],
        "answer": 1,
        "correctAnswer": "Hyperplasia",
        "explanation": "Papillomaviruses induce host cell proliferation, leading to hyperplasia, as seen in skin warts (squamous epithelial hyperplasia). Reference: Robbins, Basic Pathology, 10th ed., Chapter 2, p. 34.",
        "whyNotOtherOptions": {
            "a": "Atrophy involves reduced cell size/number.",
            "c": "Hypertrophy is increased cell size, not number.",
            "d": "Metaplasia is a change in cell type."
        },
        "relatedQuestions": ["1 (hyperplasia)"],
        "category": "Cellular Adaptations",
        "difficulty": "Medium"
    },
    {
        "id": 16,
        "question": "A 36-year-old male has experienced mid-epigastric abdominal pain for the past 3 months. Upper endoscopy reveals a 2-cm ulceration of the gastric antrum. A biopsy of the ulcer shows angiogenesis with fibrosis and mononuclear cell infiltrates with lymphocytes, macrophages, and plasma cells. The best term for this pathologic process is?",
        "options": [
            "Acute inflammation",
            "Serous inflammation",
            "Granulomatous inflammation",
            "Fibrinous inflammation"
        ],
        "answer": null,
        "correctAnswer": "Chronic inflammation",
        "explanation": "The presence of fibrosis and mononuclear cell infiltrates (lymphocytes, macrophages, plasma cells) indicates chronic inflammation, typical of a chronic peptic ulcer. None of the provided options list chronic inflammation, but granulomatous inflammation is a specific subtype requiring granulomas, which are not described. Reference: Robbins, Basic Pathology, 10th ed., Chapter 3, p. 68.",
        "whyNotOtherOptions": {
            "a": "Acute inflammation involves neutrophils and shorter duration.",
            "b": "Serous inflammation involves serous fluid, not fibrosis.",
            "c": "Granulomatous inflammation requires granulomas, not described here.",
            "d": "Fibrinous inflammation involves fibrin deposition, not prominent here."
        },
        "relatedQuestions": [],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 17,
        "question": "A 59-year-old male has had a cough with fever for the past week. A chest radiograph reveals a right pleural fluid collection. A right thoracentesis yields 500 mL of cloudy yellow fluid. Which of the following cell types is most likely to be abundant in this fluid?",
        "options": [
            "Macrophages",
            "Neutrophils",
            "CD4 lymphocytes",
            "Plasma cells",
            "Eosinophils"
        ],
        "answer": 1,
        "correctAnswer": "Neutrophils",
        "explanation": "Cloudy yellow fluid suggests an exudate from acute inflammation, likely due to bacterial infection (e.g., empyema). Neutrophils are the dominant cell type in acute inflammation. Reference: Robbins, Basic Pathology, 10th ed., Chapter 3, p. 66.",
        "whyNotOtherOptions": {
            "a": "Macrophages predominate in chronic inflammation.",
            "c": "CD4 lymphocytes are involved in immune regulation, not acute exudates.",
            "d": "Plasma cells are seen in chronic inflammation.",
            "e": "Eosinophils are associated with allergic or parasitic conditions."
        },
        "relatedQuestions": [],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 18,
        "question": "A 43-year-old male has had a cough with fever for the previous 2 months. A chest radiograph reveals nodular density, some with calcification, located mainly in the upper lobes. The microscopic appearance of a lung biopsy shows a granuloma with many epithelioid cells and prominent large Langhans giant cells. Which of the following chemical mediators is most important in the pathogenesis of this lesion?",
        "options": [
            "Complement C5a",
            "Interferon-X",
            "Bradykinin",
            "Nitric oxide"
        ],
        "answer": 1,
        "correctAnswer": "Interferon-X (Interferon-gamma)",
        "explanation": "The description suggests tuberculosis, with granulomas containing epithelioid cells and Langhans giant cells. Interferon-gamma (IFN-γ), produced by Th1 cells, activates macrophages to form granulomas. Reference: Robbins, Basic Pathology, 10th ed., Chapter 3, p. 70.",
        "whyNotOtherOptions": {
            "a": "C5a attracts neutrophils, not key in granuloma formation.",
            "c": "Bradykinin mediates pain and vascular permeability, not granulomas.",
            "d": "Nitric oxide is involved in macrophage killing, not granuloma formation."
        },
        "relatedQuestions": ["26 (IFN-γ)"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 19,
        "question": "Acute inflammation can be initiated by:",
        "options": [
            "Mast cell activation",
            "Influx of neutrophils",
            "An increase in vascular permeability",
            "C3",
            "Lysozyme"
        ],
        "answer": 0,
        "correctAnswer": "Mast cell activation",
        "explanation": "Mast cell activation, via degranulation, releases mediators like histamine, initiating acute inflammation. Neutrophil influx and vascular permeability are components, not initiators. C3 and lysozyme are effectors. Reference: Robbins, Basic Pathology, 10th ed., Chapter 3, p. 65.",
        "whyNotOtherOptions": {
            "b": "Neutrophil influx is a result, not initiator.",
            "c": "Vascular permeability is a feature, not initiator.",
            "d": "C3 is a complement component, not an initiator.",
            "e": "Lysozyme is an antimicrobial enzyme."
        },
        "relatedQuestions": [],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 20,
        "question": "Intracellular organisms, like tuberculosis, within macrophages are killed more readily in the presence of:",
        "options": [
            "Antibody",
            "Kinins",
            "Properdin",
            "Gamma-interferon",
            "Anaphylatoxin"
        ],
        "answer": 3,
        "correctAnswer": "Gamma-interferon",
        "explanation": "Gamma-interferon (IFN-γ) activates macrophages, enhancing their ability to kill intracellular pathogens like Mycobacterium tuberculosis via reactive oxygen and nitrogen species. Reference: Robbins, Basic Pathology, 10th ed., Chapter 3, p. 70.",
        "whyNotOtherOptions": {
            "a": "Antibodies aid extracellular pathogen clearance.",
            "b": "Kinins mediate vascular effects, not macrophage activation.",
            "c": "Properdin stabilizes complement, not macrophage function.",
            "e": "Anaphylatoxins (e.g., C5a) recruit inflammatory cells."
        },
        "relatedQuestions": ["18 (IFN-γ)"],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 21,
        "question": "Macrophages are derived from:",
        "options": [
            "Monocytes",
            "T cells",
            "B cells",
            "Eosinophils",
            "Plasma cells"
        ],
        "answer": 0,
        "correctAnswer": "Monocytes",
        "explanation": "Macrophages differentiate from circulating monocytes that migrate into tissues. Reference: Robbins, Basic Pathology, 10th ed., Chapter 3, p. 67.",
        "whyNotOtherOptions": {
            "b": "T cells are lymphocytes involved in cell-mediated immunity.",
            "c": "B cells produce antibodies.",
            "d": "Eosinophils combat parasites and allergies.",
            "e": "Plasma cells are differentiated B cells."
        },
        "relatedQuestions": [],
        "category": "Inflammation",
        "difficulty": "Easy"
    },
    {
        "id": 22,
        "question": "Regarding chronic inflammation, which is correct?",
        "options": [
            "It is characterized by hyperemia, edema, and leukocyte infiltration",
            "Monocytes use the same chemotactic pathways as neutrophils",
            "It is always preceded by acute inflammation",
            "Most frequently results in resolution",
            "Angiogenesis is not a feature"
        ],
        "answer": 1,
        "correctAnswer": "Monocytes use the same chemotactic pathways as neutrophils",
        "explanation": "Monocytes and neutrophils share chemotactic pathways (e.g., C5a, leukotriene B4). Chronic inflammation involves mononuclear cells, not hyperemia/edema (acute features). It can arise de novo, does not always resolve, and includes angiogenesis. Reference: Robbins, Basic Pathology, 10th ed., Chapter 3, p. 68.",
        "whyNotOtherOptions": {
            "a": "Hyperemia and edema characterize acute inflammation.",
            "c": "Chronic inflammation can occur without acute phase.",
            "d": "Chronic inflammation often leads to fibrosis, not resolution.",
            "e": "Angiogenesis is a feature of chronic inflammation."
        },
        "relatedQuestions": [],
        "category": "Inflammation",
        "difficulty": "Medium"
    },
    {
        "id": 23,
        "question": "TRUE about wound healing:",
        "options": [
            "Infected wounds heal by primary intention",
            "Deep dermal wounds heal by scar formation",
            "Wound contraction is found in healing by secondary intention",
            "More intense inflammatory response in primary intention",
            "B and C"
        ],
        "answer": 4,
        "correctAnswer": "B and C",
        "explanation": "Deep dermal wounds heal with scar formation. Wound contraction, mediated by myofibroblasts, occurs in secondary intention. Infected wounds heal by secondary intention, and primary intention has a less intense inflammatory response. Reference: Robbins, Basic Pathology, 10th ed., Chapter 3, p. 82.",
        "whyNotOtherOptions": {
            "a": "Infected wounds heal by secondary intention.",
            "d": "Secondary intention has a more intense inflammatory response."
        },
        "relatedQuestions": [],
        "category": "Tissue Repair",
        "difficulty": "Medium"
    },
    {
        "id": 24,
        "question": "False about keloid:",
        "options": [
            "Grows beyond wound margin",
            "Excess collagen deposition",
            "Precancerous leading to cancer",
            "Familial",
            "Common in neck & earlobes"
        ],
        "answer": 2,
        "correctAnswer": "Precancerous leading to cancer",
        "explanation": "Keloids are benign, with excessive collagen extending beyond wound margins, often familial, and common in areas like the neck and earlobes. They are not precancerous. Reference: Robbins, Basic Pathology, 10th ed., Chapter 3, p. 84.",
        "whyNotOtherOptions": {
            "a": "Keloids grow beyond wound margins.",
            "b": "Excess collagen is a hallmark of keloids.",
            "d": "Keloids have a genetic predisposition.",
            "e": "Keloids are common in neck and earlobes."
        },
        "relatedQuestions": ["23 (wound healing)"],
        "category": "Tissue Repair",
        "difficulty": "Medium"
    },
    {
        "id": 25,
        "question": "The following conditions are among hypercoagulable states predisposing patients for thrombosis, except?",
        "options": [
            "Cancer",
            "Burns",
            "Myocardial infarction",
            "Factor V Leiden",
            "None"
        ],
        "answer": 4,
        "correctAnswer": "None",
        "explanation": "All listed conditions promote thrombosis: cancer, burns, and myocardial infarction are acquired hypercoagulable states; Factor V Leiden is a hereditary cause. Reference: Robbins, Basic Pathology, 10th ed., Chapter 4, p. 120.",
        "whyNotOtherOptions": {
            "a": "Cancer promotes thrombosis via procoagulant factors.",
            "b": "Burns cause hypercoagulability via tissue injury.",
            "c": "Myocardial infarction triggers thrombus formation.",
            "d": "Factor V Leiden causes inherited thrombophilia."
        },
        "relatedQuestions": ["36 (thrombus)"],
        "category": "Hemodynamic Disorders",
        "difficulty": "Medium"
    },
    {
        "id": 26,
        "question": "Which one is not a component of the intrinsic pathway of the coagulation cascade?",
        "options": [
            "Factor XII",
            "Factor XI",
            "Factor VII",
            "Factor IX"
        ],
        "answer": 2,
        "correctAnswer": "Factor VII",
        "explanation": "The intrinsic pathway involves Factors XII, XI, IX, and VIII. Factor VII initiates the extrinsic pathway via tissue factor. Reference: Robbins, Basic Pathology, 10th ed., Chapter 4, p. 118.",
        "whyNotOtherOptions": {
            "a": "Factor XII initiates the intrinsic pathway.",
            "b": "Factor XI is part of the intrinsic pathway.",
            "d": "Factor IX is part of the intrinsic pathway."
        },
        "relatedQuestions": [],
        "category": "Hemodynamic Disorders",
        "difficulty": "Medium"
    },
    {
        "id": 27,
        "question": "Correct statement regarding hyperemia and congestion?",
        "options": [
            "Hyperemia is a passive process",
            "Congestion is an active process",
            "Both indicate an increase in blood in a given tissue",
            "Congestion associated with arterial dilatation and grossly appears red"
        ],
        "answer": 2,
        "correctAnswer": "Both indicate an increase in blood in a given tissue",
        "explanation": "Hyperemia (active, arteriolar dilation) and congestion (passive, venous outflow impairment) both increase blood volume in tissues. Congestion causes a cyanotic appearance, not arterial redness. Reference: Robbins, Basic Pathology, 10th ed., Chapter 4, p. 112.",
        "whyNotOtherOptions": {
            "a": "Hyperemia is active, not passive.",
            "b": "Congestion is passive, not active.",
            "d": "Congestion involves venous stasis, appearing cyanotic."
        },
        "relatedQuestions": ["35 (hepatic congestion)"],
        "category": "Hemodynamic Disorders",
        "difficulty": "Medium"
    },
    {
        "id": 28,
        "question": "Which one of the following is associated with edema due to decreased plasma oncotic pressure?",
        "options": [
            "CHF",
            "Cirrhosis",
            "Constrictive pericarditis",
            "Venous obstruction"
        ],
        "answer": 1,
        "correctAnswer": "Cirrhosis",
        "explanation": "Decreased plasma oncotic pressure, due to reduced albumin (e.g., in cirrhosis), causes edema. CHF, constrictive pericarditis, and venous obstruction cause edema via increased hydrostatic pressure. Reference: Robbins, Basic Pathology, 10th ed., Chapter 4, p. 113.",
        "whyNotOtherOptions": {
            "a": "CHF increases hydrostatic pressure.",
            "c": "Constrictive pericarditis increases hydrostatic pressure.",
            "d": "Venous obstruction increases hydrostatic pressure."
        },
        "relatedQuestions": [],
        "category": "Hemodynamic Disorders",
        "difficulty": "Medium"
    },
    {
        "id": 29,
        "question": "One is not a feature of acute hepatic congestion?",
        "options": [
            "Peri-portal hepatocyte fatty change",
            "Nutmeg liver",
            "Engorged central vein sinusoids",
            "None"
        ],
        "answer": 0,
        "correctAnswer": "Peri-portal hepatocyte fatty change",
        "explanation": "Acute hepatic congestion features engorged central veins and sinusoids and can show a nutmeg liver pattern. Fatty change, if present, is centrilobular in chronic congestion, not peri-portal in acute cases. Reference: Robbins, Basic Pathology, 10th ed., Chapter 4, p. 114.",
        "whyNotOtherOptions": {
            "b": "Nutmeg liver is seen in hepatic congestion.",
            "c": "Engorged central veins are characteristic.",
            "d": "Incorrect, as peri-portal fatty change is not a feature."
        },
        "relatedQuestions": ["27 (hyperemia/congestion)"],
        "category": "Hemodynamic Disorders",
        "difficulty": "Medium"
    },
    {
        "id": 30,
        "question": "Among the fates of a thrombus, which one describes further formation of more thrombosis?",
        "options": [
            "Embolization",
            "Propagation",
            "Dissolution",
            "Organization"
        ],
        "answer": 1,
        "correctAnswer": "Propagation",
        "explanation": "Propagation is the growth of a thrombus by additional platelet and fibrin deposition, potentially occluding the vessel. Reference: Robbins, Basic Pathology, 10th ed., Chapter 4, p. 117.",
        "whyNotOtherOptions": {
            "a": "Embolization is thrombus detachment and travel.",
            "c": "Dissolution is thrombus breakdown.",
            "d": "Organization involves thrombus incorporation into the vessel wall."
        },
        "relatedQuestions": ["25 (hypercoagulable states)"],
        "category": "Hemodynamic Disorders",
        "difficulty": "Medium"
    },
    {
        "id": 31,
        "question": "Most systemic thromboembolism arises from:",
        "options": [
            "Intracardiac mural thrombi",
            "DVT",
            "Aortic aneurysm",
            "Fragmentation of valvular vegetation"
        ],
        "answer": 0,
        "correctAnswer": "Intracardiac mural thrombi",
        "explanation": "Systemic (arterial) emboli primarily arise from intracardiac mural thrombi, often in the left ventricle (post-myocardial infarction) or left atrium (atrial fibrillation). Reference: Robbins, Basic Pathology, 10th ed., Chapter 4, p. 119.",
        "whyNotOtherOptions": {
            "b": "DVT causes pulmonary, not systemic, emboli.",
            "c": "Aortic aneurysms are a less common source.",
            "d": "Valvular vegetations are a minor source of systemic emboli."
        },
        "relatedQuestions": [],
        "category": "Hemodynamic Disorders",
        "difficulty": "Medium"
    },
    {
        "id": 32,
        "question": "The development and size of an infarct is determined by one of the following factors except:",
        "options": [
            "The nature of the vascular supply",
            "The rate of development of occlusion",
            "Susceptibility of the tissue for hypoxia",
            "Oxygen content of the blood",
            "None of the above"
        ],
        "answer": 4,
        "correctAnswer": "None of the above",
        "explanation": "All listed factors influence infarct development: vascular supply (dual vs. end-artery), occlusion rate (slow allows collaterals), tissue susceptibility (neurons vs. fibroblasts), and blood oxygen content (hypoxemia worsens infarcts). Reference: Robbins, Basic Pathology, 10th ed., Chapter 4, p. 121.",
        "whyNotOtherOptions": {
            "a": "Vascular supply affects infarct likelihood.",
            "b": "Occlusion rate impacts collateral development.",
            "c": "Tissue susceptibility determines damage extent.",
            "d": "Oxygen content affects tissue survival."
        },
        "relatedQuestions": [],
        "category": "Hemodynamic Disorders",
        "difficulty": "Medium"
    }
];

        // Core application functions
        function init() {
            initializeRegistrationSystem();
            initializeCategories();
            initializeEventListeners();
            initializeNavigation();
            loadUserData();
            updateDashboardStats();
            updateAnalytics();
            showDashboard();
            createFAB();
            updateCustomQuizModalHTML();
        }

        // ==================== REGISTRATION SYSTEM ====================
        function initializeRegistrationSystem() {
            loadRegistrationState();
            initializeRegistrationEvents();
            updateUIForRegistration();
        }

        function loadRegistrationState() {
            if (localStorage.getItem('verified') === 'true') {
                registrationModal.style.display = 'none';
                mainContent.style.display = 'block';
            } else {
                registrationModal.style.display = 'flex';
                mainContent.style.display = 'none';
                
                if (localStorage.getItem('pendingCode') && !isVerificationExpired('codeTimestamp')) {
                    regForm.style.display = 'none';
                    verifyForm.style.display = 'block';
                    document.getElementById('year').value = localStorage.getItem('tempYear') || '';
                    document.getElementById('name').value = localStorage.getItem('userName') || '';
                    document.getElementById('phone').value = localStorage.getItem('userPhone') || '';
                    document.getElementById('telegram').value = localStorage.getItem('userTelegram') || '';
                    updatePriceInfo();
                } else {
                    clearPendingRegistration();
                }
            }
        }

        function isVerificationExpired(timestampKey) {
            const codeTimestamp = localStorage.getItem(timestampKey);
            if (!codeTimestamp) return true;
            const now = new Date().getTime();
            const twoDaysInMs = 2 * 24 * 60 * 60 * 1000;
            return now - codeTimestamp > twoDaysInMs;
        }

        function clearPendingRegistration() {
            localStorage.removeItem('pendingCode');
            localStorage.removeItem('codeTimestamp');
            localStorage.removeItem('tempYear');
            localStorage.removeItem('userName');
            localStorage.removeItem('userPhone');
            localStorage.removeItem('userTelegram');
        }

        function initializeRegistrationEvents() {
            // Year selection price update
            document.getElementById('year').addEventListener('change', updatePriceInfo);
            
            // Receipt preview
            document.getElementById('receipt').addEventListener('change', handleReceiptPreview);
            document.getElementById('addReceipt').addEventListener('change', handleAddReceiptPreview);
            
            // Form submissions
            regForm.addEventListener('submit', handleRegistrationSubmit);
            addForm.addEventListener('submit', handleAddYearSubmit);
            
            // Verification buttons
            document.getElementById('verifyBtn').addEventListener('click', handleVerification);
            document.getElementById('addVerifyBtn').addEventListener('click', handleAddVerification);
            
            // Back buttons
            document.getElementById('backBtn').addEventListener('click', showRegistrationForm);
            document.getElementById('addBackBtn').addEventListener('click', showAddForm);
            
            // Add year flow
            document.getElementById('addYearBtn')?.addEventListener('click', showConfirmAddModal);
            document.getElementById('cancelAddBtn').addEventListener('click', closeConfirmAddModal);
            document.getElementById('okAddBtn').addEventListener('click', proceedToAddYear);
            
            // Modal close buttons
            document.getElementById('closeDeniedBtn').addEventListener('click', closeAccessDeniedModal);
            document.getElementById('confirmLogoutBtn').addEventListener('click', handleLogoutVerification);
            
            // Logout
            logoutBtn.addEventListener('click', handleLogout);
        }

        function updatePriceInfo() {
            const year = document.getElementById('year').value;
            const priceInfo = document.getElementById('priceInfo');
            priceInfo.textContent = year ? `Price: ${prices[year]} ETB` : 'Select Year to View Price';
        }

        function handleReceiptPreview() {
            const file = document.getElementById('receipt').files[0];
            const preview = document.getElementById('receiptPreview');
            const uploadText = document.getElementById('uploadText');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    uploadText.textContent = 'Change Payment Receipt';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                uploadText.textContent = 'Upload Payment Receipt';
            }
        }

        function handleAddReceiptPreview() {
            const file = document.getElementById('addReceipt').files[0];
            const preview = document.getElementById('addReceiptPreview');
            const uploadText = document.getElementById('addUploadText');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    uploadText.textContent = 'Change Payment Receipt';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                uploadText.textContent = 'Upload Payment Receipt (50 ETB)';
            }
        }

        async function handleRegistrationSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const regError = document.getElementById('regError');
            
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
            
            const year = document.getElementById('year').value;
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const telegram = document.getElementById('telegram').value || 'N/A';
            const receipt = document.getElementById('receipt').files[0];
            
            // Validation
            if (!year || !name || !phone || !receipt) {
                regError.textContent = 'Please fill all required fields.';
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                return;
            }
            
            // Generate verification code
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            
            // Save temporary data
            localStorage.setItem('pendingCode', code);
            localStorage.setItem('codeTimestamp', new Date().getTime());
            localStorage.setItem('tempYear', year);
            localStorage.setItem('userName', name);
            localStorage.setItem('userPhone', phone);
            localStorage.setItem('userTelegram', telegram);
            
            // Send to Telegram
            const caption = `*New Registration - MediQuiz Pro*\n*Year:* ${year} (${prices[year]} ETB)\n*Name:* ${name}\n*Phone:* ${phone}\n*Telegram:* ${telegram}\n*Verification Code:* ${code}`;
            
            const formData = new FormData();
            formData.append('chat_id', '7897840965'); // Your Telegram chat ID
            formData.append('photo', receipt);
            formData.append('caption', caption);
            formData.append('parse_mode', 'Markdown');
            
            try {
                const response = await fetch('https://api.telegram.org/bot8237566699:AAHICwsiqIrs-4_vUdrsORPlD8-WFSFYB2Y/sendPhoto', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    regForm.style.display = 'none';
                    verifyForm.style.display = 'block';
                    regError.textContent = '';
                } else {
                    regError.textContent = 'Error sending to Telegram: ' + data.description;
                }
            } catch (err) {
                regError.textContent = 'Error: ' + err.message;
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        }

        function handleVerification() {
            const enteredCode = document.getElementById('verifyCode').value;
            const verifyError = document.getElementById('verifyError');
            
            if (isVerificationExpired('codeTimestamp')) {
                verifyError.textContent = 'Verification code has expired. Please register again.';
                clearPendingRegistration();
                showRegistrationForm();
                return;
            }
            
            if (enteredCode === localStorage.getItem('pendingCode')) {
                // Successful verification
                localStorage.setItem('userYears', JSON.stringify([localStorage.getItem('tempYear')]));
                localStorage.setItem('verified', 'true');
                clearPendingRegistration();
                
                // Update UI and show main content
                updateUIForRegistration();
                registrationModal.style.display = 'none';
                mainContent.style.display = 'block';
                showNotification('Registration successful! Welcome to MediQuiz Pro.', 'success');
            } else {
                verifyError.textContent = 'Invalid verification code.';
            }
        }

        function showRegistrationModal() {
            registrationModal.classList.add('active');
        }

        function closeRegistrationModal() {
            registrationModal.classList.remove('active');
        }

        function showRegistrationForm() {
            regForm.style.display = 'block';
            verifyForm.style.display = 'none';
            document.getElementById('verifyError').textContent = '';
        }

        function showConfirmAddModal() {
            confirmAddModal.classList.add('active');
        }

        function closeConfirmAddModal() {
            confirmAddModal.classList.remove('active');
        }

        function proceedToAddYear() {
            confirmAddModal.classList.remove('active');
            addModal.classList.add('active');
            document.getElementById('addName').value = localStorage.getItem('userName') || '';
        }

        function closeAddModal() {
            addModal.classList.remove('active');
        }

        function showAddForm() {
            addForm.style.display = 'block';
            addVerifyForm.style.display = 'none';
            document.getElementById('addVerifyError').textContent = '';
        }

        async function handleAddYearSubmit(e) {
            e.preventDefault();
            
            const addSubmitBtn = document.getElementById('addSubmitBtn');
            const addError = document.getElementById('addError');
            
            addSubmitBtn.classList.add('loading');
            addSubmitBtn.disabled = true;
            
            const addName = document.getElementById('addName').value;
            const newYear = document.getElementById('newYear').value;
            const addReceipt = document.getElementById('addReceipt').files[0];
            const userYears = JSON.parse(localStorage.getItem('userYears')) || [];
            const phone = localStorage.getItem('userPhone');
            const telegram = localStorage.getItem('userTelegram') || 'N/A';
            
            // Validation
            if (!addName || !newYear || !addReceipt) {
                addError.textContent = 'Please fill all required fields.';
                addSubmitBtn.classList.remove('loading');
                addSubmitBtn.disabled = false;
                return;
            }
            
            if (addName !== localStorage.getItem('userName')) {
                addError.textContent = 'Name does not match registered name.';
                addSubmitBtn.classList.remove('loading');
                addSubmitBtn.disabled = false;
                return;
            }
            
            if (userYears.includes(newYear)) {
                addError.textContent = 'You are already registered for this year.';
                addSubmitBtn.classList.remove('loading');
                addSubmitBtn.disabled = false;
                return;
            }
            
            // Generate verification code
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            
            localStorage.setItem('addPendingCode', code);
            localStorage.setItem('addCodeTimestamp', new Date().getTime());
            localStorage.setItem('newUserYear', newYear);
            
            const caption = `*Add Year Request - MediQuiz Pro*\n*Current Years:* ${userYears.join(', ')}\n*New Year:* ${newYear}\n*Name:* ${addName}\n*Phone:* ${phone}\n*Telegram:* ${telegram}\n*Additional Fee: 50 ETB*\n*Verification Code:* ${code}`;
            
            const formData = new FormData();
            formData.append('chat_id', '7897840965');
            formData.append('photo', addReceipt);
            formData.append('caption', caption);
            formData.append('parse_mode', 'Markdown');
            
            try {
                const response = await fetch('https://api.telegram.org/bot8237566699:AAHICwsiqIrs-4_vUdrsORPlD8-WFSFYB2Y/sendPhoto', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    addForm.style.display = 'none';
                    addVerifyForm.style.display = 'block';
                    addError.textContent = '';
                } else {
                    addError.textContent = 'Error sending to Telegram: ' + data.description;
                }
            } catch (err) {
                addError.textContent = 'Error: ' + err.message;
            } finally {
                addSubmitBtn.classList.remove('loading');
                addSubmitBtn.disabled = false;
            }
        }

        function handleAddVerification() {
            const enteredCode = document.getElementById('addVerifyCode').value;
            const addVerifyError = document.getElementById('addVerifyError');
            
            if (isVerificationExpired('addCodeTimestamp')) {
                addVerifyError.textContent = 'Verification code has expired. Please submit addition again.';
                localStorage.removeItem('addPendingCode');
                localStorage.removeItem('addCodeTimestamp');
                localStorage.removeItem('newUserYear');
                showAddForm();
                return;
            }
            
            if (enteredCode === localStorage.getItem('addPendingCode')) {
                const userYears = JSON.parse(localStorage.getItem('userYears')) || [];
                const newYear = localStorage.getItem('newUserYear');
                userYears.push(newYear);
                localStorage.setItem('userYears', JSON.stringify(userYears));
                
                localStorage.removeItem('addPendingCode');
                localStorage.removeItem('addCodeTimestamp');
                localStorage.removeItem('newUserYear');
                
                addModal.classList.remove('active');
                updateUIForRegistration();
                showNotification('Year added successfully!', 'success');
            } else {
                addVerifyError.textContent = 'Invalid verification code.';
            }
        }

        function closeAccessDeniedModal() {
            accessDeniedModal.classList.remove('active');
        }

        function checkAccess(requestedYear) {
            const userYears = JSON.parse(localStorage.getItem('userYears')) || [];
            
            if (userYears.length === 0) {
                showAccessDeniedModal(userYears, requestedYear);
                return false;
            }
            
            // If you want to restrict access to specific years, add logic here
            // For now, any registered user can access all content
            return true;
        }

        function showAccessDeniedModal(userYears, requestedYear) {
            const deniedMessage = document.getElementById('deniedMessage');
            deniedMessage.textContent = `You are not registered for any year. Please register to access content.`;
            accessDeniedModal.classList.add('active');
        }

        function updateUIForRegistration() {
            const userProfileSection = document.getElementById('userProfileSection');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            const userAvatar = document.getElementById('userAvatar');
            
            if (localStorage.getItem('verified') === 'true') {
                const name = localStorage.getItem('userName') || 'User';
                const userYears = JSON.parse(localStorage.getItem('userYears')) || [];
                
                userName.textContent = name;
                userRole.textContent = `Year ${userYears.join(', ')}`;
                userAvatar.innerHTML = getInitials(name);
                userAvatar.style.background = 'var(--gradient)';
                
                // Update the register button to profile button
                const registerBtn = userProfileSection.querySelector('.action-btn');
                registerBtn.innerHTML = '<i class="fas fa-user"></i>';
                registerBtn.onclick = showProfileModal;
            } else {
                userName.textContent = 'Guest User';
                userRole.textContent = 'Not registered';
                userAvatar.innerHTML = '<i class="fas fa-user"></i>';
                userAvatar.style.background = 'var(--secondary)';
            }
        }

        async function handleLogout() {
            const logoutCode = Math.floor(100000 + Math.random() * 900000).toString();
            localStorage.setItem('logoutCode', logoutCode);
            
            const userYears = JSON.parse(localStorage.getItem('userYears')) || [];
            const name = localStorage.getItem('userName');
            const phone = localStorage.getItem('userPhone');
            const telegram = localStorage.getItem('userTelegram');
            
            const caption = `*Logout Request - MediQuiz Pro*\n*Years:* ${userYears.join(', ')}\n*Name:* ${name}\n*Phone:* ${phone}\n*Telegram:* ${telegram}\n*Logout Verification Code:* ${logoutCode}`;
            
            const formData = new FormData();
            formData.append('chat_id', '7897840965');
            formData.append('text', caption);
            formData.append('parse_mode', 'Markdown');
            
            try {
                const response = await fetch('https://api.telegram.org/bot8237566699:AAHICwsiqIrs-4_vUdrsORPlD8-WFSFYB2Y/sendMessage', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    logoutModal.classList.add('active');
                    document.getElementById('logoutError').textContent = '';
                } else {
                    showNotification('Error sending logout code', 'error');
                }
            } catch (err) {
                showNotification('Error: ' + err.message, 'error');
            }
        }

        function handleLogoutVerification() {
            const enteredCode = document.getElementById('logoutCode').value;
            const logoutError = document.getElementById('logoutError');
            
            if (enteredCode === localStorage.getItem('logoutCode')) {
                // Clear all data and reload
                localStorage.clear();
                location.reload();
            } else {
                logoutError.textContent = 'Invalid logout code.';
            }
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }

        function showProfileModal() {
            if (localStorage.getItem('verified') !== 'true') {
                showRegistrationModal();
                return;
            }

            const profileContent = document.getElementById('profileContent');
            const userYears = JSON.parse(localStorage.getItem('userYears')) || [];
            
            profileContent.innerHTML = `
                <div style="display: grid; gap: 24px;">
                    <div style="text-align: center;">
                        <div class="user-avatar" style="width: 80px; height: 80px; font-size: 24px; margin: 0 auto 16px; background: var(--gradient);">
                            ${getInitials(localStorage.getItem('userName') || 'User')}
                        </div>
                        <h3 style="color: var(--text-primary); margin-bottom: 8px;">${localStorage.getItem('userName') || 'User'}</h3>
                        <p style="color: var(--text-secondary);">Registered for Year ${userYears.join(', ')}</p>
                    </div>

                    <div class="glass-effect" style="padding: 20px; border-radius: 16px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 16px;">Account Information</h4>
                        <div style="display: grid; gap: 12px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Phone:</span>
                                <span style="color: var(--text-primary); font-weight: 500;">${localStorage.getItem('userPhone') || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Telegram:</span>
                                <span style="color: var(--text-primary); font-weight: 500;">${localStorage.getItem('userTelegram') || 'N/A'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Years:</span>
                                <span style="color: var(--text-primary); font-weight: 500;">${userYears.join(', ')} <i class="fas fa-plus add-year-btn" id="addYearBtn" style="margin-left: 8px; cursor: pointer;"></i></span>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: space-between;">
                        <button class="quiz-btn" onclick="closeProfileModal()" style="background: var(--secondary); color: white; padding: 12px 24px; border-radius: 12px; flex: 1;">
                            Close
                        </button>
                        <button class="quiz-btn" onclick="handleLogout()" style="background: linear-gradient(135deg, var(--error), #dc2626); color: white; padding: 12px 24px; border-radius: 12px; flex: 1;">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </button>
                    </div>
                </div>
            `;

            // Re-attach event listener for add year button
            document.getElementById('addYearBtn').addEventListener('click', showConfirmAddModal);
            
            profileModal.classList.add('active');
        }

        function closeProfileModal() {
            profileModal.classList.remove('active');
        }
function createFAB() {
    const fab = document.createElement('button');
    fab.className = 'fab';
    fab.innerHTML = '<i class="fas fa-plus"></i>';
    fab.title = 'Create Custom Question';
    fab.addEventListener('click', showCustomQuestionCreator);
    document.body.appendChild(fab);
}

function initializeNavigation() {
    navItems.forEach((item, index) => {
        item.addEventListener('click', () => {
            navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
            
            switch(index) {
                case 0: // Dashboard
                    currentPage = 'dashboard';
                    showDashboard();
                    break;
                case 1: // My Courses
                    currentPage = 'courses';
                    showCourses();
                    break;
                case 2: // Progress Analytics
                    currentPage = 'analytics';
                    showAnalytics();
                    break;
                case 3: // Bookmarked Questions
                    currentPage = 'bookmarks';
                    showBookmarks();
                    break;
                case 4: // Settings
                    currentPage = 'settings';
                    showSettings();
                    break;
            }
            
            closeSidebar();
        });
    });
}

function showDashboard() {
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.search-container').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    
    // Reset page title
    pageTitle.textContent = 'Medical Quiz Dashboard';
    updateDashboardStats();
    
    // Only show all questions if not in search mode
    if (!isSearchActive) {
        questions = [...quizData, ...customQuestions];
        selectedCategories = [...new Set(questions.map(q => q.category))];
        renderQuizLayout();
    } else {
        // If we're in search mode, show the search results
        performSearch(searchInput.value.trim().toLowerCase());
    }
}

function showCourses() {
    hideAllSections();
    pageTitle.textContent = 'My Courses';
    
    quizContainer.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 80px; color: var(--primary); margin-bottom: 20px; opacity: 0.8;">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary); background: linear-gradient(135deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">Learning Pathways</h2>
            <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                Structured learning paths designed to build your medical knowledge systematically.
            </p>
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; margin-top: 40px;">
                    <div onclick="window.location.href='anatomy.html'" style="cursor: pointer;">
                       ${createCourseCard('Anatomy Mastery', 'fas fa-brain', '#6366f1', 75, 'Build foundational anatomy knowledge')}
                    </div>
  <div onclick="window.location.href='alifo/yr1/ps.html'" style="cursor: pointer;">
                       ${createCourseCard('Physiology Deep Dive', 'fas fa-heartbeat', '#06b6d4', 45, 'Understand body systems and functions')}
                   </div>
  <div onclick="window.location.href='yr1/pt.html'" style="cursor: pointer;">
                       ${createCourseCard(' Pathology', 'fas fa-virus', '#10b981', 30, 'Study diseases and diagnostics')}
                    </div> 
  <div onclick="window.location.href='yr1/pc.html'" style="cursor: pointer;">
                       ${createCourseCard('Pharmacology', 'fas fa-pills', '#f59e0b', 20, 'Master drug mechanisms and effects')}
                    </div>
    <div onclick="window.location.href='yr1/micro.html'" style="cursor: pointer;">
                       ${createCourseCard('microbilogy', 'fas fa-x-ray', '#8b5cf6', 15, 'Learn radiology and imaging techniques')}
                    </div>
    <div onclick="window.location.href='yr1/bc.html'" style="cursor: pointer;">
                       ${createCourseCard('biochemstry', 'fas fa-ambulance', '#ef4444', 10, 'Critical care and emergency procedures')}
                    </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createCourseCard(title, icon, color, progress, description) {
    return `
        <div class="category-card" style="text-align: left; cursor: pointer; border-left: 4px solid ${color};" onclick="startCourse('${title.toLowerCase()}')">
            <div class="category-header">
                <div class="category-icon" style="background: ${color}20; color: ${color};">
                    <i class="${icon}"></i>
                </div>
                <div>
                    <div class="category-name" style="font-size: 16px; font-weight: 600;">${title}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${description}</div>
                </div>
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${color}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 12px;">
                <span style="font-size: 11px; color: var(--text-tertiary);">${Math.floor(progress/10)}/10 Modules</span>
                <span style="font-size: 11px; color: ${color}; font-weight: 600;">Continue →</span>
            </div>
        </div>
    `;
}

function showAnalytics() {
    hideAllSections();
    document.querySelector('.stats-grid').style.display = 'grid';
    document.querySelector('.analytics-section').style.display = 'block';
    document.querySelector('.export-section').style.display = 'block';
    pageTitle.textContent = 'Progress Analytics';
    updateAnalytics();
    
    quizContainer.innerHTML = `
        <div style="padding: 24px;">
            <div class="analytics-section glass-effect" style="border-radius: 24px; padding: 32px;">
                <h3 class="analytics-title" style="font-size: 24px; margin-bottom: 8px;">Performance Insights</h3>
                <p style="color: var(--text-secondary); margin-bottom: 32px;">Detailed analytics to optimize your learning journey</p>
                <div class="analytics-grid">
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: var(--primary);">${weakAreasCountEl.textContent}</div>
                        <div class="analytics-label">Areas Needing Focus</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #06b6d4;">${avgTimePerQuestionEl.textContent}</div>
                        <div class="analytics-label">Average Response Time</div>
                    </div>
                    <div class="analytics-card glass-effect" style="border-radius: 20px; padding: 24px;">
                        <div class="analytics-value" style="font-size: 32px; color: #10b981;">${improvementRateEl.textContent}</div>
                        <div class="analytics-label">Weekly Progress Rate</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">📊 Learning Recommendations</h3>
                <div style="display: grid; gap: 16px;">
                    ${createRecommendation('Focus on Weak Areas', 'fas fa-bullseye', 'var(--primary)', 'Spend 60% of study time on topics below 70% mastery')}
                    ${createRecommendation('Consistent Practice', 'fas fa-chart-line', '#10b981', `Maintain your ${userStats.streak}-day streak for optimal retention`)}
                    ${createRecommendation('Active Recall', 'fas fa-brain', '#8b5cf6', 'Use spaced repetition for better long-term memory')}
                    ${createRecommendation('Mixed Practice', 'fas fa-random', '#f59e0b', 'Combine different topics in single study sessions')}
                </div>
            </div>

            <div class="glass-effect" style="border-radius: 24px; padding: 32px; margin-top: 24px; border: 1px solid rgba(255, 255, 255, 0.2);">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 24px; color: var(--text-primary);">🎯 Study Plan</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    ${createStudyPlanItem('Daily Goal', '50 questions', 'fas fa-calendar-day', '#6366f1')}
                    ${createStudyPlanItem('Weekly Target', '5 hours', 'fas fa-chart-bar', '#06b6d4')}
                    ${createStudyPlanItem('Mastery Goal', '85% overall', 'fas fa-trophy', '#f59e0b')}
                    ${createStudyPlanItem('Weak Topics', '2 sessions/week', 'fas fa-exclamation-triangle', '#ef4444')}
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function createRecommendation(title, icon, color, description) {
    return `
        <div style="display: flex; align-items: center; gap: 16px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px; border-left: 4px solid ${color};">
            <i class="${icon}" style="color: ${color}; font-size: 24px;"></i>
            <div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${title}</div>
                <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.5;">${description}</div>
            </div>
        </div>
    `;
}

function createStudyPlanItem(title, value, icon, color) {
    return `
        <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px;">
            <i class="${icon}" style="color: ${color}; font-size: 32px; margin-bottom: 12px;"></i>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${title}</div>
            <div style="font-size: 18px; color: ${color}; font-weight: 700;">${value}</div>
        </div>
    `;
}

function showBookmarks() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    hideAllSections();
    pageTitle.textContent = 'Bookmarked Questions';
    
    if (bookmarkedQuestionsList.length === 0) {
        quizContainer.innerHTML = `
            <div style="text-align: center; padding: 80px 20px;">
                <div style="font-size: 96px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                    <i class="far fa-bookmark"></i>
                </div>
                <h2 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary);">No Bookmarked Questions Yet</h2>
                <p style="color: var(--text-secondary); margin-bottom: 40px; max-width: 400px; margin-left: auto; margin-right: auto; font-size: 16px; line-height: 1.6;">
                    Click the bookmark icon on any question to save it here for quick review. This is perfect for difficult concepts or important topics you want to revisit.
                </p>
                <button class="quiz-btn" onclick="showDashboard(); navItems[0].click()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 32px; border-radius: 16px;">
                    <i class="fas fa-arrow-left"></i>
                    Explore Questions
                </button>
            </div>
        `;
    } else {
        quizContainer.innerHTML = `
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                    <div>
                        <h2 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
                            ${bookmarkedQuestionsList.length} Saved Question${bookmarkedQuestionsList.length !== 1 ? 's' : ''}
                        </h2>
                        <p style="color: var(--text-secondary);">Your personal collection of important questions</p>
                    </div>
                    <button class="quiz-btn" onclick="startBookmarksQuiz()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px;">
                        <i class="fas fa-play"></i>
                        Practice Bookmarks
                    </button>
                </div>
                <div style="display: grid; gap: 20px;">
                    ${bookmarkedQuestionsList.map(question => `
                        <div class="question-card glass-effect" style="cursor: pointer; border-radius: 20px; padding: 24px;" onclick="jumpToBookmarkQuestion(${question.id})">
                            <div class="question-header">
                                <div class="question-meta">
                                    <div class="question-number" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));">Q${question.id}</div>
                                    <div class="question-category glass-effect">${question.category}</div>
                                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                                        ${question.difficulty}
                                    </div>
                                    ${question.custom ? '<div class="question-category glass-effect" style="background: #10b98120; color: #10b981;">Custom</div>' : ''}
                                </div>
                                <div class="question-actions">
                                    <button class="action-btn bookmark-btn" onclick="event.stopPropagation(); toggleBookmark(${question.id}); showBookmarks();" aria-label="Remove Bookmark" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                                        <i class="fas fa-bookmark"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="question-text" style="font-size: 16px; line-height: 1.6;">${question.question}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    quizContainer.classList.remove('hidden');
}

// Add this function to handle clicking on individual bookmark questions
function jumpToBookmarkQuestion(questionId) {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    // Start a quiz with just this one question
    questions = [bookmarkedQuestionsList.find(q => q.id === questionId)];
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Question';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
}

function showSettings() {
    hideAllSections();
    pageTitle.textContent = 'Settings & Preferences';
    
    quizContainer.innerHTML = `
        <div style="padding: 24px; max-width: 800px; margin: 0 auto;">
            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">🎨 Appearance</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Customize the look and feel of your study environment</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Theme</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? '' : 'active'}" onclick="setTheme('light')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-sun"></i>
                                Light Mode
                            </button>
                            <button class="mode-btn ${document.body.classList.contains('dark-mode') ? 'active' : ''}" onclick="setTheme('dark')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-moon"></i>
                                Dark Mode
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Animation</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn active" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-bolt"></i>
                                Smooth
                            </button>
                            <button class="mode-btn" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-minus"></i>
                                Minimal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">⚡ Study Preferences</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Optimize your learning experience</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Default Mode</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button class="mode-btn ${currentMode === 'quiz' ? 'active' : ''}" onclick="setDefaultMode('quiz')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-tasks"></i>
                                Quiz
                            </button>
                            <button class="mode-btn ${currentMode === 'exam' ? 'active' : ''}" onclick="setDefaultMode('exam')" style="border-radius: 12px; padding: 12px 16px;">
                                <i class="fas fa-file-alt"></i>
                                Exam
                            </button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Questions Per Session</label>
                        <select class="modern-dropdown" style="width: 100%;" onchange="setQuestionsPerSession(this.value)">
                            <option value="10">10 Questions</option>
                            <option value="25" selected>25 Questions</option>
                            <option value="50">50 Questions</option>
                            <option value="100">100 Questions</option>
                            <option value="0">All Questions</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">📊 Data & Progress</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Manage your learning data</p>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <button class="quiz-btn" onclick="exportProgress()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-download" style="margin-right: 12px;"></i>
                        Export Progress Data
                    </button>
                    <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-plus" style="margin-right: 12px;"></i>
                        Create Custom Question
                    </button>
                    <button class="quiz-btn" onclick="resetProgress()" style="background: linear-gradient(135deg, var(--error), #dc2626); color: white; padding: 16px 24px; border-radius: 16px; justify-content: start;">
                        <i class="fas fa-trash" style="margin-right: 12px;"></i>
                        Reset All Progress
                    </button>
                </div>
            </div>

            <div class="settings-panel" style="padding: 32px;">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">ℹ️ About MediQuiz Pro</h3>
                <div style="color: var(--text-secondary); line-height: 1.7;">
                    <p>MediQuiz Pro is an advanced medical education platform designed to help medical students and professionals enhance their knowledge through interactive quizzes and detailed analytics.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
                        <div>
                            <strong style="color: var(--text-primary);">Version</strong>
                            <div>2.1.0</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Questions</strong>
                            <div>${quizData.length + customQuestions.length} total</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">Last Updated</strong>
                            <div>${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
}

function setTheme(theme) {
    if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-sun';
    } else {
        document.body.classList.remove('dark-mode');
        themeToggle.querySelector('i').className = 'fas fa-moon';
    }
    showNotification(`Theme set to ${theme} mode`, 'success');
}

function setDefaultMode(mode) {
    currentMode = mode;
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[mode === 'quiz' ? 1 : 0].classList.add('active');
    showNotification(`Default mode set to ${mode}`, 'success');
}

function setQuestionsPerSession(count) {
    showNotification(`Questions per session set to ${count === '0' ? 'all' : count}`, 'info');
}

function showCustomQuestionCreator() {
    const modal = document.createElement('div');
    modal.className = 'custom-quiz-modal active';
    modal.innerHTML = `
        <div class="custom-quiz-content glass-effect" style="max-width: 600px; border-radius: 24px;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">Create Custom Question</h3>
                <button class="action-btn" onclick="closeCustomQuestionModal()" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="custom-question-creator">
                <div style="display: grid; gap: 20px;">
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Question Text</label>
                        <textarea id="customQuestionText" placeholder="Enter your question here..." style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 80px;"></textarea>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Category</label>
                        <select id="customQuestionCategory" class="modern-dropdown" style="width: 100%;">
                            <option value="Custom Anatomy">Custom Anatomy</option>
                            <option value="Custom Physiology">Custom Physiology</option>
                            <option value="Custom Pathology">Custom Pathology</option>
                            <option value="Custom Pharmacology">Custom Pharmacology</option>
                            <option value="General Medicine">General Medicine</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Difficulty</label>
                        <div class="mode-selector glass-effect" style="padding: 8px; border-radius: 16px;">
                            <button type="button" class="mode-btn difficulty-btn active" data-difficulty="Easy" style="border-radius: 12px; padding: 12px 16px;">
                                Easy
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Medium" style="border-radius: 12px; padding: 12px 16px;">
                                Medium
                            </button>
                            <button type="button" class="mode-btn difficulty-btn" data-difficulty="Hard" style="border-radius: 12px; padding: 12px 16px;">
                                Hard
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">Options</label>
                        <div style="display: grid; gap: 12px;">
                            ${['A', 'B', 'C', 'D'].map(letter => `
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--surface); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--text-secondary); flex-shrink: 0;">${letter}</div>
                                    <input type="text" id="customOption${letter}" placeholder="Option ${letter}" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; background: var(--surface); color: var(--text-primary);">
                                    <input type="radio" name="correctAnswer" value="${letter}" id="correct${letter}" style="transform: scale(1.2);">
                                    <label for="correct${letter}" style="color: var(--text-secondary); font-weight: 600;">Correct</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Explanation</label>
                        <textarea id="customExplanation" placeholder="Explain why the correct answer is right..." style="width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: var(--surface); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 60px;"></textarea>
                    </div>
                </div>
                
                <div class="custom-quiz-actions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;">
                    <button class="quiz-btn" onclick="closeCustomQuestionModal()" style="background: var(--secondary); color: white; padding: 12px 24px; border-radius: 12px;">
                        Cancel
                    </button>
                    <button class="quiz-btn check-btn" onclick="saveCustomQuestion()" style="padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-save"></i>
                        Save Question
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add difficulty button handlers
    modal.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            modal.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

function closeCustomQuestionModal() {
    const modal = document.querySelector('.custom-quiz-modal');
    if (modal) {
        modal.remove();
    }
}

function saveCustomQuestion() {
    const questionText = document.getElementById('customQuestionText').value;
    const category = document.getElementById('customQuestionCategory').value;
    const difficulty = document.querySelector('.difficulty-btn.active').dataset.difficulty;
    const explanation = document.getElementById('customExplanation').value;
    
    // Get options
    const options = [];
    for (let letter of ['A', 'B', 'C', 'D']) {
        const optionText = document.getElementById(`customOption${letter}`).value;
        if (optionText.trim()) {
            options.push(optionText);
        }
    }
    
    // Get correct answer
    const correctAnswerRadio = document.querySelector('input[name="correctAnswer"]:checked');
    if (!correctAnswerRadio) {
        showNotification('Please select the correct answer', 'error');
        return;
    }
    
    const correctAnswerIndex = ['A', 'B', 'C', 'D'].indexOf(correctAnswerRadio.value);
    
    if (!questionText.trim() || options.length < 2) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    // Generate a unique ID for the custom question
    const maxId = Math.max(
        ...quizData.map(q => q.id),
        ...customQuestions.map(q => q.id),
        0
    );
    
    const newQuestion = {
        id: maxId + 1,
        question: questionText,
        options: options,
        answer: correctAnswerIndex,
        correctAnswer: options[correctAnswerIndex],
        explanation: explanation || 'No explanation provided.',
        whyNotOtherOptions: {},
        relatedQuestions: [],
        category: category,
        difficulty: difficulty,
        custom: true
    };
    
    customQuestions.push(newQuestion);
    saveUserData();
    
    closeCustomQuestionModal();
    showNotification('Custom question created successfully!', 'success');
    
    // Refresh the current view and categories
    initializeCategories();
    if (currentPage === 'dashboard') {
        showDashboard();
    } else if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}

function hideAllSections() {
    quizContainer.classList.add('hidden');
    resultsScreen.classList.add('hidden');
    document.querySelector('.stats-grid').style.display = 'none';
    document.querySelector('.analytics-section').style.display = 'none';
    document.querySelector('.export-section').style.display = 'none';
    // Note: search-container is NOT hidden here - we want it always visible during search
}

function startCourse(courseName) {
    showNotification(`Starting ${courseName} course...`, 'info');
    // Filter questions by course/category and start quiz
    const courseQuestions = [...quizData, ...customQuestions].filter(q => 
        q.category.toLowerCase().includes(courseName.toLowerCase())
    );
    
    if (courseQuestions.length === 0) {
        showNotification('No questions available for this course yet', 'info');
        return;
    }
    
    questions = courseQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active');
    pageTitle.textContent = `Quiz Mode - ${courseName}`;
    
    hideAllSections();
    renderQuizLayout();
}

// FIXED BOOKMARK PRACTICE FUNCTION
function startBookmarksQuiz() {
    const bookmarkedQuestionsList = [...quizData, ...customQuestions].filter(q => bookmarkedQuestions.has(q.id));
    
    if (bookmarkedQuestionsList.length === 0) {
        showNotification('No bookmarked questions to practice!', 'error');
        return;
    }
    
    questions = bookmarkedQuestionsList;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    currentMode = 'quiz';
    
    // Update mode buttons
    modeButtons.forEach(b => b.classList.remove('active'));
    modeButtons[1].classList.add('active'); // Quiz mode
    
    pageTitle.textContent = 'Quiz Mode - Bookmarked Questions';
    
    hideAllSections();
    quizContainer.classList.remove('hidden');
    renderQuizLayout();
    
    showNotification(`Starting practice with ${questions.length} bookmarked questions`, 'success');
}

function resetProgress() {
    if (confirm('Are you sure you want to reset all your progress? This action cannot be undone.')) {
        userProgress = {};
        userStats = {
            totalQuestions: 0,
            correctAnswers: 0,
            timeSpent: 0,
            masteryLevel: 0,
            streak: 0,
            lastActive: new Date().toISOString(),
            weeklyProgress: []
        };
        bookmarkedQuestions = new Set();
        customQuestions = [];
        saveUserData();
        updateDashboardStats();
        updateAnalytics();
        showNotification('All progress has been reset', 'success');
        showDashboard();
    }
}

function initializeEventListeners() {
    menuToggle.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', closeSidebar);
    themeToggle.addEventListener('click', toggleTheme);
    
    modeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.mode;
            pageTitle.textContent = `${btn.dataset.mode.charAt(0).toUpperCase() + btn.dataset.mode.slice(1)} Mode`;
            startQuiz();
        });
    });
    
    initializeEnhancedFeatures();
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
    mainContent.classList.toggle('sidebar-open');
    document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
    mainContent.classList.remove('sidebar-open');
    document.body.style.overflow = '';
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const icon = themeToggle.querySelector('i');
    if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun';
    } else {
        icon.className = 'fas fa-moon';
    }
}

function initializeEnhancedFeatures() {
    initializeSearch();
    initializeKeyboardNavigation();
    enhanceAccessibility();
    
    exportProgressBtn.addEventListener('click', exportProgress);
    createCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.add('active');
    });
    cancelCustomQuizBtn.addEventListener('click', () => {
        customQuizModal.classList.remove('active');
    });
    createCustomQuizBtnModal.addEventListener('click', () => {
        const selectedOptions = document.querySelectorAll('.custom-quiz-option.selected');
        const options = {
            categories: selectedCategories,
            difficulty: null,
            bookmarkedOnly: false
        };
        
        selectedOptions.forEach(option => {
            const category = option.dataset.category;
            if (category === 'easy' || category === 'medium' || category === 'hard') {
                options.difficulty = category;
            } else if (category === 'bookmarked') {
                options.bookmarkedOnly = true;
            }
        });
        
        createCustomQuiz(options);
    });
    
    // Add selection toggling for custom quiz options
    document.addEventListener('click', (e) => {
        if (e.target.closest('.custom-quiz-option')) {
            const option = e.target.closest('.custom-quiz-option');
            option.classList.toggle('selected');
        }
    });
    
    // Ensure search works when clicking dashboard
    navItems[0].addEventListener('click', () => {
        if (searchInput.value.trim().length > 0) {
            // If there's a search query, maintain search state
            isSearchActive = true;
        }
    });
}

// FIXED SEARCH FUNCTIONALITY
function initializeSearch() {
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            
            // Clear previous search state when input is empty
            if (query.length === 0) {
                document.body.classList.remove('search-blur-active');
                isSearchActive = false;
                if (currentPage === 'dashboard') {
                    showDashboard();
                }
                return;
            }
            
            // Add blur effect when searching
            document.body.classList.add('search-blur-active');
            
            if (query.length < 2) {
                isSearchActive = false;
                return;
            }
            
            isSearchActive = true;
            performSearch(query);
        });
        
        // Add clear search functionality
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                clearSearch();
            }
        });
    }
}

function performSearch(query) {
    const allQuestions = [...quizData, ...customQuestions];
    searchResults = allQuestions.filter(q => 
        q.question.toLowerCase().includes(query) ||
        q.category.toLowerCase().includes(query) ||
        (q.explanation && q.explanation.toLowerCase().includes(query)) ||
        q.options.some(opt => opt.toLowerCase().includes(query))
    );
    
    console.log('Search query:', query, 'Results:', searchResults.length); // Debug log
    
    if (searchResults.length > 0) {
        // Show search results in quiz layout
        questions = searchResults;
        currentQuestionIndex = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        
        hideAllSections();
        quizContainer.classList.remove('hidden');
        renderQuizLayout();
        
        // Update page title to show search context
        pageTitle.textContent = `Search: "${query}" (${searchResults.length} results)`;
        
        // Highlight search terms
        setTimeout(() => {
            highlightSearchTerms(query);
        }, 100);
    } else {
        // Show no results message
        showSearchNoResults(query);
    }
}

function showSearchNoResults(query) {
    hideAllSections();
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-search"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Results Found</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                No questions match your search for "<strong style="color: var(--primary);">${query}</strong>". Try different keywords or browse categories.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-times"></i>
                    Clear Search
                </button>
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Browse Categories
                </button>
            </div>
        </div>
    `;
    quizContainer.classList.remove('hidden');
    pageTitle.textContent = `Search: "${query}" (0 results)`;
}

function clearSearch() {
    searchInput.value = '';
    document.body.classList.remove('search-blur-active');
    isSearchActive = false;
    showDashboard();
}

function highlightSearchTerms(query) {
    const questionTexts = document.querySelectorAll('.question-text');
    const optionTexts = document.querySelectorAll('.option-text');
    const categoryElements = document.querySelectorAll('.question-category');
    
    const highlightText = (element) => {
        const originalText = element.textContent;
        const regex = new RegExp(`(${query})`, 'gi');
        const highlighted = originalText.replace(regex, '<mark class="search-highlight">$1</mark>');
        element.innerHTML = highlighted;
    };
    
    questionTexts.forEach(highlightText);
    optionTexts.forEach(highlightText);
    categoryElements.forEach(highlightText);
}

function initializeKeyboardNavigation() {
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key) {
            case 'ArrowDown':
            case 'ArrowUp':
                e.preventDefault();
                navigateOptions(e.key === 'ArrowDown' ? 1 : -1);
                break;
            case ' ':
            case 'Enter':
                e.preventDefault();
                if (document.activeElement.classList.contains('option')) {
                    document.activeElement.click();
                }
                break;
            case '1':
            case '2':
            case '3':
            case '4':
            case '5':
                e.preventDefault();
                const index = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option:not(.disabled)');
                if (options[index]) {
                    options[index].click();
                }
                break;
            case 'Escape':
                if (document.querySelector('.custom-quiz-modal')) {
                    document.querySelector('.custom-quiz-modal').remove();
                }
                break;
        }
    });
}

function navigateOptions(direction) {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const currentIndex = Array.from(options).findIndex(opt => opt === document.activeElement);
    let nextIndex = currentIndex + direction;
    
    if (nextIndex < 0) nextIndex = options.length - 1;
    if (nextIndex >= options.length) nextIndex = 0;
    
    options[nextIndex].focus();
}

function enhanceAccessibility() {
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('option')) {
            const options = e.target.parentElement.querySelectorAll('.option');
            options.forEach((opt, index) => {
                opt.setAttribute('aria-checked', opt.classList.contains('selected') ? 'true' : 'false');
                opt.setAttribute('role', 'radio');
                opt.setAttribute('tabindex', '0');
            });
        }
    });
}

function loadUserData() {
    const savedProgress = localStorage.getItem('mediQuizProgress');
    const savedStats = localStorage.getItem('mediQuizStats');
    const savedBookmarks = localStorage.getItem('mediQuizBookmarks');
    const savedCustomQuestions = localStorage.getItem('mediQuizCustomQuestions');
    
    if (savedProgress) {
        userProgress = JSON.parse(savedProgress);
    }
    if (savedStats) {
        userStats = JSON.parse(savedStats);
        const today = new Date().toDateString();
        const lastActive = new Date(userStats.lastActive).toDateString();
        if (lastActive !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastActive === yesterday.toDateString()) {
                userStats.streak++;
            } else {
                userStats.streak = 1;
            }
        }
    }
    if (savedBookmarks) {
        bookmarkedQuestions = new Set(JSON.parse(savedBookmarks));
    }
    if (savedCustomQuestions) {
        customQuestions = JSON.parse(savedCustomQuestions);
    }
    
    userStats.lastActive = new Date().toISOString();
    saveUserData();
}

function saveUserData() {
    localStorage.setItem('mediQuizProgress', JSON.stringify(userProgress));
    localStorage.setItem('mediQuizStats', JSON.stringify(userStats));
    localStorage.setItem('mediQuizBookmarks', JSON.stringify(Array.from(bookmarkedQuestions)));
    localStorage.setItem('mediQuizCustomQuestions', JSON.stringify(customQuestions));
}

function updateDashboardStats() {
    correctAnswersEl.textContent = userStats.correctAnswers;
    timeSpentEl.textContent = `${Math.floor(userStats.timeSpent / 60)}h ${userStats.timeSpent % 60}m`;
    masteryLevelEl.textContent = `${userStats.masteryLevel}%`;
    streakCountEl.textContent = userStats.streak;
}

function updateAnalytics() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => allQuestions.find(q => q.id == id)?.category)
        .reduce((acc, category) => {
            acc[category] = (acc[category] || 0) + 1;
            return acc;
        }, {});
        
    weakAreasCountEl.textContent = Object.keys(weakAreas).length;
    
    const totalTime = userStats.timeSpent * 60;
    const avgTime = userStats.totalQuestions > 0 ? Math.round(totalTime / userStats.totalQuestions) : 0;
    avgTimePerQuestionEl.textContent = `${avgTime}s`;
    
    if (userStats.weeklyProgress.length > 1) {
        const latest = userStats.weeklyProgress[userStats.weeklyProgress.length - 1];
        const previous = userStats.weeklyProgress[userStats.weeklyProgress.length - 2];
        const improvement = ((latest - previous) / previous) * 100;
        improvementRateEl.textContent = `${Math.round(improvement)}%`;
    } else {
        improvementRateEl.textContent = "0%";
    }
}

function exportProgress() {
    const data = {
        progress: userProgress,
        stats: userStats,
        bookmarks: Array.from(bookmarkedQuestions),
        customQuestions: customQuestions,
        exportDate: new Date().toISOString(),
        analytics: generateStudyReport()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mediquiz-progress-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('Progress data exported successfully!', 'success');
}

function createCustomQuiz(options) {
    let filteredQuestions = [...quizData, ...customQuestions];
    
    if (options.categories && options.categories.length > 0) {
        filteredQuestions = filteredQuestions.filter(q => options.categories.includes(q.category));
    }
    
    if (options.difficulty) {
        filteredQuestions = filteredQuestions.filter(q => q.difficulty.toLowerCase() === options.difficulty);
    }
    
    if (options.bookmarkedOnly) {
        filteredQuestions = filteredQuestions.filter(q => bookmarkedQuestions.has(q.id));
    }
    
    if (options.count && options.count > 0) {
        filteredQuestions = shuffleArray(filteredQuestions).slice(0, options.count);
    }
    
    questions = filteredQuestions;
    currentQuestionIndex = 0;
    userAnswers = new Array(questions.length);
    isAnswerChecked = false;
    examSubmitted = false;
    
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    hideAllSections();
    renderQuizLayout();
    customQuizModal.classList.remove('active');
    showNotification(`Custom quiz created with ${questions.length} questions`, 'success');
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function generateStudyReport() {
    const allQuestions = [...quizData, ...customQuestions];
    const weakAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) < 0.6)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    const strongAreas = Object.entries(userProgress)
        .filter(([_, data]) => data.attempts > 0 && (data.correct / data.attempts) >= 0.8)
        .map(([id, _]) => {
            const question = allQuestions.find(q => q.id == id);
            return {
                questionId: id,
                category: question?.category,
                difficulty: question?.difficulty,
                performance: userProgress[id].correct / userProgress[id].attempts
            };
        });
        
    return {
        weakAreas,
        strongAreas,
        totalMastered: Object.values(userProgress).filter(p => p.correct >= 3).length,
        totalQuestions: allQuestions.length,
        masteryPercentage: calculateMasteryLevel(),
        generatedAt: new Date().toISOString()
    };
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        padding: 20px 28px;
        background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--primary)'};
        color: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        font-weight: 600;
        max-width: 400px;
        line-height: 1.5;
    `;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}" style="font-size: 20px;"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 400);
    }, 4000);
}

function initializeCategories() {
    const allQuestions = [...quizData, ...customQuestions];
    const categories = [...new Set(allQuestions.map(q => q.category))];
    const categoryIcons = {
        "Anatomy Fundamentals": "fas fa-brain",
        "Neuroanatomy": "fas fa-brain",
        "Gastrointestinal System": "fas fa-stomach",
        "Cardiovascular System": "fas fa-heart",
        "Custom Anatomy": "fas fa-user-md",
        "Custom Physiology": "fas fa-heartbeat",
        "Custom Pathology": "fas fa-virus",
        "Custom Pharmacology": "fas fa-pills",
        "General Medicine": "fas fa-stethoscope"
    };
    
    const categoryColors = {
        "Anatomy Fundamentals": "#6366f1",
        "Neuroanatomy": "#06b6d4",
        "Gastrointestinal System": "#10b981",
        "Cardiovascular System": "#ef4444",
        "Custom Anatomy": "#8b5cf6",
        "Custom Physiology": "#f59e0b",
        "Custom Pathology": "#ec4899",
        "Custom Pharmacology": "#84cc16",
        "General Medicine": "#64748b"
    };

    categoriesGrid.innerHTML = '';
    categories.forEach(category => {
        const categoryQuestions = allQuestions.filter(q => q.category === category);
        const mastered = categoryQuestions.filter(q =>
            userProgress[q.id] && userProgress[q.id].correct >= 3
        ).length;
        const progress = categoryQuestions.length > 0 ?
            Math.round((mastered / categoryQuestions.length) * 100) : 0;
            
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card active glass-effect';
        categoryCard.dataset.category = category;
        categoryCard.style.borderLeft = `4px solid ${categoryColors[category] || '#6366f1'}`;
        categoryCard.innerHTML = `
            <div class="category-header">
                <div class="category-icon" style="background: ${categoryColors[category] || '#6366f1'}20; color: ${categoryColors[category] || '#6366f1'}">
                    <i class="${categoryIcons[category] || 'fas fa-question'}"></i>
                </div>
                <div class="category-name">${category}</div>
                ${category.includes('Custom') ? '<div style="font-size: 10px; color: var(--primary); background: var(--primary-light); padding: 2px 6px; border-radius: 8px;">Custom</div>' : ''}
            </div>
            <div class="category-stats">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%; background: ${categoryColors[category] || '#6366f1'}"></div>
                </div>
                <div class="progress-text">${progress}%</div>
            </div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                ${categoryQuestions.length} question${categoryQuestions.length !== 1 ? 's' : ''}
                ${categoryQuestions.filter(q => q.custom).length > 0 ? ` · ${categoryQuestions.filter(q => q.custom).length} custom` : ''}
            </div>
        `;
        
        if (categoryQuestions.length > 1) {
            const dropdown = document.createElement('div');
            dropdown.className = 'modern-dropdown';
            dropdown.innerHTML = `
                <select onchange="jumpToQuestion(this.value)">
                    <option value="">Jump to Question...</option>
                    ${categoryQuestions.sort((a, b) => a.id - b.id).map(q => 
                        `<option value="question-${q.id}">Q${q.id}: ${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}${q.custom ? ' ★' : ''}</option>`
                    ).join('')}
                </select>
            `;
            categoryCard.appendChild(dropdown);
        }
        
        categoryCard.addEventListener('click', (e) => {
            if (!e.target.closest('.modern-dropdown') && !e.target.closest('select')) {
                toggleCategory(categoryCard);
                const firstQ = categoryQuestions.sort((a, b) => a.id - b.id)[0];
                if (firstQ) {
                    jumpToQuestion(`question-${firstQ.id}`);
                }
            }
        });
        
        categoriesGrid.appendChild(categoryCard);
    });
    
    selectedCategories = [...categories];
}

function toggleCategory(categoryCard) {
    const category = categoryCard.dataset.category;
    if (categoryCard.classList.contains('active')) {
        categoryCard.classList.remove('active');
        selectedCategories = selectedCategories.filter(c => c !== category);
    } else {
        categoryCard.classList.add('active');
        selectedCategories.push(category);
    }
    startQuiz();
    closeSidebar();
}

function startQuiz() {
    if (currentPage !== 'dashboard') return;
    
    quizContainer.style.opacity = '0';
    setTimeout(() => {
        const allQuestions = [...quizData, ...customQuestions];
        questions = selectedCategories.length > 0 ? 
            allQuestions.filter(q => selectedCategories.includes(q.category)) : 
            allQuestions;
            
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        if (currentMode === 'learn' && incorrectQuestions.length > 0) {
            questions = allQuestions.filter(q => incorrectQuestions.includes(q.id));
        }
        if (questions.length === 0) {
            showNoQuestionsMessage();
            return;
        }
        questions.sort((a, b) => a.id - b.id);
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = new Array(questions.length);
        isAnswerChecked = false;
        examSubmitted = false;
        quizContainer.classList.remove('hidden');
        resultsScreen.classList.add('hidden');
        questionTimers = new Array(questions.length).fill(0);
        if (currentMode === 'exam') {
            isCountdown = true;
            remainingTime = 120 * questions.length;
        } else {
            isCountdown = false;
        }
        startTimer();
        renderQuizLayout();
        quizContainer.style.opacity = '1';
    }, 300);
}

function showNoQuestionsMessage() {
    let message = '';
    if (isSearchActive) {
        message = 'No questions match your search criteria. Try different keywords.';
    } else if (selectedCategories.length === 0) {
        message = 'No categories selected. Please select categories from the sidebar.';
    } else {
        message = 'No questions available for the selected categories.';
    }
    
    quizContainer.innerHTML = `
        <div class="no-questions" style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; color: var(--text-tertiary); margin-bottom: 24px; opacity: 0.5;">
                <i class="fas fa-inbox"></i>
            </div>
            <h2 style="font-size: 28px; margin-bottom: 16px; color: var(--text-primary);">No Questions Available</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                ${message}
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="quiz-btn" onclick="toggleSidebar()" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-folder-open"></i>
                    Select Categories
                </button>
                <button class="quiz-btn" onclick="showCustomQuestionCreator()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border-radius: 12px;">
                    <i class="fas fa-plus"></i>
                    Create Question
                </button>
                ${isSearchActive ? `
                    <button class="quiz-btn" onclick="clearSearch()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 12px 24px; border-radius: 12px;">
                        <i class="fas fa-times"></i>
                        Clear Search
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    resultsScreen.classList.add('hidden');
    stopTimer();
    quizContainer.style.opacity = '1';
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    startTime = new Date();
    timerInterval = setInterval(() => {
        if (isCountdown) {
            remainingTime--;
            if (remainingTime <= 0) {
                remainingTime = 0;
                clearInterval(timerInterval);
                if (currentMode === 'exam' && !examSubmitted) {
                    showNotification('Time up! Submitting exam.', 'error');
                    submitExam();
                }
            }
            updateTimerDisplay(formatTime(remainingTime), 'timerDisplay', true);
        } else {
            questionTimers[currentQuestionIndex]++;
            updateTimerDisplay(formatTime(questionTimers[currentQuestionIndex]), 'timerDisplay', false);
        }
    }, 1000);
}

function formatTime(seconds) {
    const min = Math.floor(seconds / 60).toString().padStart(2, '0');
    const sec = (seconds % 60).toString().padStart(2, '0');
    return `${min}:${sec}`;
}

function updateTimerDisplay(time, id, isCountdown = false) {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = `Time: ${time}`;
        if (isCountdown) {
            el.classList.remove('timer-warning', 'timer-error');
            if (remainingTime <= 30) {
                el.classList.add('timer-error');
            } else if (remainingTime <= 60) {
                el.classList.add('timer-warning');
            }
        }
    }
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        if (startTime) {
            const endTime = new Date();
            const timeSpent = Math.floor((endTime - startTime) / 1000 / 60);
            userStats.timeSpent += timeSpent;
            userStats.lastActive = new Date().toISOString();
            saveUserData();
            updateDashboardStats();
        }
    }
}

function renderQuizLayout() {
    if (questions.length === 0) {
        showNoQuestionsMessage();
        return;
    }
    
    if (currentMode === 'exam') {
        renderExamLayout();
    } else {
        renderSingleQuestionLayout();
    }
}

function renderExamLayout() {
    const isImmediateMode = examCheckMode === 'immediate';
    quizContainer.innerHTML = `
        <div class="exam-header" style="margin-bottom: 24px; padding: 20px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                <div>
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                        Exam Mode: ${questions.length} Questions
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        ${isImmediateMode ?
                          'Immediate Check - See explanations as you answer' :
                          'All-in-One Check - Check all answers at the end'}
                    </p>
                </div>
                <div class="exam-mode-toggle" style="display: flex; gap: 8px; background: var(--glass); padding: 4px; border-radius: var(--radius);">
                    <button class="mode-toggle-btn ${isImmediateMode ? 'active' : ''}" data-mode="immediate" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="Immediate Check Mode">
                        Immediate Check
                    </button>
                    <button class="mode-toggle-btn ${!isImmediateMode ? 'active' : ''}" data-mode="all-at-once" style="padding: 8px 16px; border: none; border-radius: 6px; background: ${!isImmediateMode ? 'var(--primary)' : 'transparent'}; color: ${!isImmediateMode ? 'white' : 'var(--text-secondary)'}; cursor: pointer; font-size: 12px; font-weight: 500;" aria-label="All-at-Once Check Mode">
                        Check All
                    </button>
                </div>
            </div>
            <div class="progress-info" style="display: flex; align-items: center; gap: 16px;">
                <span style="font-size: 14px; color: var(--text-secondary);" id="answeredCount">0/${questions.length} answered</span>
                <div class="progress-bar" style="flex: 1; height: 6px;">
                    <div class="progress-fill" id="examProgressFill" style="width: 0%"></div>
                </div>
                <span id="timerDisplay" style="font-size: 14px; color: var(--text-secondary);">Time: ${formatTime(remainingTime)}</span>
                ${examSubmitted ? `<span style="color: var(--success); font-weight: 600; font-size: 14px;">Submitted!</span>` : ''}
            </div>
        </div>
        <div class="exam-mode-layout">
            ${questions.map((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.answer;
                const showExplanationButton = examSubmitted || (isImmediateMode && userAnswer !== undefined);
                return `
                    <div class="question-card fade-in" data-question-index="${index}" id="question-${question.id}">
                        <div class="question-header">
                            <div class="question-meta">
                                <div class="question-number">Q${question.id}</div>
                                <div class="question-category">${question.category}</div>
                                <div class="question-difficulty" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${getDifficultyColor(question.difficulty)}; color: white;">
                                    ${question.difficulty}
                                </div>
                                ${userAnswer !== undefined ? `
                                    <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                                        ${isCorrect ? 'Correct' : 'Incorrect'}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="question-actions">
                                <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                                    <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                                </button>
                            </div>
                        </div>
                        <div class="question-text">${question.question}</div>
                        <div class="options-grid">
                            ${question.options.map((option, optIndex) => {
                                const isSelected = userAnswer === optIndex;
                                const isCorrectOption = optIndex === question.answer;
                                let optionClass = 'option';
                                if (userAnswer !== undefined) {
                                    if (isCorrectOption) {
                                        optionClass += ' correct';
                                    } else if (isSelected && !isCorrectOption) {
                                        optionClass += ' incorrect';
                                    }
                                    optionClass += ' disabled';
                                } else if (isSelected) {
                                    optionClass += ' selected';
                                }
                                return `
                                    <div class="${optionClass}" data-option-index="${optIndex}" role="button" aria-label="Option ${String.fromCharCode(65 + optIndex)}">
                                        <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                                        <div class="option-text">${option}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${showExplanationButton ? `
                            <div class="explanation-section">
                                <details open>
                                    <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                                    <div class="explanation-content correct-answer">
                                        <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                                    </div>
                                </details>
                                ${userAnswer !== undefined && userAnswer !== question.answer ? `
                                    <details>
                                        <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                                        <div class="explanation-content why-not-section">
                                            <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                            <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                                        </div>
                                    </details>
                                ` : ''}
                                <details>
                                    <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                                    <div class="explanation-content">${question.explanation}</div>
                                </details>
                                <details>
                                    <summary><i class="fas fa-link"></i> Related Questions</summary>
                                    <div class="explanation-content related-questions">
                                        <div class="related-questions-list">
                                            ${question.relatedQuestions.map(q => {
                                                const qId = q.match(/\d+/)[0];
                                                return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                </details>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('')}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    ${examCheckMode === 'all-at-once' && !examSubmitted ? `
                        <button class="quiz-btn check-btn" id="checkAllBtn" ${userAnswers.filter(a => a !== undefined).length === 0 ? 'disabled' : ''} aria-label="Check All Answers">
                            <i class="fas fa-check-double"></i>
                            Check All Answers
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn submit-btn" id="examSubmitBtn" ${examSubmitted ? 'disabled' : ''} aria-label="Submit Exam">
                    <i class="fas fa-paper-plane"></i>
                    ${examSubmitted ? 'Exam Submitted' : `Submit Exam (${questions.length} questions)`}
                </button>
            </div>
        </div>
    `;
    initializeExamModeEvents();
    updateExamSubmitButton();
}

function renderSingleQuestionLayout() {
    if (currentQuestionIndex >= questions.length) {
        showResults();
        return;
    }
    const question = questions[currentQuestionIndex];
    const userAnswer = userAnswers[currentQuestionIndex];
    const isCorrect = userAnswer === question.answer;
    quizContainer.innerHTML = `
        <div class="question-card fade-in" data-question-index="${currentQuestionIndex}">
            <div class="question-header">
                <div class="question-meta">
                    <div class="question-number">Q${question.id}</div>
                    <div class="question-category">${question.category}</div>
                    <div class="question-difficulty" style="background: ${getDifficultyColor(question.difficulty)};">
                        ${question.difficulty}
                    </div>
                    ${userAnswer !== undefined ? `
                        <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isCorrect ? 'var(--success)' : 'var(--error)'}; color: white;">
                            ${isCorrect ? 'Correct' : 'Incorrect'}
                        </div>
                    ` : ''}
                </div>
                <div class="question-actions">
                    <button class="action-btn bookmark-btn" data-question-id="${question.id}" aria-label="Bookmark Question">
                        <i class="${bookmarkedQuestions.has(question.id) ? 'fas' : 'far'} fa-bookmark"></i>
                    </button>
                </div>
            </div>
            <div class="question-text">${question.question}</div>
            <div class="options-grid">
                ${question.options.map((option, index) => {
                    const isSelected = userAnswer === index;
                    const isCorrectOption = index === question.answer;
                    let optionClass = 'option';
                    if (isAnswerChecked) {
                        if (isCorrectOption) {
                            optionClass += ' correct';
                        } else if (isSelected && !isCorrectOption) {
                            optionClass += ' incorrect';
                        }
                        optionClass += ' disabled';
                    } else if (isSelected) {
                        optionClass += ' selected';
                    }
                    return `
                        <div class="${optionClass}" data-option-index="${index}" role="button" aria-label="Option ${String.fromCharCode(65 + index)}">
                            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                            <div class="option-text">${option}</div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${isAnswerChecked ? `
                <div class="explanation-section">
                    <details open>
                        <summary><i class="fas fa-info-circle"></i> Correct Answer</summary>
                        <div class="explanation-content correct-answer">
                            <strong>Answer: ${String.fromCharCode(65 + question.answer)}. ${question.correctAnswer}</strong>
                        </div>
                    </details>
                    ${userAnswer !== undefined && userAnswer !== question.answer ? `
                        <details>
                            <summary><i class="fas fa-exclamation-circle"></i> Why Not Your Answer?</summary>
                            <div class="explanation-content why-not-section">
                                <strong>Why not ${String.fromCharCode(65 + userAnswer)}?</strong>
                                <p>${question.whyNotOtherOptions[String.fromCharCode(97 + userAnswer)]}</p>
                            </div>
                        </details>
                    ` : ''}
                    <details>
                        <summary><i class="fas fa-book"></i> Detailed Explanation</summary>
                        <div class="explanation-content">${question.explanation}</div>
                    </details>
                    <details>
                        <summary><i class="fas fa-link"></i> Related Questions</summary>
                        <div class="explanation-content related-questions">
                            <div class="related-questions-list">
                                ${question.relatedQuestions.map(q => {
                                    const qId = q.match(/\d+/)[0];
                                    return `<span class="related-question-tag" onclick="jumpToQuestion('question-${qId}')" role="button" aria-label="Jump to Question ${qId}">Q${qId}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    </details>
                </div>
            ` : ''}
            <div class="quiz-controls">
                <div style="display: flex; gap: 12px;">
                    <button class="quiz-btn check-btn" id="checkAnswerBtn" ${userAnswer === undefined ? 'disabled' : ''} aria-label="Check Answer">
                        <i class="fas fa-check"></i>
                        Check Answer
                    </button>
                    ${currentMode === 'learn' && incorrectQuestions.length > 0 ? `
                        <button class="quiz-btn" id="incorrectOnlyBtn" aria-label="Show Incorrect Only">
                            <i class="fas fa-filter"></i>
                            Incorrect Only
                        </button>
                    ` : ''}
                </div>
                <button class="quiz-btn next-btn" id="nextQuestionBtn" ${!isAnswerChecked ? 'disabled' : ''} aria-label="Next Question">
                    <i class="fas fa-arrow-right"></i>
                    ${currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish'}
                </button>
            </div>
        </div>
    `;
    initializeQuizEvents();
    updateTimerDisplay(formatTime(isCountdown ? remainingTime : questionTimers[currentQuestionIndex]), 'timerDisplay', isCountdown);
}

function initializeQuizEvents() {
    const checkAnswerBtn = document.getElementById('checkAnswerBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const incorrectOnlyBtn = document.getElementById('incorrectOnlyBtn');
    const bookmarkBtn = document.querySelector('.bookmark-btn');
    const options = document.querySelectorAll('.option:not(.disabled)');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            if (!isAnswerChecked) {
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                userAnswers[currentQuestionIndex] = parseInt(option.dataset.optionIndex);
                if (checkAnswerBtn) checkAnswerBtn.disabled = false;
                updateExamSubmitButton();
            }
        });
    });
    
    if (checkAnswerBtn) {
        checkAnswerBtn.addEventListener('click', () => {
            checkAnswer();
            renderQuizLayout();
        });
    }
    
    if (nextQuestionBtn) {
        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (incorrectOnlyBtn) {
        incorrectOnlyBtn.addEventListener('click', () => {
            questions = quizData.filter(q => incorrectQuestions.includes(q.id));
            currentQuestionIndex = 0;
            userAnswers = new Array(questions.length);
            isAnswerChecked = false;
            renderQuizLayout();
        });
    }
    
    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', () => {
            const questionId = parseInt(bookmarkBtn.dataset.questionId);
            toggleBookmark(questionId);
            bookmarkBtn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    }
}

function initializeExamModeEvents() {
    const options = document.querySelectorAll('.option:not(.disabled)');
    const checkAllBtn = document.getElementById('checkAllBtn');
    const submitBtn = document.getElementById('examSubmitBtn');
    const modeToggleButtons = document.querySelectorAll('.mode-toggle-btn');
    
    options.forEach(option => {
        option.addEventListener('click', () => {
            const questionIndex = parseInt(option.closest('.question-card').dataset.questionIndex);
            const prevSelected = option.closest('.options-grid').querySelector('.selected');
            if (prevSelected) prevSelected.classList.remove('selected');
            option.classList.add('selected');
            userAnswers[questionIndex] = parseInt(option.dataset.optionIndex);
            updateExamProgress();
            updateExamSubmitButton();
            if (examCheckMode === 'immediate') {
                checkAnswer(questionIndex);
                renderQuizLayout();
            }
        });
    });
    
    if (checkAllBtn) {
        checkAllBtn.addEventListener('click', () => {
            userAnswers.forEach((answer, index) => {
                if (answer !== undefined) {
                    checkAnswer(index);
                }
            });
            renderQuizLayout();
        });
    }
    
    if (submitBtn) {
        submitBtn.addEventListener('click', submitExam);
    }
    
    modeToggleButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeToggleButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            examCheckMode = btn.dataset.mode;
            renderQuizLayout();
        });
    });
    
    document.querySelectorAll('.bookmark-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const questionId = parseInt(btn.dataset.questionId);
            toggleBookmark(questionId);
            btn.querySelector('i').className = bookmarkedQuestions.has(questionId) ? 'fas fa-bookmark' : 'far fa-bookmark';
        });
    });
}

function updateExamProgress() {
    const answered = userAnswers.filter(a => a !== undefined).length;
    const progressPercent = (answered / questions.length) * 100;
    const answeredCount = document.getElementById('answeredCount');
    const progressFill = document.getElementById('examProgressFill');
    if (answeredCount) {
        answeredCount.textContent = `${answered}/${questions.length} answered`;
    }
    if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
    }
}

function updateExamSubmitButton() {
    const submitBtn = document.getElementById('examSubmitBtn');
    if (submitBtn) {
        const allAnswered = userAnswers.every(a => a !== undefined);
        submitBtn.disabled = !allAnswered || examSubmitted;
        submitBtn.innerHTML = examSubmitted ?
            '<i class="fas fa-paper-plane"></i> Exam Submitted' :
            `<i class="fas fa-paper-plane"></i> Submit Exam (${questions.length} questions)`;
    }
}

function checkAnswer(questionIndex = currentQuestionIndex) {
    const question = questions[questionIndex];
    const userAnswer = userAnswers[questionIndex];
    isAnswerChecked = true;
    if (userAnswer === question.answer) {
        score++;
        userStats.correctAnswers++;
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].correct++;
        userProgress[question.id].attempts++;
        incorrectQuestions = incorrectQuestions.filter(id => id !== question.id);
    } else {
        if (!incorrectQuestions.includes(question.id)) {
            incorrectQuestions.push(question.id);
        }
        if (!userProgress[question.id]) userProgress[question.id] = { correct: 0, attempts: 0 };
        userProgress[question.id].attempts++;
    }
    userStats.totalQuestions++;
    userStats.masteryLevel = calculateMasteryLevel();
    saveUserData();
    updateDashboardStats();
}

function submitExam() {
    examSubmitted = true;
    if (examCheckMode === 'all-at-once') {
        userAnswers.forEach((answer, index) => {
            if (answer !== undefined) {
                checkAnswer(index);
            }
        });
    }
    stopTimer();
    showResults();
}

function calculateMasteryLevel() {
    const masteredQuestions = Object.values(userProgress).filter(p => p.correct >= 3).length;
    return quizData.length > 0 ? Math.round((masteredQuestions / quizData.length) * 100) : 0;
}

function showResults() {
    stopTimer();
    quizContainer.classList.add('hidden');
    resultsScreen.classList.remove('hidden');
    const percentage = questions.length > 0 ? Math.round((score / questions.length) * 100) : 0;
    
    let restartText = 'Restart Quiz';
    if (currentPage === 'bookmarks') {
        restartText = 'Practice Again';
    }
    
    resultsScreen.innerHTML = `
        <div class="results-card fade-in">
            <div class="results-header">
                <h2 class="results-title">${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)} Results</h2>
                <p class="score-text">You completed ${questions.length} question${questions.length !== 1 ? 's' : ''}</p>
            </div>
            <div class="score-display">${percentage}%</div>
            <div class="score-text">Score: ${score} out of ${questions.length} correct</div>
            <div class="results-details">
                ${questions.map((q, index) => {
                    const isCorrect = userAnswers[index] === q.answer;
                    return `
                        <div class="result-item">
                            <div class="result-question">Q${q.id}: ${q.question}</div>
                            <div class="result-status ${isCorrect ? 'result-correct' : 'result-incorrect'}">
                                ${isCorrect ? 'Correct' : 'Incorrect'}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="restart-btn" id="restartQuiz" aria-label="Restart Quiz" style="margin: 0;">
                    <i class="fas fa-redo"></i>
                    ${restartText}
                </button>
                ${currentPage === 'bookmarks' ? `
                    <button class="quiz-btn" onclick="showBookmarks()" style="background: linear-gradient(135deg, var(--secondary), #4b5563); color: white; padding: 16px 24px; border-radius: var(--radius);">
                        <i class="fas fa-bookmark"></i>
                        Back to Bookmarks
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('restartQuiz').addEventListener('click', () => {
        if (currentPage === 'bookmarks') {
            startBookmarksQuiz();
        } else {
            startQuiz();
        }
    });
}

function toggleBookmark(questionId) {
    if (bookmarkedQuestions.has(questionId)) {
        bookmarkedQuestions.delete(questionId);
        showNotification('Question removed from bookmarks', 'info');
    } else {
        bookmarkedQuestions.add(questionId);
        showNotification('Question bookmarked', 'success');
    }
    saveUserData();
    
    // If we're on the bookmarks page, refresh it
    if (currentPage === 'bookmarks') {
        showBookmarks();
    }
}


function getDifficultyColor(difficulty) {
    switch (difficulty.toLowerCase()) {
        case 'easy': return '#10b981';
        case 'medium': return '#f59e0b';
        case 'hard': return '#ef4444';
        default: return '#64748b';
    }
}

function jumpToQuestion(questionId) {
    const questionIndex = questions.findIndex(q => `question-${q.id}` === questionId);
    if (questionIndex !== -1) {
        if (currentMode === 'exam') {
            const element = document.getElementById(questionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        } else {
            currentQuestionIndex = questionIndex;
            isAnswerChecked = false;
            renderQuizLayout();
        }
    } else {
        // If question not in current quiz, start a new quiz with that question's category
        const question = quizData.find(q => `question-${q.id}` === questionId) || customQuestions.find(q => `question-${q.id}` === questionId);
        if (question) {
            selectedCategories = [question.category];
            startQuiz();
            setTimeout(() => {
                const element = document.getElementById(questionId);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
        }
    }
}

// Initialize the application
init();
    </script>
</body>
</html>

